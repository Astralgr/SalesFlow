<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <title>SalesFlow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00CEC8;
            --primary-dark: #00B8B3;
            --secondary: #00A8A3;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
            --sidebar-width: 220px;
        }

        [data-theme="dark"] {
            --primary: #00CEC8;
            --primary-dark: #00E5DD;
            --secondary: #00D9D3;
            --success: #34d399;
            --danger: #f87171;
            --warning: #fbbf24;
            --info: #60a5fa;
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border: #374151;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.4;
            font-size: 14px;
        }



/* Enhanced Customer Profile */
.customer-profile-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.customer-profile-section {
    background: var(--bg-secondary);
    padding: 1rem;
    border-radius: 8px;
    border-left: 3px solid var(--primary);
}

.customer-profile-section-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.customer-info-item {
    display: flex;
    align-items: start;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.customer-info-icon {
    color: var(--primary);
    font-size: 1rem;
    flex-shrink: 0;
    margin-top: 0.1rem;
}

.customer-info-content {
    flex: 1;
}

.customer-info-label {
    font-size: 0.7rem;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 0.15rem;
}

.customer-info-value {
    color: var(--text-primary);
    word-break: break-word;
}

.customer-info-value a {
    color: var(--primary);
    text-decoration: none;
}

.customer-info-value a:hover {
    text-decoration: underline;
}

/* Enhanced Banner */
.customer-header-banner {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1rem;
    display: none;
    box-shadow: 0 4px 12px rgba(27, 168, 175, 0.3);
}

.customer-header-banner.active {
    display: flex;
    flex-direction: column;
}

.customer-banner-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 2rem;
    margin-bottom: 1rem;
    width: 100%;
}

.customer-header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
    min-width: 0;
}

.customer-header-icon {
    font-size: 3rem;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    flex-shrink: 0;
}

.customer-header-info {
    flex: 1;
    min-width: 0;
}

.customer-header-title {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 0.25rem;
}

.customer-header-name {
    font-size: 1.75rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.25rem;
    line-height: 1.2;
}

.customer-header-company {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.customer-header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: flex-start;
    flex-shrink: 0;
}

.customer-header-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
}

.customer-header-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
}

.customer-header-btn.delete:hover {
    background: var(--danger);
}

.customer-banner-details {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    align-items: center;
    width: 100%;
}

.customer-banner-detail {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.customer-banner-detail-icon {
    font-size: 1.1rem;
    opacity: 0.9;
}

.customer-banner-detail-content {
    display: flex;
    align-items: center;
    gap: 0.35rem;
}

.customer-banner-detail-label {
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.05em;
    white-space: nowrap;
}

.customer-banner-detail-value {
    font-size: 0.85rem;
    color: white;
    white-space: nowrap;
}

.customer-banner-detail-value a {
    color: white;
    text-decoration: none;
    border-bottom: 1px dashed rgba(255, 255, 255, 0.5);
}

.customer-banner-detail-value a:hover {
    border-bottom-style: solid;
}

/* Sticky Action Bar */
.sticky-action-bar {
    position: sticky;
    top: 0;
    background: var(--bg-primary);
    border-bottom: 2px solid var(--border);
    padding: 1rem 1.5rem;
    margin: -1.5rem -1.5rem 1.5rem -1.5rem;
    z-index: 1000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px var(--shadow);
}

.sticky-action-bar-title {
    font-size: 1.1rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sticky-action-bar-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-large {
    padding: 0.75rem 1.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Field Error State */
.form-input.error,
.form-textarea.error,
.customer-combobox-input.error {
    border-color: var(--danger) !important;
    animation: shake 0.3s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.field-error-message {
    color: var(--danger);
    font-size: 0.75rem;
    margin-top: 0.35rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-section.error {
    border-color: var(--danger);
    animation: pulse 0.5s;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

/* Enhanced Customer Dropdown */
.customer-combobox {
    position: relative;
}

.customer-combobox-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 0.9rem;
    transition: all 0.2s;
}

.customer-combobox-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 206, 200, 0.1);
}

.customer-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg-primary);
    border: 2px solid var(--primary);
    border-radius: 8px;
    margin-top: 0.5rem;
    max-height: 250px;
    overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0, 206, 200, 0.3), 0 0 0 1px rgba(0, 206, 200, 0.1);
    z-index: 100;
}

.customer-dropdown.active {
    display: block;
    animation: dropdownSlide 0.2s ease-out;
}

@keyframes dropdownSlide {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.customer-dropdown-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 1px solid var(--border);
}

.customer-dropdown-item:last-child {
    border-bottom: none;
}

.customer-dropdown-item:hover {
    background: var(--bg-secondary);
    padding-left: 1.25rem;
}

.customer-dropdown-item.new-customer {
    color: var(--primary);
    font-weight: 700;
    background: linear-gradient(90deg, rgba(0, 206, 200, 0.1), transparent);
}

.customer-dropdown-item.new-customer:hover {
    background: linear-gradient(90deg, rgba(0, 206, 200, 0.2), transparent);
}

.customer-dropdown-item-name {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.customer-dropdown-item-email {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* Modern Form Sections */
.form-section {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    border: 2px solid transparent;
    transition: all 0.3s;
    position: relative;
    overflow: visible; /* Changed from hidden to visible */
}

.form-section:hover {
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(0, 206, 200, 0.1);
}

.form-section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    cursor: pointer;
}

.form-section-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    flex-shrink: 0;
}

.form-section-title {
    font-size: 1rem;
    font-weight: 700;
    flex: 1;
}

.form-section-toggle {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    background: var(--bg-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.form-section.collapsed .form-section-toggle {
    transform: rotate(-90deg);
}

.form-section-content {
    max-height: 1000px;
    overflow: visible; /* Changed to visible */
    transition: max-height 0.3s ease-out;
    position: relative;
}

.form-section.collapsed .form-section-content {
    max-height: 0;
    overflow: hidden; /* Hidden only when collapsed */
}

/* Quick Templates */
.quick-templates {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}

.template-btn {
    padding: 0.5rem 1rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.template-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
    transform: translateY(-2px);
}

/* Modern Participant Cards */
.participant-grid {
    display: grid;
    gap: 0.75rem;
}

.participant-card {
    background: var(--bg-tertiary);
    border-radius: 8px;
    padding: 1rem;
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1rem;
    align-items: start;
}

.participant-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.25rem;
}

.participant-details {
    flex: 1;
}

.participant-card-name {
    font-weight: 700;
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
}

.participant-card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.participant-card-meta span {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* Outcome Selector */
.outcome-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.75rem;
}

.outcome-option {
    padding: 1rem;
    border: 2px solid var(--border);
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-secondary);
}

.outcome-option:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.outcome-option.selected {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(0, 206, 200, 0.1), rgba(0, 168, 163, 0.05));
}

.outcome-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.outcome-label {
    font-size: 0.8rem;
    font-weight: 600;
}

/* MEDDPICC Visual Tracker */
.meddpicc-visual-tracker {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.meddpicc-tracker-item {
    background: var(--bg-secondary);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    border: 2px solid transparent;
    transition: all 0.3s;
    cursor: pointer;
}

.meddpicc-tracker-item:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.meddpicc-tracker-item.completed {
    border-color: var(--success);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
}

.meddpicc-tracker-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--bg-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    font-size: 1.5rem;
    transition: all 0.3s;
}

.meddpicc-tracker-item.completed .meddpicc-tracker-icon {
    background: var(--success);
    color: white;
}

.meddpicc-tracker-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
}

.meddpicc-tracker-item.completed .meddpicc-tracker-label {
    color: var(--success);
}

/* Meeting Type Pills */
.meeting-type-pills {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.meeting-type-pill {
    padding: 0.75rem 1.25rem;
    border: 2px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
    background: var(--bg-secondary);
}

.meeting-type-pill:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.meeting-type-pill.selected {
    border-color: var(--primary);
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
}

.meeting-type-icon {
    font-size: 1.25rem;
}

/* Enhanced Rich Text Editor */
.enhanced-editor-wrapper {
    border: 2px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.2s;
}

.enhanced-editor-wrapper:focus-within {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 206, 200, 0.1);
}

.enhanced-editor-toolbar {
    background: var(--bg-tertiary);
    padding: 0.75rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
}

.toolbar-group {
    display: flex;
    gap: 0.25rem;
    padding-right: 0.75rem;
    border-right: 1px solid var(--border);
}

.toolbar-group:last-child {
    border-right: none;
}

.enhanced-editor-content {
    min-height: 200px;
    padding: 1rem;
    background: var(--bg-primary);
    font-size: 0.9rem;
    line-height: 1.6;
}

/* Smart Suggestions */
.smart-suggestions {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05));
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid #667eea;
}

.smart-suggestions-title {
    font-size: 0.8rem;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.suggestion-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.suggestion-pill {
    padding: 0.5rem 1rem;
    background: white;
    border: 1px solid #667eea;
    border-radius: 8px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

[data-theme="dark"] .suggestion-pill {
    background: var(--bg-secondary);
}

.suggestion-pill:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
}


/* Progress Indicator */
.form-progress {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 10px;
}

.progress-step {
    flex: 1;
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: 3px;
    position: relative;
    overflow: hidden;
}

.progress-step.completed {
    background: var(--success);
}

.progress-step.active {
    background: var(--primary);
}

.progress-step.active::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem 0.75rem;
            z-index: 101;
            overflow-y: auto;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #00E5DD 0%, #00CEC8 50%, #00A8A3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
            padding: 0 0.5rem;
            letter-spacing: -0.5px;
            position: relative;
        }

        .sidebar-logo::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 0.5rem;
            right: 0.5rem;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.3;
        }

        .customer-header-banner {
            background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 12px rgba(27, 168, 175, 0.3);
        }

        .customer-header-banner.active {
            display: flex;
        }

        .customer-header-icon {
            font-size: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .customer-header-info {
            flex: 1;
        }

        .customer-header-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.25rem;
        }

        .customer-header-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .customer-header-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .customer-header-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .sidebar-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 700;
            margin: 1.5rem 0 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0.5rem;
        }

        .sidebar-title-btn {
            background: rgba(0, 206, 200, 0.15);
            border: 1px solid rgba(0, 206, 200, 0.3);
            color: var(--primary);
            cursor: pointer;
            font-size: 1rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 700;
        }

        .sidebar-title-btn:hover {
            background: rgba(0, 206, 200, 0.25);
            transform: scale(1.1);
        }

        .action-btn {
            width: 100%;
            padding: 0.65rem 0.75rem;
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.03);
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .action-btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            transition: all 0.3s;
            position: relative;
            z-index: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .action-btn:hover .action-btn-icon {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .action-btn-icon svg {
            width: 18px;
            height: 18px;
            stroke: rgba(255, 255, 255, 0.9);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .action-btn:hover .action-btn-icon svg {
            stroke: white;
        }

       .category-filter {
    padding: 0.6rem 0.75rem;
    border: none;
    background: rgba(255, 255, 255, 0.03);
    color: rgba(255, 255, 255, 1);
    border-radius: 10px;
    cursor: pointer;
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
    min-height: 42px;
}

.category-filter-content {
    display: contents;
}

.category-filter-name {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    min-width: 0;
}

.category-filter::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--primary);
    transform: scaleY(0);
    transition: transform 0.3s;
}

.category-filter:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateX(4px);
}

.category-filter:hover::before {
    transform: scaleY(1);
}

.category-filter.active {
    background: linear-gradient(135deg, rgba(0, 206, 200, 0.2), rgba(0, 168, 163, 0.15));
    color: white;
    border-left: 3px solid var(--primary);
    font-weight: 600;
}

.category-filter.active::before {
    transform: scaleY(1);
}

        .category-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
        }

.customer-count {
    font-size: 0.7rem;
    background: rgba(0, 206, 200, 0.15);
    color: var(--primary);
    padding: 0.2rem 0.5rem;
    border-radius: 6px;
    font-weight: 700;
    min-width: 24px;
    text-align: center;
}

.customer-filter-actions {
    display: flex;
    gap: 0.25rem;
}

.customer-filter-btn {
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    width: 20px;
    height: 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    padding: 0;
}

.customer-filter-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    transform: scale(1.1);
}

.customer-filter-btn.delete:hover {
    background: var(--danger);
    color: white;
}

.customer-filter-btn svg {
    width: 12px;
    height: 12px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}

.customer-header-actions {
    display: flex;
    gap: 0.35rem;
    align-items: center;
}

.customer-header-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.customer-header-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
}

.customer-header-btn.delete:hover {
    background: var(--danger);
}

        .category-filter.active .customer-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .header {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            margin-left: var(--sidebar-width);
            z-index: 100;
            box-shadow: 0 1px 4px var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-bar {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 206, 200, 0.1);
        }

.search-icon {
    position: absolute;
    left: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    color: var(--text-secondary);
    pointer-events: none;
}

        .header-actions {
            display: flex;
            gap: 0.35rem;
        }

        .btn-icon {
            background: transparent;
            border: none;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
.btn-add-note {
    background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
    color: white !important;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(0, 206, 200, 0.3);
}

.btn-add-note:hover {
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 4px 12px rgba(0, 206, 200, 0.5);
}

.btn-add-note svg {
    width: 18px;
    height: 18px;
}

        .btn-icon:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-icon.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .btn-icon svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .container {
            margin-left: var(--sidebar-width);
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 1rem;
        }

        .container.kanban-mode {
            grid-template-columns: 1fr;
        }

        .container.form-mode {
            grid-template-columns: 1fr;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

.inline-form-container {
    display: none;
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 1.5rem 2rem;
    box-shadow: 0 1px 4px var(--shadow);
    animation: slideIn 0.3s ease-out;
    overflow: visible;
    max-width: 60%;
    width: 100%;
    margin: 0 auto;
}

        .inline-form-container.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .customer-overview-section {
            display: none;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 1px 4px var(--shadow);
        }

        .customer-overview-section.active {
            display: block;
        }

        .customer-overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .customer-overview-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .customer-overview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
            border-color: var(--primary);
        }

        .customer-overview-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .customer-overview-badges {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        .customer-overview-badge {
            padding: 0.125rem 0.5rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .customer-overview-badge.meetings {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
        }

        .customer-overview-badge.preparations {
            background: rgba(250, 112, 154, 0.15);
            color: #fa709a;
        }

        .customer-overview-badge.tasks {
            background: rgba(0, 206, 200, 0.15);
            color: var(--primary);
        }

        .customer-overview-info {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }

        .customer-overview-info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            font-size: 0.75rem;
        }

        .customer-overview-label {
            color: var(--text-secondary);
        }

        .customer-overview-value {
            font-weight: 600;
        }

        .dashboard-stats-section {
            display: none;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 4px var(--shadow);
            margin-bottom: 1rem;
        }

        .dashboard-stats-section.active {
            display: block;
        }

        .dashboard-stats-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dashboard-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
        }

        .dashboard-stat-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: 10px;
            padding: 0.875rem;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .dashboard-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .dashboard-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--shadow);
            border-color: var(--primary);
        }

        .dashboard-stat-icon {
            font-size: 1.5rem;
            margin-bottom: 0.35rem;
        }

        .dashboard-stat-value {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .dashboard-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dashboard-stat-sublabel {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.35rem;
            padding-top: 0.35rem;
            border-top: 1px solid var(--border);
        }

        .dashboard-meetings-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .meeting-type-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.65rem;
            border-left: 3px solid;
            transition: all 0.2s;
        }

        .meeting-type-card:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 10px var(--shadow);
        }

        .meeting-type-card.discovery {
            border-left-color: #667eea;
        }

        .meeting-type-card.demo {
            border-left-color: #f093fb;
        }

        .meeting-type-card.follow-up {
            border-left-color: #4facfe;
        }

        .meeting-type-card.quarterly {
            border-left-color: #43e97b;
        }

        .meeting-type-card.sales {
            border-left-color: #fa709a;
        }

        .meeting-type-card.other {
            border-left-color: var(--text-secondary);
        }

        .meeting-type-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .meeting-type-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: capitalize;
            margin-top: 0.2rem;
        }

        .customer-preparations-section, .customer-meetings-section {
            display: none;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 1px 4px var(--shadow);
        }

.customer-participants-section {
    display: none;
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 1px 4px var(--shadow);
    margin-bottom: 1rem;
}

.customer-participants-section.active {
    display: block;
}

.participants-overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 0.75rem;
    margin-top: 0.75rem;
}

.participant-overview-card {
    background: linear-gradient(135deg, #3d1a00 0%, #c43a00 100%);
    border-radius: 10px;
    padding: 1rem;
    color: white;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.participant-overview-actions {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.participant-overview-card:hover .participant-overview-actions {
    opacity: 1;
}

.participant-action-btn {
    background: rgba(255, 255, 255, 0.9);
    border: none;
    color: var(--text-primary);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

[data-theme="dark"] .participant-action-btn {
    background: rgba(31, 41, 55, 0.95);
    color: white;
}

.participant-action-btn:hover {
    transform: scale(1.1);
}

.participant-action-btn.delete:hover {
    background: var(--danger);
    color: white;
}

.btn-add-participant {
    background: linear-gradient(135deg, #3d1a00 0%, #c43a00 100%);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(61, 26, 0, 0.4);
}

.btn-add-participant:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(61, 26, 0, 0.6);
    background: linear-gradient(135deg, #4a2000 0%, #d44500 100%);
}

.participant-action-btn svg {
    width: 16px;
    height: 16px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

.participant-overview-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(61, 26, 0, 0.4);
}

.participant-overview-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s;
}

.participant-overview-card:hover::before {
    opacity: 1;
}



.participant-overview-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}

.participant-overview-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: 700;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.participant-overview-info {
    flex: 1;
}

.participant-overview-name {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.participant-overview-role {
    font-size: 0.75rem;
    opacity: 0.9;
}

.participant-overview-details {
    font-size: 0.75rem;
    line-height: 1.6;
    opacity: 0.95;
}

.participant-overview-detail {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
}

.participant-overview-meetings {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 0.7rem;
    opacity: 0.9;
}

        .customer-preparations-section.active, .customer-meetings-section.active {
            display: block;
        }

        .customer-preparations-section.empty, .customer-meetings-section.empty {
            padding: 0.5rem;
            background: transparent;
            box-shadow: none;
        }

        .empty-state-compact {
            text-align: center;
            padding: 0.75rem;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 0.8rem;
            border: 2px dashed var(--border);
        }

        .empty-state-compact-icon {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
            opacity: 0.5;
        }

        .empty-state-add-btn {
            margin-top: 0.5rem;
            padding: 0.35rem 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            transition: all 0.2s;
        }

        .empty-state-add-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .customer-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
        }

        .customer-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .customer-meeting-summary, .customer-preparation-summary {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .customer-meeting-summary {
            border-left: 3px solid #667eea;
        }

        .customer-preparation-summary {
            border-left: 3px solid #fa709a;
        }

        .meeting-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .meeting-summary-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .meeting-summary-date {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .meeting-summary-content {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            white-space: pre-wrap;
            max-height: 60px;
            overflow: hidden;
        }

        .meeting-summary-content.expanded {
            max-height: none;
        }

        .meeting-expand-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0;
        }

        .meeting-expand-btn:hover {
            color: var(--primary-dark);
        }

        .preparation-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.35rem;
        }

        .meddpicc-progress {
            margin: 0.75rem 0;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .meddpicc-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .meddpicc-progress-title {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .meddpicc-progress-score {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--primary);
        }

        .meddpicc-progress-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .meddpicc-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s;
        }

        .meddpicc-items {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.35rem;
        }

        .meddpicc-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.7rem;
        }

        .meddpicc-item-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
        }

        .meddpicc-item-icon.completed {
            background: var(--success);
            color: white;
        }

        .meddpicc-item-icon.incomplete {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .tasks-section {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 1px 4px var(--shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .view-toggle {
            display: flex;
            gap: 0.35rem;
        }

        .view-btn {
            padding: 0.35rem 0.75rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .task-filters {
            display: flex;
            gap: 0.35rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.35rem 0.75rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .kanban-board {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .kanban-board.active {
            display: grid;
        }

        .kanban-column {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem;
            min-height: 400px;
        }

        .kanban-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
        }

        .kanban-column-title {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .kanban-column-count {
            background: var(--bg-tertiary);
            padding: 0.125rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .kanban-cards {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 350px;
        }

        .kanban-cards.drag-over {
            background: var(--bg-tertiary);
            border-radius: 6px;
            border: 2px dashed var(--primary);
        }

        .task-card {
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 0.75rem;
            cursor: move;
            transition: all 0.2s;
            display: flex;
            gap: 0.5rem;
            position: relative;
            animation: slideIn 0.2s ease-out;
        }

        .task-card:hover {
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }

        .task-card.overdue {
            border-left: 3px solid var(--danger);
        }

        .task-card.due-soon {
            border-left: 3px solid var(--warning);
        }

        .task-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .task-card.color-red { border-color: #ef4444; }
        .task-card.color-orange { border-color: #f97316; }
        .task-card.color-yellow { border-color: #eab308; }
        .task-card.color-green { border-color: #10b981; }
        .task-card.color-blue { border-color: #3b82f6; }
        .task-card.color-purple { border-color: #8b5cf6; }
        .task-card.color-pink { border-color: #ec4899; }

        .task-number {
            position: absolute;
            top: -8px;
            left: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .task-checkbox:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .task-checkbox.completed {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: var(--primary);
        }

        .task-checkbox svg {
            width: 14px;
            height: 14px;
            stroke: white;
            stroke-width: 3;
            fill: none;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s;
        }

        .task-checkbox.completed svg {
            opacity: 1;
            transform: scale(1);
        }

        .task-content {
            flex: 1;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.35rem;
        }

        .task-title {
            font-size: 0.9rem;
            font-weight: 600;
            flex: 1;
        }

        .task-title.completed {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .task-badges {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        .task-priority, .task-category {
            padding: 0.125rem 0.5rem;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-high {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .priority-medium {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .priority-low {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .task-customer {
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .task-meeting-badge {
            padding: 0.125rem 0.5rem;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 600;
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .task-due-date {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 0.35rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            width: fit-content;
        }

        .task-due-date.overdue {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            font-weight: 600;
        }

        .task-due-date.due-soon {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            font-weight: 600;
        }

        .task-description {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 0.35rem;
            white-space: pre-wrap;
        }

        .subtasks-container {
            margin: 0.35rem 0;
            padding-left: 0.5rem;
            border-left: 2px solid var(--border);
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0;
            font-size: 0.75rem;
        }

        .subtask-checkbox {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-radius: 3px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .subtask-checkbox.completed {
            background: var(--primary);
            border-color: var(--primary);
        }

        .subtask-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.35rem;
            gap: 0.5rem;
        }

        .task-tags {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
            flex: 1;
        }

        .tag {
            padding: 0.125rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .task-actions {
            display: flex;
            gap: 0.25rem;
        }

        .task-btn {
            background: transparent;
            border: none;
            padding: 0.35rem;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .task-btn:hover {
            background: var(--bg-tertiary);
            color: var(--primary);
        }

        .task-btn.delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .task-btn.archive:hover {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .task-btn svg {
            width: 14px;
            height: 14px;
        }

        .color-picker {
            display: flex;
            gap: 0.35rem;
            margin-top: 0.35rem;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border: 2px solid var(--text-primary);
            transform: scale(1.05);
        }

        .notes-container {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 1px 4px var(--shadow);
            position: sticky;
            top: 80px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .notes-container.hidden {
            display: none;
        }

        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .note-box {
            border-radius: 10px;
            padding: 0.75rem;
            color: white;
            cursor: move;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            animation: slideIn 0.2s ease-out;
        }

        .note-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .note-box.dragging {
            opacity: 0.7;
        }

        .note-number {
            position: absolute;
            top: -8px;
            left: 8px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .note-content {
            margin-bottom: 0.5rem;
            line-height: 1.4;
            white-space: pre-wrap;
            font-size: 0.8rem;
        }

        .note-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.35rem;
        }

        .note-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.35rem;
            border-radius: 6px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .note-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .note-btn svg {
            width: 14px;
            height: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1.25rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin: auto;
        }

        .modal-content.large {
            max-width: 800px;
        }

        .modal-content.xlarge {
            max-width: 1200px;
            width: 95%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .close-btn {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 6px;
            color: var(--text-secondary);
            transition: all 0.2s;
            line-height: 1;
        }

        .close-btn:hover {
            background: var(--bg-secondary);
            transform: rotate(90deg);
        }

        .modal-tabs {
            display: flex;
            gap: 0.35rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .modal-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .modal-tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .modal-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.35rem;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 206, 200, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
        }

        .form-footer {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--border);
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }



.customer-combobox-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 0.9rem;
    transition: all 0.2s;
}

.customer-combobox-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 206, 200, 0.1);
}

.customer-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg-primary);
    border: 2px solid var(--primary);
    border-radius: 8px;
    margin-top: 0.5rem;
    max-height: 250px;
    overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0, 206, 200, 0.3), 0 0 0 1px rgba(0, 206, 200, 0.1);
    z-index: 10000;
}

.customer-dropdown.active {
    display: block;
    animation: dropdownSlide 0.2s ease-out;
}

@keyframes dropdownSlide {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.customer-dropdown-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 1px solid var(--border);
    background: var(--bg-primary);
}

.customer-dropdown-item:last-child {
    border-bottom: none;
}

.customer-dropdown-item:hover {
    background: var(--bg-secondary);
    padding-left: 1.25rem;
}

.customer-dropdown-item.new-customer {
    color: var(--primary);
    font-weight: 700;
    background: linear-gradient(90deg, rgba(0, 206, 200, 0.1), transparent);
}

.customer-dropdown-item.new-customer:hover {
    background: linear-gradient(90deg, rgba(0, 206, 200, 0.2), rgba(0, 206, 200, 0.05));
}

.customer-dropdown-item-name {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
    color: var(--text-primary);
}

.customer-dropdown-item-email {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

        .rich-text-toolbar {
            display: flex;
            gap: 0.35rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap;
        }

        .rich-text-btn {
            padding: 0.4rem 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
            min-width: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .rich-text-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .rich-text-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .rich-text-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .rich-text-editor {
            width: 100%;
            min-height: 150px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0 0 8px 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
            overflow-y: auto;
            line-height: 1.6;
        }

        .rich-text-editor:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 206, 200, 0.1);
        }

        .rich-text-editor ul,
        .rich-text-editor ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .rich-text-editor li {
            margin-bottom: 0.25rem;
        }

        .rich-text-editor p {
            margin-bottom: 0.5rem;
        }

        .rich-text-editor strong {
            font-weight: 700;
        }

        .rich-text-editor em {
            font-style: italic;
        }

        .rich-text-editor u {
            text-decoration: underline;
        }

        .meddpicc-toolbar, .action-item-toolbar {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .meddpicc-toolbar-label, .action-item-toolbar-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .meddpicc-toolbar-label svg, .action-item-toolbar-label svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .meddpicc-toolbar-buttons, .action-item-toolbar-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .meddpicc-quick-btn, .action-item-quick-btn {
            padding: 0.4rem 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            position: relative;
        }

        .meddpicc-info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-secondary);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            cursor: help;
            margin-left: 0.25rem;
            position: relative;
        }

        .meddpicc-info-icon:hover {
            background: var(--primary);
        }

        .meddpicc-tooltip {
            position: fixed;
            bottom: auto;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            width: 320px;
            display: none;
            pointer-events: none;
        }

        .meddpicc-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--border);
        }

        .meddpicc-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--bg-primary);
            z-index: 1;
        }

        .meddpicc-info-icon:hover .meddpicc-tooltip {
            display: block;
        }

        .meddpicc-quick-btn:hover .meddpicc-tooltip {
            display: block;
        }

        .meddpicc-tooltip-title {
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 0.35rem;
            color: var(--primary);
        }

        .meddpicc-tooltip-description {
            font-size: 0.75rem;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .meddpicc-quick-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .action-item-quick-btn:hover {
            background: var(--success);
            color: white;
            border-color: var(--success);
            transform: translateY(-1px);
        }

        .meddpicc-quick-btn.success-flash, .action-item-quick-btn.success-flash {
            background: var(--success);
            color: white;
            border-color: var(--success);
            animation: successPulse 0.5s ease-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .subtasks-form {
            margin-top: 0.35rem;
        }

        .subtask-input-group {
            display: flex;
            gap: 0.35rem;
            margin-bottom: 0.35rem;
        }

        .subtask-input {
            flex: 1;
        }

        .btn-add-subtask {
            padding: 0.35rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 0.8rem;
        }

        .btn-add-subtask:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-remove-subtask {
            padding: 0.35rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .participants-list {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .participant-item {
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 0.35rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-weight: 600;
            margin-bottom: 0.125rem;
            font-size: 0.8rem;
        }

        .participant-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .btn-remove-participant {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .meeting-tasks-list {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .meeting-task-preview {
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 0.35rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .btn-remove-meeting-task {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .export-content {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem;
        }

        .export-preview {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
        }

        .export-actions {
            display: flex;
            gap: 0.35rem;
        }

        .btn-export {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--primary);
            color: white;
        }

        .btn-export:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .customer-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 350px;
            overflow-y: auto;
        }

        .customer-item {
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .customer-info {
            flex: 1;
        }

        .customer-name {
            font-weight: 600;
            margin-bottom: 0.125rem;
            font-size: 0.85rem;
        }

        .customer-email {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .customer-actions {
            display: flex;
            gap: 0.35rem;
        }

        .tags-overview-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 1rem;
            max-height: 70vh;
        }

        .tags-list-section {
            border-right: 1px solid var(--border);
            padding-right: 1rem;
            overflow-y: auto;
        }

        .tag-item {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 0.35rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .tag-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(2px);
        }

        .tag-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .tag-item-name {
            font-weight: 600;
        }

        .tag-item-count {
            font-size: 0.75rem;
            background: var(--bg-tertiary);
            padding: 0.125rem 0.35rem;
            border-radius: 4px;
        }

        .tag-item.active .tag-item-count {
            background: rgba(255, 255, 255, 0.2);
        }

        .customers-by-tag-section {
            overflow-y: auto;
        }

        .customer-tag-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .customer-tag-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .customer-tag-name {
            font-size: 1rem;
            font-weight: 600;
        }

        .meetings-count-badge {
            background: var(--primary);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .meetings-list-compact {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .meeting-compact-item {
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .meeting-compact-date {
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin-top: 0.125rem;
        }

        .meeting-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #667eea;
        }

        .meeting-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .meeting-info h3 {
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .meeting-date {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .meeting-notes {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            white-space: pre-wrap;
        }

        .meeting-tasks {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }

        .meeting-tasks-title {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.35rem;
            color: var(--text-secondary);
        }

        .meeting-task-item {
            padding: 0.35rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-bottom: 0.25rem;
            font-size: 0.75rem;
        }

        .meeting-tag {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 0.35rem;
            margin-bottom: 0.35rem;
        }

        .meddpicc-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 2px solid var(--border);
        }

        .meddpicc-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .meddpicc-grid, .meddpicc-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .meddpicc-field {
            background: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: 6px;
        }

        .meddpicc-field-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .meddpicc-field-value {
            font-size: 0.75rem;
            color: var(--text-primary);
            white-space: pre-wrap;
        }

        .meddpicc-field.empty .meddpicc-field-value {
            color: var(--text-secondary);
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1001;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        .confirm-modal.active {
            display: flex;
        }

        .confirm-content {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1.25rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            animation: slideUp 0.2s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .confirm-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .confirm-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.35rem;
        }

        .confirm-message {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            line-height: 1.4;
            font-size: 0.85rem;
        }

        .confirm-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .toast {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 1001;
            transition: transform 0.3s;
            font-size: 0.85rem;
        }

        .toast.active {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--danger);
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
            .notes-container {
                position: relative;
                top: 0;
                max-height: none;
            }
            .kanban-board {
                grid-template-columns: 1fr;
            }
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            .tags-overview-content {
                grid-template-columns: 1fr;
            }
            .tags-list-section {
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding-right: 0;
                padding-bottom: 0.5rem;
                margin-bottom: 0.5rem;
            }
            .meddpicc-items {
                grid-template-columns: repeat(2, 1fr);
            }
            .meddpicc-grid, .meddpicc-form-grid {
                grid-template-columns: 1fr;
            }
            .customer-overview-grid {
                grid-template-columns: 1fr;
            }
        }
@media (max-width: 768px) {
    :root {
        --sidebar-width: 0;
    }
    .sidebar {
        transform: translateX(-100%);
    }
    .header, .container {
        margin-left: 0;
    }
    .form-row {
        grid-template-columns: 1fr;
    }
    .modal-content.xlarge, .modal-content.large {
        width: 95%;
        padding: 1rem;
    }
    .modal-tabs {
        overflow-x: scroll;
    }
    .inline-form-container {
        padding: 1rem 1.5rem; /* Reduced padding on mobile */
        max-width: 100%;
    }
}

/* User Authentication Styles */
.user-profile {
    position: relative;
}

.user-profile-btn {
    background: transparent;
    border: none;
    padding: 0.5rem;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.user-profile-btn:hover {
    background: var(--bg-secondary);
}

.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid var(--primary);
}

.user-dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 8px 24px var(--shadow);
    min-width: 250px;
    z-index: 1000;
}

.user-dropdown.active {
    display: block;
    animation: dropdownSlide 0.2s ease-out;
}

.user-dropdown-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
}

.user-dropdown-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.user-dropdown-email {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.user-dropdown-menu {
    padding: 0.5rem;
}

.user-dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.85rem;
}

.user-dropdown-item:hover {
    background: var(--bg-secondary);
}

.user-dropdown-item svg {
    width: 16px;
    height: 16px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

.btn-sign-in {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0, 206, 200, 0.3);
}

.btn-sign-in:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 206, 200, 0.5);
}

.auth-loading {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-logo">SalesFlow</div>

        <button class="action-btn btn-home" id="homeBtn" style="margin-bottom: 1rem;">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                    <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                    <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                    <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                </svg>
            </div>
            <span>Dashboard</span>
        </button>

        <div class="sidebar-title">Quick Actions</div>
        <button class="action-btn btn-preparation" id="newPreparationBtn">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            </div>
            <span>Prepare Meeting</span>
        </button>
        <button class="action-btn btn-meeting" id="newMeetingBtn">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
            </div>
            <span>Meeting Notes</span>
        </button>
        <button class="action-btn btn-new-task" id="newTaskBtn">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"></path>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
            </div>
            <span>New Task</span>
        </button>
        <button class="action-btn btn-new-note" id="newNoteBtn">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                </svg>
            </div>
            <span>Quick Note</span>
        </button>
        <button class="action-btn btn-show-tasks" id="showAllTasksBtn">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
            </div>
            <span>All Tasks</span>
        </button>

        <div class="sidebar-title">
            <span>Customers</span>
            <button class="sidebar-title-btn" id="manageCustomersBtn" title="Manage">+</button>
        </div>
<button class="category-filter active" data-customer="all">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span class="category-dot" style="background: white"></span>
        All Customers
    </div>
    <span class="customer-count" id="allCustomersCount">0</span>
</button>
        <div id="customerFilters"></div>
    </aside>

    <header class="header">
        <div class="header-content">
<div class="search-bar">
    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
    </svg>
    <input type="text" id="searchInput" placeholder="Search company...">
</div>
            <div class="header-actions">
                <button class="btn-icon" id="tagsOverviewBtn" title="Tags">
                    <svg viewBox="0 0 24 24">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                    </svg>
                </button>
                <button class="btn-icon" id="viewMeetingsBtn" title="Meetings">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </button>
                <button class="btn-icon" id="themeToggle" title="Theme">
                    <svg viewBox="0 0 24 24">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button class="btn-icon" id="archiveBtn" title="Archive">
                    <svg viewBox="0 0 24 24">
                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                        <rect x="1" y="3" width="22" height="5"></rect>
                        <line x1="10" y1="12" x2="14" y2="12"></line>
                    </svg>
                </button>
                <button class="btn-icon danger" id="clearAllBtn" title="Clear All">
                    <svg viewBox="0 0 24 24">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </button>

            <!-- Auth Section - ADD THIS ENTIRE BLOCK -->
            <div id="authContainer">
                <div class="auth-loading" id="authLoading">
                    <div class="spinner"></div>
                    <span>Loading...</span>
                </div>
                <button class="btn-sign-in" id="signInBtn" style="display: none;">
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>
                <div class="user-profile" id="userProfile" style="display: none;">
                    <button class="user-profile-btn" id="userProfileBtn">
                        <img src="" alt="User" class="user-avatar" id="userAvatar">
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-header">
                            <div class="user-dropdown-name" id="userName"></div>
                            <div class="user-dropdown-email" id="userEmail"></div>
                        </div>
                        <div class="user-dropdown-menu">
                            <div class="user-dropdown-item" id="signOutBtn">
                                <svg viewBox="0 0 24 24">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16 17 21 12 16 7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                                Sign Out
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

            </div>
        </div>
<div class="customer-header-banner" id="customerHeaderBanner">
    <div class="customer-banner-top">
        <div class="customer-header-left">
            <div class="customer-header-icon"></div>
            <div class="customer-header-info">
                <div class="customer-header-title">Customer Profile</div>
                <div class="customer-header-name" id="customerHeaderName"></div>
                <div class="customer-header-company" id="customerHeaderCompany"></div>
            </div>
        </div>
        <div class="customer-header-actions">
            <button class="customer-header-btn" onclick="editCustomerFromBanner()" title="Edit Profile">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </button>
            <button class="customer-header-btn delete" onclick="deleteCustomerFromHeader()" title="Delete">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
            <button class="customer-header-btn" onclick="showDashboard()" title="Back to All">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
    </div>
    <div class="customer-banner-details" id="customerBannerDetails"></div>
</div>
</div>
    </header>

    <div class="container" id="mainContainer">
        <div class="main-content">
<!-- Inline Preparation Form -->
<div class="inline-form-container" id="inlinePreparationForm">
    <form id="preparationForm">
        <input type="hidden" id="preparationId">
        
        <!-- Sticky Action Bar -->
        <div class="sticky-action-bar">
            <div class="sticky-action-bar-title">
                 Meeting Preparation
            </div>
            <div class="sticky-action-bar-actions">
                <button type="button" class="btn btn-secondary btn-large" onclick="closeInlinePreparationForm()">
                     Cancel
                </button>
                <button type="submit" class="btn btn-primary btn-large">
                     Save Preparation
                </button>
            </div>
        </div>

        <div class="modal-tabs">
            <button type="button" class="modal-tab active" data-tab="info" data-form="preparation"> Prepare</button>
            <button type="button" class="modal-tab" data-tab="export" data-form="preparation"> Export</button>
        </div>

        <div class="tab-content active" data-tab-content="info">
            <!-- Customer Selection -->
            <div class="form-section" style="border-color: var(--primary);">
                <div class="form-section-header">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Customer *</div>
                </div>
                <div class="form-section-content">
                    <div class="customer-combobox">
                        <input type="text" class="customer-combobox-input" id="preparationCustomerInput" 
                               placeholder="Type to search or add new customer..." autocomplete="off" required>
                        <div class="customer-dropdown" id="preparationCustomerDropdown"></div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                         Type a name to search existing customers or create a new one
                    </div>
                </div>
            </div>

            <!-- Quick Templates -->
            <div class="smart-suggestions">
                <div class="smart-suggestions-title">
                     Quick Templates
                </div>
                <div class="suggestion-pills">
                    <button type="button" class="suggestion-pill" onclick="applyPrepTemplate('discovery')">
                         Discovery Call
                    </button>
                    <button type="button" class="suggestion-pill" onclick="applyPrepTemplate('demo')">
                         Product Demo
                    </button>
                    <button type="button" class="suggestion-pill" onclick="applyPrepTemplate('quarterly')">
                         Quarterly Review
                    </button>
                    <button type="button" class="suggestion-pill" onclick="applyPrepTemplate('negotiation')">
                         Negotiation
                    </button>
                </div>
            </div>

            <!-- Meeting Goals -->
            <div class="form-section">
                <div class="form-section-header">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Meeting Goals</div>
                </div>
                <div class="form-section-content">
                    <textarea class="form-textarea" id="preparationGoals" required 
                              placeholder="What do you want to achieve?&#10;&#10;Examples:&#10; Understand their current workflow&#10; Identify key pain points&#10; Secure next steps"
                              style="min-height: 120px;"></textarea>
                </div>
            </div>

            <!-- Discussion Points -->
            <div class="form-section">
                <div class="form-section-header" onclick="toggleSection(this)">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Discussion Points</div>
                    <div class="form-section-toggle"></div>
                </div>
                <div class="form-section-content">
                    <textarea class="form-textarea" id="preparationDiscussionPoints" 
                              placeholder="Key topics to cover...&#10;&#10; Topic 1&#10; Topic 2&#10; Topic 3"
                              style="min-height: 100px;"></textarea>
                </div>
            </div>

            <!-- Background & Context -->
            <div class="form-section">
                <div class="form-section-header" onclick="toggleSection(this)">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Background & Context</div>
                    <div class="form-section-toggle"></div>
                </div>
                <div class="form-section-content">
                    <textarea class="form-textarea" id="preparationBackground" 
                              placeholder="Company background, previous interactions, relevant context..."
                              style="min-height: 100px;"></textarea>
                </div>
            </div>

            <!-- Materials Needed -->
            <div class="form-section">
                <div class="form-section-header" onclick="toggleSection(this)">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Materials & Resources</div>
                    <div class="form-section-toggle"></div>
                </div>
                <div class="form-section-content">
                    <textarea class="form-textarea" id="preparationMaterials" 
                              placeholder="Slides, demos, case studies, pricing docs..."
                              style="min-height: 80px;"></textarea>
                </div>
            </div>

            <!-- Expected Outcomes -->
            <div class="form-section">
                <div class="form-section-header" onclick="toggleSection(this)">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Expected Outcomes</div>
                    <div class="form-section-toggle"></div>
                </div>
                <div class="form-section-content">
                    <textarea class="form-textarea" id="preparationOutcomes" 
                              placeholder="What success looks like after this meeting..."
                              style="min-height: 80px;"></textarea>
                </div>
            </div>
        </div>

        <div class="tab-content" data-tab-content="export">
            <div class="export-content">
                <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem;"> Export Preparation</h4>
                <div class="export-preview" id="preparationExportPreview">Preview...</div>
                <div class="export-actions">
                    <button type="button" class="btn-export" id="copyPreparationBtn"> Copy</button>
                    <button type="button" class="btn-export" id="downloadPreparationBtn"> Download</button>
                </div>
            </div>
        </div>
    </form>
</div>

          <!-- Inline Meeting Form -->
<div class="inline-form-container" id="inlineMeetingForm">
    <form id="meetingForm">
        <input type="hidden" id="meetingId">
        
        <!-- Sticky Action Bar -->
        <div class="sticky-action-bar">
            <div class="sticky-action-bar-title">
                 Meeting Notes
            </div>
            <div class="sticky-action-bar-actions">
                <button type="button" class="btn btn-secondary btn-large" onclick="closeInlineMeetingForm()">
                     Cancel
                </button>
                <button type="submit" class="btn btn-primary btn-large">
                     Save Meeting
                </button>
            </div>
        </div>

        <div class="modal-tabs">
            <button type="button" class="modal-tab active" data-tab="info" data-form="meeting">
                 Info
            </button>
            <button type="button" class="modal-tab" data-tab="preparation" data-form="meeting" id="preparationTab" style="display: none;">
                 Prep
            </button>
            <button type="button" class="modal-tab" data-tab="notes" data-form="meeting">
                 Notes
            </button>
            <button type="button" class="modal-tab" data-tab="meddpicc" data-form="meeting">
                 MEDDPICC
            </button>
            <button type="button" class="modal-tab" data-tab="actions" data-form="meeting">
                 Actions
            </button>
            <button type="button" class="modal-tab" data-tab="export" data-form="meeting">
                 Export
            </button>
        </div>

        <!-- INFO TAB -->
        <div class="tab-content active" data-tab-content="info">
            <!-- Customer -->
            <div class="form-section" style="border-color: var(--primary);">
                <div class="form-section-header">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Customer *</div>
                </div>
                <div class="form-section-content">
                    <div class="customer-combobox">
                        <input type="text" class="customer-combobox-input" id="meetingCustomerInput" 
                               placeholder="Type to search or add new customer..." autocomplete="off" required>
                        <div class="customer-dropdown" id="customerDropdown"></div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                         Type a name to search existing customers or create a new one
                    </div>
                </div>
            </div>

            <!-- Meeting Details -->
            <div class="form-section">
                <div class="form-section-header">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Meeting Details</div>
                </div>
                <div class="form-section-content">
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-input" id="meetingTitle" placeholder="e.g., Q4 Business Review" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date & Time *</label>
                            <input type="datetime-local" class="form-input" id="meetingDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duration (min)</label>
                            <input type="number" class="form-input" id="meetingDuration" placeholder="60" min="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Meeting Type *</label>
                        <div class="meeting-type-pills">
                            <div class="meeting-type-pill" onclick="selectMeetingType('discovery')">
                                <span class="meeting-type-icon"></span>
                                <span>Discovery</span>
                            </div>
                            <div class="meeting-type-pill" onclick="selectMeetingType('demo')">
                                <span class="meeting-type-icon"></span>
                                <span>Demo</span>
                            </div>
                            <div class="meeting-type-pill" onclick="selectMeetingType('follow-up')">
                                <span class="meeting-type-icon"></span>
                                <span>Follow-up</span>
                            </div>
                            <div class="meeting-type-pill" onclick="selectMeetingType('quarterly')">
                                <span class="meeting-type-icon"></span>
                                <span>Quarterly</span>
                            </div>
                            <div class="meeting-type-pill" onclick="selectMeetingType('sales')">
                                <span class="meeting-type-icon"></span>
                                <span>Sales</span>
                            </div>
                            <div class="meeting-type-pill" onclick="selectMeetingType('other')">
                                <span class="meeting-type-icon"></span>
                                <span>Other</span>
                            </div>
                        </div>
                        <input type="hidden" id="meetingType" value="other">
                    </div>
                </div>
            </div>

            <!-- Participants -->
            <div class="form-section">
                <div class="form-section-header" onclick="toggleSection(this)">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Participants</div>
                    <div class="form-section-toggle"></div>
                </div>
                <div class="form-section-content">
                    <div class="form-row" style="margin-bottom: 0.75rem;">
                        <input type="text" class="form-input" id="participantNameInput" placeholder="Name *">
                        <input type="text" class="form-input" id="participantRoleInput" placeholder="Role">
                    </div>
                    <div class="form-row" style="margin-bottom: 0.75rem;">
                        <input type="email" class="form-input" id="participantEmailInput" placeholder="Email">
                        <input type="tel" class="form-input" id="participantPhoneInput" placeholder="Phone">
                    </div>
                    <button type="button" class="btn btn-primary" id="addParticipantBtn" style="width: 100%; margin-bottom: 1rem;">
                         Add Participant
                    </button>
                    <div class="participant-grid" id="participantsList"></div>
                </div>
            </div>

            <!-- Outcome & Follow-up -->
            <div class="form-section">
                <div class="form-section-header" onclick="toggleSection(this)">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Outcome & Follow-up</div>
                    <div class="form-section-toggle"></div>
                </div>
                <div class="form-section-content">
                    <div class="form-group">
                        <label class="form-label">Meeting Outcome</label>
                        <div class="outcome-selector">
                            <div class="outcome-option" onclick="selectOutcome('positive')">
                                <div class="outcome-icon"></div>
                                <div class="outcome-label">Positive</div>
                            </div>
                            <div class="outcome-option" onclick="selectOutcome('neutral')">
                                <div class="outcome-icon"></div>
                                <div class="outcome-label">Neutral</div>
                            </div>
                            <div class="outcome-option" onclick="selectOutcome('negative')">
                                <div class="outcome-icon"></div>
                                <div class="outcome-label">Negative</div>
                            </div>
                            <div class="outcome-option" onclick="selectOutcome('won')">
                                <div class="outcome-icon"></div>
                                <div class="outcome-label">Won</div>
                            </div>
                            <div class="outcome-option" onclick="selectOutcome('lost')">
                                <div class="outcome-icon"></div>
                                <div class="outcome-label">Lost</div>
                            </div>
                        </div>
                        <input type="hidden" id="meetingOutcome">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Follow-up Date</label>
                        <input type="date" class="form-input" id="meetingFollowUpDate">
                    </div>
                </div>
            </div>
        </div>

        <!-- PREPARATION TAB -->
        <div class="tab-content" data-tab-content="preparation">
            <div id="preparationContent" style="background: var(--bg-secondary); padding: 0.75rem; border-radius: 8px;">
                <p style="color: var(--text-secondary); text-align: center; font-size: 0.8rem;">No preparation</p>
            </div>
        </div>

        <!-- NOTES TAB -->
        <div class="tab-content" data-tab-content="notes">


            <div class="form-group">
                <label class="form-label">Meeting Notes *</label>
                <div class="enhanced-editor-wrapper">
                    <div class="enhanced-editor-toolbar">
                        <div class="toolbar-group">
                            <button type="button" class="rich-text-btn" data-command="bold" title="Bold">
                                <svg viewBox="0 0 24 24"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg>
                            </button>
                            <button type="button" class="rich-text-btn" data-command="italic" title="Italic">
                                <svg viewBox="0 0 24 24"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg>
                            </button>
                            <button type="button" class="rich-text-btn" data-command="underline" title="Underline">
                                <svg viewBox="0 0 24 24"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path><line x1="4" y1="21" x2="20" y2="21"></line></svg>
                            </button>
                        </div>
                        <div class="toolbar-group">
                            <button type="button" class="rich-text-btn" data-command="insertUnorderedList" title="Bullet List">
                                <svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                            </button>
                            <button type="button" class="rich-text-btn" data-command="insertOrderedList" title="Numbered List">
                                <svg viewBox="0 0 24 24"><line x1="10" y1="6" x2="21" y2="6"></line><line x1="10" y1="12" x2="21" y2="12"></line><line x1="10" y1="18" x2="21" y2="18"></line><path d="M4 6h1v4"></path><path d="M4 10h2"></path><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="rich-text-editor enhanced-editor-content" id="meetingNotesEditor" contenteditable="true" data-placeholder="Start typing your notes..."></div>
                </div>
                <div class="meddpicc-toolbar">
                    <div class="meddpicc-toolbar-label">
                         Select text and quick add to MEDDPICC:
                    </div>
                    <div class="meddpicc-toolbar-buttons">
                        <button type="button" class="meddpicc-quick-btn" data-field="metrics"><span></span><span>Metrics</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="economicBuyer"><span></span><span>Buyer</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="decisionCriteria"><span></span><span>Criteria</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="decisionProcess"><span></span><span>Process</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="paperProcess"><span></span><span>Paper</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="pain"><span></span><span>Pain</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="champion"><span></span><span>Champion</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="competition"><span></span><span>Comp</span></button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Next Steps</label>
                <div class="enhanced-editor-wrapper">
                    <div class="enhanced-editor-toolbar">
                        <div class="toolbar-group">
                            <button type="button" class="rich-text-btn" data-command="bold" data-target="nextSteps" title="Bold">
                                <svg viewBox="0 0 24 24"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg>
                            </button>
                            <button type="button" class="rich-text-btn" data-command="insertUnorderedList" data-target="nextSteps" title="Bullet List">
                                <svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div class="rich-text-editor enhanced-editor-content" id="meetingNextStepsEditor" contenteditable="true" data-placeholder="What are the next steps?"></div>
                </div>
                <div class="action-item-toolbar">
                    <div class="action-item-toolbar-label"> Select text and quick add action:</div>
                    <div class="action-item-toolbar-buttons">
                        <button type="button" class="action-item-quick-btn">
                            <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2;">
                                <line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            <span>Add Task</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Tags</label>
                <input type="text" class="form-input" id="meetingTags" placeholder="renewal, upsell, expansion">
            </div>
        </div>

        <!-- MEDDPICC TAB -->
        <div class="tab-content" data-tab-content="meddpicc">
            <!-- Visual Tracker -->
            <div class="meddpicc-visual-tracker" id="meddpiccVisualTracker">
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('Metrics')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Metrics</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('EconomicBuyer')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Buyer</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('DecisionCriteria')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Criteria</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('DecisionProcess')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Process</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('PaperProcess')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Paper</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('Pain')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Pain</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('Champion')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Champion</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('Competition')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Comp</div>
                </div>
            </div>

            <div class="meddpicc-form-grid">
                <div class="form-group">
                    <label class="form-label"> Metrics</label>
                    <textarea class="form-textarea" id="meddpiccMetrics" placeholder="ROI, cost savings, efficiency gains..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"> Economic Buyer</label>
                    <input type="text" class="form-input" id="meddpiccEconomicBuyer" placeholder="Name & Title">
                </div>
                <div class="form-group">
                    <label class="form-label"> Decision Criteria</label>
                    <textarea class="form-textarea" id="meddpiccDecisionCriteria" placeholder="Technical & business requirements..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"> Decision Process</label>
                    <textarea class="form-textarea" id="meddpiccDecisionProcess" placeholder="Steps, stakeholders, timeline..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"> Paper Process</label>
                    <textarea class="form-textarea" id="meddpiccPaperProcess" placeholder="Legal, procurement, approvals..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"> Pain</label>
                    <textarea class="form-textarea" id="meddpiccPain" placeholder="Problems they need to solve..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"> Champion</label>
                    <input type="text" class="form-input" id="meddpiccChampion" placeholder="Name & Title">
                </div>
                <div class="form-group">
                    <label class="form-label"> Competition</label>
                    <textarea class="form-textarea" id="meddpiccCompetition" placeholder="Other vendors, alternatives..."></textarea>
                </div>
            </div>
        </div>

        <!-- ACTIONS TAB -->
        <div class="tab-content" data-tab-content="actions">
            <div class="form-group">
                <label class="form-label">Action Items</label>
                <div style="display: flex; gap: 0.35rem; margin-bottom: 0.35rem;">
                    <input type="text" class="form-input" id="quickTaskInput" placeholder="Add task...">
                    <button type="button" class="btn btn-primary" id="addQuickTaskBtn"></button>
                </div>
                <div class="meeting-tasks-list" id="meetingTasksList"></div>
            </div>
        </div>

        <!-- EXPORT TAB -->
        <div class="tab-content" data-tab-content="export">
            <div class="export-content">
                <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem;"> Export Meeting Notes</h4>
                <div class="export-preview" id="meetingExportPreview">Preview...</div>
                <div class="export-actions">
                    <button type="button" class="btn-export" id="copyMeetingBtn"> Copy</button>
                    <button type="button" class="btn-export" id="downloadMeetingBtn"> Download</button>
                </div>
            </div>
        </div>
    </form>
</div>

            <div class="dashboard-stats-section" id="dashboardStatsSection">
                <div class="dashboard-stats-title">
                     Statistics
                </div>
                <div class="dashboard-stats-grid">
                    <div class="dashboard-stat-card">
                        <div class="dashboard-stat-icon"></div>
                        <div class="dashboard-stat-value" id="dashStatTotal">0</div>
                        <div class="dashboard-stat-label">Total Tasks</div>
                        <div class="dashboard-stat-sublabel">
                            <span id="dashStatActive">0</span> active  
                            <span id="dashStatCompleted">0</span> completed
                        </div>
                    </div>
                    <div class="dashboard-stat-card">
                        <div class="dashboard-stat-icon"></div>
                        <div class="dashboard-stat-value" id="dashStatMeetings">0</div>
                        <div class="dashboard-stat-label">Meetings</div>
                        <div class="dashboard-stat-sublabel" id="dashStatMeetingsSub">Across all customers</div>
                    </div>
                    <div class="dashboard-stat-card">
                        <div class="dashboard-stat-icon"></div>
                        <div class="dashboard-stat-value" id="dashStatCustomers">0</div>
                        <div class="dashboard-stat-label">Customers</div>
                        <div class="dashboard-stat-sublabel" id="dashStatCustomersSub">With activity</div>
                    </div>
                    <div class="dashboard-stat-card">
                        <div class="dashboard-stat-icon"></div>
                        <div class="dashboard-stat-value" id="dashStatPreparations">0</div>
                        <div class="dashboard-stat-label">Preparations</div>
                        <div class="dashboard-stat-sublabel">Ready for meetings</div>
                    </div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <div class="dashboard-stats-title">
                         Meeting Types
                    </div>
                    <div class="dashboard-meetings-breakdown" id="dashboardMeetingsBreakdown"></div>
                </div>
            </div>
            
            <div class="customer-overview-section" id="customerOverviewSection">
                <div class="section-header">
                    <h2 class="section-title">Overview</h2>
                </div>
                <div class="customer-overview-grid" id="customerOverviewGrid"></div>
                <div class="empty-state" id="customerOverviewEmpty" style="display: none;">
                    <div class="empty-state-icon"></div>
                    <div>No activity yet</div>
                </div>
            </div>

<!-- Customer Participants Section -->
<div class="customer-participants-section" id="customerParticipantsSection">
    <div class="customer-section-header">
        <h3 class="customer-section-title"> People You've Met</h3>
    </div>
    <div class="participants-overview-grid" id="customerParticipantsGrid"></div>
    <div class="empty-state-compact" id="customerParticipantsEmpty" style="display: none;">
        <div class="empty-state-compact-icon"></div>
        <div>No participants recorded yet</div>
    </div>
</div>

            <div class="customer-preparations-section" id="customerPreparationsSection">
                <div class="customer-section-header">
                    <h3 class="customer-section-title"> Preparations</h3>
                </div>
                <div id="customerPreparationsList"></div>
                <div class="empty-state" id="customerPreparationsEmpty" style="display: none;"></div>
            </div>

            <div class="customer-meetings-section" id="customerMeetingsSection">
                <div class="customer-section-header">
                    <h3 class="customer-section-title"> Meetings</h3>
                </div>
                <div id="customerMeetingsList"></div>
                <div class="empty-state" id="customerMeetingsEmpty" style="display: none;"></div>
            </div>

            <div class="tasks-section">
                <div class="section-header">
                    <h2 class="section-title" id="mainSectionTitle">Tasks</h2>
                    <div class="view-toggle">
                        <button class="view-btn" data-view="list"></button>
                        <button class="view-btn" data-view="kanban"></button>
                        <button class="view-btn active" data-view="active">Active</button>
                        <button class="view-btn" data-view="archived">Archive</button>
                    </div>
                </div>

                <div class="task-filters" id="taskFilters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="today">Today</button>
                    <button class="filter-btn" data-filter="week">Week</button>
                    <button class="filter-btn" data-filter="overdue">Overdue</button>
                    <button class="filter-btn" data-filter="high">High</button>
                </div>

                <div class="tasks-list" id="tasksList"></div>

                <div class="kanban-board" id="kanbanBoard">
                    <div class="kanban-column">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title"> To Do</div>
                            <div class="kanban-column-count" id="todoCount">0</div>
                        </div>
                        <div class="kanban-cards" id="todoColumn" data-status="todo"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title"> Progress</div>
                            <div class="kanban-column-count" id="progressCount">0</div>
                        </div>
                        <div class="kanban-cards" id="progressColumn" data-status="in-progress"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title"> Done</div>
                            <div class="kanban-column-count" id="doneCount">0</div>
                        </div>
                        <div class="kanban-cards" id="doneColumn" data-status="done"></div>
                    </div>
                </div>

                <div class="empty-state" id="tasksEmpty" style="display: none;">
                    <div class="empty-state-icon"></div>
                    <div>No tasks</div>
                </div>
            </div>
        </div>

<div class="notes-container" id="notesContainer">
    <div class="section-header">
        <h2 class="section-title">Notes</h2>
        <button class="btn-icon btn-add-note" onclick="openNoteModal()" title="Add Note">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
    </div>
    <div class="notes-list" id="notesList"></div>
    <div class="empty-state" id="notesEmpty" style="display: none;">
        <div class="empty-state-icon"></div>
        <div>No notes</div>
    </div>
</div>
    </div>

    <!-- Tags Modal -->
    <div class="modal" id="tagsOverviewModal">
        <div class="modal-content xlarge">
            <div class="modal-header">
                <h3 class="modal-title"> Tags</h3>
                <button class="close-btn" id="closeTagsOverviewBtn"></button>
            </div>
            <div class="tags-overview-content">
                <div class="tags-list-section">
                    <h4 style="margin-bottom: 0.5rem; font-size: 0.85rem;">All Tags</h4>
                    <div id="tagsListContainer"></div>
                    <div class="empty-state" id="tagsEmpty" style="display: none; padding: 1rem 0;">
                        <div class="empty-state-icon"></div>
                        <div>No tags</div>
                    </div>
                </div>
                <div class="customers-by-tag-section">
                    <h4 style="margin-bottom: 0.5rem; font-size: 0.85rem;" id="selectedTagTitle">Select a tag</h4>
                    <div id="customersByTagContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customers Modal -->
    <div class="modal" id="customersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Customers</h3>
                <button class="close-btn" id="closeCustomersModalBtn"></button>
            </div>
            <button class="btn btn-primary" id="openAddCustomerBtn" style="margin-bottom: 0.75rem; width: 100%;">+ Add Customer</button>
            <div class="customer-list" id="customerList"></div>
            <div class="empty-state" id="customersEmpty" style="display: none;">
                <div class="empty-state-icon"></div>
                <div>No customers</div>
            </div>
        </div>
    </div>

<!-- Customer Form Modal -->
<div class="modal" id="customerFormModal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 class="modal-title" id="customerFormTitle">Customer Profile</h3>
            <button class="close-btn" id="closeCustomerFormBtn"></button>
        </div>
        <form id="customerForm">
            <input type="hidden" id="customerId">
            
            <!-- Basic Information -->
            <div class="customer-profile-section" style="margin-bottom: 1rem;">
                <div class="customer-profile-section-title">
                     Company Information
                </div>
                <div class="form-group">
                    <label class="form-label">Company Name *</label>
                    <input type="text" class="form-input" id="customerName" required>
                </div>
            </div>

            <!-- All Info in One Row -->
            <div class="customer-profile-section" style="margin-bottom: 1rem;">
                <div class="customer-profile-section-title">
                     Details
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="customerEmail">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="customerPhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-input" id="customerWebsite" placeholder="https://">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <input type="text" class="form-input" id="customerIndustry" placeholder="e.g., Technology">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company Size</label>
                        <select class="form-select" id="customerSize">
                            <option value="">Select...</option>
                            <option value="1-10">1-10</option>
                            <option value="11-50">11-50</option>
                            <option value="51-200">51-200</option>
                            <option value="201-500">201-500</option>
                            <option value="501-1000">501-1000</option>
                            <option value="1000+">1000+</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">LinkedIn</label>
                        <input type="url" class="form-input" id="customerLinkedIn" placeholder="https://linkedin.com/company/...">
                    </div>
                </div>
            </div>

            <!-- Address Information -->
            <div class="customer-profile-section" style="margin-bottom: 1rem;">
                <div class="customer-profile-section-title">
                     Address
                </div>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div class="form-group">
                        <label class="form-label">Street Address</label>
                        <input type="text" class="form-input" id="customerAddress">
                    </div>
                    <div class="form-group">
                        <label class="form-label">City</label>
                        <input type="text" class="form-input" id="customerCity">
                    </div>
                    <div class="form-group">
                        <label class="form-label">State</label>
                        <input type="text" class="form-input" id="customerState">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 0.75rem;">
                    <div class="form-group">
                        <label class="form-label">Zip Code</label>
                        <input type="text" class="form-input" id="customerZip">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <input type="text" class="form-input" id="customerCountry">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Google Maps Link</label>
                        <input type="url" class="form-input" id="customerMapsLink" placeholder="https://maps.google.com/...">
                    </div>
                </div>
            </div>

            <div class="form-footer">
                <button type="button" class="btn btn-secondary" id="cancelCustomerFormBtn">Cancel</button>
                <button type="submit" class="btn btn-primary"> Save Customer</button>
            </div>
        </form>
    </div>
</div>
   

    <!-- All Meetings Modal -->
    <div class="modal" id="allMeetingsModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title">All Meetings</h3>
                <button class="close-btn" id="closeAllMeetingsBtn"></button>
            </div>
            <div id="allMeetingsList"></div>
            <div class="empty-state" id="meetingsEmpty" style="display: none;">
                <div class="empty-state-icon"></div>
                <div>No meetings</div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Task</h3>
                <button class="close-btn" id="closeTaskModalBtn"></button>
            </div>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <input type="hidden" id="taskMeetingId">
                
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-input" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="taskDescription"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Customer</label>
                    <div class="customer-combobox">
                        <input type="text" class="customer-combobox-input" id="taskCustomerInput" placeholder="Customer..." autocomplete="off">
                        <div class="customer-dropdown" id="taskCustomerDropdown"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="taskPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="taskStatus">
                            <option value="todo">To Do</option>
                            <option value="in-progress">In Progress</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="taskDueDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Color</label>
                    <div class="color-picker">
                        <div class="color-option" data-color="none" style="background: var(--bg-tertiary)"></div>
                        <div class="color-option" data-color="red" style="background: #ef4444"></div>
                        <div class="color-option" data-color="orange" style="background: #f97316"></div>
                        <div class="color-option" data-color="yellow" style="background: #eab308"></div>
                        <div class="color-option" data-color="green" style="background: #10b981"></div>
                        <div class="color-option" data-color="blue" style="background: #3b82f6"></div>
                        <div class="color-option" data-color="purple" style="background: #8b5cf6"></div>
                        <div class="color-option" data-color="pink" style="background: #ec4899"></div>
                    </div>
                    <input type="hidden" id="taskColor" value="none">
                </div>
                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <input type="text" class="form-input" id="taskTags" placeholder="tag1, tag2">
                </div>
                <div class="form-group">
                    <label class="form-label">Subtasks</label>
                    <div class="subtasks-form" id="subtasksForm"></div>
                    <button type="button" class="btn-add-subtask" id="addSubtaskBtn">+ Add</button>
                </div>
                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" id="cancelTaskBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

<!-- Add Participant Modal -->
<div class="modal" id="addParticipantModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New Person</h3>
            <button class="close-btn" id="closeAddParticipantBtn"></button>
        </div>
        <form id="addParticipantForm">
            <input type="hidden" id="addParticipantCustomerId">
            
            <div class="form-group">
                <label class="form-label">Name *</label>
                <input type="text" class="form-input" id="addParticipantName" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Role</label>
                <input type="text" class="form-input" id="addParticipantRole" placeholder="e.g., VP of Sales">
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="addParticipantEmail" placeholder="name@company.com">
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-input" id="addParticipantPhone" placeholder="+1 (555) 123-4567">
            </div>
            
            <div class="form-group">
                <label class="form-label">Add to Meeting (Optional)</label>
                <select class="form-select" id="addParticipantMeetingId">
                    <option value="">Don't add to a specific meeting</option>
                </select>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.35rem;">
                     If no meeting is selected, this person will be available for future meetings
                </div>
            </div>
            
            <div class="form-footer">
                <button type="button" class="btn btn-secondary" id="cancelAddParticipantBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">+ Add Person</button>
            </div>
        </form>
    </div>
</div>

<!-- Participant Edit Modal -->
<div class="modal" id="participantEditModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Participant</h3>
            <button class="close-btn" id="closeParticipantEditBtn"></button>
        </div>
        <form id="participantEditForm">
            <input type="hidden" id="editParticipantCustomerId">
            <input type="hidden" id="editParticipantOriginalEmail">
            
            <div class="form-group">
                <label class="form-label">Name *</label>
                <input type="text" class="form-input" id="editParticipantName" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Role</label>
                <input type="text" class="form-input" id="editParticipantRole">
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="editParticipantEmail">
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-input" id="editParticipantPhone">
            </div>
            
            <div class="form-footer">
                <button type="button" class="btn btn-secondary" id="cancelParticipantEditBtn">Cancel</button>
                <button type="submit" class="btn btn-primary"> Save Changes</button>
            </div>
        </form>
    </div>
</div>

    <!-- Note Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Note</h3>
                <button class="close-btn" id="closeNoteModalBtn"></button>
            </div>
            <form id="noteForm">
                <input type="hidden" id="noteId">
                <div class="form-group">
                    <label class="form-label">Content *</label>
                    <textarea class="form-textarea" id="noteContent" required style="min-height: 120px;"></textarea>
                </div>
                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" id="cancelNoteBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="exportModalTitle">Export</h3>
                <button class="close-btn" id="closeExportModalBtn"></button>
            </div>
            <div class="export-content">
                <div class="export-preview" id="exportModalPreview"></div>
                <div class="export-actions">
                    <button type="button" class="btn-export" id="copyExportModalBtn"> Copy</button>
                    <button type="button" class="btn-export" id="downloadExportModalBtn"> Download</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-icon" id="confirmIcon"></div>
            <h3 class="confirm-title" id="confirmTitle">Confirm</h3>
            <p class="confirm-message" id="confirmMessage">Are you sure?</p>
            <div class="confirm-actions">
                <button class="btn btn-secondary" id="cancelConfirmBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
    // ========================================
    // FIREBASE CONFIGURATION
    // ========================================
    
    // REPLACE THIS with your actual Firebase config from Step 7
const firebaseConfig = {

  apiKey: "AIzaSyD0sFHiPsOfDJFLB3Ak-Tn-xeWvTsdzPKg",

  authDomain: "salesflow-b96a8.firebaseapp.com",

  projectId: "salesflow-b96a8",

  storageBucket: "salesflow-b96a8.firebasestorage.app",

  messagingSenderId: "684901199328",

  appId: "1:684901199328:web:313da7d811a754f7378f85",

  measurementId: "G-NRLQ2RVVYB"

};


    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ========================================
    // APPLICATION STATE
    // ========================================
    
    const state = {
        tasks: [],
        notes: [],
        customers: [],
        meetings: [],
        preparations: [],
        currentCategory: 'all',
        currentCustomer: 'all',
        currentFilter: 'all',
        currentView: 'active',
        currentDisplayMode: 'list',
        searchQuery: '',
        editingTask: null,
        editingNote: null,
        editingCustomer: null,
        editingMeeting: null,
        editingPreparation: null,
        selectedColor: 'none',
        confirmCallback: null,
        meetingTasks: [],
        meetingParticipants: [],
        selectedCustomerId: null,
        selectedTaskCustomerId: null,
        selectedPreparationCustomerId: null,
        selectedTag: null,
        currentMeetingTab: 'info',
        currentPreparationTab: 'info',
        currentUser: null  // ADD THIS LINE
    };


function renameCustomerFromSidebar(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    const newName = prompt('Rename customer:', customer.name);
    if (!newName || newName.trim() === '') return;
    if (newName.trim() === customer.name) return;
    
    const trimmedName = newName.trim();
    
    // Check if name already exists
    if (state.customers.some(c => c.id !== customerId && c.name.toLowerCase() === trimmedName.toLowerCase())) {
        showToast('Name already exists', 'error');
        return;
    }
    
    // Update customer
    customer.name = trimmedName;
    
    // Update all references
    state.tasks.forEach(task => {
        if (task.customerId === customerId) {
            task.customerName = trimmedName;
        }
    });
    
    state.meetings.forEach(meeting => {
        if (meeting.customerId === customerId) {
            meeting.customerName = trimmedName;
        }
    });
    
    state.preparations.forEach(prep => {
        if (prep.customerId === customerId) {
            prep.customerName = trimmedName;
        }
    });
    
    saveData();
    renderCustomerFilters();
    renderCustomerList();
    
    // Update header if viewing this customer
    if (state.currentCustomer === customerId) {
        document.getElementById('customerHeaderName').textContent = trimmedName;
    }
    
    // Update overview if visible
    if (document.getElementById('customerOverviewSection').classList.contains('active')) {
        renderCustomerOverview();
    }
    
    showToast('Renamed!', 'success');
}

function deleteCustomerFromSidebar(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    const hasData = state.tasks.some(t => t.customerId === customerId) ||
                    state.meetings.some(m => m.customerId === customerId) ||
                    state.preparations.some(p => p.customerId === customerId);
    
    const message = hasData 
        ? `Delete "${customer.name}"? This will remove all associated tasks, meetings, and preparations.`
        : `Delete "${customer.name}"?`;
    
    showConfirm('', 'Delete Customer?', message, () => {
        // Remove customer
        state.customers = state.customers.filter(c => c.id !== customerId);
        
        // Remove customer reference from tasks
        state.tasks.forEach(task => {
            if (task.customerId === customerId) {
                task.customerId = null;
                task.customerName = '';
            }
        });
        
        // Remove meetings
        state.meetings = state.meetings.filter(m => m.customerId !== customerId);
        
        // Remove preparations
        state.preparations = state.preparations.filter(p => p.customerId !== customerId);
        
        saveData();
        renderCustomerFilters();
        renderCustomerList();
        
        // If currently viewing this customer, go back to dashboard
        if (state.currentCustomer === customerId) {
            showDashboard();
        }
        
        // Update overview if visible
        if (document.getElementById('customerOverviewSection').classList.contains('active')) {
            renderCustomerOverview();
        }
        
        showToast('Deleted', 'success');
    });
}

function renameCustomerFromHeader() {
    if (state.currentCustomer === 'all') return;
    renameCustomerFromSidebar(state.currentCustomer);
}

function deleteCustomerFromHeader() {
    if (state.currentCustomer === 'all') return;
    deleteCustomerFromSidebar(state.currentCustomer);
}

function deletePreparation(preparationId) {
    const preparation = state.preparations.find(p => p.id === preparationId);
    if (!preparation) return;
    
    showConfirm('', 'Delete Preparation?', `Delete this preparation for ${preparation.customerName}?`, () => {
        state.preparations = state.preparations.filter(p => p.id !== preparationId);
        saveData();
        
        // Update customer preparations section if visible
        if (state.currentCustomer !== 'all') {
            showCustomerPreparationsSection(state.currentCustomer);
        }
        
        // Update overview if visible
        if (document.getElementById('customerOverviewSection').classList.contains('active')) {
            renderCustomerOverview();
        }
        
        updateStats();
        showToast('Deleted', 'success');
    });
}

function deleteMeetingFromCustomer(meetingId) {
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (!meeting) return;
    
    const hasTasks = state.tasks.some(t => t.meetingId === meetingId);
    const message = hasTasks 
        ? `Delete this meeting? Associated tasks will remain but lose their meeting link.`
        : `Delete this meeting?`;
    
    showConfirm('', 'Delete Meeting?', message, () => {
        state.meetings = state.meetings.filter(m => m.id !== meetingId);
        
        // Remove meeting reference from tasks
        state.tasks.forEach(task => {
            if (task.meetingId === meetingId) {
                delete task.meetingId;
            }
        });
        
        saveData();
        
        // Update customer meetings section if visible
        if (state.currentCustomer !== 'all') {
            showCustomerMeetingsSection(state.currentCustomer);
        }
        
        // Update overview if visible
        if (document.getElementById('customerOverviewSection').classList.contains('active')) {
            renderCustomerOverview();
        }
        
        updateStats();
        showToast('Deleted', 'success');
    });
}

function editCustomerFromBanner() {
    if (state.currentCustomer === 'all') return;
    openEditCustomerForm(state.currentCustomer);
}

function updateCustomerBanner(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    const banner = document.getElementById('customerHeaderBanner');
    const nameEl = document.getElementById('customerHeaderName');
    const companyEl = document.getElementById('customerHeaderCompany');
    const detailsEl = document.getElementById('customerBannerDetails');
    
    nameEl.textContent = customer.name;
    companyEl.style.display = 'none';
    
    // Build details horizontally
    let detailsHTML = '';
    
    if (customer.email) {
        detailsHTML += `
            <div class="customer-banner-detail">
                <div class="customer-banner-detail-icon"></div>
                <div class="customer-banner-detail-content">
                    <div class="customer-banner-detail-value"><a href="mailto:${escapeHtml(customer.email)}">${escapeHtml(customer.email)}</a></div>
                </div>
            </div>
        `;
    }
    
    if (customer.phone) {
        detailsHTML += `
            <div class="customer-banner-detail">
                <div class="customer-banner-detail-icon"></div>
                <div class="customer-banner-detail-content">
                    <div class="customer-banner-detail-value"><a href="tel:${escapeHtml(customer.phone)}">${escapeHtml(customer.phone)}</a></div>
                </div>
            </div>
        `;
    }
    
    if (customer.address || customer.city) {
        let addressText = '';
        if (customer.address) addressText += customer.address;
        if (customer.city) {
            if (addressText) addressText += ', ';
            addressText += customer.city;
        }
        if (customer.state) addressText += ', ' + customer.state;
        if (customer.zip) addressText += ' ' + customer.zip;
        
        detailsHTML += `
            <div class="customer-banner-detail">
                <div class="customer-banner-detail-icon"></div>
                <div class="customer-banner-detail-content">
                    <div class="customer-banner-detail-value">
                        ${customer.mapsLink ? `<a href="${escapeHtml(customer.mapsLink)}" target="_blank">${escapeHtml(addressText)}</a>` : escapeHtml(addressText)}
                    </div>
                </div>
            </div>
        `;
    }
    
    if (customer.website) {
        detailsHTML += `
            <div class="customer-banner-detail">
                <div class="customer-banner-detail-icon"></div>
                <div class="customer-banner-detail-content">
                    <div class="customer-banner-detail-value"><a href="${escapeHtml(customer.website)}" target="_blank">Website</a></div>
                </div>
            </div>
        `;
    }
    
    if (customer.industry) {
        detailsHTML += `
            <div class="customer-banner-detail">
                <div class="customer-banner-detail-icon"></div>
                <div class="customer-banner-detail-content">
                    <div class="customer-banner-detail-value">${escapeHtml(customer.industry)}</div>
                </div>
            </div>
        `;
    }
    
    if (customer.size) {
        detailsHTML += `
            <div class="customer-banner-detail">
                <div class="customer-banner-detail-icon"></div>
                <div class="customer-banner-detail-content">
                    <div class="customer-banner-detail-value">${escapeHtml(customer.size)}</div>
                </div>
            </div>
        `;
    }
    
    if (customer.linkedIn) {
        detailsHTML += `
            <div class="customer-banner-detail">
                <div class="customer-banner-detail-icon"></div>
                <div class="customer-banner-detail-content">
                    <div class="customer-banner-detail-value"><a href="${escapeHtml(customer.linkedIn)}" target="_blank">LinkedIn</a></div>
                </div>
            </div>
        `;
    }
    
    detailsEl.innerHTML = detailsHTML;
}

function getParticipantKey(participant) {
    // Create a consistent unique key for each participant
    if (participant.email && participant.email.trim()) {
        return participant.email.toLowerCase().trim();
    }
    return participant.name.toLowerCase().trim();
}

function openAddParticipantModal(customerId) {
    const modal = document.getElementById('addParticipantModal');
    const form = document.getElementById('addParticipantForm');
    const meetingSelect = document.getElementById('addParticipantMeetingId');
    
    // Reset form
    form.reset();
    document.getElementById('addParticipantCustomerId').value = customerId;
    
    // Populate meeting dropdown with meetings for this customer
    const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
    meetingSelect.innerHTML = '<option value="">Don\'t add to a specific meeting</option>';
    
    if (customerMeetings.length > 0) {
        customerMeetings.forEach(meeting => {
            const option = document.createElement('option');
            option.value = meeting.id;
            option.textContent = `${meeting.title} - ${new Date(meeting.date).toLocaleDateString()}`;
            meetingSelect.appendChild(option);
        });
    }
    
    // Set up event listeners
    const closeBtn = document.getElementById('closeAddParticipantBtn');
    const cancelBtn = document.getElementById('cancelAddParticipantBtn');
    
    // Remove old listeners by cloning
    const newCloseBtn = closeBtn.cloneNode(true);
    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
    
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // Add fresh listeners
    document.getElementById('closeAddParticipantBtn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeAddParticipantModal();
    });
    
    document.getElementById('cancelAddParticipantBtn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeAddParticipantModal();
    });
    
    document.getElementById('addParticipantForm').addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        handleAddParticipantSubmit(e);
    });
    
    // Show modal
    modal.classList.add('active');
}

function closeAddParticipantModal() {
    const modal = document.getElementById('addParticipantModal');
    if (modal) {
        modal.classList.remove('active');
        document.getElementById('addParticipantForm').reset();
    }
}

function handleAddParticipantSubmit(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    const customerId = document.getElementById('addParticipantCustomerId').value;
    const name = document.getElementById('addParticipantName').value.trim();
    const role = document.getElementById('addParticipantRole').value.trim();
    const email = document.getElementById('addParticipantEmail').value.trim();
    const phone = document.getElementById('addParticipantPhone').value.trim();
    const meetingId = document.getElementById('addParticipantMeetingId').value;
    
    if (!name) {
        showToast(' Name is required', 'error');
        return false;
    }
    
    const newParticipant = {
        name: name,
        role: role,
        email: email,
        phone: phone
    };
    
    // Check if we should add to a specific meeting
    if (meetingId) {
        const meeting = state.meetings.find(m => m.id === meetingId);
        if (meeting) {
            if (!meeting.participants) {
                meeting.participants = [];
            }
            
            // Check if participant already exists in this meeting
            const key = email && email.trim() 
                ? email.toLowerCase().trim() 
                : name.toLowerCase().trim();
            
            const exists = meeting.participants.some(p => {
                const pKey = p.email && p.email.trim() 
                    ? p.email.toLowerCase().trim() 
                    : p.name.toLowerCase().trim();
                return pKey === key;
            });
            
            if (exists) {
                showToast(' This person is already in that meeting', 'error');
                return false;
            }
            
            meeting.participants.push(newParticipant);
            saveData();
            closeAddParticipantModal();
            showCustomerParticipantsSection(customerId);
            showToast(` ${name} added to meeting!`, 'success');
        }
    } else {
        // Add to all meetings for this customer
        const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
        
        if (customerMeetings.length === 0) {
            showToast(' No meetings found for this customer. Add them to a meeting first.', 'error');
            return false;
        }
        
        let addedCount = 0;
        const key = email && email.trim() 
            ? email.toLowerCase().trim() 
            : name.toLowerCase().trim();
        
        customerMeetings.forEach(meeting => {
            if (!meeting.participants) {
                meeting.participants = [];
            }
            
            // Check if participant already exists in this meeting
            const exists = meeting.participants.some(p => {
                const pKey = p.email && p.email.trim() 
                    ? p.email.toLowerCase().trim() 
                    : p.name.toLowerCase().trim();
                return pKey === key;
            });
            
            if (!exists) {
                meeting.participants.push({ ...newParticipant });
                addedCount++;
            }
        });
        
        if (addedCount > 0) {
            saveData();
            closeAddParticipantModal();
            showCustomerParticipantsSection(customerId);
            showToast(` ${name} added to ${addedCount} meeting(s)!`, 'success');
        } else {
            showToast(' This person already exists in all meetings', 'error');
        }
    }
    
    return false;
}

function editParticipantFromOverview(participantKey, customerId) {
    // Find all meetings for this customer
    const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
    
    // Find the participant using consistent key matching
    let participant = null;
    for (let meeting of customerMeetings) {
        if (meeting.participants) {
            participant = meeting.participants.find(p => {
                const key = p.email && p.email.trim() 
                    ? p.email.toLowerCase().trim() 
                    : p.name.toLowerCase().trim();
                return key === participantKey;
            });
            if (participant) break;
        }
    }
    
    if (!participant) {
        showToast(' Participant not found', 'error');
        return;
    }
    
    // Populate form
    document.getElementById('editParticipantCustomerId').value = customerId;
    document.getElementById('editParticipantOriginalEmail').value = participantKey;
    document.getElementById('editParticipantName').value = participant.name;
    document.getElementById('editParticipantRole').value = participant.role || '';
    document.getElementById('editParticipantEmail').value = participant.email || '';
    document.getElementById('editParticipantPhone').value = participant.phone || '';
    
    // Set up event listeners for this modal instance
    const modal = document.getElementById('participantEditModal');
    const closeBtn = document.getElementById('closeParticipantEditBtn');
    const cancelBtn = document.getElementById('cancelParticipantEditBtn');
    const form = document.getElementById('participantEditForm');
    
    // Remove old listeners by cloning
    const newCloseBtn = closeBtn.cloneNode(true);
    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
    
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // Add fresh listeners
    document.getElementById('closeParticipantEditBtn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeParticipantEditModal();
    });
    
    document.getElementById('cancelParticipantEditBtn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeParticipantEditModal();
    });
    
    document.getElementById('participantEditForm').addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        handleParticipantEditSubmit(e);
    });
    
    // Show modal
    modal.classList.add('active');
}


function closeParticipantEditModal() {
    const modal = document.getElementById('participantEditModal');
    if (modal) {
        modal.classList.remove('active');
        // Reset form
        document.getElementById('participantEditForm').reset();
    }
}

function handleParticipantEditSubmit(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    const customerId = document.getElementById('editParticipantCustomerId').value;
    const originalKey = document.getElementById('editParticipantOriginalEmail').value;
    const newName = document.getElementById('editParticipantName').value.trim();
    const newRole = document.getElementById('editParticipantRole').value.trim();
    const newEmail = document.getElementById('editParticipantEmail').value.trim();
    const newPhone = document.getElementById('editParticipantPhone').value.trim();
    
    if (!newName) {
        showToast(' Name is required', 'error');
        return false;
    }
    
    // Update participant in all meetings for this customer
    let updated = 0;
    state.meetings.forEach(meeting => {
        if (meeting.customerId === customerId && meeting.participants) {
            meeting.participants.forEach(participant => {
                const key = participant.email && participant.email.trim() 
    ? participant.email.toLowerCase().trim() 
    : participant.name.toLowerCase().trim();
                if (key === originalKey) {
                    participant.name = newName;
                    participant.role = newRole;
                    participant.email = newEmail;
                    participant.phone = newPhone;
                    updated++;
                }
            });
        }
    });
    
    if (updated > 0) {
        saveData();
        closeParticipantEditModal();
        showCustomerParticipantsSection(customerId);
        showToast(' Participant updated in ' + updated + ' meeting(s)!', 'success');
    } else {
        showToast(' No meetings found to update', 'error');
    }
    
    return false;
}


function deleteParticipantFromOverview(participantKey, customerId) {
    // Find how many meetings have this participant
    const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
    let meetingCount = 0;
    
    customerMeetings.forEach(meeting => {
        if (meeting.participants) {
            const hasParticipant = meeting.participants.some(p => {
                const key = p.email || p.name.toLowerCase();
                return key === participantKey;
            });
            if (hasParticipant) meetingCount++;
        }
    });
    
    const message = meetingCount > 1 
        ? `Remove this participant from ${meetingCount} meetings?`
        : 'Remove this participant?';
    
    showConfirm('', 'Delete Participant?', message, () => {
        // Remove participant from all meetings
        state.meetings.forEach(meeting => {
            if (meeting.customerId === customerId && meeting.participants) {
                meeting.participants = meeting.participants.filter(p => {
                    const key = p.email || p.name.toLowerCase();
                    return key !== participantKey;
                });
            }
        });
        
        saveData();
        showCustomerParticipantsSection(customerId);
        showToast(' Participant deleted!', 'success');
    });
}

        function init() {
    loadData(); // Load theme only
    setupEventListeners();
    setupColorPicker();
    setupCustomerCombobox();
    setupTaskCustomerCombobox();
    setupPreparationCustomerCombobox();
    setupInlineTabs();
    setupRichTextEditor();
    setupMEDDPICCQuickAdd();
    setupActionItemQuickAdd();
    setupAuthListeners();  // ADD THIS LINE
    initAuth();            // ADD THIS LINE
    
    showHome();
}

        function setupEventListeners() {
            document.getElementById('homeBtn').addEventListener('click', () => showDashboard());
            document.getElementById('showAllTasksBtn').addEventListener('click', () => showAllTasks());
            document.getElementById('newPreparationBtn').addEventListener('click', () => openInlinePreparationForm());
            document.getElementById('newMeetingBtn').addEventListener('click', () => openInlineMeetingForm());
            document.getElementById('newTaskBtn').addEventListener('click', () => openTaskModal());
            document.getElementById('newNoteBtn').addEventListener('click', () => openNoteModal());
            document.getElementById('manageCustomersBtn').addEventListener('click', () => openCustomersModal());
            document.getElementById('viewMeetingsBtn').addEventListener('click', () => openAllMeetingsModal());
            document.getElementById('tagsOverviewBtn').addEventListener('click', () => openTagsOverviewModal());
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('archiveBtn').addEventListener('click', () => showArchived());
            document.getElementById('clearAllBtn').addEventListener('click', () => showConfirm('', 'Clear All?', 'Delete everything?', confirmClearAll));
            
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
            document.getElementById('noteForm').addEventListener('submit', handleNoteSubmit);
            document.getElementById('customerForm').addEventListener('submit', handleCustomerSubmit);
            document.getElementById('meetingForm').addEventListener('submit', handleMeetingSubmit);
            document.getElementById('preparationForm').addEventListener('submit', handlePreparationSubmit);
            
            document.getElementById('searchInput').addEventListener('input', handleSearch);

            document.getElementById('closeCustomersModalBtn').addEventListener('click', closeCustomersModal);
            document.getElementById('closeCustomerFormBtn').addEventListener('click', closeCustomerFormModal);
            document.getElementById('closeAllMeetingsBtn').addEventListener('click', closeAllMeetingsModal);
            document.getElementById('closeTaskModalBtn').addEventListener('click', closeTaskModal);
            document.getElementById('closeNoteModalBtn').addEventListener('click', closeNoteModal);
            document.getElementById('closeTagsOverviewBtn').addEventListener('click', closeTagsOverviewModal);
            document.getElementById('closeExportModalBtn').addEventListener('click', closeExportModal);

            document.getElementById('cancelCustomerFormBtn').addEventListener('click', closeCustomerFormModal);
            document.getElementById('cancelTaskBtn').addEventListener('click', closeTaskModal);
            document.getElementById('cancelNoteBtn').addEventListener('click', closeNoteModal);
            document.getElementById('cancelConfirmBtn').addEventListener('click', closeConfirmModal);

            document.getElementById('copyPreparationBtn').addEventListener('click', copyPreparationToClipboard);
            document.getElementById('downloadPreparationBtn').addEventListener('click', downloadPreparation);
            document.getElementById('copyMeetingBtn').addEventListener('click', copyMeetingToClipboard);
            document.getElementById('downloadMeetingBtn').addEventListener('click', downloadMeeting);
            document.getElementById('copyExportModalBtn').addEventListener('click', copyFromExportModal);
            document.getElementById('downloadExportModalBtn').addEventListener('click', downloadFromExportModal);

            document.getElementById('openAddCustomerBtn').addEventListener('click', openAddCustomerForm);
            document.getElementById('addQuickTaskBtn').addEventListener('click', addQuickTask);
            document.getElementById('addParticipantBtn').addEventListener('click', addParticipant);
            document.getElementById('addSubtaskBtn').addEventListener('click', () => addSubtaskInput());


            document.getElementById('quickTaskInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addQuickTask();
                }
            });

            document.getElementById('participantRoleInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addParticipant();
                }
            });

document.getElementById('participantEmailInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addParticipant();
    }
});

document.getElementById('participantPhoneInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addParticipant();
    }
});

            document.querySelector('.category-filter[data-customer="all"]').addEventListener('click', () => {
                document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
                document.querySelector('.category-filter[data-customer="all"]').classList.add('active');
                state.currentCustomer = 'all';
                hideCustomerMeetingsSection();
                hideCustomerPreparationsSection();
                showCustomerOverview();
                updateSectionTitle();
                renderTasks();
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentFilter = btn.dataset.filter;
                    renderTasks();
                });
            });

            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    
                    if (view === 'list' || view === 'kanban') {
                        state.currentDisplayMode = view;
                        document.querySelectorAll('.view-btn[data-view="list"], .view-btn[data-view="kanban"]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        if (view === 'kanban') {
                            document.getElementById('tasksList').style.display = 'none';
                            document.getElementById('kanbanBoard').classList.add('active');
                            document.getElementById('mainContainer').classList.add('kanban-mode');
                            document.getElementById('notesContainer').classList.add('hidden');
                            document.getElementById('taskFilters').style.display = 'none';
                        } else {
                            document.getElementById('tasksList').style.display = 'flex';
                            document.getElementById('kanbanBoard').classList.remove('active');
                            document.getElementById('mainContainer').classList.remove('kanban-mode');
                            document.getElementById('notesContainer').classList.remove('hidden');
                            document.getElementById('taskFilters').style.display = 'flex';
                        }
                    } else {
                        document.querySelectorAll('.view-btn[data-view="active"], .view-btn[data-view="archived"]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        state.currentView = view;
                    }
                    
                    renderTasks();
                });
            });

            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('meetingDate').value = now.toISOString().slice(0, 16);
        }

        function setupInlineTabs() {
            const tabs = document.querySelectorAll('.modal-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    const formType = tab.dataset.form;
                    
                    if (formType) {
                        const formContainer = formType === 'meeting' ? '#inlineMeetingForm' : '#inlinePreparationForm';
                        const formTabs = document.querySelectorAll(`${formContainer} .modal-tab`);
                        const formContents = document.querySelectorAll(`${formContainer} .tab-content`);
                        
                        formTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        formContents.forEach(content => content.classList.remove('active'));
                        const targetContent = document.querySelector(`${formContainer} [data-tab-content="${tabName}"]`);
                        if (targetContent) targetContent.classList.add('active');
                        
                        if (formType === 'meeting') {
                            state.currentMeetingTab = tabName;
                            if (tabName === 'export') {
                                updateMeetingExportPreview();
                            }
                        } else {
                            state.currentPreparationTab = tabName;
                            if (tabName === 'export') {
                                updatePreparationExportPreview();
                            }
                        }
                    }
                });
            });
        }

       function openInlinePreparationForm(preparation = null) {
    // Hide other sections
    document.getElementById('inlineMeetingForm').classList.remove('active');
    document.getElementById('dashboardStatsSection').classList.remove('active');
    document.getElementById('customerOverviewSection').classList.remove('active');
    document.getElementById('customerPreparationsSection').classList.remove('active');
    document.getElementById('customerMeetingsSection').classList.remove('active');
hideCustomerParticipantsSection();
    document.querySelector('.tasks-section').style.display = 'none'; // Hide tasks section
    document.getElementById('notesContainer').classList.add('hidden');
    document.getElementById('mainContainer').classList.add('form-mode');
    
    state.editingPreparation = preparation;
    state.selectedPreparationCustomerId = null;
    
    // Reset tabs
    document.querySelectorAll('#inlinePreparationForm .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#inlinePreparationForm .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#inlinePreparationForm .modal-tab[data-tab="info"]').classList.add('active');
    document.querySelector('#inlinePreparationForm [data-tab-content="info"]').classList.add('active');
    state.currentPreparationTab = 'info';
    
    if (preparation) {
        document.getElementById('preparationId').value = preparation.id;
        document.getElementById('preparationCustomerInput').value = preparation.customerName || '';
        state.selectedPreparationCustomerId = preparation.customerId;
        document.getElementById('preparationGoals').value = preparation.goals;
        document.getElementById('preparationDiscussionPoints').value = preparation.discussionPoints || '';
        document.getElementById('preparationBackground').value = preparation.background || '';
        document.getElementById('preparationMaterials').value = preparation.materials || '';
        document.getElementById('preparationOutcomes').value = preparation.outcomes || '';
    } else {
        document.getElementById('preparationForm').reset();
        document.getElementById('preparationCustomerInput').value = '';
    }
    
    document.getElementById('inlinePreparationForm').classList.add('active');
    window.scrollTo(0, 0);
}

function closeInlinePreparationForm() {
    const formElement = document.getElementById('inlinePreparationForm');
    if (formElement.classList.contains('active')) {
        formElement.classList.remove('active');
        document.querySelector('.tasks-section').style.display = 'block'; // Show tasks section
        document.getElementById('notesContainer').classList.remove('hidden');
        document.getElementById('mainContainer').classList.remove('form-mode');
        state.editingPreparation = null;
        state.selectedPreparationCustomerId = null;
        
        // Return to appropriate view
        if (state.currentCustomer === 'all') {
            showDashboard();
        } else {
            // Show customer-specific view
showCustomerParticipantsSection(state.currentCustomer);
            showCustomerPreparationsSection(state.currentCustomer);
            showCustomerMeetingsSection(state.currentCustomer);
            updateSectionTitle();
            renderTasks();
        }
    }
}

       function openInlineMeetingForm(meeting = null) {
    // Hide other sections
    document.getElementById('inlinePreparationForm').classList.remove('active');
    document.getElementById('dashboardStatsSection').classList.remove('active');
    document.getElementById('customerOverviewSection').classList.remove('active');
    document.getElementById('customerPreparationsSection').classList.remove('active');
    document.getElementById('customerMeetingsSection').classList.remove('active');
hideCustomerParticipantsSection();
    document.querySelector('.tasks-section').style.display = 'none'; // Hide tasks section
    document.getElementById('notesContainer').classList.add('hidden');
    document.getElementById('mainContainer').classList.add('form-mode');
    
    state.editingMeeting = meeting;
    state.meetingTasks = [];
    state.meetingParticipants = [];
state.editingParticipantIndex = null;
    state.selectedCustomerId = null;
state.editingParticipantIndex = null;
    
    // Reset tabs
    document.querySelectorAll('#inlineMeetingForm .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#inlineMeetingForm .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#inlineMeetingForm .modal-tab[data-tab="info"]').classList.add('active');
    document.querySelector('#inlineMeetingForm [data-tab-content="info"]').classList.add('active');
    state.currentMeetingTab = 'info';
    
    if (meeting) {
        document.getElementById('meetingId').value = meeting.id;
        document.getElementById('meetingCustomerInput').value = meeting.customerName || '';
        state.selectedCustomerId = meeting.customerId;
        document.getElementById('meetingDate').value = meeting.date;
        document.getElementById('meetingType').value = meeting.type || 'other';
        document.getElementById('meetingDuration').value = meeting.duration || '';
        document.getElementById('meetingTitle').value = meeting.title;
        document.getElementById('meetingTags').value = meeting.tags ? meeting.tags.join(', ') : '';
        
        if (meeting.notesHTML) {
            setEditorHTML('meetingNotesEditor', meeting.notesHTML);
        } else {
            setEditorHTML('meetingNotesEditor', escapeHtml(meeting.notes || ''));
        }
        
        if (meeting.nextStepsHTML) {
            setEditorHTML('meetingNextStepsEditor', meeting.nextStepsHTML);
        } else {
            setEditorHTML('meetingNextStepsEditor', escapeHtml(meeting.nextSteps || ''));
        }
        
        document.getElementById('meetingFollowUpDate').value = meeting.followUpDate || '';
        document.getElementById('meetingOutcome').value = meeting.outcome || '';
        state.meetingParticipants = meeting.participants || [];
        renderParticipantsList();
        document.getElementById('meddpiccMetrics').value = meeting.meddpicc?.metrics || '';
        document.getElementById('meddpiccEconomicBuyer').value = meeting.meddpicc?.economicBuyer || '';
        document.getElementById('meddpiccDecisionCriteria').value = meeting.meddpicc?.decisionCriteria || '';
        document.getElementById('meddpiccDecisionProcess').value = meeting.meddpicc?.decisionProcess || '';
        document.getElementById('meddpiccPaperProcess').value = meeting.meddpicc?.paperProcess || '';
        document.getElementById('meddpiccPain').value = meeting.meddpicc?.pain || '';
        document.getElementById('meddpiccChampion').value = meeting.meddpicc?.champion || '';
        document.getElementById('meddpiccCompetition').value = meeting.meddpicc?.competition || '';
        const meetingTasks = state.tasks.filter(t => t.meetingId === meeting.id);
        state.meetingTasks = meetingTasks.map(t => t.title);
        renderMeetingTasksList();
        if (meeting.customerId) {
            loadPreparationForCustomer(meeting.customerId);
        }
    } else {
        document.getElementById('meetingForm').reset();
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('meetingDate').value = now.toISOString().slice(0, 16);
        setEditorHTML('meetingNotesEditor', '');
        setEditorHTML('meetingNextStepsEditor', '');
        state.meetingTasks = [];
        state.meetingParticipants = [];
        renderMeetingTasksList();
        renderParticipantsList();
        document.getElementById('preparationTab').style.display = 'none';
    }
    
    document.getElementById('inlineMeetingForm').classList.add('active');
    window.scrollTo(0, 0);
}


function closeInlineMeetingForm() {
    const formElement = document.getElementById('inlineMeetingForm');
    if (formElement.classList.contains('active')) {
        formElement.classList.remove('active');
        document.querySelector('.tasks-section').style.display = 'block'; // Show tasks section
        document.getElementById('notesContainer').classList.remove('hidden');
        document.getElementById('mainContainer').classList.remove('form-mode');
        state.editingMeeting = null;
        state.meetingTasks = [];
        state.meetingParticipants = [];
        state.selectedCustomerId = null;
        
        // Return to appropriate view
        if (state.currentCustomer === 'all') {
            showDashboard();
        } else {
            // Show customer-specific view
showCustomerParticipantsSection(state.currentCustomer);
            showCustomerPreparationsSection(state.currentCustomer);
            showCustomerMeetingsSection(state.currentCustomer);
            updateSectionTitle();
            renderTasks();
        }
    }
}


function openInlinePreparationFormForCustomer(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    // Hide other sections
    document.getElementById('inlineMeetingForm').classList.remove('active');
    document.getElementById('dashboardStatsSection').classList.remove('active');
    document.getElementById('customerOverviewSection').classList.remove('active');
    document.getElementById('customerPreparationsSection').classList.remove('active');
    document.getElementById('customerMeetingsSection').classList.remove('active');
    document.querySelector('.tasks-section').style.display = 'none';
    document.getElementById('notesContainer').classList.add('hidden');
    document.getElementById('mainContainer').classList.add('form-mode');
    
    state.editingPreparation = null;
    state.selectedPreparationCustomerId = customerId; // Set the customer ID
    
    // Reset tabs
    document.querySelectorAll('#inlinePreparationForm .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#inlinePreparationForm .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#inlinePreparationForm .modal-tab[data-tab="info"]').classList.add('active');
    document.querySelector('#inlinePreparationForm [data-tab-content="info"]').classList.add('active');
    state.currentPreparationTab = 'info';
    
    // Reset form and set customer
    document.getElementById('preparationForm').reset();
    document.getElementById('preparationCustomerInput').value = customer.name;
    
    document.getElementById('inlinePreparationForm').classList.add('active');
    window.scrollTo(0, 0);
}

function openInlineMeetingFormForCustomer(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    // Hide other sections
    document.getElementById('inlinePreparationForm').classList.remove('active');
    document.getElementById('dashboardStatsSection').classList.remove('active');
    document.getElementById('customerOverviewSection').classList.remove('active');
    document.getElementById('customerPreparationsSection').classList.remove('active');
    document.getElementById('customerMeetingsSection').classList.remove('active');
    document.querySelector('.tasks-section').style.display = 'none';
    document.getElementById('notesContainer').classList.add('hidden');
    document.getElementById('mainContainer').classList.add('form-mode');
    
    state.editingMeeting = null;
    state.meetingTasks = [];
    state.meetingParticipants = [];
    state.selectedCustomerId = customerId; // Set the customer ID
    
    // Reset tabs
    document.querySelectorAll('#inlineMeetingForm .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#inlineMeetingForm .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#inlineMeetingForm .modal-tab[data-tab="info"]').classList.add('active');
    document.querySelector('#inlineMeetingForm [data-tab-content="info"]').classList.add('active');
    state.currentMeetingTab = 'info';
    
    // Reset form and set customer
    document.getElementById('meetingForm').reset();
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('meetingDate').value = now.toISOString().slice(0, 16);
    document.getElementById('meetingCustomerInput').value = customer.name;
    setEditorHTML('meetingNotesEditor', '');
    setEditorHTML('meetingNextStepsEditor', '');
    renderMeetingTasksList();
    renderParticipantsList();
    
    loadPreparationForCustomer(customerId);
    
    document.getElementById('inlineMeetingForm').classList.add('active');
    window.scrollTo(0, 0);
}

        function setupRichTextEditor() {
            document.querySelectorAll('.rich-text-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const command = btn.dataset.command;
                    const target = btn.dataset.target;
                    
                    let editor;
                    if (target === 'nextSteps') {
                        editor = document.getElementById('meetingNextStepsEditor');
                    } else {
                        editor = document.getElementById('meetingNotesEditor');
                    }
                    
                    editor.focus();
                    document.execCommand(command, false, null);
                    update 
ToolbarState(editor);
                });
            });

            const editors = [
                document.getElementById('meetingNotesEditor'),
                document.getElementById('meetingNextStepsEditor')
            ];

            editors.forEach(editor => {
                if (!editor) return;

                editor.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const selection = window.getSelection();
                        const range = selection.getRangeAt(0);
                        const currentNode = range.startContainer.parentNode;
                        
                        const listItem = currentNode.closest('li');
                        if (listItem) {
                            const text = listItem.textContent.trim();
                            
                            if (!text) {
                                e.preventDefault();
                                document.execCommand('outdent');
                                document.execCommand('formatBlock', false, 'p');
                            }
                        }
                    }
                });

                editor.addEventListener('mouseup', () => updateToolbarState(editor));
                editor.addEventListener('keyup', () => updateToolbarState(editor));
            });
        }

        function updateToolbarState(editor) {
            const buttons = editor.previousElementSibling?.querySelectorAll('.rich-text-btn');
            if (!buttons) return;

            buttons.forEach(btn => {
                const command = btn.dataset.command;
                let isActive = false;

                try {
                    isActive = document.queryCommandState(command);
                } catch (e) {
                    // Command not supported
                }

                if (isActive) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function getEditorHTML(editorId) {
            const editor = document.getElementById(editorId);
            return editor.innerHTML.trim();
        }

        function setEditorHTML(editorId, html) {
            const editor = document.getElementById(editorId);
            editor.innerHTML = html || '';
        }

        function getEditorText(editorId) {
            const editor = document.getElementById(editorId);
            return editor.innerText.trim();
        }

        function htmlToPlainText(html) {
            if (!html) return '';
            
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            function processNode(node) {
                let text = '';
                let hasContent = false;
                
                for (let child of node.childNodes) {
                    if (child.nodeType === Node.TEXT_NODE) {
                        const content = child.textContent;
                        if (content) {
                            text += content;
                            hasContent = true;
                        }
                    } else if (child.nodeType === Node.ELEMENT_NODE) {
                        const tagName = child.tagName.toLowerCase();
                        
                        if (tagName === 'br') {
                            text += '\n';
                            hasContent = true;
                        } else if (tagName === 'div' || tagName === 'p') {
                            if (hasContent && text && !text.endsWith('\n')) {
                                text += '\n';
                            }
                            const childText = processNode(child);
                            text += childText;
                            if (childText.trim() || !childText) {
                                text += '\n';
                            }
                            hasContent = true;
                        } else if (tagName === 'ul') {
                            if (hasContent && text && !text.endsWith('\n')) {
                                text += '\n';
                            }
                            const items = child.querySelectorAll('li');
                            items.forEach(li => {
                                text += ' ' + li.textContent.trim() + '\n';
                            });
                            hasContent = true;
                        } else if (tagName === 'ol') {
                            if (hasContent && text && !text.endsWith('\n')) {
                                text += '\n';
                            }
                            const items = child.querySelectorAll('li');
                            items.forEach((li, index) => {
                                text += `${index + 1}. ` + li.textContent.trim() + '\n';
                            });
                            hasContent = true;
                        } else if (tagName !== 'li') {
                            text += processNode(child);
                            hasContent = true;
                        }
                    }
                }
                
                return text;
            }
            
            let result = processNode(temp);
            result = result.replace(/\n{3,}/g, '\n\n');
            return result.trim();
        }

        function setupMEDDPICCQuickAdd() {
            const quickButtons = document.querySelectorAll('.meddpicc-quick-btn');
            
            quickButtons.forEach(button => {
                const infoIcon = button.querySelector('.meddpicc-info-icon');
                const tooltip = button.querySelector('.meddpicc-tooltip');
                
                if (infoIcon && tooltip) {
                    infoIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                    
                    infoIcon.addEventListener('mouseenter', (e) => {
                        const rect = infoIcon.getBoundingClientRect();
                        tooltip.style.top = (rect.top - 10) + 'px';
                        tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                    });
                }
                
                button.addEventListener('click', (e) => {
                    if (e.target.closest('.meddpicc-info-icon')) {
                        return;
                    }
                    
                    const field = button.dataset.field;
                    const selection = window.getSelection();
                    const selectedText = selection.toString().trim();
                    
                    if (!selectedText) {
                        showToast('Select text first', 'error');
                        return;
                    }
                    
                    const meddpiccField = document.getElementById(`meddpicc${field.charAt(0).toUpperCase() + field.slice(1)}`);
                    if (meddpiccField) {
                        const currentValue = meddpiccField.value.trim();
                        const newValue = currentValue ? currentValue + '\n\n ' + selectedText : ' ' + selectedText;
                        meddpiccField.value = newValue;
                        button.classList.add('success-flash');
                        setTimeout(() => button.classList.remove('success-flash'), 500);
                        showToast('Added!', 'success');
                    }
                });
            });
        }

        function setupActionItemQuickAdd() {
            const quickButton = document.querySelector('.action-item-quick-btn');
            if (!quickButton) return;
            
            quickButton.addEventListener('click', () => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                
                if (!selectedText) {
                    showToast('Select text first', 'error');
                    return;
                }
                
                if (!state.meetingTasks.includes(selectedText)) {
                    state.meetingTasks.push(selectedText);
                    renderMeetingTasksList();
                    quickButton.classList.add('success-flash');
                    setTimeout(() => quickButton.classList.remove('success-flash'), 500);
                    showToast('Added!', 'success');
                } else {
                    showToast('Already exists', 'error');
                }
            });
        }

function showAllTasks() {
    state.currentCustomer = 'all';
    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
    hideDashboardStats();
    hideCustomerMeetingsSection();
    hideCustomerPreparationsSection();
    hideCustomerOverview();
    updateSectionTitle();
    renderTasks();
}


function showDashboard() {
    state.currentCustomer = 'all';
    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
    document.querySelector('.category-filter[data-customer="all"]').classList.add('active');
    
    // Close any open forms
    closeInlineMeetingForm();
    closeInlinePreparationForm();
    
    // Hide customer-specific sections
    hideCustomerMeetingsSection();
    hideCustomerPreparationsSection();
hideCustomerParticipantsSection();
    
    // Show dashboard sections
    showDashboardStats();
    showCustomerOverview();
    
    // Show tasks and notes
    document.querySelector('.tasks-section').style.display = 'block';
    document.getElementById('notesContainer').classList.remove('hidden');
    document.getElementById('mainContainer').classList.remove('form-mode');
    
    updateSectionTitle();
    renderTasks();
renderNotes();
}

        function showHome() {
            showDashboard();
renderNotes();
        }

        function showDashboardStats() {
            document.getElementById('dashboardStatsSection').classList.add('active');
            updateStats();
        }

        function hideDashboardStats() {
            document.getElementById('dashboardStatsSection').classList.remove('active');
        }

        function showCustomerOverview() {
            hideCustomerMeetingsSection();
            hideCustomerPreparationsSection();
            document.getElementById('customerOverviewSection').classList.add('active');
            renderCustomerOverview();
        }

        function hideCustomerOverview() {
            document.getElementById('customerOverviewSection').classList.remove('active');
        }

function renderCustomerOverview() {
    const container = document.getElementById('customerOverviewGrid');
    const empty = document.getElementById('customerOverviewEmpty');
    
    let customersWithActivity = state.customers.filter(customer => {
        const hasMeetings = state.meetings.some(m => m.customerId === customer.id);
        const hasPreparations = state.preparations.some(p => p.customerId === customer.id);
        return hasMeetings || hasPreparations;
    });
    
    // Filter by search query
    if (state.searchQuery) {
        customersWithActivity = customersWithActivity.filter(customer => {
            const matchesName = customer.name.toLowerCase().includes(state.searchQuery);
            const matchesEmail = customer.email && customer.email.toLowerCase().includes(state.searchQuery);
            const matchesCompany = customer.company && customer.company.toLowerCase().includes(state.searchQuery);
            const matchesPhone = customer.phone && customer.phone.toLowerCase().includes(state.searchQuery);
            
            // Also search through their meetings
            let matchesMeetingTitle = false;
            const customerMeetings = state.meetings.filter(m => m.customerId === customer.id);
            if (customerMeetings.length > 0) {
                matchesMeetingTitle = customerMeetings.some(m => 
                    m.title.toLowerCase().includes(state.searchQuery) ||
                    (m.type && m.type.toLowerCase().includes(state.searchQuery))
                );
            }
            
            return matchesName || matchesEmail || matchesCompany || matchesPhone || matchesMeetingTitle;
        });
    }
    
    if (customersWithActivity.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        if (state.searchQuery) {
            empty.innerHTML = `
                <div class="empty-state-icon"></div>
                <div>No customers found for "${escapeHtml(state.searchQuery)}"</div>
            `;
        } else {
            empty.innerHTML = `
                <div class="empty-state-icon"></div>
                <div>No activity yet</div>
            `;
        }
        return;
    }
    
    empty.style.display = 'none';
    container.innerHTML = customersWithActivity.map(customer => {
        const meetings = state.meetings.filter(m => m.customerId === customer.id);
        const preparations = state.preparations.filter(p => p.customerId === customer.id);
        const tasks = state.tasks.filter(t => t.customerId === customer.id && !t.archived);
        const latestMeeting = meetings.length > 0 ? meetings[0] : null;
        const latestMeetingDate = latestMeeting ? new Date(latestMeeting.date) : null;
        return `
            <div class="customer-overview-card" onclick="selectCustomerFromOverview('${customer.id}')">
                <div class="customer-overview-name"> ${escapeHtml(customer.name)}</div>
                <div class="customer-overview-badges">
                    ${meetings.length > 0 ? `<span class="customer-overview-badge meetings">${meetings.length} Meeting${meetings.length > 1 ? 's' : ''}</span>` : ''}
                    ${preparations.length > 0 ? `<span class="customer-overview-badge preparations">${preparations.length} Prep${preparations.length > 1 ? 's' : ''}</span>` : ''}
                    ${tasks.length > 0 ? `<span class="customer-overview-badge tasks">${tasks.length} Task${tasks.length > 1 ? 's' : ''}</span>` : ''}
                </div>
                <div class="customer-overview-info">
                    ${latestMeetingDate ? `
                        <div class="customer-overview-info-item">
                            <span class="customer-overview-label">Last:</span>
                            <span class="customer-overview-value">${latestMeetingDate.toLocaleDateString()}</span>
                        </div>
                    ` : ''}
                    ${customer.company ? `
                        <div class="customer-overview-info-item">
                            <span class="customer-overview-label">Company:</span>
                            <span class="customer-overview-value">${escapeHtml(customer.company)}</span>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

// Add this function to check if meeting form has data
function isMeetingFormDirty() {
    if (!document.getElementById('inlineMeetingForm').classList.contains('active')) {
        return false;
    }
    
    const customerInput = document.getElementById('meetingCustomerInput').value.trim();
    const title = document.getElementById('meetingTitle').value.trim();
    const notesText = getEditorText('meetingNotesEditor');
    const nextStepsText = getEditorText('meetingNextStepsEditor');
    const metrics = document.getElementById('meddpiccMetrics').value.trim();
    const economicBuyer = document.getElementById('meddpiccEconomicBuyer').value.trim();
    const decisionCriteria = document.getElementById('meddpiccDecisionCriteria').value.trim();
    const decisionProcess = document.getElementById('meddpiccDecisionProcess').value.trim();
    const paperProcess = document.getElementById('meddpiccPaperProcess').value.trim();
    const pain = document.getElementById('meddpiccPain').value.trim();
    const champion = document.getElementById('meddpiccChampion').value.trim();
    const competition = document.getElementById('meddpiccCompetition').value.trim();
    
    return customerInput || title || notesText || nextStepsText || 
           metrics || economicBuyer || decisionCriteria || decisionProcess || 
           paperProcess || pain || champion || competition ||
           state.meetingTasks.length > 0 || state.meetingParticipants.length > 0;
}

// Add this function to check if preparation form has data
function isPreparationFormDirty() {
    if (!document.getElementById('inlinePreparationForm').classList.contains('active')) {
        return false;
    }
    
    const customerInput = document.getElementById('preparationCustomerInput').value.trim();
    const goals = document.getElementById('preparationGoals').value.trim();
    const discussionPoints = document.getElementById('preparationDiscussionPoints').value.trim();
    const background = document.getElementById('preparationBackground').value.trim();
    const materials = document.getElementById('preparationMaterials').value.trim();
    const outcomes = document.getElementById('preparationOutcomes').value.trim();
    
    return customerInput || goals || discussionPoints || background || materials || outcomes;
}

// Add this function to check if any form is dirty
function isAnyFormDirty() {
    return isMeetingFormDirty() || isPreparationFormDirty();
}

// Add this function to show discard confirmation
function showDiscardConfirmation(callback) {
    showConfirm(
        '',
        'Discard Changes?',
        'You have unsaved changes. Are you sure you want to discard them?',
        callback
    );
}

// Update the setupEventListeners function to add checks before navigation
function setupEventListeners() {
    document.getElementById('homeBtn').addEventListener('click', () => {
        if (isAnyFormDirty()) {
            showDiscardConfirmation(() => {
                closeInlineMeetingForm();
                closeInlinePreparationForm();
                showDashboard();
            });
        } else {
            showDashboard();
        }
    });
    
    document.getElementById('showAllTasksBtn').addEventListener('click', () => {
        if (isAnyFormDirty()) {
            showDiscardConfirmation(() => {
                closeInlineMeetingForm();
                closeInlinePreparationForm();
                showAllTasks();
            });
        } else {
            showAllTasks();
        }
    });
    
    document.getElementById('newPreparationBtn').addEventListener('click', () => {
        if (isAnyFormDirty()) {
            showDiscardConfirmation(() => {
                closeInlineMeetingForm();
                closeInlinePreparationForm();
                openInlinePreparationForm();
            });
        } else {
            openInlinePreparationForm();
        }
    });
    
    document.getElementById('newMeetingBtn').addEventListener('click', () => {
        if (isAnyFormDirty()) {
            showDiscardConfirmation(() => {
                closeInlineMeetingForm();
                closeInlinePreparationForm();
                openInlineMeetingForm();
            });
        } else {
            openInlineMeetingForm();
        }
    });
    
    document.getElementById('newTaskBtn').addEventListener('click', () => {
        if (isAnyFormDirty()) {
            showDiscardConfirmation(() => {
                closeInlineMeetingForm();
                closeInlinePreparationForm();
                openTaskModal();
            });
        } else {
            openTaskModal();
        }
    });
    
    document.getElementById('newNoteBtn').addEventListener('click', () => {
        if (isAnyFormDirty()) {
            showDiscardConfirmation(() => {
                closeInlineMeetingForm();
                closeInlinePreparationForm();
                openNoteModal();
            });
        } else {
            openNoteModal();
        }
    });
    
    document.getElementById('manageCustomersBtn').addEventListener('click', () => {
        if (isAnyFormDirty()) {
            showDiscardConfirmation(() => {
                closeInlineMeetingForm();
                closeInlinePreparationForm();
                openCustomersModal();
            });
        } else {
            openCustomersModal();
        }
    });
    
    document.getElementById('viewMeetingsBtn').addEventListener('click', () => {
        if (isAnyFormDirty()) {
            showDiscardConfirmation(() => {
                closeInlineMeetingForm();
                closeInlinePreparationForm();
                openAllMeetingsModal();
            });
        } else {
            openAllMeetingsModal();
        }
    });
    
    document.getElementById('tagsOverviewBtn').addEventListener('click', () => {
        if (isAnyFormDirty()) {
            showDiscardConfirmation(() => {
                closeInlineMeetingForm();
                closeInlinePreparationForm();
                openTagsOverviewModal();
            });
        } else {
            openTagsOverviewModal();
        }
    });
    
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    
    document.getElementById('archiveBtn').addEventListener('click', () => {
        if (isAnyFormDirty()) {
            showDiscardConfirmation(() => {
                closeInlineMeetingForm();
                closeInlinePreparationForm();
                showArchived();
            });
        } else {
            showArchived();
        }
    });
    
    document.getElementById('clearAllBtn').addEventListener('click', () => showConfirm('', 'Clear All?', 'Delete everything?', confirmClearAll));
    
    document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
    document.getElementById('noteForm').addEventListener('submit', handleNoteSubmit);
    document.getElementById('customerForm').addEventListener('submit', handleCustomerSubmit);
    document.getElementById('meetingForm').addEventListener('submit', handleMeetingSubmit);
    document.getElementById('preparationForm').addEventListener('submit', handlePreparationSubmit);
    
    document.getElementById('searchInput').addEventListener('input', handleSearch);

    document.getElementById('closeCustomersModalBtn').addEventListener('click', closeCustomersModal);
    document.getElementById('closeCustomerFormBtn').addEventListener('click', closeCustomerFormModal);
    document.getElementById('closeAllMeetingsBtn').addEventListener('click', closeAllMeetingsModal);
    document.getElementById('closeTaskModalBtn').addEventListener('click', closeTaskModal);
    document.getElementById('closeNoteModalBtn').addEventListener('click', closeNoteModal);
    document.getElementById('closeTagsOverviewBtn').addEventListener('click', closeTagsOverviewModal);
    document.getElementById('closeExportModalBtn').addEventListener('click', closeExportModal);

    document.getElementById('cancelCustomerFormBtn').addEventListener('click', closeCustomerFormModal);
    document.getElementById('cancelTaskBtn').addEventListener('click', closeTaskModal);
    document.getElementById('cancelNoteBtn').addEventListener('click', closeNoteModal);
    document.getElementById('cancelConfirmBtn').addEventListener('click', closeConfirmModal);

    document.getElementById('copyPreparationBtn').addEventListener('click', copyPreparationToClipboard);
    document.getElementById('downloadPreparationBtn').addEventListener('click', downloadPreparation);
    document.getElementById('copyMeetingBtn').addEventListener('click', copyMeetingToClipboard);
    document.getElementById('downloadMeetingBtn').addEventListener('click', downloadMeeting);
    document.getElementById('copyExportModalBtn').addEventListener('click', copyFromExportModal);
    document.getElementById('downloadExportModalBtn').addEventListener('click', downloadFromExportModal);

    document.getElementById('openAddCustomerBtn').addEventListener('click', openAddCustomerForm);
    document.getElementById('addQuickTaskBtn').addEventListener('click', addQuickTask);
    document.getElementById('addParticipantBtn').addEventListener('click', addParticipant);
    document.getElementById('addSubtaskBtn').addEventListener('click', () => addSubtaskInput());

    document.getElementById('quickTaskInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addQuickTask();
        }
    });

    document.getElementById('participantRoleInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addParticipant();
        }
    });

    document.querySelector('.category-filter[data-customer="all"]').addEventListener('click', () => {
        if (isAnyFormDirty()) {
            showDiscardConfirmation(() => {
                closeInlineMeetingForm();
                closeInlinePreparationForm();
                document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
                document.querySelector('.category-filter[data-customer="all"]').classList.add('active');
                state.currentCustomer = 'all';
hideDashboardStats();
                hideCustomerMeetingsSection();
                hideCustomerPreparationsSection();
hideCustomerParticipantsSection();
                showCustomerOverview();
                updateSectionTitle();
                renderTasks();
            });
        } else {
            document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
            document.querySelector('.category-filter[data-customer="all"]').classList.add('active');
            state.currentCustomer = 'all';
hideDashboardStats();
            hideCustomerMeetingsSection();
            hideCustomerPreparationsSection();
hideCustomerParticipantsSection();
            showCustomerOverview();
            updateSectionTitle();
            renderTasks();
        }
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.currentFilter = btn.dataset.filter;
            renderTasks();
        });
    });

    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const view = btn.dataset.view;
            
            if (view === 'list' || view === 'kanban') {
                state.currentDisplayMode = view;
                document.querySelectorAll('.view-btn[data-view="list"], .view-btn[data-view="kanban"]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                if (view === 'kanban') {
                    document.getElementById('tasksList').style.display = 'none';
                    document.getElementById('kanbanBoard').classList.add('active');
                    document.getElementById('mainContainer').classList.add('kanban-mode');
                    document.getElementById('notesContainer').classList.add('hidden');
                    document.getElementById('taskFilters').style.display = 'none';
                } else {
                    document.getElementById('tasksList').style.display = 'flex';
                    document.getElementById('kanbanBoard').classList.remove('active');
                    document.getElementById('mainContainer').classList.remove('kanban-mode');
                    document.getElementById('notesContainer').classList.remove('hidden');
                    document.getElementById('taskFilters').style.display = 'flex';
                }
            } else {
                document.querySelectorAll('.view-btn[data-view="active"], .view-btn[data-view="archived"]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.currentView = view;
            }
            
            renderTasks();
        });
    });

    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('meetingDate').value = now.toISOString().slice(0, 16);
}

        function selectCustomerFromOverview(customerId) {
            state.currentCustomer = customerId;
            document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
            const customerFilter = document.querySelector(`.category-filter[data-customer="${customerId}"]`);
            if (customerFilter) customerFilter.classList.add('active');
            hideDashboardStats();
            hideCustomerOverview();
showCustomerParticipantsSection(customerId);
            showCustomerPreparationsSection(customerId);
            showCustomerMeetingsSection(customerId);
            updateSectionTitle();
updateCustomerBanner(customerId);
            renderTasks();
        }

function showCustomerParticipantsSection(customerId) {
    const section = document.getElementById('customerParticipantsSection');
    const grid = document.getElementById('customerParticipantsGrid');
    const empty = document.getElementById('customerParticipantsEmpty');
    
    // Get all meetings for this customer
    const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
    
    // Collect all unique participants
    const participantsMap = new Map();
    
    customerMeetings.forEach(meeting => {
        if (meeting.participants && meeting.participants.length > 0) {
            meeting.participants.forEach(participant => {
                // Create consistent key
                const key = participant.email && participant.email.trim() 
                    ? participant.email.toLowerCase().trim() 
                    : participant.name.toLowerCase().trim();
                
                if (!participantsMap.has(key)) {
                    participantsMap.set(key, {
                        ...participant,
                        meetings: [],
                        uniqueKey: key  // Store the key with the participant
                    });
                }
                
                participantsMap.get(key).meetings.push({
                    title: meeting.title,
                    date: meeting.date,
                    id: meeting.id
                });
            });
        }
    });
    
    const participants = Array.from(participantsMap.values());
    
    if (participants.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
    } else {
        empty.style.display = 'none';
        grid.innerHTML = participants.map(participant => {
            const initials = participant.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            const meetingCount = participant.meetings.length;
            const lastMeeting = participant.meetings[participant.meetings.length - 1];
            
            // Use the stored unique key
            const participantKey = participant.uniqueKey;
            
            return `
                <div class="participant-overview-card">
                    <div class="participant-overview-actions">
                        <button class="participant-action-btn" onclick="editParticipantFromOverview('${escapeHtml(participantKey)}', '${customerId}')" title="Edit">
                            <svg viewBox="0 0 24 24">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="participant-action-btn delete" onclick="deleteParticipantFromOverview('${escapeHtml(participantKey)}', '${customerId}')" title="Delete">
                            <svg viewBox="0 0 24 24">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="participant-overview-header">
                        <div class="participant-overview-avatar">${initials}</div>
                        <div class="participant-overview-info">
                            <div class="participant-overview-name">${escapeHtml(participant.name)}</div>
                            ${participant.role ? `<div class="participant-overview-role">${escapeHtml(participant.role)}</div>` : ''}
                        </div>
                    </div>
                    <div class="participant-overview-details">
                        ${participant.email ? `
                            <div class="participant-overview-detail">
                                <span></span>
                                <span>${escapeHtml(participant.email)}</span>
                            </div>
                        ` : ''}
                        ${participant.phone ? `
                            <div class="participant-overview-detail">
                                <span></span>
                                <span>${escapeHtml(participant.phone)}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="participant-overview-meetings">
                         ${meetingCount} meeting${meetingCount > 1 ? 's' : ''}  Last: ${new Date(lastMeeting.date).toLocaleDateString()}
                    </div>
                </div>
            `;
        }).join('');
    }
    
// Update section header with Add button
const sectionHeader = section.querySelector('.customer-section-header');
if (sectionHeader && !sectionHeader.querySelector('.btn-add-participant')) {
    const title = sectionHeader.querySelector('.customer-section-title');
    sectionHeader.style.display = 'flex';
    sectionHeader.style.justifyContent = 'space-between';
    sectionHeader.style.alignItems = 'center';
    
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-add-participant';
    addBtn.innerHTML = '+ Add Person';
    addBtn.onclick = () => openAddParticipantModal(customerId);
    sectionHeader.appendChild(addBtn);
}

    section.classList.add('active');
}


function hideCustomerParticipantsSection() {
    document.getElementById('customerParticipantsSection').classList.remove('active');
}

function updateSectionTitle() {
    const titleElement = document.getElementById('mainSectionTitle');
    const headerBanner = document.getElementById('customerHeaderBanner');
    
    if (state.currentCustomer !== 'all') {
        const customer = state.customers.find(c => c.id === state.currentCustomer);
        if (customer) {
            titleElement.textContent = 'Tasks';
            headerBanner.classList.add('active');
            updateCustomerBanner(state.currentCustomer);
        }
    } else {
        titleElement.textContent = 'Tasks';
        headerBanner.classList.remove('active');
    }
}

        function showCustomerPreparationsSection(customerId) {
    const section = document.getElementById('customerPreparationsSection');
    const container = document.getElementById('customerPreparationsList');
    const empty = document.getElementById('customerPreparationsEmpty');
    const customerPreparations = state.preparations.filter(p => p.customerId === customerId);
    if (customerPreparations.length === 0) {
        section.classList.add('empty');
        container.innerHTML = '';
        empty.style.display = 'block';
        empty.className = 'empty-state-compact';
        empty.innerHTML = `
            <div class="empty-state-compact-icon"></div>
            <div>No preparations</div>
            <button class="empty-state-add-btn" onclick="openInlinePreparationFormForCustomer('${customerId}')">
                <span>+</span>
                <span>Prepare</span>
            </button>
        `;
    } else {
        section.classList.remove('empty');
        empty.style.display = 'none';
        container.innerHTML = customerPreparations.map(prep => `
            <div class="customer-preparation-summary">
                <div class="meeting-summary-header">
                    <div style="flex: 1;">
                        <div style="font-size: 0.7rem; color: var(--text-secondary); font-weight: 600;">PREPARATION</div>
                        <div class="meeting-summary-title"> ${new Date(prep.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div class="task-actions">
    <button class="task-btn" onclick="editPreparationFromCustomer('${prep.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
    </button>
    <button class="task-btn" onclick="exportPreparationFromList('${prep.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
    </button>
    <button class="task-btn delete" onclick="deletePreparation('${prep.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
    </button>
</div>
                </div>
                <div style="margin-top: 0.5rem;">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); font-weight: 600;">GOALS</div>
                    <div class="meeting-summary-content" id="prep-goals-${prep.id}">${escapeHtml(prep.goals)}</div>
                    <button class="meeting-expand-btn" onclick="togglePreparationExpand('prep-goals-${prep.id}')">More</button>
                </div>
            </div>
        `).join('');
    }
    section.classList.add('active');
}

        function hideCustomerPreparationsSection() {
            document.getElementById('customerPreparationsSection').classList.remove('active');
        }

        function togglePreparationExpand(elementId) {
            const content = document.getElementById(elementId);
            const btn = event.currentTarget;
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.textContent = 'More';
            } else {
                content.classList.add('expanded');
                btn.textContent = 'Less';
            }
        }

        function editPreparationFromCustomer(preparationId) {
            const preparation = state.preparations.find(p => p.id === preparationId);
            if (preparation) openInlinePreparationForm(preparation);
        }

        function showCustomerMeetingsSection(customerId) {
    const section = document.getElementById('customerMeetingsSection');
    const container = document.getElementById('customerMeetingsList');
    const empty = document.getElementById('customerMeetingsEmpty');
    const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
    if (customerMeetings.length === 0) {
        section.classList.add('empty');
        container.innerHTML = '';
        empty.style.display = 'block';
        empty.className = 'empty-state-compact';
        empty.innerHTML = `
            <div class="empty-state-compact-icon"></div>
            <div>No meetings</div>
            <button class="empty-state-add-btn" onclick="openInlineMeetingFormForCustomer('${customerId}')">
                <span>+</span>
                <span>Add Meeting</span>
            </button>
        `;
    } else {
        section.classList.remove('empty');
        empty.style.display = 'none';
        container.innerHTML = customerMeetings.map(meeting => {
            const meetingDate = new Date(meeting.date);
            const meddpiccScore = calculateMEDDPICCCompletion(meeting);
            const hasPreparation = state.preparations.some(p => p.customerId === customerId);
            const notesText = meeting.notesHTML ? htmlToPlainText(meeting.notesHTML) : meeting.notes;
            
            return `
                <div class="customer-meeting-summary">
                    <div class="meeting-summary-header">
                        <div style="flex: 1;">
                            <div style="font-size: 0.7rem; color: var(--text-secondary); font-weight: 600;">MEETING</div>
                            <div class="meeting-summary-title">
                                ${escapeHtml(meeting.title)} ${hasPreparation ? '<span class="preparation-badge"></span>' : ''}
                            </div>
                            <div class="meeting-summary-date"> ${meetingDate.toLocaleDateString()}</div>
                        </div>
                        <div class="task-actions">
    <button class="task-btn" onclick="editMeetingFromCustomer('${meeting.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
    </button>
    <button class="task-btn" onclick="exportMeetingFromList('${meeting.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
    </button>
    <button class="task-btn delete" onclick="deleteMeetingFromCustomer('${meeting.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
    </button>
</div>
                    </div>
                    ${meddpiccScore.completed > 0 ? `
                        <div class="meddpicc-progress">
                            <div class="meddpicc-progress-header">
                                <div class="meddpicc-progress-title"> MEDDPICC</div>
                                <div class="meddpicc-progress-score">${meddpiccScore.completed}/8</div>
                            </div>
                            <div class="meddpicc-progress-bar">
                                <div class="meddpicc-progress-fill" style="width: ${meddpiccScore.percentage}%"></div>
                            </div>
                            <div class="meddpicc-items">
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.metrics ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.metrics ? '' : ''}
                                    </div>
                                    <span>Metrics</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.economicBuyer ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.economicBuyer ? '' : ''}
                                    </div>
                                    <span>Buyer</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.decisionCriteria ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.decisionCriteria ? '' : ''}
                                    </div>
                                    <span>Criteria</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.decisionProcess ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.decisionProcess ? '' : ''}
                                    </div>
                                    <span>Process</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.paperProcess ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.paperProcess ? '' : ''}
                                    </div>
                                    <span>Paper</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.pain ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.pain ? '' : ''}
                                    </div>
                                    <span>Pain</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.champion ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.champion ? '' : ''}
                                    </div>
                                    <span>Champion</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.competition ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.competition ? '' : ''}
                                    </div>
                                    <span>Comp</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    <div style="margin-top: 0.5rem;">
                        <div style="font-size: 0.7rem; color: var(--text-secondary); font-weight: 600;">NOTES</div>
                        <div class="meeting-summary-content" id="meeting-content-${meeting.id}">${escapeHtml(notesText)}</div>
                        <button class="meeting-expand-btn" onclick="toggleMeetingExpand('${meeting.id}')">More</button>
                    </div>
                </div>
            `;
        }).join('');
    }
    section.classList.add('active');
}

        function hideCustomerMeetingsSection() {
            document.getElementById('customerMeetingsSection').classList.remove('active');
        }

        function toggleMeetingExpand(meetingId) {
            const content = document.getElementById(`meeting-content-${meetingId}`);
            const btn = event.currentTarget;
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.textContent = 'More';
            } else {
                content.classList.add('expanded');
                btn.textContent = 'Less';
            }
        }

        function editMeetingFromCustomer(meetingId) {
            const meeting = state.meetings.find(m => m.id === meetingId);
            if (meeting) openInlineMeetingForm(meeting);
        }

        function calculateMEDDPICCCompletion(meeting) {
            const fields = [
                meeting.meddpicc?.metrics,
                meeting.meddpicc?.economicBuyer,
                meeting.meddpicc?.decisionCriteria,
                meeting.meddpicc?.decisionProcess,
                meeting.meddpicc?.paperProcess,
                meeting.meddpicc?.pain,
                meeting.meddpicc?.champion,
                meeting.meddpicc?.competition
            ];
            const completed = fields.filter(field => field && field.trim()).length;
            return {
                completed,
                total: 8,
                percentage: Math.round((completed / 8) * 100)
            };
        }

        function setupColorPicker() {
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    state.selectedColor = option.dataset.color;
                    document.getElementById('taskColor').value = state.selectedColor;
                });
            });
        }

        function setupCustomerCombobox() {
            const input = document.getElementById('meetingCustomerInput');
            const dropdown = document.getElementById('customerDropdown');
            input.addEventListener('focus', () => {
                updateCustomerDropdown();
                dropdown.classList.add('active');
            });
            input.addEventListener('input', () => {
                updateCustomerDropdown(input.value);
                dropdown.classList.add('active');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.customer-combobox')) {
                    dropdown.classList.remove('active');
                }
            });
        }

        function setupTaskCustomerCombobox() {
            const input = document.getElementById('taskCustomerInput');
            const dropdown = document.getElementById('taskCustomerDropdown');
            input.addEventListener('focus', () => {
                updateTaskCustomerDropdown();
                dropdown.classList.add('active');
            });
            input.addEventListener('input', () => {
                updateTaskCustomerDropdown(input.value);
                dropdown.classList.add('active');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#taskCustomerInput') && !e.target.closest('#taskCustomerDropdown')) {
                    dropdown.classList.remove('active');
                }
            });
        }

        function setupPreparationCustomerCombobox() {
            const input = document.getElementById('preparationCustomerInput');
            const dropdown = document.getElementById('preparationCustomerDropdown');
            input.addEventListener('focus', () => {
                updatePreparationCustomerDropdown();
                dropdown.classList.add('active');
            });
            input.addEventListener('input', () => {
                updatePreparationCustomerDropdown(input.value);
                dropdown.classList.add('active');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#preparationCustomerInput') && !e.target.closest('#preparationCustomerDropdown')) {
                    dropdown.classList.remove('active');
                }
            });
        }

        function updateCustomerDropdown(searchTerm = '') {
            const dropdown = document.getElementById('customerDropdown');
            const filteredCustomers = state.customers.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));
            let html = '';
            if (searchTerm && !filteredCustomers.some(c => c.name.toLowerCase() === searchTerm.toLowerCase())) {
                html += `<div class="customer-dropdown-item new-customer" onclick="selectNewCustomer('${escapeHtml(searchTerm)}')"> Add "${escapeHtml(searchTerm)}"</div>`;
            }
            filteredCustomers.forEach(customer => {
                html += `
                    <div class="customer-dropdown-item" onclick="selectExistingCustomer('${customer.id}')">
                        <div class="customer-dropdown-item-name">${escapeHtml(customer.name)}</div>
                        ${customer.email ? `<div class="customer-dropdown-item-email">${escapeHtml(customer.email)}</div>` : ''}
                    </div>
                `;
            });
            if (filteredCustomers.length === 0 && !searchTerm) {
                html = '<div class="customer-dropdown-item" style="text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No customers</div>';
            }
            dropdown.innerHTML = html;
        }

        function updateTaskCustomerDropdown(searchTerm = '') {
            const dropdown = document.getElementById('taskCustomerDropdown');
            const filteredCustomers = state.customers.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));
            let html = '';
            if (searchTerm && !filteredCustomers.some(c => c.name.toLowerCase() === searchTerm.toLowerCase())) {
                html += `<div class="customer-dropdown-item new-customer" onclick="selectNewTaskCustomer('${escapeHtml(searchTerm)}')"> Add "${escapeHtml(searchTerm)}"</div>`;
            }
            filteredCustomers.forEach(customer => {
                html += `
                    <div class="customer-dropdown-item" onclick="selectExistingTaskCustomer('${customer.id}')">
                        <div class="customer-dropdown-item-name">${escapeHtml(customer.name)}</div>
                        ${customer.email ? `<div class="customer-dropdown-item-email">${escapeHtml(customer.email)}</div>` : ''}
                    </div>
                `;
            });
            if (filteredCustomers.length === 0 && !searchTerm) {
                html = '<div class="customer-dropdown-item" style="text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No customers</div>';
            }
            dropdown.innerHTML = html;
        }

        function updatePreparationCustomerDropdown(searchTerm = '') {
            const dropdown = document.getElementById('preparationCustomerDropdown');
            const filteredCustomers = state.customers.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));
            let html = '';
            if (searchTerm && !filteredCustomers.some(c => c.name.toLowerCase() === searchTerm.toLowerCase())) {
                html += `<div class="customer-dropdown-item new-customer" onclick="selectNewPreparationCustomer('${escapeHtml(searchTerm)}')"> Add "${escapeHtml(searchTerm)}"</div>`;
            }
            filteredCustomers.forEach(customer => {
                html += `
                    <div class="customer-dropdown-item" onclick="selectExistingPreparationCustomer('${customer.id}')">
                        <div class="customer-dropdown-item-name">${escapeHtml(customer.name)}</div>
                        ${customer.email ? `<div class="customer-dropdown-item-email">${escapeHtml(customer.email)}</div>` : ''}
                    </div>
                `;
            });
            if (filteredCustomers.length === 0 && !searchTerm) {
                html = '<div class="customer-dropdown-item" style="text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No customers</div>';
            }
            dropdown.innerHTML = html;
        }

        function selectExistingCustomer(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('meetingCustomerInput').value = customer.name;
                state.selectedCustomerId = customerId;
                document.getElementById('customerDropdown').classList.remove('active');
                loadPreparationForCustomer(customerId);
            }
        }

        function selectNewCustomer(customerName) {
            document.getElementById('meetingCustomerInput').value = customerName;
            state.selectedCustomerId = null;
            document.getElementById('customerDropdown').classList.remove('active');
            document.getElementById('preparationTab').style.display = 'none';
        }

        function selectExistingTaskCustomer(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('taskCustomerInput').value = customer.name;
                state.selectedTaskCustomerId = customerId;
                document.getElementById('taskCustomerDropdown').classList.remove('active');
            }
        }

        function selectNewTaskCustomer(customerName) {
            document.getElementById('taskCustomerInput').value = customerName;
            state.selectedTaskCustomerId = null;
            document.getElementById('taskCustomerDropdown').classList.remove('active');
        }

        function selectExistingPreparationCustomer(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('preparationCustomerInput').value = customer.name;
                state.selectedPreparationCustomerId = customerId;
                document.getElementById('preparationCustomerDropdown').classList.remove('active');
            }
        }

        function selectNewPreparationCustomer(customerName) {
            document.getElementById('preparationCustomerInput').value = customerName;
            state.selectedPreparationCustomerId = null;
            document.getElementById('preparationCustomerDropdown').classList.remove('active');
        }

        function loadPreparationForCustomer(customerId) {
            const preparation = state.preparations.find(p => p.customerId === customerId);
            const preparationTab = document.getElementById('preparationTab');
            const preparationContent = document.getElementById('preparationContent');
            if (preparation) {
                preparationTab.style.display = 'flex';
                preparationContent.innerHTML = `
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem; color: white; font-weight: 600; font-size: 0.8rem;">
                         Preparation Available
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                        <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.35rem;">GOALS</div>
                        <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px; white-space: pre-wrap; font-size: 0.8rem;">${escapeHtml(preparation.goals)}</div>
                    </div>
                    ${preparation.discussionPoints ? `
                        <div style="margin-bottom: 0.75rem;">
                            <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.35rem;">DISCUSSION</div>
                            <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px; white-space: pre-wrap; font-size: 0.8rem;">${escapeHtml(preparation.discussionPoints)}</div>
                        </div>
                    ` : ''}
                    <button type="button" class="btn btn-secondary" onclick="editPreparationFromMeeting('${preparation.id}')" style="width: 100%;"> Edit</button>
                `;
            } else {
                preparationTab.style.display = 'none';
                preparationContent.innerHTML = '<p style="color: var(--text-secondary); text-align: center; font-size: 0.8rem;">No preparation</p>';
            }
        }

        function editPreparationFromMeeting(preparationId) {
            const preparation = state.preparations.find(p => p.id === preparationId);
            if (preparation) {
                closeInlineMeetingForm();
                openInlinePreparationForm(preparation);
            }
        }

        function openTagsOverviewModal() {
            renderTagsOverview();
            document.getElementById('tagsOverviewModal').classList.add('active');
        }

        function closeTagsOverviewModal() {
            document.getElementById('tagsOverviewModal').classList.remove('active');
            state.selectedTag = null;
        }

        function renderTagsOverview() {
            const tagsMap = new Map();
            state.meetings.forEach(meeting => {
                if (meeting.tags && meeting.tags.length > 0) {
                    meeting.tags.forEach(tag => {
                        if (!tagsMap.has(tag)) {
                            tagsMap.set(tag, []);
                        }
                        tagsMap.get(tag).push({
                            meetingId: meeting.id,
                            customerId: meeting.customerId,
                            customerName: meeting.customerName,
                            meetingTitle: meeting.title,
                            meetingDate: meeting.date
                        });
                    });
                }
            });
            const tagsContainer = document.getElementById('tagsListContainer');
            const emptyState = document.getElementById('tagsEmpty');
            if (tagsMap.size === 0) {
                tagsContainer.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('selectedTagTitle').textContent = 'No tags';
                document.getElementById('customersByTagContainer').innerHTML = '';
                return;
            }
            emptyState.style.display = 'none';
            const sortedTags = Array.from(tagsMap.entries()).sort((a, b) => b[1].length - a[1].length);
            tagsContainer.innerHTML = sortedTags.map(([tag, meetings]) => `
                <div class="tag-item" onclick="selectTag('${escapeHtml(tag)}')">
                    <span class="tag-item-name"> ${escapeHtml(tag)}</span>
                    <span class="tag-item-count">${meetings.length}</span>
                </div>
            `).join('');
            if (!state.selectedTag && sortedTags.length > 0) {
                selectTag(sortedTags[0][0]);
            } else if (state.selectedTag) {
                selectTag(state.selectedTag);
            }
        }

        function selectTag(tag) {
            state.selectedTag = tag;
            document.querySelectorAll('.tag-item').forEach(item => item.classList.remove('active'));
            event.currentTarget?.classList.add('active');
            document.getElementById('selectedTagTitle').textContent = `Tag: ${tag}`;
            const meetingsWithTag = state.meetings.filter(m => m.tags && m.tags.includes(tag));
            const customerMeetings = new Map();
            meetingsWithTag.forEach(meeting => {
                if (meeting.customerId) {
                    if (!customerMeetings.has(meeting.customerId)) {
                        customerMeetings.set(meeting.customerId, {
                            customerName: meeting.customerName,
                            meetings: []
                        });
                    }
                    customerMeetings.get(meeting.customerId).meetings.push(meeting);
                }
            });
            const container = document.getElementById('customersByTagContainer');
            if (customerMeetings.size === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><div class="empty-state-icon"></div><div>No customers</div></div>';
                return;
            }
            container.innerHTML = Array.from(customerMeetings.entries()).map(([customerId, data]) => `
                <div class="customer-tag-card">
                    <div class="customer-tag-header">
                        <div class="customer-tag-name"> ${escapeHtml(data.customerName)}</div>
                        <div class="meetings-count-badge">${data.meetings.length}</div>
                    </div>
                    <div class="meetings-list-compact">
                        ${data.meetings.map(meeting => `
                            <div class="meeting-compact-item">
                                <strong>${escapeHtml(meeting.title)}</strong>
                                <div class="meeting-compact-date"> ${new Date(meeting.date).toLocaleDateString()}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function openCustomersModal() {
            renderCustomerList();
            document.getElementById('customersModal').classList.add('active');
        }

        function closeCustomersModal() {
            document.getElementById('customersModal').classList.remove('active');
        }

function openAddCustomerForm() {
    state.editingCustomer = null;
    document.getElementById('customerFormTitle').textContent = 'Add Customer';
    document.getElementById('customerForm').reset();
    document.getElementById('customerFormModal').classList.add('active');
}

       function openEditCustomerForm(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    state.editingCustomer = customer;
    document.getElementById('customerFormTitle').textContent = 'Edit Customer Profile';
    document.getElementById('customerId').value = customer.id;
    document.getElementById('customerName').value = customer.name;
    document.getElementById('customerEmail').value = customer.email || '';
    document.getElementById('customerPhone').value = customer.phone || '';
    document.getElementById('customerWebsite').value = customer.website || '';
    document.getElementById('customerAddress').value = customer.address || '';
    document.getElementById('customerCity').value = customer.city || '';
    document.getElementById('customerState').value = customer.state || '';
    document.getElementById('customerZip').value = customer.zip || '';
    document.getElementById('customerCountry').value = customer.country || '';
    document.getElementById('customerIndustry').value = customer.industry || '';
    document.getElementById('customerSize').value = customer.size || '';
    document.getElementById('customerLinkedIn').value = customer.linkedIn || '';
    document.getElementById('customerMapsLink').value = customer.mapsLink || '';
    document.getElementById('customerFormModal').classList.add('active');
}

        function closeCustomerFormModal() {
            document.getElementById('customerFormModal').classList.remove('active');
            state.editingCustomer = null;
        }

        function handleCustomerSubmit(e) {
    e.preventDefault();
    const customer = {
        id: document.getElementById('customerId').value || Date.now().toString(),
        name: document.getElementById('customerName').value.trim(),
        email: document.getElementById('customerEmail').value.trim(),
        phone: document.getElementById('customerPhone').value.trim(),
        website: document.getElementById('customerWebsite').value.trim(),
        address: document.getElementById('customerAddress').value.trim(),
        city: document.getElementById('customerCity').value.trim(),
        state: document.getElementById('customerState').value.trim(),
        zip: document.getElementById('customerZip').value.trim(),
        country: document.getElementById('customerCountry').value.trim(),
        industry: document.getElementById('customerIndustry').value.trim(),
        size: document.getElementById('customerSize').value,
        linkedIn: document.getElementById('customerLinkedIn').value.trim(),
        mapsLink: document.getElementById('customerMapsLink').value.trim(),
        createdAt: state.editingCustomer?.createdAt || new Date().toISOString()
    };
    
    if (state.editingCustomer) {
        const index = state.customers.findIndex(c => c.id === customer.id);
        state.customers[index] = customer;
        showToast(' Customer updated!', 'success');
    } else {
        state.customers.push(customer);
        showToast(' Customer added!', 'success');
    }
    
    saveData();
    renderCustomerList();
    renderCustomerFilters();
    
    // Update banner if viewing this customer
    if (state.currentCustomer === customer.id) {
        updateCustomerBanner(customer.id);
    }
    
    closeCustomerFormModal();
}

        function deleteCustomer(customerId) {
            showConfirm('', 'Delete?', 'Delete customer?', () => {
                state.customers = state.customers.filter(c => c.id !== customerId);
                saveData();
                renderCustomerList();
                renderCustomerFilters();
                showToast('Deleted', 'success');
            });
        }

       function renderCustomerList() {
    const container = document.getElementById('customerList');
    const empty = document.getElementById('customersEmpty');
    if (state.customers.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    empty.style.display = 'none';
    container.innerHTML = state.customers.map(customer => `
        <div class="customer-item">
            <div class="customer-info">
                <div class="customer-name">${escapeHtml(customer.name)}</div>
                ${customer.email ? `<div class="customer-email">${escapeHtml(customer.email)}</div>` : ''}
            </div>
            <div class="customer-actions">
                <button class="task-btn" onclick="openEditCustomerForm('${customer.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="task-btn delete" onclick="deleteCustomer('${customer.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

function renderCustomerFilters() {
    const container = document.getElementById('customerFilters');
    const taskCounts = {};
    state.tasks.filter(t => !t.archived).forEach(task => {
        if (task.customerId) {
            taskCounts[task.customerId] = (taskCounts[task.customerId] || 0) + 1;
        }
    });
    container.innerHTML = state.customers.map(customer => `
        <button class="category-filter" data-customer="${customer.id}">
            <span class="category-dot" style="background: white;"></span>
            <span class="category-filter-name">${escapeHtml(customer.name)}</span>
            <span class="customer-count">${taskCounts[customer.id] || 0}</span>
            <div class="customer-filter-actions">
                <div class="customer-filter-btn" onclick="event.stopPropagation(); renameCustomerFromSidebar('${customer.id}')" title="Rename">
                    <svg viewBox="0 0 24 24">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </div>
                <div class="customer-filter-btn delete" onclick="event.stopPropagation(); deleteCustomerFromSidebar('${customer.id}')" title="Delete">
                    <svg viewBox="0 0 24 24">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </div>
            </div>
        </button>
    `).join('');
    
    const allCount = state.tasks.filter(t => !t.archived).length;
    document.getElementById('allCustomersCount').textContent = allCount;

    document.querySelectorAll('.category-filter[data-customer]').forEach(btn => {
        btn.addEventListener('click', () => {
            if (btn.dataset.customer === 'all') return;
            
            if (isAnyFormDirty()) {
                showDiscardConfirmation(() => {
                    closeInlineMeetingForm();
                    closeInlinePreparationForm();
                    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentCustomer = btn.dataset.customer;
                    hideDashboardStats();
                    hideCustomerOverview();
showCustomerParticipantsSection(state.currentCustomer);
                    showCustomerPreparationsSection(state.currentCustomer);
                    showCustomerMeetingsSection(state.currentCustomer);
                    updateSectionTitle();
                    renderTasks();
                    renderNotes();
                });
            } else {
                document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.currentCustomer = btn.dataset.customer;
                hideDashboardStats();
                hideCustomerOverview();
                closeInlineMeetingForm();
                closeInlinePreparationForm();
showCustomerParticipantsSection(state.currentCustomer);
                showCustomerPreparationsSection(state.currentCustomer);
                showCustomerMeetingsSection(state.currentCustomer);
                updateSectionTitle();
                renderTasks();
                renderNotes();
            }
        });
    });
}

       function handlePreparationSubmit(e) {
    e.preventDefault();
    
    // Clear previous errors
    document.querySelectorAll('.form-input, .form-textarea, .customer-combobox-input').forEach(el => {
        el.classList.remove('error');
    });
    document.querySelectorAll('.field-error-message').forEach(el => el.remove());
    document.querySelectorAll('.form-section').forEach(el => el.classList.remove('error'));
    
    // Validation checks
    const validations = [
        {
            field: 'preparationCustomerInput',
            value: document.getElementById('preparationCustomerInput').value.trim(),
            message: 'Please enter a customer name',
            tab: 'info'
        },
        {
            field: 'preparationGoals',
            value: document.getElementById('preparationGoals').value.trim(),
            message: 'Please enter meeting goals',
            tab: 'info'
        }
    ];
    
    // Find first error
    for (let validation of validations) {
        if (!validation.value) {
            // Switch to the correct tab - FIXED VERSION
            const tabs = document.querySelectorAll('#inlinePreparationForm .modal-tab[data-form="preparation"]');
            const contents = document.querySelectorAll('#inlinePreparationForm .tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            const targetTab = document.querySelector(`#inlinePreparationForm .modal-tab[data-tab="${validation.tab}"][data-form="preparation"]`);
            const targetContent = document.querySelector(`#inlinePreparationForm .tab-content[data-tab-content="${validation.tab}"]`);
            
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.click();
            }
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            state.currentPreparationTab = validation.tab;
            
            setTimeout(() => {
                const field = document.getElementById(validation.field);
                if (field) {
                    field.classList.add('error');
                    
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'field-error-message';
                    errorMsg.innerHTML = ` ${validation.message}`;
                    
                    const parent = field.closest('.form-group') || field.closest('.form-section-content');
                    if (parent) {
                        parent.appendChild(errorMsg);
                        
                        const section = field.closest('.form-section');
                        if (section) {
                            section.classList.add('error');
                            section.classList.remove('collapsed');
                        }
                    }
                    
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => field.focus(), 300);
                }
            }, 200);
            
            showToast(` ${validation.message}`, 'error');
            return;
        }
    }
    
    // All validation passed, proceed with save
    const customerInput = document.getElementById('preparationCustomerInput').value.trim();
    const goals = document.getElementById('preparationGoals').value.trim();
    
    let customerId = state.selectedPreparationCustomerId;
    let customerName = customerInput;
    
    if (!customerId && customerInput) {
        const newCustomer = {
            id: Date.now().toString(),
            name: customerInput,
            email: '',
            phone: '',
            company: '',
            notes: '',
            createdAt: new Date().toISOString()
        };
        state.customers.push(newCustomer);
        customerId = newCustomer.id;
        customerName = newCustomer.name;
        showToast(' Customer created!', 'success');
    }
    
    const preparation = {
        id: document.getElementById('preparationId').value || Date.now().toString(),
        customerId: customerId,
        customerName: customerName,
        goals: goals,
        discussionPoints: document.getElementById('preparationDiscussionPoints').value.trim(),
        background: document.getElementById('preparationBackground').value.trim(),
        materials: document.getElementById('preparationMaterials').value.trim(),
        outcomes: document.getElementById('preparationOutcomes').value.trim(),
        createdAt: state.editingPreparation?.createdAt || new Date().toISOString()
    };
    
    if (state.editingPreparation) {
        const index = state.preparations.findIndex(p => p.id === preparation.id);
        state.preparations[index] = preparation;
        showToast(' Preparation updated!', 'success');
    } else {
        const existingIndex = state.preparations.findIndex(p => p.customerId === customerId);
        if (existingIndex !== -1) {
            state.preparations[existingIndex] = preparation;
            showToast(' Preparation updated!', 'success');
        } else {
            state.preparations.unshift(preparation);
            showToast(' Preparation saved!', 'success');
        }
    }
    
    saveData();
    renderCustomerFilters();
    
    if (document.getElementById('customerOverviewSection').classList.contains('active')) {
        renderCustomerOverview();
    }
    
    closeInlinePreparationForm();
}

function handleMeetingSubmit(e) {
    e.preventDefault();
    
    // Clear previous errors
    document.querySelectorAll('.form-input, .form-textarea, .customer-combobox-input').forEach(el => {
        el.classList.remove('error');
    });
    document.querySelectorAll('.field-error-message').forEach(el => el.remove());
    document.querySelectorAll('.form-section').forEach(el => el.classList.remove('error'));
    
    // Validation checks
    const validations = [
        {
            field: 'meetingCustomerInput',
            value: document.getElementById('meetingCustomerInput').value.trim(),
            message: 'Please enter a customer name',
            tab: 'info',
            section: null
        },
        {
            field: 'meetingTitle',
            value: document.getElementById('meetingTitle').value.trim(),
            message: 'Please enter a meeting title',
            tab: 'info',
            section: null
        },
        {
            field: 'meetingDate',
            value: document.getElementById('meetingDate').value,
            message: 'Please select a date and time',
            tab: 'info',
            section: null
        },
        {
            field: 'meetingType',
            value: document.getElementById('meetingType').value,
            message: 'Please select a meeting type',
            tab: 'info',
            section: null,
            customCheck: () => {
                const selected = document.querySelector('.meeting-type-pill.selected');
                return selected !== null;
            }
        },
        {
            field: 'meetingNotesEditor',
            value: getEditorText('meetingNotesEditor'),
            message: 'Please enter meeting notes',
            tab: 'notes',
            section: null
        }
    ];
    
    // Find first error
    for (let validation of validations) {
        let isValid = validation.customCheck ? validation.customCheck() : validation.value;
        
        if (!isValid) {
            // Switch to the correct tab
            document.querySelectorAll('#inlineMeetingForm .modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#inlineMeetingForm .tab-content').forEach(c => c.classList.remove('active'));
            
            const targetTab = document.querySelector(`#inlineMeetingForm .modal-tab[data-tab="${validation.tab}"]`);
            const targetContent = document.querySelector(`#inlineMeetingForm [data-tab-content="${validation.tab}"]`);
            
            if (targetTab && targetContent) {
                targetTab.classList.add('active');
                targetContent.classList.add('active');
            }
            
            // Scroll to and highlight the field
            setTimeout(() => {
                const field = document.getElementById(validation.field);
                if (field) {
                    // Add error class
                    field.classList.add('error');
                    
                    // Add error message
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'field-error-message';
                    errorMsg.innerHTML = ` ${validation.message}`;
                    
                    // Find the parent form-group or form-section-content
                    const parent = field.closest('.form-group') || field.closest('.form-section-content');
                    if (parent) {
                        parent.appendChild(errorMsg);
                        
                        // Highlight parent section
                        const section = field.closest('.form-section');
                        if (section) {
                            section.classList.add('error');
                            // Expand if collapsed
                            section.classList.remove('collapsed');
                        }
                    }
                    
                    // Scroll to field
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Focus the field
                    setTimeout(() => field.focus(), 300);
                }
            }, 100);
            
            showToast(` ${validation.message}`, 'error');
            return;
        }
    }
    
    // All validation passed, proceed with save
    const customerInput = document.getElementById('meetingCustomerInput').value.trim();
    const title = document.getElementById('meetingTitle').value.trim();
    const date = document.getElementById('meetingDate').value;
    const type = document.getElementById('meetingType').value;
    const notesHTML = getEditorHTML('meetingNotesEditor');
    const notesText = getEditorText('meetingNotesEditor');
    const nextStepsHTML = getEditorHTML('meetingNextStepsEditor');
    const nextStepsText = getEditorText('meetingNextStepsEditor');
    
    let customerId = state.selectedCustomerId;
    let customerName = customerInput;
    
    if (!customerId && customerInput) {
        const newCustomer = {
            id: Date.now().toString(),
            name: customerInput,
            email: '',
            phone: '',
            company: '',
            notes: '',
            createdAt: new Date().toISOString()
        };
        state.customers.push(newCustomer);
        customerId = newCustomer.id;
        customerName = newCustomer.name;
        showToast(' Customer created!', 'success');
    }
    
    const tagsInput = document.getElementById('meetingTags').value.trim();
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
    const meeting = {
        id: document.getElementById('meetingId').value || Date.now().toString(),
        customerId: customerId,
        customerName: customerName,
        date: date,
        type: type,
        duration: document.getElementById('meetingDuration').value,
        title: title,
        tags: tags,
        participants: state.meetingParticipants,
        notes: notesText,
        notesHTML: notesHTML,
        nextSteps: nextStepsText,
        nextStepsHTML: nextStepsHTML,
        followUpDate: document.getElementById('meetingFollowUpDate').value,
        outcome: document.getElementById('meetingOutcome').value,
        meddpicc: {
            metrics: document.getElementById('meddpiccMetrics').value.trim(),
            economicBuyer: document.getElementById('meddpiccEconomicBuyer').value.trim(),
            decisionCriteria: document.getElementById('meddpiccDecisionCriteria').value.trim(),
            decisionProcess: document.getElementById('meddpiccDecisionProcess').value.trim(),
            paperProcess: document.getElementById('meddpiccPaperProcess').value.trim(),
            pain: document.getElementById('meddpiccPain').value.trim(),
            champion: document.getElementById('meddpiccChampion').value.trim(),
            competition: document.getElementById('meddpiccCompetition').value.trim()
        },
        createdAt: state.editingMeeting?.createdAt || new Date().toISOString()
    };
    
    if (state.editingMeeting) {
        const index = state.meetings.findIndex(m => m.id === meeting.id);
        state.meetings[index] = meeting;
        showToast(' Meeting updated!', 'success');
    } else {
        state.meetings.unshift(meeting);
        showToast(' Meeting saved!', 'success');
    }
    
    state.meetingTasks.forEach(taskTitle => {
        const existingTask = state.tasks.find(t => t.meetingId === meeting.id && t.title === taskTitle);
        if (!existingTask) {
            const task = {
                id: Date.now().toString() + Math.random(),
                title: taskTitle,
                description: `From: ${meeting.title}`,
                priority: 'medium',
                status: 'todo',
                dueDate: '',
                tags: ['meeting'],
                color: 'none',
                subtasks: [],
                completed: false,
                archived: false,
                customerId: customerId,
                customerName: customerName,
                meetingId: meeting.id,
                createdAt: new Date().toISOString()
            };
            state.tasks.unshift(task);
        }
    });
    
    saveData();
    renderTasks();
    updateStats();
    renderCustomerFilters();
    
    if (document.getElementById('customerOverviewSection').classList.contains('active')) {
        renderCustomerOverview();
    }
    
    if (state.currentCustomer !== 'all' && state.currentCustomer === customerId) {

        showCustomerMeetingsSection(customerId);
    }
    
    closeInlineMeetingForm();
}
        function generatePreparationExport() {
            const customerName = document.getElementById('preparationCustomerInput').value.trim();
            const goals = document.getElementById('preparationGoals').value.trim();
            const discussionPoints = document.getElementById('preparationDiscussionPoints').value.trim();
            const background = document.getElementById('preparationBackground').value.trim();
            const materials = document.getElementById('preparationMaterials').value.trim();
            const outcomes = document.getElementById('preparationOutcomes').value.trim();
            let exportText = `PREPARATION\n${'='.repeat(40)}\n\n`;
            exportText += `Customer: ${customerName}\n`;
            exportText += `Date: ${new Date().toLocaleString()}\n\n`;
            if (goals) exportText += `GOALS\n${'-'.repeat(40)}\n${goals}\n\n`;
            if (discussionPoints) exportText += `DISCUSSION\n${'-'.repeat(40)}\n${discussionPoints}\n\n`;
            if (background) exportText += `BACKGROUND\n${'-'.repeat(40)}\n${background}\n\n`;
            if (materials) exportText += `MATERIALS\n${'-'.repeat(40)}\n${materials}\n\n`;
            if (outcomes) exportText += `OUTCOMES\n${'-'.repeat(40)}\n${outcomes}\n\n`;
            return exportText;
        }

        function updatePreparationExportPreview() {
            const preview = document.getElementById('preparationExportPreview');
            preview.textContent = generatePreparationExport();
        }

        function copyPreparationToClipboard() {
            const exportText = generatePreparationExport();
            navigator.clipboard.writeText(exportText).then(() => {
                showToast('Copied!', 'success');
            }).catch(() => {
                showToast('Failed', 'error');
            });
        }

        function downloadPreparation() {
            const exportText = generatePreparationExport();
            const customerName = document.getElementById('preparationCustomerInput').value.trim();
            const filename = `prep_${customerName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Downloaded!', 'success');
        }

        function exportPreparationFromList(preparationId) {
            const preparation = state.preparations.find(p => p.id === preparationId);
            if (!preparation) return;
            let exportText = `PREPARATION\n${'='.repeat(40)}\n\n`;
            exportText += `Customer: ${preparation.customerName}\n`;
            exportText += `Date: ${new Date(preparation.createdAt).toLocaleString()}\n\n`;
            if (preparation.goals) exportText += `GOALS\n${'-'.repeat(40)}\n${preparation.goals}\n\n`;
            if (preparation.discussionPoints) exportText += `DISCUSSION\n${'-'.repeat(40)}\n${preparation.discussionPoints}\n\n`;
            if (preparation.background) exportText += `BACKGROUND\n${'-'.repeat(40)}\n${preparation.background}\n\n`;
            if (preparation.materials) exportText += `MATERIALS\n${'-'.repeat(40)}\n${preparation.materials}\n\n`;
            if (preparation.outcomes) exportText += `OUTCOMES\n${'-'.repeat(40)}\n${preparation.outcomes}\n\n`;
            const filename = `prep_${preparation.customerName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            openExportModal(' Export', exportText, filename);
        }

        function addParticipant() {
    const nameInput = document.getElementById('participantNameInput');
    const roleInput = document.getElementById('participantRoleInput');
    const emailInput = document.getElementById('participantEmailInput');
    const phoneInput = document.getElementById('participantPhoneInput');
    
    const name = nameInput.value.trim();
    const role = roleInput.value.trim();
    const email = emailInput.value.trim();
    const phone = phoneInput.value.trim();
    
    if (!name) {
        showToast('Enter name', 'error');
        return;
    }
    
    const participant = { name, role, email, phone };
    
    if (state.editingParticipantIndex !== null) {
        // Update existing participant
        state.meetingParticipants[state.editingParticipantIndex] = participant;
        state.editingParticipantIndex = null;
        document.getElementById('addParticipantBtn').innerHTML = ' Add Participant';
        showToast('Participant updated!', 'success');
    } else {
        // Add new participant
        state.meetingParticipants.push(participant);
    }
    
    nameInput.value = '';
    roleInput.value = '';
    emailInput.value = '';
    phoneInput.value = '';
    
    renderParticipantsList();
}

function editParticipant(index) {
    const participant = state.meetingParticipants[index];
    if (!participant) return;
    
    document.getElementById('participantNameInput').value = participant.name;
    document.getElementById('participantRoleInput').value = participant.role || '';
    document.getElementById('participantEmailInput').value = participant.email || '';
    document.getElementById('participantPhoneInput').value = participant.phone || '';
    
    state.editingParticipantIndex = index;
    document.getElementById('addParticipantBtn').innerHTML = ' Update Participant';
    
    // Scroll to the input area
    document.getElementById('participantNameInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
    document.getElementById('participantNameInput').focus();
}

        function renderParticipantsList() {
    const container = document.getElementById('participantsList');
    if (state.meetingParticipants.length === 0) {
        container.innerHTML = '<div style="padding: 0.75rem; text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No participants added</div>';
        return;
    }
    container.innerHTML = state.meetingParticipants.map((participant, index) => {
        const initials = participant.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        return `
            <div class="participant-card">
                <div class="participant-avatar">${initials}</div>
                <div class="participant-details">
                    <div class="participant-card-name">${escapeHtml(participant.name)}</div>
                    <div class="participant-card-meta">
                        ${participant.role ? `<span> ${escapeHtml(participant.role)}</span>` : ''}
                        ${participant.email ? `<span> ${escapeHtml(participant.email)}</span>` : ''}
                        ${participant.phone ? `<span> ${escapeHtml(participant.phone)}</span>` : ''}
                    </div>
                </div>
                <div class="task-actions">
                    <button type="button" class="task-btn" onclick="editParticipant(${index})" title="Edit">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button type="button" class="task-btn delete" onclick="removeParticipant(${index})" title="Delete">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

        function addQuickTask() {
            const input = document.getElementById('quickTaskInput');
            const taskTitle = input.value.trim();
            if (!taskTitle) {
                showToast('Enter task', 'error');
                return;
            }
            state.meetingTasks.push(taskTitle);
            input.value = '';
            renderMeetingTasksList();
        }

        function removeMeetingTask(index) {
            state.meetingTasks.splice(index, 1);
            renderMeetingTasksList();
        }

        function renderMeetingTasksList() {
            const container = document.getElementById('meetingTasksList');
            if (state.meetingTasks.length === 0) {
                container.innerHTML = '<div style="padding: 0.75rem; text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No tasks</div>';
                return;
            }
            container.innerHTML = state.meetingTasks.map((task, index) => `
                <div class="meeting-task-preview">
                    <span> ${escapeHtml(task)}</span>
                    <button type="button" class="btn-remove-meeting-task" onclick="removeMeetingTask(${index})"></button>
                </div>
            `).join('');
        }

        function handleMeetingSubmit(e) {
            e.preventDefault();
            const customerInput = document.getElementById('meetingCustomerInput').value.trim();
            const title = document.getElementById('meetingTitle').value.trim();
            const date = document.getElementById('meetingDate').value;
            const type = document.getElementById('meetingType').value;
            const notesHTML = getEditorHTML('meetingNotesEditor');
            const notesText = getEditorText('meetingNotesEditor');
            const nextStepsHTML = getEditorHTML('meetingNextStepsEditor');
            const nextStepsText = getEditorText('meetingNextStepsEditor');
            
            if (!customerInput) {
                showToast(' Enter customer', 'error');
                document.querySelector('#inlineMeetingForm .modal-tab[data-tab="info"]').click();
                document.getElementById('meetingCustomerInput').focus();
                return;
            }
            if (!title) {
                showToast(' Enter title', 'error');
                document.querySelector('#inlineMeetingForm .modal-tab[data-tab="info"]').click();
                document.getElementById('meetingTitle').focus();
                return;
            }
            if (!date) {
                showToast(' Select date', 'error');
                document.querySelector('#inlineMeetingForm .modal-tab[data-tab="info"]').click();
                document.getElementById('meetingDate').focus();
                return;
            }
            if (!type) {
                showToast(' Select type', 'error');
                document.querySelector('#inlineMeetingForm .modal-tab[data-tab="info"]').click();
                document.getElementById('meetingType').focus();
                return;
            }
            if (!notesText) {
                showToast(' Enter notes', 'error');
                document.querySelector('#inlineMeetingForm .modal-tab[data-tab="notes"]').click();
                document.getElementById('meetingNotesEditor').focus();
                return;
            }
            let customerId = state.selectedCustomerId;
            let customerName = customerInput;
            if (!customerId && customerInput) {
                const newCustomer = {
                    id: Date.now().toString(),
                    name: customerInput,
                    email: '',
                    phone: '',
                    company: '',
                    notes: '',
                    createdAt: new Date().toISOString()
                };
                state.customers.push(newCustomer);
                customerId = newCustomer.id;
                customerName = newCustomer.name;
                showToast('Customer created!', 'success');
            }
            const tagsInput = document.getElementById('meetingTags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
            const meeting = {
                id: document.getElementById('meetingId').value || Date.now().toString(),
                customerId: customerId,
                customerName: customerName,
                date: document.getElementById('meetingDate').value,
                type: document.getElementById('meetingType').value,
                duration: document.getElementById('meetingDuration').value,
                title: document.getElementById('meetingTitle').value.trim(),
                tags: tags,
                participants: state.meetingParticipants,
                notes: notesText,
                notesHTML: notesHTML,
                nextSteps: nextStepsText,
                nextStepsHTML: nextStepsHTML,
                followUpDate: document.getElementById('meetingFollowUpDate').value,
                outcome: document.getElementById('meetingOutcome').value,
                meddpicc: {
                    metrics: document.getElementById('meddpiccMetrics').value.trim(),
                    economicBuyer: document.getElementById('meddpiccEconomicBuyer').value.trim(),
                    decisionCriteria: document.getElementById('meddpiccDecisionCriteria').value.trim(),
                    decisionProcess: document.getElementById('meddpiccDecisionProcess').value.trim(),
                    paperProcess: document.getElementById('meddpiccPaperProcess').value.trim(),
                    pain: document.getElementById('meddpiccPain').value.trim(),
                    champion: document.getElementById('meddpiccChampion').value.trim(),
                    competition: document.getElementById('meddpiccCompetition').value.trim()
                },
                createdAt: state.editingMeeting?.createdAt || new Date().toISOString()
            };
            if (state.editingMeeting) {
                const index = state.meetings.findIndex(m => m.id === meeting.id);
                state.meetings[index] = meeting;
                showToast('Updated!', 'success');
            } else {
                state.meetings.unshift(meeting);
                showToast('Saved!', 'success');
            }
            state.meetingTasks.forEach(taskTitle => {
                const existingTask = state.tasks.find(t => t.meetingId === meeting.id && t.title === taskTitle);
                if (!existingTask) {
                    const task = {
                        id: Date.now().toString() + Math.random(),
                        title: taskTitle,
                        description: `From: ${meeting.title}`,
                        priority: 'medium',
                        status: 'todo',
                        dueDate: '',
                        tags: ['meeting'],
                        color: 'none',
                        subtasks: [],
                        completed: false,
                        archived: false,
                        customerId: customerId,
                        customerName: customerName,
                        meetingId: meeting.id,
                        createdAt: new Date().toISOString()
                    };
                    state.tasks.unshift(task);
                }
            });
            saveData();
            renderTasks();
            updateStats();
            renderCustomerFilters();
            if (document.getElementById('customerOverviewSection').classList.contains('active')) {
                renderCustomerOverview();
            }
            if (state.currentCustomer !== 'all' && state.currentCustomer === customerId) {
                showCustomerMeetingsSection(customerId);
showCustomerParticipantsSection(customerId);
            }
            closeInlineMeetingForm();
        }

        function generateMeetingExport() {
            const customerName = document.getElementById('meetingCustomerInput').value.trim();
            const title = document.getElementById('meetingTitle').value.trim();
            const date = document.getElementById('meetingDate').value;
            const type = document.getElementById('meetingType').value;
            const duration = document.getElementById('meetingDuration').value;
            const notesHTML = getEditorHTML('meetingNotesEditor');
            const notes = htmlToPlainText(notesHTML);
            const nextStepsHTML = getEditorHTML('meetingNextStepsEditor');
            const nextSteps = htmlToPlainText(nextStepsHTML);
            const metrics = document.getElementById('meddpiccMetrics').value.trim();
            const economicBuyer = document.getElementById('meddpiccEconomicBuyer').value.trim();
            const decisionCriteria = document.getElementById('meddpiccDecisionCriteria').value.trim();
            const decisionProcess = document.getElementById('meddpiccDecisionProcess').value.trim();
            const paperProcess = document.getElementById('meddpiccPaperProcess').value.trim();
            const pain = document.getElementById('meddpiccPain').value.trim();
            const champion = document.getElementById('meddpiccChampion').value.trim();
            const competition = document.getElementById('meddpiccCompetition').value.trim();
            
            let exportText = `MEETING\n${'='.repeat(40)}\n\n`;
            exportText += `Customer: ${customerName}\n`;
            exportText += `Title: ${title}\n`;
            exportText += `Date: ${new Date(date).toLocaleString()}\n`;
            exportText += `Type: ${type}\n`;
            if (duration) exportText += `Duration: ${duration}min\n`;
            exportText += `\n`;
            
if (state.meetingParticipants.length > 0) {
    exportText += `PARTICIPANTS\n${'-'.repeat(40)}\n`;
    state.meetingParticipants.forEach(p => {
        exportText += ` ${p.name}`;
        if (p.role) exportText += `\n  Role: ${p.role}`;
        if (p.email) exportText += `\n  Email: ${p.email}`;
        if (p.phone) exportText += `\n  Phone: ${p.phone}`;
        exportText += `\n`;
    });
    exportText += `\n`;
}
            
            exportText += `NOTES\n${'-'.repeat(40)}\n${notes}\n\n`;
            
            if (nextSteps) {
                exportText += `NEXT STEPS\n${'-'.repeat(40)}\n${nextSteps}\n\n`;
            }
            
            const hasMeddpicc = metrics || economicBuyer || decisionCriteria || decisionProcess || paperProcess || pain || champion || competition;
            if (hasMeddpicc) {
                exportText += `MEDDPICC\n${'='.repeat(40)}\n\n`;
                if (metrics) exportText += ` METRICS\n${metrics}\n\n`;
                if (economicBuyer) exportText += ` BUYER\n${economicBuyer}\n\n`;
                if (decisionCriteria) exportText += ` CRITERIA\n${decisionCriteria}\n\n`;
                if (decisionProcess) exportText += ` PROCESS\n${decisionProcess}\n\n`;
                if (paperProcess) exportText += ` PAPER\n${paperProcess}\n\n`;
                if (pain) exportText += ` PAIN\n${pain}\n\n`;
                if (champion) exportText += ` CHAMPION\n${champion}\n\n`;
                if (competition) exportText += ` COMPETITION\n${competition}\n\n`;
            }
            
            if (state.meetingTasks.length > 0) {
                exportText += `ACTIONS\n${'-'.repeat(40)}\n`;
                state.meetingTasks.forEach((task, i) => {
                    exportText += `${i + 1}. ${task}\n`;
                });
                exportText += `\n`;
            }
            
            return exportText;
        }

        function updateMeetingExportPreview() {
            const preview = document.getElementById('meetingExportPreview');
            preview.textContent = generateMeetingExport();
        }

        function copyMeetingToClipboard() {
            const exportText = generateMeetingExport();
            navigator.clipboard.writeText(exportText).then(() => {
                showToast('Copied!', 'success');
            }).catch(() => {
                showToast('Failed', 'error');
            });
        }

        function downloadMeeting() {
            const exportText = generateMeetingExport();
            const customerName = document.getElementById('meetingCustomerInput').value.trim();
            const title = document.getElementById('meetingTitle').value.trim();
            const filename = `meeting_${customerName.replace(/\s+/g, '_')}_${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Downloaded!', 'success');
        }

        function exportMeetingFromList(meetingId) {
            const meeting = state.meetings.find(m => m.id === meetingId);
            if (!meeting) return;
            const notesText = meeting.notesHTML ? htmlToPlainText(meeting.notesHTML) : meeting.notes;
            const nextStepsText = meeting.nextStepsHTML ? htmlToPlainText(meeting.nextStepsHTML) : meeting.nextSteps;
            
            let exportText = `MEETING\n${'='.repeat(40)}\n\n`;
            exportText += `Customer: ${meeting.customerName || 'N/A'}\n`;
            exportText += `Title: ${meeting.title}\n`;
            exportText += `Date: ${new Date(meeting.date).toLocaleString()}\n`;
            exportText += `Type: ${meeting.type}\n`;
            if (meeting.duration) exportText += `Duration: ${meeting.duration}min\n`;
            exportText += `\n`;
            
if (meeting.participants && meeting.participants.length > 0) {
    exportText += `PARTICIPANTS\n${'-'.repeat(40)}\n`;
    meeting.participants.forEach(p => {
        exportText += ` ${p.name}`;
        if (p.role) exportText += `\n  Role: ${p.role}`;
        if (p.email) exportText += `\n  Email: ${p.email}`;
        if (p.phone) exportText += `\n  Phone: ${p.phone}`;
        exportText += `\n`;
    });
    exportText += `\n`;
}
            
            exportText += `NOTES\n${'-'.repeat(40)}\n${notesText}\n\n`;
            
            if (nextStepsText) {
                exportText += `NEXT STEPS\n${'-'.repeat(40)}\n${nextStepsText}\n\n`;
            }
            
            if (meeting.meddpicc) {
                const m = meeting.meddpicc;
                const hasMeddpicc = m.metrics || m.economicBuyer || m.decisionCriteria || m.decisionProcess || m.paperProcess || m.pain || m.champion || m.competition;
                if (hasMeddpicc) {
                    exportText += `MEDDPICC\n${'='.repeat(40)}\n\n`;
                    if (m.metrics) exportText += ` METRICS\n${m.metrics}\n\n`;
                    if (m.economicBuyer) exportText += ` BUYER\n${m.economicBuyer}\n\n`;
                    if (m.decisionCriteria) exportText += ` CRITERIA\n${m.decisionCriteria}\n\n`;
                    if (m.decisionProcess) exportText += ` PROCESS\n${m.decisionProcess}\n\n`;
                    if (m.paperProcess) exportText += ` PAPER\n${m.paperProcess}\n\n`;
                    if (m.pain) exportText += ` PAIN\n${m.pain}\n\n`;
                    if (m.champion) exportText += ` CHAMPION\n${m.champion}\n\n`;
                    if (m.competition) exportText += ` COMPETITION\n${m.competition}\n\n`;
                }
            }
            
            const meetingTasks = state.tasks.filter(t => t.meetingId === meeting.id);
            if (meetingTasks.length > 0) {
                exportText += `ACTIONS\n${'-'.repeat(40)}\n`;
                meetingTasks.forEach((task, i) => {
                    exportText += `${i + 1}. ${task.title}\n`;
                });
                exportText += `\n`;
            }
            
            const filename = `meeting_${meeting.customerName.replace(/\s+/g, '_')}_${meeting.title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            openExportModal(' Export', exportText, filename);
        }

        function openAllMeetingsModal() {
            renderAllMeetings();
            document.getElementById('allMeetingsModal').classList.add('active');
        }

        function closeAllMeetingsModal() {
            document.getElementById('allMeetingsModal').classList.remove('active');
        }

        function renderAllMeetings() {
            const container = document.getElementById('allMeetingsList');
            const empty = document.getElementById('meetingsEmpty');
            if (state.meetings.length === 0) {
                container.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';
            container.innerHTML = state.meetings.map(meeting => {
                const meetingTasks = state.tasks.filter(t => t.meetingId === meeting.id);
                const meetingDate = new Date(meeting.date);
                const meddpiccScore = calculateMEDDPICCCompletion(meeting);
                const notesText = meeting.notesHTML ? htmlToPlainText(meeting.notesHTML) : meeting.notes;
                return `
                    <div class="meeting-card">
                        <div class="meeting-header">
                            <div class="meeting-info">
                                <h3>${escapeHtml(meeting.title)}</h3>
                                <div class="meeting-date">
                                     ${meetingDate.toLocaleDateString()}
                                    ${meeting.customerName ? `   ${escapeHtml(meeting.customerName)}` : ''}
                                    ${meeting.type ? `   ${escapeHtml(meeting.type)}` : ''}
                                </div>
                            </div>
                            <div class="task-actions">
    <button class="task-btn" onclick="editMeeting('${meeting.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
    </button>
    <button class="task-btn" onclick="exportMeetingFromList('${meeting.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
    </button>
    <button class="task-btn delete" onclick="deleteMeeting('${meeting.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
    </button>
</div>
                        </div>
                        ${meddpiccScore.completed > 0 ? `
                            <div class="meddpicc-section">
                                <div class="meddpicc-section-title"> MEDDPICC (${meddpiccScore.completed}/8)</div>
                            </div>
                        ` : ''}
                        ${meeting.tags && meeting.tags.length > 0 ? `
                            <div style="margin-bottom: 0.5rem;">
                                ${meeting.tags.map(tag => `<span class="meeting-tag">${escapeHtml(tag)}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div class="meeting-notes">${escapeHtml(notesText)}</div>
                        ${meetingTasks.length > 0 ? `
                            <div class="meeting-tasks">
                                <div class="meeting-tasks-title"> Actions (${meetingTasks.length})</div>
                                ${meetingTasks.map(task => `
                                    <div class="meeting-task-item">${task.completed ? '' : ''} ${escapeHtml(task.title)}</div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function editMeeting(meetingId) {
            const meeting = state.meetings.find(m => m.id === meetingId);
            if (meeting) {
                openInlineMeetingForm(meeting);
                closeAllMeetingsModal();
            }
        }

        function deleteMeeting(meetingId) {
            showConfirm('', 'Delete?', 'Delete meeting?', () => {
                state.meetings = state.meetings.filter(m => m.id !== meetingId);
                state.tasks.forEach(task => {
                    if (task.meetingId === meetingId) {
                        delete task.meetingId;
                    }
                });
                saveData();
                renderAllMeetings();
                renderTasks();
                updateStats();
                if (state.currentCustomer !== 'all') {
                    showCustomerMeetingsSection(state.currentCustomer);
                }
                showToast('Deleted', 'success');
            });
        }

        function openTaskModal(task = null) {
            state.editingTask = task;
            state.selectedColor = 'none';
            state.selectedTaskCustomerId = null;
            if (task) {
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskCustomerInput').value = task.customerName || '';
                state.selectedTaskCustomerId = task.customerId || null;
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskStatus').value = task.status || 'todo';
                document.getElementById('taskDueDate').value = task.dueDate || '';
                document.getElementById('taskTags').value = task.tags.join(', ');
                document.getElementById('taskColor').value = task.color || 'none';
                document.getElementById('taskMeetingId').value = task.meetingId || '';
                state.selectedColor = task.color || 'none';
                document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                const colorOption = document.querySelector(`.color-option[data-color="${state.selectedColor}"]`);
                if (colorOption) colorOption.classList.add('selected');
                const subtasksForm = document.getElementById('subtasksForm');
                subtasksForm.innerHTML = '';
                task.subtasks.forEach(sub => {
                    addSubtaskInput(sub.text, sub.completed);
                });
            } else {
                document.getElementById('taskForm').reset();
                document.getElementById('taskCustomerInput').value = '';
                document.getElementById('subtasksForm').innerHTML = '';
                document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                document.querySelector('.color-option[data-color="none"]').classList.add('selected');
            }
            document.getElementById('taskModal').classList.add('active');
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            state.editingTask = null;
            state.selectedTaskCustomerId = null;
        }

        function addSubtaskInput(text = '', completed = false) {
            const container = document.getElementById('subtasksForm');
            const div = document.createElement('div');
            div.className = 'subtask-input-group';
            div.innerHTML = `
                <input type="text" class="form-input subtask-input" value="${escapeHtml(text)}" placeholder="Subtask...">
                <button type="button" class="btn-remove-subtask" onclick="this.parentElement.remove()"></button>
            `;
            container.appendChild(div);
        }

        function handleTaskSubmit(e) {
            e.preventDefault();
            const subtaskInputs = document.querySelectorAll('.subtask-input');
            const subtasks = Array.from(subtaskInputs)
                .map(input => ({ text: input.value.trim(), completed: false }))
                .filter(sub => sub.text);
            const customerInputValue = document.getElementById('taskCustomerInput').value.trim();
            let customerId = state.selectedTaskCustomerId;
            let customerName = customerInputValue;
            if (!customerId && customerInputValue) {
                const existingCustomer = state.customers.find(c => c.name.toLowerCase() === customerInputValue.toLowerCase());
                if (existingCustomer) {
                    customerId = existingCustomer.id;
                    customerName = existingCustomer.name;
                } else {
                    const newCustomer = {
                        id: Date.now().toString(),
                        name: customerInputValue,
                        email: '',
                        phone: '',
                        company: '',
                        notes: '',
                        createdAt: new Date().toISOString()
                    };
                    state.customers.push(newCustomer);
                    customerId = newCustomer.id;
                    customerName = newCustomer.name;
                    showToast('Customer created!', 'success');
                }
            }
            const task = {
                id: document.getElementById('taskId').value || Date.now().toString(),
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                customerId: customerId || null,
                customerName: customerName || '',
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                dueDate: document.getElementById('taskDueDate').value,
                tags: document.getElementById('taskTags').value.split(',').map(t => t.trim()).filter(t => t),
                color: document.getElementById('taskColor').value,
                subtasks: subtasks,
                completed: state.editingTask?.completed || false,
                archived: state.editingTask?.archived || false,
                meetingId: state.editingTask?.meetingId || null,
                createdAt: state.editingTask?.createdAt || new Date().toISOString()
            };
            if (state.editingTask) {
                const index = state.tasks.findIndex(t => t.id === task.id);
                state.tasks[index] = task;
                showToast('Updated!', 'success');
            } else {
                state.tasks.unshift(task);
                showToast('Created!', 'success');
            }
            saveData();
            renderTasks();
            updateStats();
            renderCustomerFilters();
            if (document.getElementById('customerOverviewSection').classList.contains('active')) {
                renderCustomerOverview();
            }
            closeTaskModal();
        }

        function openNoteModal(note = null) {
            state.editingNote = note;
            if (note) {
                document.getElementById('noteId').value = note.id;
                document.getElementById('noteContent').value = note.content;
            } else {
                document.getElementById('noteForm').reset();
            }
            document.getElementById('noteModal').classList.add('active');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            state.editingNote = null;
        }

        function handleNoteSubmit(e) {
            e.preventDefault();
            const note = {
                id: document.getElementById('noteId').value || Date.now().toString(),
                content: document.getElementById('noteContent').value.trim(),
                createdAt: state.editingNote?.createdAt || new Date().toISOString()
            };
            if (state.editingNote) {
                const index = state.notes.findIndex(n => n.id === note.id);
                state.notes[index] = note;
                showToast('Updated!', 'success');
            } else {
                state.notes.unshift(note);
                showToast('Created!', 'success');
            }
            saveData();
            renderNotes();
            closeNoteModal();
        }

        let currentExportData = null;

        function openExportModal(title, content, filename) {
            currentExportData = { content, filename };
            document.getElementById('exportModalTitle').textContent = title;
            document.getElementById('exportModalPreview').textContent = content;
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
            currentExportData = null;
        }

        function copyFromExportModal() {
            if (currentExportData) {
                navigator.clipboard.writeText(currentExportData.content).then(() => {
                    showToast('Copied!', 'success');
                }).catch(() => {
                    showToast('Failed', 'error');
                });
            }
        }

        function downloadFromExportModal() {
            if (currentExportData) {
                const blob = new Blob([currentExportData.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentExportData.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Downloaded!', 'success');
            }
        }

        function showConfirm(icon, title, message, callback) {
            document.getElementById('confirmIcon').textContent = icon;
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            state.confirmCallback = callback;
            const confirmBtn = document.getElementById('confirmBtn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                if (state.confirmCallback) {
                    state.confirmCallback();
                }
                closeConfirmModal();
            });
            document.getElementById('confirmModal').classList.add('active');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            state.confirmCallback = null;
        }

        function confirmClearAll() {
            state.tasks = [];
            state.notes = [];
            state.customers = [];
            state.meetings = [];
            state.preparations = [];
            localStorage.removeItem('taskflow_tasks');
            localStorage.removeItem('taskflow_notes');
            localStorage.removeItem('taskflow_customers');
            localStorage.removeItem('taskflow_meetings');
            localStorage.removeItem('taskflow_preparations');
            render();
            updateStats();
            renderCustomerFilters();
            hideCustomerMeetingsSection();
            hideCustomerPreparationsSection();
            hideCustomerOverview();
            updateSectionTitle();
            showToast('Cleared!', 'success');
        }

        function toggleTaskComplete(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    task.status = 'done';
                } else if (task.status === 'done') {
                    task.status = 'todo';
                }
                saveData();
                renderTasks();
                updateStats();
                if (document.getElementById('customerOverviewSection').classList.contains('active')) {
                    renderCustomerOverview();
                }
            }
        }

        function toggleSubtask(taskId, subtaskIndex) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task && task.subtasks[subtaskIndex]) {
                task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
                saveData();
                renderTasks();
            }
        }

        function editTask(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) openTaskModal(task);
        }

        function deleteTask(id) {
            showConfirm('', 'Delete?', 'Delete task?', () => {
                state.tasks = state.tasks.filter(t => t.id !== id);
                saveData();
                renderTasks();
                updateStats();
                renderCustomerFilters();
                if (document.getElementById('customerOverviewSection').classList.contains('active')) {
                    renderCustomerOverview();
                }
                showToast('Deleted', 'success');
            });
        }

        function archiveTask(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.archived = !task.archived;
                saveData();
                renderTasks();
                renderCustomerFilters();
                if (document.getElementById('customerOverviewSection').classList.contains('active')) {
                    renderCustomerOverview();
                }
                showToast(task.archived ? 'Archived' : 'Unarchived', 'success');
            }
        }

        function changeTaskStatus(taskId, newStatus) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = newStatus;
                if (newStatus === 'done') {
                    task.completed = true;
                } else {
                    task.completed = false;
                }
                saveData();
                renderTasks();
                updateStats();
            }
        }

        function showArchived() {
            state.currentView = 'archived';
            document.querySelectorAll('.view-btn[data-view="active"], .view-btn[data-view="archived"]').forEach(b => b.classList.remove('active'));
            document.querySelector('.view-btn[data-view="archived"]').classList.add('active');
            renderTasks();
        }

        function editNote(id) {
            const note = state.notes.find(n => n.id === id);
            if (note) openNoteModal(note);
        }

        function deleteNote(id) {
            showConfirm('', 'Delete?', 'Delete note?', () => {
                state.notes = state.notes.filter(n => n.id !== id);
                saveData();
                renderNotes();
                showToast('Deleted', 'success');
            });
        }

function render() {
    renderTasks();
    renderNotes();
    
    // Also update customer overview if it's visible
    if (document.getElementById('customerOverviewSection').classList.contains('active')) {
        renderCustomerOverview();
    }
}

        function renderTasks() {
            if (state.currentDisplayMode === 'kanban') {
                renderKanban();
            } else {
                renderList();
            }
        }

function renderList() {
    let tasks = state.tasks.filter(t => t.archived === (state.currentView === 'archived'));
    
    // Filter by customer
    if (state.currentCustomer !== 'all') {
        tasks = tasks.filter(t => t.customerId === state.currentCustomer);
    }
    
    // Filter by search query
    if (state.searchQuery) {
        tasks = tasks.filter(t => {
            const matchesTitle = t.title.toLowerCase().includes(state.searchQuery);
            const matchesDescription = t.description.toLowerCase().includes(state.searchQuery);
            const matchesCustomerName = t.customerName && t.customerName.toLowerCase().includes(state.searchQuery);
            const matchesTags = t.tags.some(tag => tag.toLowerCase().includes(state.searchQuery));
            
            // Search company name
            let matchesCompany = false;
            if (t.customerId) {
                const customer = state.customers.find(c => c.id === t.customerId);
                if (customer && customer.company) {
                    matchesCompany = customer.company.toLowerCase().includes(state.searchQuery);
                }
            }
            
            // Search meeting participant names and roles
            let matchesParticipant = false;
            if (t.meetingId) {
                const meeting = state.meetings.find(m => m.id === t.meetingId);
                if (meeting && meeting.participants) {
                    matchesParticipant = meeting.participants.some(p => 
                        (p.role && p.role.toLowerCase().includes(state.searchQuery)) ||
                        (p.name && p.name.toLowerCase().includes(state.searchQuery))
                    );
                }
            }
            
            return matchesTitle || matchesDescription || matchesCustomerName || 
                   matchesTags || matchesCompany || matchesParticipant;
        });
    }
    
    // Filter by time/priority
    const today = new Date().toISOString().split('T')[0];
    const weekFromNow = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    switch (state.currentFilter) {
        case 'today':
            tasks = tasks.filter(t => t.dueDate === today);
            break;
        case 'week':
            tasks = tasks.filter(t => t.dueDate && t.dueDate <= weekFromNow);
            break;
        case 'overdue':
            tasks = tasks.filter(t => t.dueDate && t.dueDate < today && !t.completed);
            break;
        case 'high':
            tasks = tasks.filter(t => t.priority === 'high');
            break;
    }
    
    const container = document.getElementById('tasksList');
    const empty = document.getElementById('tasksEmpty');
    if (tasks.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        if (state.searchQuery) {
            empty.innerHTML = `
                <div class="empty-state-icon"></div>
                <div>No results for "${escapeHtml(state.searchQuery)}"</div>
            `;
        } else {
            empty.innerHTML = `
                <div class="empty-state-icon"></div>
                <div>No tasks</div>
            `;
        }
        return;
    }
    empty.style.display = 'none';
    container.innerHTML = tasks.map((task, index) => createTaskCard(task, index + 1)).join('');
    setupDragDrop();
}

function renderKanban() {
    let tasks = state.tasks.filter(t => !t.archived);
    
    if (state.currentCustomer !== 'all') {
        tasks = tasks.filter(t => t.customerId === state.currentCustomer);
    }
    
    // ADD THIS BLOCK for search filtering
    if (state.searchQuery) {
        tasks = tasks.filter(t => {
            const matchesTitle = t.title.toLowerCase().includes(state.searchQuery);
            const matchesDescription = t.description.toLowerCase().includes(state.searchQuery);
            const matchesCustomerName = t.customerName && t.customerName.toLowerCase().includes(state.searchQuery);
            const matchesTags = t.tags.some(tag => tag.toLowerCase().includes(state.searchQuery));
            
            let matchesCompany = false;
            if (t.customerId) {
                const customer = state.customers.find(c => c.id === t.customerId);
                if (customer && customer.company) {
                    matchesCompany = customer.company.toLowerCase().includes(state.searchQuery);
                }
            }
            
            let matchesParticipant = false;
            if (t.meetingId) {
                const meeting = state.meetings.find(m => m.id === t.meetingId);
                if (meeting && meeting.participants) {
                    matchesParticipant = meeting.participants.some(p => 
                        (p.role && p.role.toLowerCase().includes(state.searchQuery)) ||
                        (p.name && p.name.toLowerCase().includes(state.searchQuery))
                    );
                }
            }
            
            return matchesTitle || matchesDescription || matchesCustomerName || 
                   matchesTags || matchesCompany || matchesParticipant;
        });
    }
            const todoTasks = tasks.filter(t => t.status === 'todo');
            const progressTasks = tasks.filter(t => t.status === 'in-progress');
            const doneTasks = tasks.filter(t => t.status === 'done');
            document.getElementById('todoCount').textContent = todoTasks.length;
            document.getElementById('progressCount').textContent = progressTasks.length;
            document.getElementById('doneCount').textContent = doneTasks.length;
            document.getElementById('todoColumn').innerHTML = todoTasks.map((task, index) => createTaskCard(task, index + 1, true)).join('');
            document.getElementById('progressColumn').innerHTML = progressTasks.map((task, index) => createTaskCard(task, index + 1, true)).join('');
            document.getElementById('doneColumn').innerHTML = doneTasks.map((task, index) => createTaskCard(task, index + 1, true)).join('');
            setupKanbanDragDrop();
        }

        function setupDragDrop() {
            const tasksList = document.getElementById('tasksList');
            let draggedElement = null;
            tasksList.querySelectorAll('.task-card').forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedElement = card;
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    updateTaskOrder();
                });
            });
            tasksList.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(tasksList, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (afterElement == null) {
                    tasksList.appendChild(dragging);
                } else {
                    tasksList.insertBefore(dragging, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateTaskOrder() {
            const taskElements = document.querySelectorAll('#tasksList .task-card');
            const newOrder = [];
            taskElements.forEach(el => {
                const taskId = el.dataset.taskId;
                const task = state.tasks.find(t => t.id === taskId);
                if (task) newOrder.push(task);
            });
            state.tasks = newOrder.concat(state.tasks.filter(t => !newOrder.includes(t)));
            saveData();
            showToast('Reordered', 'success');
        }

        function setupKanbanDragDrop() {
            const columns = document.querySelectorAll('.kanban-cards');
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });
                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });
                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    const taskId = e.dataTransfer.getData('text/plain');
                    const newStatus = column.dataset.status;
                    changeTaskStatus(taskId, newStatus);
                });
            });
            const cards = document.querySelectorAll('.kanban-cards .task-card');
            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', card.dataset.taskId);
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });
        }

        function createTaskCard(task, number, isKanban = false) {
            const today = new Date().toISOString().split('T')[0];
            const threeDays = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            let dueDateClass = '';
            let dueDateText = '';
            if (task.dueDate) {
                if (task.dueDate < today && !task.completed) {
                    dueDateClass = 'overdue';
                    dueDateText = ' Overdue';
                } else if (task.dueDate <= threeDays && !task.completed) {
                    dueDateClass = 'due-soon';
                    dueDateText = ' Soon';
                } else {
                    dueDateText = ` ${task.dueDate}`;
                }
            }
            const colorClass = task.color && task.color !== 'none' ? `color-${task.color}` : '';
            return `
                <div class="task-card ${dueDateClass} ${colorClass}" draggable="true" data-task-id="${task.id}">
                    <div class="task-number">${number}</div>
                    <div class="task-checkbox ${task.completed ? 'completed' : ''}" onclick="event.stopPropagation(); toggleTaskComplete('${task.id}')">
                        <svg viewBox="0 0 24 24">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="task-content">
                        <div class="task-header">
                            <div style="flex: 1;">
                                ${task.customerName ? `<div style="font-size: 0.95rem; font-weight: 700; color: #667eea; margin-bottom: 0.25rem;"> ${escapeHtml(task.customerName)}</div>` : ''}
                                <div class="task-title ${task.completed ? 'completed' : ''}">${escapeHtml(task.title)}</div>
                            </div>
                            <div class="task-badges">
                                ${task.meetingId ? '<span class="task-meeting-badge"></span>' : ''}
                                <span class="task-priority priority-${task.priority}">${task.priority}</span>
                            </div>
                        </div>
                        ${task.dueDate ? `<div class="task-due-date ${dueDateClass}">${dueDateText}</div>` : ''}
                        ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                        ${task.subtasks.length > 0 ? `
                            <div class="subtasks-container">
                                ${task.subtasks.map((sub, i) => `
                                    <div class="subtask-item">
                                        <div class="subtask-checkbox ${sub.completed ? 'completed' : ''}" onclick="event.stopPropagation(); toggleSubtask('${task.id}', ${i})"></div>
                                        <span class="subtask-text ${sub.completed ? 'completed' : ''}">${escapeHtml(sub.text)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="task-meta">
                            <div class="task-tags">
                                ${task.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                            </div>
                            <div class="task-actions">
                                <button class="task-btn" onclick="event.stopPropagation(); editTask('${task.id}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="task-btn archive" onclick="event.stopPropagation(); archiveTask('${task.id}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                                        <rect x="1" y="3" width="22" height="5"></rect>
                                        <line x1="10" y1="12" x2="14" y2="12"></line>
                                    </svg>
                                </button>
                                <button class="task-btn delete" onclick="event.stopPropagation(); deleteTask('${task.id}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNotes() {
    const container = document.getElementById('notesList');
    const empty = document.getElementById('notesEmpty');
    
    if (state.notes.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    const gradients = [
        'linear-gradient(135deg, #00CEC8 0%, #00A8A3 100%)',
        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
    ];
    
    container.innerHTML = state.notes.map((note, i) => `
        <div class="note-box" style="background: ${gradients[i % gradients.length]}" draggable="true" data-note-id="${note.id}">
            <div class="note-number">${i + 1}</div>
            <div class="note-content">${escapeHtml(note.content)}</div>
            <div class="note-actions">
                <button class="note-btn" onclick="event.stopPropagation(); editNote('${note.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="note-btn" onclick="event.stopPropagation(); deleteNote('${note.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

        function updateStats() {
            const total = state.tasks.filter(t => !t.archived).length;
            const active = state.tasks.filter(t => !t.completed && !t.archived).length;
            const completed = state.tasks.filter(t => t.completed && !t.archived).length;
            const meetings = state.meetings.length;
            const customers = state.customers.length;
            const preparations = state.preparations.length;
            
            document.getElementById('dashStatTotal').textContent = total;
            document.getElementById('dashStatActive').textContent = active;
            document.getElementById('dashStatCompleted').textContent = completed;
            document.getElementById('dashStatMeetings').textContent = meetings;
            document.getElementById('dashStatCustomers').textContent = customers;
            document.getElementById('dashStatPreparations').textContent = preparations;
            
            updateMeetingTypesBreakdown();
        }

        function updateMeetingTypesBreakdown() {
            const meetingTypes = {
                discovery: 0,
                demo: 0,
                'follow-up': 0,
                quarterly: 0,
                sales: 0,
                other: 0
            };
            
            state.meetings.forEach(meeting => {
                const type = meeting.type || 'other';
                if (meetingTypes.hasOwnProperty(type)) {
                    meetingTypes[type]++;
                } else {
                    meetingTypes.other++;
                }
            });
            
            const container = document.getElementById('dashboardMeetingsBreakdown');
            
            if (state.meetings.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 1rem; color: var(--text-secondary); font-size: 0.85rem;">No meetings yet</div>';
                return;
            }
            
            const typeIcons = {
                discovery: '',
                demo: '',
                'follow-up': '',
                quarterly: '',
                sales: '',
                other: ''
            };
            
            container.innerHTML = Object.entries(meetingTypes)
                .filter(([type, count]) => count > 0)
                .map(([type, count]) => `
                    <div class="meeting-type-card ${type}">
                        <div class="meeting-type-count">${typeIcons[type]} ${count}</div>
                        <div class="meeting-type-label">${type.replace('-', ' ')}</div>
                    </div>
                `).join('');
        }

function handleSearch(e) {
    state.searchQuery = e.target.value.toLowerCase();
    render();
}

        function toggleTheme() {
            const current = document.body.dataset.theme;
            document.body.dataset.theme = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', document.body.dataset.theme);
            showToast('Theme changed', 'success');
        }

        function saveData() {
    // Don't save if no user is logged in
    if (!state.currentUser) {
        console.warn('No user signed in, not saving data');
        return;
    }
    
    // Save with user-specific prefix
    const userPrefix = `user_${state.currentUser.uid}_`;
    
    localStorage.setItem(userPrefix + 'taskflow_tasks', JSON.stringify(state.tasks));
    localStorage.setItem(userPrefix + 'taskflow_notes', JSON.stringify(state.notes));
    localStorage.setItem(userPrefix + 'taskflow_customers', JSON.stringify(state.customers));
    localStorage.setItem(userPrefix + 'taskflow_meetings', JSON.stringify(state.meetings));
    localStorage.setItem(userPrefix + 'taskflow_preparations', JSON.stringify(state.preparations));
}

function loadData() {
    // Only load theme here - user data loaded after auth
    const theme = localStorage.getItem('theme');
    if (theme) document.body.dataset.theme = theme;
}

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

// Section collapse/expand
function toggleSection(header) {
    const section = header.parentElement;
    section.classList.toggle('collapsed');
}

// Preparation templates
function applyPrepTemplate(type) {
    const templates = {
        discovery: {
            goals: " Understand current workflow and challenges\n Identify key stakeholders\n Determine budget and timeline\n Establish decision-making process",
            discussion: " Current solution and pain points\n Team size and structure\n Key metrics and KPIs\n Decision criteria and timeline",
            outcomes: " Clear understanding of their needs\n Next meeting scheduled\n Follow-up materials sent"
        },
        demo: {
            goals: " Showcase key features relevant to their needs\n Address technical questions\n Demonstrate ROI\n Secure commitment for next steps",
            discussion: " Product walkthrough\n Integration requirements\n Security and compliance\n Pricing and packages",
            outcomes: " Proof of concept agreed\n Technical requirements documented\n Trial period scheduled"
        },
        quarterly: {
            goals: " Review progress and metrics\n Discuss challenges and wins\n Plan for next quarter\n Identify expansion opportunities",
            discussion: " Usage metrics and adoption\n Feedback and feature requests\n Upcoming initiatives\n Renewal timeline",
            outcomes: " Action items documented\n Renewal discussion initiated\n Next review scheduled"
        },
        negotiation: {
            goals: " Address pricing concerns\n Finalize terms and conditions\n Secure commitment\n Close the deal",
            discussion: " Pricing and discounts\n Contract terms\n Implementation timeline\n Success metrics",
            outcomes: " Agreement on terms\n Contract sent for signature\n Kickoff meeting scheduled"
        }
    };
    
    const template = templates[type];
    if (template) {
        document.getElementById('preparationGoals').value = template.goals;
        document.getElementById('preparationDiscussionPoints').value = template.discussion;
        document.getElementById('preparationOutcomes').value = template.outcomes;
        showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} template applied!`, 'success');
    }
}

// Meeting type selection
function selectMeetingType(type) {
    document.querySelectorAll('.meeting-type-pill').forEach(pill => pill.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    document.getElementById('meetingType').value = type;
}

// Outcome selection
function selectOutcome(outcome) {
    document.querySelectorAll('.outcome-option').forEach(opt => opt.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    document.getElementById('meetingOutcome').value = outcome;
}



function removeParticipant(index) {
    state.meetingParticipants.splice(index, 1);
    
    // Reset editing state if we're deleting the participant being edited
    if (state.editingParticipantIndex === index) {
        state.editingParticipantIndex = null;
        document.getElementById('addParticipantBtn').innerHTML = ' Add Participant';
        document.getElementById('participantNameInput').value = '';
        document.getElementById('participantRoleInput').value = '';
        document.getElementById('participantEmailInput').value = '';
        document.getElementById('participantPhoneInput').value = '';
    } else if (state.editingParticipantIndex !== null && state.editingParticipantIndex > index) {
        // Adjust index if we deleted someone before the one being edited
        state.editingParticipantIndex--;
    }
    
    renderParticipantsList();
}



// MEDDPICC visual tracker update
function updateMeddpiccVisualTracker() {
    const fields = ['Metrics', 'EconomicBuyer', 'DecisionCriteria', 'DecisionProcess', 'PaperProcess', 'Pain', 'Champion', 'Competition'];
    fields.forEach(field => {
        const value = document.getElementById(`meddpicc${field}`).value.trim();
        const tracker = document.querySelector(`.meddpicc-tracker-item[onclick="focusMeddpiccField('${field}')"]`);
        if (value) {
            tracker.classList.add('completed');
        } else {
            tracker.classList.remove('completed');
        }
    });
}

function focusMeddpiccField(field) {
    document.getElementById(`meddpicc${field}`).focus();
}

// Update existing openInlineMeetingForm to set up trackers
const originalOpenMeetingForm = openInlineMeetingForm;
openInlineMeetingForm = function(meeting = null) {
    originalOpenMeetingForm(meeting);
    
    // Set up meeting type
    if (meeting && meeting.type) {
        document.querySelectorAll('.meeting-type-pill').forEach(pill => {
            if (pill.onclick.toString().includes(meeting.type)) {
                pill.classList.add('selected');
            }
        });
    }
    
    // Set up outcome
    if (meeting && meeting.outcome) {
        document.querySelectorAll('.outcome-option').forEach(opt => {
            if (opt.onclick.toString().includes(meeting.outcome)) {
                opt.classList.add('selected');
            }
        });
    }
    
    // Update MEDDPICC tracker
    setTimeout(updateMeddpiccVisualTracker, 100);
};

// Add input listeners for MEDDPICC fields
document.addEventListener('DOMContentLoaded', () => {
    ['Metrics', 'EconomicBuyer', 'DecisionCriteria', 'DecisionProcess', 'PaperProcess', 'Pain', 'Champion', 'Competition'].forEach(field => {
        const element = document.getElementById(`meddpicc${field}`);
        if (element) {
            element.addEventListener('input', updateMeddpiccVisualTracker);
        }
    });
});

// ========================================
// AUTHENTICATION FUNCTIONS
// ========================================

function initAuth() {
    const authLoading = document.getElementById('authLoading');
    const signInBtn = document.getElementById('signInBtn');
    const userProfile = document.getElementById('userProfile');
    
    // Listen for authentication state changes
    auth.onAuthStateChanged((user) => {
        authLoading.style.display = 'none';
        
        if (user) {
            // User is signed in
            state.currentUser = {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName,
                photoURL: user.photoURL
            };
            
            signInBtn.style.display = 'none';
            userProfile.style.display = 'block';
            
            // Set user info in dropdown
            document.getElementById('userAvatar').src = user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || user.email);
            document.getElementById('userName').textContent = user.displayName || 'User';
            document.getElementById('userEmail').textContent = user.email;
            
            showToast(' Signed in as ' + (user.displayName || user.email), 'success');
            
            // Load this user's data
            loadUserData(user.uid);
        } else {
            // User is signed out
            state.currentUser = null;
            signInBtn.style.display = 'flex';
            userProfile.style.display = 'none';
        }
    });
}

function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.addScope('email');
    provider.addScope('profile');
    
    auth.signInWithPopup(provider)
        .then((result) => {
            console.log(' Sign in successful:', result.user.email);
        })
        .catch((error) => {
            console.error(' Sign in error:', error);
            showToast(' Sign in failed: ' + error.message, 'error');
        });
}

function signOut() {
    auth.signOut()
        .then(() => {
            showToast(' Signed out successfully', 'success');
            
            // Clear all data
            state.tasks = [];
            state.notes = [];
            state.customers = [];
            state.meetings = [];
            state.preparations = [];
            
            render();
            updateStats();
            renderCustomerFilters();
            showDashboard();
        })
        .catch((error) => {
            console.error(' Sign out error:', error);
            showToast(' Sign out failed', 'error');
        });
}

function loadUserData(uid) {
    const userPrefix = `user_${uid}_`;
    
    const tasks = localStorage.getItem(userPrefix + 'taskflow_tasks');
    const notes = localStorage.getItem(userPrefix + 'taskflow_notes');
    const customers = localStorage.getItem(userPrefix + 'taskflow_customers');
    const meetings = localStorage.getItem(userPrefix + 'taskflow_meetings');
    const preparations = localStorage.getItem(userPrefix + 'taskflow_preparations');
    
    if (tasks) state.tasks = JSON.parse(tasks);
    if (notes) state.notes = JSON.parse(notes);
    if (customers) state.customers = JSON.parse(customers);
    if (meetings) state.meetings = JSON.parse(meetings);
    if (preparations) state.preparations = JSON.parse(preparations);
    
    render();
    updateStats();
    renderCustomerFilters();
}

function setupAuthListeners() {
    document.getElementById('signInBtn').addEventListener('click', signInWithGoogle);
    document.getElementById('signOutBtn').addEventListener('click', signOut);
    
    // Toggle user dropdown
    document.getElementById('userProfileBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('userDropdown').classList.toggle('active');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('userDropdown');
        const profileBtn = document.getElementById('userProfileBtn');
        if (!profileBtn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('active');
        }
    });
}

        init();
        window.addEventListener('beforeunload', saveData);
    </script>
</body>
</html>
