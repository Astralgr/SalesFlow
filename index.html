<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mnimi</title>
    <style>
       * {margin: 0; padding: 0; box-sizing: border-box;}

:root {
    --primary: #00CEC8; --primary-dark: #00B8B3; --secondary: #00A8A3;
    --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
    --bg-primary: #ffffff; --bg-secondary: #f9fafb; --bg-tertiary: #f3f4f6;
    --text-primary: #111827; --text-secondary: #6b7280; --text-tertiary: #9ca3af;
    --border: #e5e7eb; --shadow: rgba(0, 0, 0, 0.1); --sidebar-width: 190px;
    --font-regular: 400; --font-medium: 500; --font-semibold: 600; --font-bold: 700;
}

[data-theme="dark"] {
    --primary: #00E5DD; --primary-dark: #00F5ED; --secondary: #00D9D3;
    --success: #34d399; --danger: #f87171; --warning: #fbbf24; --info: #60a5fa;
    --bg-primary: #0a0a0a; --bg-secondary: #1a1a1a; --bg-tertiary: #2a2a2a;
    --text-primary: #ffffff; --text-secondary: rgba(255, 255, 255, 0.7);
    --text-tertiary: rgba(255, 255, 255, 0.5); --border: #333; --shadow: rgba(0, 0, 0, 0.5);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-secondary); color: var(--text-primary);
    line-height: 1.4; font-size: 14px; font-weight: var(--font-regular);
    transition: background-color 0.3s, color 0.3s;
}

* {transition: background-color 0.3s, border-color 0.3s, color 0.3s;}

h1, h2, h3, h4, h5, h6 {
    font-weight: var(--font-bold); color: var(--text-primary);
    letter-spacing: -0.02em; line-height: 1.2;
}
h1 {font-size: 2rem;} h2 {font-size: 1.5rem;} h3 {font-size: 1.25rem;}
h4 {font-size: 1.1rem;} h5 {font-size: 1rem;} h6 {font-size: 0.9rem;}

.text-heading {font-weight: var(--font-bold); color: var(--text-primary);}
.text-subheading {font-weight: var(--font-semibold); color: var(--text-primary);}
.text-body {font-weight: var(--font-regular); color: var(--text-primary);}
.text-label {
    font-weight: var(--font-medium); color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem;
}
.text-caption {font-weight: var(--font-regular); color: var(--text-tertiary); font-size: 0.8rem;}
.text-primary-color {color: var(--text-primary);}
.text-secondary-color {color: var(--text-secondary);}
.text-tertiary-color {color: var(--text-tertiary);}

.btn-view-all-notes {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
    color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px;
    cursor: pointer; font-size: 0.8rem; font-weight: 600;
    display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;
    white-space: nowrap; box-shadow: 0 2px 8px rgba(27, 168, 175, 0.3);
}

.consolidated-meeting-block {
    background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem;
    margin-bottom: 1.5rem; border-left: 4px solid #667eea;
}
.consolidated-meeting-header {margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--border);}
.consolidated-meeting-title {font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;}
.consolidated-meeting-meta {display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.85rem; color: var(--text-secondary);}
.consolidated-meeting-meta-item {display: flex; align-items: center; gap: 0.35rem;}
.consolidated-meeting-notes {
    font-size: 0.9rem; line-height: 1.7; white-space: pre-wrap;
    color: var(--text-primary); margin-bottom: 1rem;
}
.consolidated-meeting-nextsteps, .consolidated-meeting-participants {
    background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-top: 1rem;
}
.consolidated-meeting-nextsteps-title, .consolidated-meeting-participants-title {
    font-size: 0.85rem; font-weight: 700; color: var(--text-secondary);
    text-transform: uppercase; margin-bottom: 0.5rem;
}
.consolidated-meeting-nextsteps-content {font-size: 0.85rem; line-height: 1.6; white-space: pre-wrap;}
.consolidated-participant-item {
    font-size: 0.85rem; margin-bottom: 0.5rem; padding: 0.5rem;
    background: var(--bg-primary); border-radius: 6px;
}
.consolidated-participant-name {font-weight: 600; margin-bottom: 0.25rem;}
.consolidated-participant-details {font-size: 0.75rem; color: var(--text-secondary);}

.upcoming-meetings-section {
    display: none; background: var(--bg-primary); border-radius: 12px;
    padding: 1rem; box-shadow: 0 1px 4px var(--shadow); margin-bottom: 1rem;
}
.upcoming-meetings-section.active {display: block;}
.upcoming-meetings-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;}
.upcoming-meetings-title {font-size: 1.1rem; font-weight: var(--font-bold); display: flex; align-items: center; gap: 0.5rem;}
.upcoming-meetings-filters {display: flex; gap: 0.35rem;}
.upcoming-filter-btn {
    padding: 0.35rem 0.75rem; border: 1px solid var(--border); background: transparent;
    color: var(--text-secondary); border-radius: 6px; cursor: pointer;
    font-size: 0.75rem; transition: all 0.2s; font-weight: 600;
}
.upcoming-filter-btn:hover {background: var(--bg-secondary);}
.upcoming-filter-btn.active {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
    color: white; border-color: #023747;
}
.upcoming-meetings-list {
    display: flex; flex-direction: column; gap: 0.5rem;
    max-height: 500px; overflow-y: auto; overflow-x: hidden;
}
.upcoming-meeting-row {
    display: grid; grid-template-columns: 80px 1fr auto;
    align-items: center; gap: 1rem; padding: 0.75rem;
    background: var(--bg-secondary); border-radius: 8px;
    transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent;
}
.upcoming-meeting-row:hover {
    background: var(--bg-tertiary); transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow);
}
.upcoming-meeting-row.today {
    border-left-color: #ef4444;
    background: linear-gradient(90deg, rgba(239, 68, 68, 0.08), var(--bg-secondary));
}
.upcoming-meeting-row.soon {
    border-left-color: #f59e0b;
    background: linear-gradient(90deg, rgba(245, 158, 11, 0.08), var(--bg-secondary));
}
.upcoming-meeting-row.upcoming {border-left-color: #10b981;}
.upcoming-meeting-row.starting-soon {
    border-left-color: #f59e0b;
    background: linear-gradient(90deg, rgba(245, 158, 11, 0.12), var(--bg-secondary));
    animation: pulse-starting 2s infinite;
}
.upcoming-meeting-row.happening-now {
    border-left-color: #ef4444;
    background: linear-gradient(90deg, rgba(239, 68, 68, 0.12), var(--bg-secondary));
    animation: pulse-happening 1.5s infinite;
}
.upcoming-meeting-row.just-finished {
    border-left-color: #10b981;
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.12), var(--bg-secondary));
}

@keyframes pulse-starting {
    0%, 100% {box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); transform: translateX(0);}
    50% {box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); transform: translateX(2px);}
}
@keyframes pulse-happening {
    0%, 100% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); transform: translateX(0);}
    50% {box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); transform: translateX(4px);}
}
@keyframes pulse-glow {
    0%, 100% {box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);}
    50% {box-shadow: 0 0 16px rgba(239, 68, 68, 0.8);}
}
@keyframes pulse-glow-orange {
    0%, 100% {box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);}
    50% {box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);}
}
@keyframes pulse-glow-red {
    0%, 100% {box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);}
    50% {box-shadow: 0 0 24px rgba(239, 68, 68, 0.9);}
}

.upcoming-meeting-date {
    padding: 0.2rem 0.1rem; border-radius: 10px; text-align: center;
    font-weight: 700; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
}
.upcoming-meeting-date.today {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white; animation: pulse-glow 2s infinite;
}
.upcoming-meeting-date.soon {background: linear-gradient(135deg, #f59e0b, #d97706); color: white;}
.upcoming-meeting-date.upcoming {background: linear-gradient(135deg, #10b981, #059669); color: white;}
.upcoming-meeting-date.starting-soon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white; animation: pulse-glow-orange 2s infinite;
}
.upcoming-meeting-date.happening-now {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white; animation: pulse-glow-red 1.5s infinite;
}
.upcoming-meeting-date.just-finished {background: linear-gradient(135deg, #10b981, #059669); color: white;}

.upcoming-date-day {
    font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.05em; opacity: 0.9; padding: 0.1rem 0.75rem;
}
.upcoming-date-date {font-size: 0.75rem; font-weight: 700; margin-top: 0.15rem; padding: 0.1rem 0.75rem;}
.upcoming-meeting-details {flex: 1; min-width: 0;}
.upcoming-meeting-time-title {
    display: flex; align-items: center; gap: 0.5rem;
    margin-bottom: 0.35rem; flex-wrap: wrap;
}
.upcoming-meeting-time {font-weight: 700; font-size: 0.85rem; color: var(--text-primary);}
.upcoming-meeting-title {font-size: 0.9rem; font-weight: 600; color: var(--text-primary);}
.upcoming-meeting-meta {
    display: flex; align-items: center; gap: 0.75rem;
    font-size: 0.75rem; color: var(--text-secondary); flex-wrap: wrap;
}
.upcoming-meeting-meta-item {display: flex; align-items: center; gap: 0.25rem;}
.upcoming-prep-status {
    display: inline-flex; align-items: center; gap: 0.25rem;
    padding: 0.125rem 0.5rem; border-radius: 6px;
    font-size: 0.7rem; font-weight: 600;
}
.upcoming-prep-status.none {background: rgba(239, 68, 68, 0.15); color: #ef4444;}
.upcoming-prep-status.ready {background: rgba(16, 185, 129, 0.15); color: #10b981;}
.upcoming-meeting-actions {display: flex; gap: 0.25rem; opacity: 0; transition: opacity 0.2s;}
.upcoming-meeting-row:hover .upcoming-meeting-actions {opacity: 1;}
.upcoming-action-btn {
    background: var(--bg-tertiary); border: none; color: var(--text-primary);
    width: 32px; height: 32px; border-radius: 6px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.upcoming-action-btn:hover {background: var(--primary); color: white; transform: scale(1.05);}
.upcoming-action-btn.delete:hover {background: var(--danger);}
.upcoming-action-btn svg {width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;}
.upcoming-meetings-empty {text-align: center; padding: 1rem; color: var(--text-secondary);}
.upcoming-empty-icon {font-size: 1.5rem; margin-bottom: 0.35rem; opacity: 0.5;}
.upcoming-empty-text {margin-bottom: 0.75rem; font-size: 0.85rem;}

.upcoming-meeting-status {
    display: inline-flex; align-items: center; gap: 0.35rem;
    padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem;
    font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
}
.upcoming-meeting-status.starting-soon {
    background: rgba(245, 158, 11, 0.2); color: #f59e0b; animation: pulse-text 2s infinite;
}
.upcoming-meeting-status.happening-now {
    background: rgba(239, 68, 68, 0.2); color: #ef4444; animation: pulse-text 1.5s infinite;
}
.upcoming-meeting-status.just-finished {background: rgba(16, 185, 129, 0.2); color: #10b981;}

@keyframes pulse-text {
    0%, 100% {opacity: 1;}
    50% {opacity: 0.7;}
}

.meeting-highlight-flash {animation: highlightFlash 3s ease-out;}
@keyframes highlightFlash {
    0% {box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); background: rgba(16, 185, 129, 0.2);}
    50% {box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); background: rgba(16, 185, 129, 0.15);}
    100% {box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); background: var(--bg-secondary);}
}

.btn-schedule-meeting {
    background: transparent; border: 1px solid var(--border);
    color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 8px;
    cursor: pointer; font-size: 0.8rem; font-weight: 600;
    display: flex; align-items: center; gap: 0.5rem;
    transition: all 0.2s; white-space: nowrap;
}

.customer-activity-section,
.all-customers-section {
    display: none;
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 1px 4px var(--shadow);
    margin-bottom: 1rem;
    position: relative;
    /* Enable resize functionality */
    resize: vertical;
    overflow: hidden;  /* Changed from 'auto' to 'hidden' - prevents outer scrollbar */
    min-height: 150px;
    height: 350px; /* Default height for proper inner scroll calculation */
}

.customer-activity-section::after,
.all-customers-section::after {
    content: '';
    position: absolute;
    right: 4px;
    bottom: 4px;
    width: 0;
    height: 0;
    pointer-events: none;
    border-style: solid;
    border-width: 0 0 10px 10px;
    border-color: transparent transparent var(--text-tertiary) transparent;
    opacity: 0.4;
}

.customer-activity-section.active,
.all-customers-section.active {
    display: block;
}

.customer-activity-section .activity-list {
    max-height: calc(100% - 80px);
    overflow-y: auto;
    overflow-x: hidden;
}

.all-customers-section .customers-list {
    height: calc(100% - 50px);
    overflow-y: auto;
    overflow-x: hidden;
}

.customer-activity-section.active,
.all-customers-section.active { display: block; }
.customer-activity-section .activity-list { max-height: calc(100% - 20px); overflow-y: auto; }



.activity-list {margin-top: 0.75rem; overflow-y: auto;}
.activity-header-row {
    display: grid; grid-template-columns: 20px 1fr 1fr 1fr 1fr 40px;
    align-items: center; gap: 1rem; padding: 0.5rem 0.75rem;
    margin-bottom: 0.5rem; border-bottom: 2px solid var(--border);
    position: sticky; top: 0; background: var(--bg-primary); z-index: 10;
}
.activity-header-cell {
    font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.05em; color: var(--text-secondary);
}
.activity-header-cell.right {text-align: right;}
.activity-row {
    display: grid; grid-template-columns: 20px 1fr 1fr 1fr 1fr 40px;
    align-items: center; gap: 1rem; padding: 0.65rem 0.75rem;
    background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.35rem;
    transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent;
}
.activity-row:hover {
    background: var(--bg-tertiary); transform: translateX(4px);
    box-shadow: 0 2px 8px var(--shadow);
}

.activity-note-cell { display: flex; align-items: center; gap: 0.25rem; min-width: 0; }
.activity-note-input { flex: 1; padding: 0.2rem 0.4rem; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.7rem; min-width: 0; resize: none; overflow: hidden; font-family: inherit; line-height: 1.4; }
.activity-note-input:focus { outline: none; border-color: var(--primary); }
.activity-note-input::placeholder { color: var(--text-tertiary); }
.activity-note-text { font-size: 0.75rem; color: var(--text-secondary); cursor: pointer; flex: 1; word-break: break-word; }
.activity-note-text:hover { color: var(--primary); }

.activity-row.recent {border-left-color: #10b981;}
.activity-row.recent:hover {background: linear-gradient(90deg, rgba(16, 185, 129, 0.08), var(--bg-tertiary));}
.activity-row.warning {border-left-color: #f59e0b;}
.activity-row.warning:hover {background: linear-gradient(90deg, rgba(245, 158, 11, 0.08), var(--bg-tertiary));}
.activity-row.overdue {border-left-color: #ef4444;}
.activity-row.overdue:hover {background: linear-gradient(90deg, rgba(239, 68, 68, 0.08), var(--bg-tertiary));}

.activity-status-dot {width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;}
.activity-status-dot.recent {background: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);}
.activity-status-dot.warning {background: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);}
.activity-status-dot.overdue {
    background: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
    animation: pulse-red 2s infinite;
}

.customer-row {
    display: grid; grid-template-columns: 20px 1.5fr 1fr 1.5fr 0.8fr 40px;
    align-items: center; gap: 1rem; padding: 0.65rem 0.75rem;
    background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.35rem;
    transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent;
}
.customer-row:hover {
    background: var(--bg-tertiary); transform: translateX(4px);
    box-shadow: 0 2px 8px var(--shadow); border-left-color: var(--primary);
}
.customer-row.pinned { border-left-color: #fbbf24; background: rgba(251, 191, 36, 0.05); }
.customer-logo { width: 20px; height: 20px; border-radius: 4px; object-fit: contain; background: white; padding: 2px; }
.customer-name-cell { font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; }
.customer-name-cell .pin-star { font-size: 1rem; }
.customer-website-cell a { color: var(--primary); text-decoration: none; font-size: 0.8rem; display: flex; align-items: center; gap: 0.25rem; }
.customer-website-cell a:hover { text-decoration: underline; }
.customer-address-cell { font-size: 0.8rem; color: var(--text-secondary); }
.customer-address-cell a { color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; gap: 0.25rem; }
.customer-address-cell a:hover { color: var(--primary); }
.customer-industry-badge {
    padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600;
    background: var(--bg-tertiary); color: var(--text-secondary); text-align: center;
}
.customer-row-actions { display: flex; gap: 0.15rem; opacity: 0; transition: opacity 0.2s; justify-content: flex-end; }
.customer-row:hover .customer-row-actions { opacity: 1; }

@keyframes pulse-red {
    0%, 100% {opacity: 1;}
    50% {opacity: 0.6;}
}
@keyframes pulse {
    0%, 100% {transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);}
    50% {transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);}
}

.customer-banner-detail {display: flex; align-items: center; gap: 0.5rem;}
.activity-customer {
    font-weight: 700; font-size: 0.9rem; color: var(--text-primary);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.activity-meeting {
    font-size: 0.85rem; color: var(--text-secondary);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.activity-time {
    font-size: 0.85rem; color: var(--text-secondary);
    text-align: right; white-space: nowrap;
}
.activity-time.overdue {color: #ef4444; font-weight: 600;}
.activity-time.warning {color: #f59e0b; font-weight: 600;}
.activity-arrow {
    color: var(--text-secondary); font-size: 1.2rem;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.activity-row:hover .activity-arrow {color: var(--primary); transform: translateX(4px);}

.quick-add-contacts {
    background: var(--bg-tertiary); border-radius: 8px;
    padding: 0.75rem; margin-bottom: 1rem; display: none;
}
.quick-add-contacts.active {display: block;}
.quick-add-contacts-title {
    font-size: 0.75rem; font-weight: 700; color: var(--text-secondary);
    text-transform: uppercase; margin-bottom: 0.5rem;
    display: flex; align-items: center; gap: 0.5rem;
}
.quick-add-contacts-list {display: flex; flex-direction: column; gap: 0.35rem;}
.quick-add-contact-item {
    display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem;
    background: var(--bg-primary); border-radius: 6px; cursor: pointer;
    transition: all 0.2s; border: 1px solid transparent;
}
.quick-add-contact-item:hover {
    border-color: var(--primary); transform: translateX(4px);
    background: var(--bg-secondary);
}
.quick-add-contact-avatar {
    width: 32px; height: 32px; border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700; font-size: 0.75rem; flex-shrink: 0;
}
.quick-add-contact-info {flex: 1; min-width: 0;}
.quick-add-contact-name {font-size: 0.85rem; font-weight: 600; margin-bottom: 0.125rem;}
.quick-add-contact-details {
    font-size: 0.7rem; color: var(--text-secondary);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.quick-add-contact-icon {
    color: var(--primary); font-size: 1rem;
    opacity: 0; transition: opacity 0.2s;
}
.quick-add-contact-item:hover .quick-add-contact-icon {opacity: 1;}

.follow-up-meeting-item {
    display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem;
    border: 2px solid var(--border); border-radius: 8px; margin-bottom: 0.5rem;
    cursor: pointer; transition: all 0.2s; background: var(--bg-primary);
}
.follow-up-meeting-item:hover {
    background: var(--bg-tertiary); border-color: var(--primary);
    transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow);
}
.follow-up-meeting-item.selected {
    background: linear-gradient(135deg, rgba(0, 206, 200, 0.1), rgba(0, 168, 163, 0.05));
    border-color: var(--primary); border-width: 2px;
}
.follow-up-meeting-item input[type="checkbox"] {
    margin-top: 0.25rem; cursor: pointer; width: 18px; height: 18px; flex-shrink: 0;
}
.follow-up-meeting-info {flex: 1; min-width: 0;}
.follow-up-meeting-title {
    font-weight: 600; color: var(--text-primary);
    margin-bottom: 0.25rem; font-size: 0.95rem;
}
.follow-up-meeting-meta {
    display: flex; gap: 1rem; font-size: 0.85rem;
    color: var(--text-secondary); margin-bottom: 0.25rem; flex-wrap: wrap;
}
.follow-up-meeting-preview {
    font-size: 0.85rem; color: var(--text-secondary); font-style: italic;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.follow-up-step h3 {font-size: 1.1rem; font-weight: 600;}
#followUpMeetingsList:empty::before {
    content: 'No meetings found'; display: block; text-align: center;
    padding: 2rem; color: var(--text-secondary); font-style: italic;
}
.follow-up-type-option input[type="radio"]:checked ~ div {color: var(--text-primary);}
.follow-up-type-option input[type="radio"]:not(:checked) ~ div {opacity: 0.6;}
.follow-up-type-option:has(input[type="radio"]:checked) {
    border-color: var(--primary) !important;
    background: linear-gradient(135deg, rgba(0, 206, 200, 0.1), rgba(0, 168, 163, 0.05)) !important;
}

.customer-profile-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;}
.customer-profile-section {
    background: var(--bg-secondary); padding: 1rem;
    border-radius: 8px; border-left: 3px solid var(--primary);
}
.customer-profile-section-title {
    font-size: 0.75rem; font-weight: 700; color: var(--text-secondary);
    text-transform: uppercase; margin-bottom: 0.75rem;
    display: flex; align-items: center; gap: 0.5rem;
}
.customer-info-item {
    display: flex; align-items: start; gap: 0.5rem;
    margin-bottom: 0.5rem; font-size: 0.85rem;
}
.customer-info-icon {
    color: var(--primary); font-size: 1rem;
    flex-shrink: 0; margin-top: 0.1rem;
}
.customer-info-content {flex: 1;}
.customer-info-label {
    font-size: 0.7rem; color: var(--text-secondary); font-weight: 600;
    text-transform: uppercase; margin-bottom: 0.15rem;
}
.customer-info-value {color: var(--text-primary); word-break: break-word;}
.customer-info-value a {color: var(--primary); text-decoration: none;}
.customer-info-value a:hover {text-decoration: underline;}

.customer-header-banner {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
    padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem; margin-bottom: 1rem;
    display: none; box-shadow: 0 4px 12px rgba(27, 168, 175, 0.3);
}
.customer-header-banner.active {display: flex; flex-direction: column;}
.customer-banner-top {
    display: flex; align-items: flex-start; justify-content: space-between;
    gap: 2rem; margin-bottom: 0.25rem; width: 100%;
}
.customer-header-left {display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0;}
.customer-header-icon {
    font-size: 3rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    flex-shrink: 0; display: flex; align-items: center;
    justify-content: center; width: 56px; height: 56px;
}
.customer-header-icon img {box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: transform 0.2s;}
.customer-header-icon img:hover {transform: scale(1.05);}
.customer-header-info {flex: 1; min-width: 0;}
.customer-header-title {
    font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.05em; color: rgba(255, 255, 255, 0.8); margin-bottom: 0.25rem;
}
.customer-header-name {
    font-size: 1.75rem; font-weight: var(--font-bold);
    color: white; margin-bottom: 0; line-height: 1.2; letter-spacing: -0.02em;
}
.customer-header-company {
    font-size: 0.9rem; color: rgba(255, 255, 255, 0.9);
    display: flex; align-items: center; gap: 0.5rem;
}
.customer-header-actions {display: flex; gap: 0.5rem; align-items: flex-start; flex-shrink: 0;}
.customer-header-btn {
    background: rgba(255, 255, 255, 0.2); border: none; color: white;
    width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
    font-size: 1.1rem; display: flex; align-items: center;
    justify-content: center; transition: all 0.2s; flex-shrink: 0;
}
.customer-header-btn:hover {background: rgba(255, 255, 255, 0.3); transform: scale(1.05);}
.customer-header-btn#bannerPinBtn span {font-size: 1.2rem; line-height: 1;}
.customer-header-btn#bannerPinBtn:hover span {color: #fbbf24;}.customer-header-btn.delete:hover {background: var(--danger);}
.customer-banner-details {
    display: flex; flex-wrap: wrap; gap: 1.5rem; padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    align-items: center; width: 100%;
}
.customer-banner-detail-icon {
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
.customer-banner-detail-icon svg {
    width: 14px; height: 14px; stroke: rgba(255, 255, 255, 0.9);
    fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
}
.customer-banner-detail-content {display: flex; align-items: center; gap: 0.35rem;}
.customer-banner-detail-label {
    font-size: 0.65rem; color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase; font-weight: 600;
    letter-spacing: 0.05em; white-space: nowrap;
}
.customer-banner-detail-value {font-size: 0.85rem; color: white; white-space: nowrap;}
.customer-banner-detail-value a {
    color: white; text-decoration: none;
    border-bottom: 1px dashed rgba(255, 255, 255, 0.5);
}
.customer-banner-detail-value a:hover {border-bottom-style: solid;}

.sticky-action-bar {
    position: sticky; top: 0; background: var(--bg-primary);
    border-bottom: 2px solid var(--border); padding: 1rem 1.5rem;
    margin: -1.5rem -1.5rem 1.5rem -1.5rem; z-index: 1000;
    display: flex; justify-content: space-between; align-items: center;
}

.sticky-action-bar-title {
    font-size: 1.1rem; font-weight: 700;
    display: flex; align-items: center; gap: 0.5rem;
}
.sticky-action-bar-actions {display: flex; gap: 0.5rem;}
.btn-large {
    padding: 0.75rem 1.5rem; font-size: 0.95rem; font-weight: 600;
    display: flex; align-items: center; gap: 0.5rem;
}

.form-input.error, .form-textarea.error, .customer-combobox-input.error {
    border-color: var(--danger) !important; animation: shake 0.3s;
}
@keyframes shake {
    0%, 100% {transform: translateX(0);}
    25% {transform: translateX(-10px);}
    75% {transform: translateX(10px);}
}
.field-error-message {
    color: var(--danger); font-size: 0.75rem; margin-top: 0.35rem;
    font-weight: 600; display: flex; align-items: center;
    gap: 0.35rem; animation: fadeIn 0.3s;
}
@keyframes fadeIn {
    from {opacity: 0; transform: translateY(-5px);}
    to {opacity: 1; transform: translateY(0);}
}
.form-section.error {border-color: var(--danger); animation: pulse 0.5s;}

.customer-combobox {position: relative;}
.customer-combobox-input {
    width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--border);
    border-radius: 8px; background: var(--bg-secondary);
    color: var(--text-primary); font-size: 0.9rem; transition: all 0.2s;
}
.customer-combobox-input:focus {
    outline: none; border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 206, 200, 0.1);
}
.customer-dropdown {
    display: none; position: absolute; top: 100%; left: 0; right: 0;
    background: var(--bg-primary); border: 2px solid var(--primary);
    border-radius: 8px; margin-top: 0.5rem; max-height: 250px;
    overflow-y: auto; box-shadow: 0 8px 24px rgba(0, 206, 200, 0.3), 0 0 0 1px rgba(0, 206, 200, 0.1);
    z-index: 100;
}
.customer-dropdown.active {display: block; animation: dropdownSlide 0.2s ease-out;}
@keyframes dropdownSlide {
    from {opacity: 0; transform: translateY(-10px);}
    to {opacity: 1; transform: translateY(0);}
}
.customer-dropdown-item {
    padding: 0.75rem 1rem; cursor: pointer; transition: all 0.2s;
    border-bottom: 1px solid var(--border);
}
.customer-dropdown-item:last-child {border-bottom: none;}
.customer-dropdown-item:hover {background: var(--bg-secondary); padding-left: 1.25rem;}
.customer-dropdown-item.new-customer {
    color: var(--primary); font-weight: 700;
    background: linear-gradient(90deg, rgba(0, 206, 200, 0.1), transparent);
}
.customer-dropdown-item.new-customer:hover {
    background: linear-gradient(90deg, rgba(0, 206, 200, 0.2), transparent);
}
.customer-dropdown-item-name {font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;}
.customer-dropdown-item-email {font-size: 0.75rem; color: var(--text-secondary);}

.form-section {
    background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem;
    margin-bottom: 1rem; border: 2px solid transparent;
    transition: all 0.3s; position: relative; overflow: visible;
}
.form-section:hover {
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(0, 206, 200, 0.1);
}
.form-section-header {
    display: flex; align-items: center; gap: 0.75rem;
    margin-bottom: 1rem; cursor: pointer;
}
.form-section-icon {
    width: 40px; height: 40px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.25rem; background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white; flex-shrink: 0;
}
.form-section-title {font-size: 1rem; font-weight: 700; flex: 1;}
.form-section-toggle {
    width: 24px; height: 24px; border-radius: 6px; background: var(--bg-tertiary);
    display: flex; align-items: center; justify-content: center; transition: all 0.3s;
}
.form-section.collapsed .form-section-toggle {transform: rotate(-90deg);}
.form-section-content {
    max-height: 1000px; overflow: visible;
    transition: max-height 0.3s ease-out; position: relative;
}
.form-section.collapsed .form-section-content {max-height: 0; overflow: hidden;}

.template-btn {
    padding: 0.5rem 1rem; background: var(--bg-tertiary);
    border: 1px solid var(--border); border-radius: 8px;
    font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; gap: 0.5rem;
}


.participant-grid {display: grid; gap: 0.75rem;}
.participant-card {
    background: var(--bg-tertiary); border-radius: 8px; padding: 1rem;
    display: grid; grid-template-columns: auto 1fr auto;
    gap: 1rem; align-items: start;
}
.participant-avatar {
    width: 48px; height: 48px; border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700; font-size: 1.25rem;
}
.participant-details {flex: 1;}
.participant-card-name {font-weight: 700; font-size: 0.95rem; margin-bottom: 0.25rem;}
.participant-card-meta {
    display: flex; flex-wrap: wrap; gap: 0.5rem;
    font-size: 0.75rem; color: var(--text-secondary);
}
.participant-card-meta span {display: flex; align-items: center; gap: 0.25rem;}


.meddpicc-visual-tracker {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem; margin-bottom: 1.5rem;
}
.meddpicc-tracker-item {
    background: var(--bg-secondary); border-radius: 10px; padding: 1rem;
    text-align: center; border: 2px solid transparent;
    transition: all 0.3s; cursor: pointer;
}
.meddpicc-tracker-item:hover {border-color: var(--primary); transform: translateY(-2px);}
.meddpicc-tracker-item.completed {
    border-color: var(--success);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
}
.meddpicc-tracker-icon {
    width: 48px; height: 48px; border-radius: 50%; background: var(--bg-tertiary);
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 0.5rem; font-size: 1.5rem; transition: all 0.3s;
}
.meddpicc-tracker-item.completed .meddpicc-tracker-icon {background: var(--success); color: white;}
.meddpicc-tracker-label {font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);}
.meddpicc-tracker-item.completed .meddpicc-tracker-label {color: var(--success);}

.meeting-type-pills {display: flex; gap: 0.5rem; flex-wrap: wrap;}
.meeting-type-pill {
    padding: 0.75rem 1.25rem; border: 2px solid var(--border);
    border-radius: 10px; cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; gap: 0.5rem;
    font-size: 0.85rem; font-weight: 600; background: var(--bg-secondary);
}
.meeting-type-pill:hover {border-color: var(--primary); transform: translateY(-2px);}
.meeting-type-pill.selected {
    border-color: var(--primary);
    background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;
}
.meeting-type-icon {font-size: 1.25rem;}

.enhanced-editor-wrapper {
    border: 2px solid var(--border); border-radius: 12px;
    overflow: hidden; transition: all 0.2s;
}
.enhanced-editor-wrapper:focus-within {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 206, 200, 0.1);
}
.enhanced-editor-toolbar {
    background: var(--bg-tertiary); padding: 0.75rem;
    border-bottom: 1px solid var(--border); display: flex;
    gap: 0.5rem; flex-wrap: wrap; align-items: center;
}
.toolbar-group {
    display: flex; gap: 0.25rem; padding-right: 0.75rem;
    border-right: 1px solid var(--border);
}
.toolbar-group:last-child {border-right: none;}
.enhanced-editor-content {
    min-height: 200px; padding: 1rem; background: var(--bg-primary);
    font-size: 0.9rem; line-height: 1.6;
}

.smart-suggestions {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05));
    border-radius: 10px; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #667eea;
}
.smart-suggestions-title {
    font-size: 0.8rem; font-weight: 700; color: #667eea;
    margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;
}
.suggestion-pills {display: flex; flex-wrap: wrap; gap: 0.5rem;}
.suggestion-pill {
    padding: 0.5rem 1rem; background: white; border: 1px solid #667eea;
    border-radius: 8px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s;
}
[data-theme="dark"] .suggestion-pill {background: var(--bg-secondary);}
.suggestion-pill:hover {background: #667eea; color: white; transform: translateY(-2px);}

.form-progress {
    display: flex; gap: 0.5rem; margin-bottom: 1.5rem;
    padding: 1rem; background: var(--bg-secondary); border-radius: 10px;
}
.progress-step {
    flex: 1; height: 6px; background: var(--bg-tertiary);
    border-radius: 3px; position: relative; overflow: hidden;
}
.progress-step.completed {background: var(--success);}
.progress-step.active {background: var(--primary);}
.progress-step.active::after {
    content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 1.5s infinite;
}
@keyframes shimmer {
    0% {transform: translateX(-100%);}
    100% {transform: translateX(100%);}
}

.sidebar {
    position: fixed; left: 0; top: 0; width: var(--sidebar-width);
    height: 100vh; background: linear-gradient(135deg, #023747 0%, #127c87 100%);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    padding: 1.25rem 0.6rem 0 0.6rem; z-index: 101;
    box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
    display: flex; flex-direction: column;
    overflow: hidden;
}
[data-theme="dark"] .sidebar {
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
    border-right: 1px solid var(--border);
}
.sidebar-customers-scroll {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-bottom: 1rem;
    margin-right: -0.5rem;
    padding-right: 0.5rem;
}

.sidebar-customers-scroll::-webkit-scrollbar {
    width: 6px;
}

.sidebar-customers-scroll::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.sidebar-customers-scroll::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

.sidebar-customers-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
}

[data-theme="dark"] .sidebar-customers-scroll::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
}

[data-theme="dark"] .sidebar-customers-scroll::-webkit-scrollbar-thumb {
    background: rgba(0, 229, 221, 0.3);
}

[data-theme="dark"] .sidebar-customers-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 229, 221, 0.5);
}

[data-theme="dark"] .sidebar-logo {text-shadow: 0 0 20px rgba(0, 229, 221, 0.5);}
[data-theme="dark"] .action-btn {background: rgba(0, 229, 221, 0.05);}
[data-theme="dark"] .action-btn:hover {
    background: rgba(0, 229, 221, 0.15);
    box-shadow: 0 4px 12px rgba(0, 229, 221, 0.2);
}

.sidebar-logo {
    font-size: 1.25rem; font-weight: 800; color: white;
    margin-bottom: 1.5rem; padding: 0 0.4rem;
    letter-spacing: -0.5px; position: relative;
}
.sidebar-logo::after {
    content: ''; position: absolute; bottom: -0.5rem;
    left: 0.5rem; right: 0.5rem; height: 2px;
    background: linear-gradient(90deg, transparent, var(--primary), transparent);
    opacity: 0.3;
}

.sidebar-title {
    font-size: 0.55rem; text-transform: uppercase; letter-spacing: 0.1em;
    color: rgba(255, 255, 255, 0.5); font-weight: var(--font-bold);
    margin: 1.25rem 0 0.6rem; display: flex; justify-content: space-between;
    align-items: center; padding: 0 0.4rem;
}
.sidebar-title-btn {
    background: rgba(0, 206, 200, 0.15); border: 1px solid rgba(0, 206, 200, 0.3);
    color: var(--primary); cursor: pointer; font-size: 0.85rem;
    padding: 0.2rem 0.4rem; border-radius: 5px; transition: all 0.2s; font-weight: 700;
}
.sidebar-title-btn:hover {background: rgba(0, 206, 200, 0.25); transform: scale(1.1);}

.action-btn {
    width: 100%; padding: 0.5rem 0.6rem; border: none; border-radius: 8px;
    font-size: 0.75rem; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.4rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: rgba(255, 255, 255, 0.03); color: rgba(255, 255, 255, 0.9);
    position: relative; overflow: hidden;
}
.action-btn::before {
    content: ''; position: absolute; top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.5s;
}
.action-btn:hover::before {left: 100%;}
.action-btn:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateX(4px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
.action-btn-icon {
    width: 30px; height: 30px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.85rem; flex-shrink: 0; transition: all 0.3s;
    position: relative; z-index: 1; background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}
.action-btn:hover .action-btn-icon {
    transform: scale(1.1); background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
}
.action-btn-icon svg {
    width: 15px; height: 15px; stroke: rgba(255, 255, 255, 0.9);
    fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
}
.action-btn:hover .action-btn-icon svg {stroke: white;}

.btn-sign-in {
    background: var(--bg-tertiary); border: 1px solid var(--border);
    color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 8px;
    cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s;
    display: flex; align-items: center; gap: 0.5rem; margin-left: auto;
}
.btn-sign-in:hover {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
    color: white; border-color: #023747;
    transform: translateY(-2px); box-shadow: 0 4px 10px rgba(27, 168, 175, 0.5);
}

.btn-sign-in svg {width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;}

.action-btn .notification-badge {
    position: absolute; top: 0.5rem; right: 0.5rem; background: #ef4444;
    color: white; font-size: 0.65rem; font-weight: 700;
    padding: 0.125rem 0.4rem; border-radius: 10px;
    min-width: 18px; text-align: center; animation: pulse-badge 2s infinite;
}
@keyframes pulse-badge {
    0%, 100% {transform: scale(1);}
    50% {transform: scale(1.1);}
}

.meeting-action-btn.share {background: rgba(59, 130, 246, 0.9);}
.meeting-action-btn.share:hover {background: #3b82f6; color: white;}

.share-modal-tabs {
    display: flex; gap: 0.35rem; margin-bottom: 1rem;
    border-bottom: 2px solid var(--border);
}
.share-modal-tab {
    padding: 0.5rem 1rem; background: transparent; border: none;
    color: var(--text-secondary); font-size: 0.8rem; font-weight: 500;
    cursor: pointer; border-bottom: 2px solid transparent;
    transition: all 0.2s; white-space: nowrap;
}
.share-modal-tab:hover {color: var(--text-primary); background: var(--bg-secondary);}
.share-modal-tab.active {color: var(--primary); border-bottom-color: var(--primary);}
.share-tab-content {display: none;}
.share-tab-content.active {display: block;}

.permission-option {
    padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px;
    margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s;
    display: flex; align-items: start; gap: 0.75rem;
}
.permission-option:hover {border-color: var(--primary); background: var(--bg-secondary);}
.permission-option input[type="radio"]:checked ~ div {color: var(--text-primary);}
.permission-option:has(input[type="radio"]:checked) {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(0, 206, 200, 0.1), rgba(0, 168, 163, 0.05));
}

.shared-with-list {display: flex; flex-direction: column; gap: 0.75rem;}
.shared-user-card {
    background: var(--bg-secondary); border-radius: 8px; padding: 0.75rem;
    display: grid; grid-template-columns: auto 1fr auto; gap: 0.75rem; align-items: center;
}
.shared-user-avatar {
    width: 40px; height: 40px; border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700; font-size: 0.9rem;
}
.shared-user-info {flex: 1;}
.shared-user-name {font-weight: 600; font-size: 0.9rem; margin-bottom: 0.125rem;}
.shared-user-email {font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;}
.shared-user-meta {display: flex; gap: 0.5rem; font-size: 0.7rem; align-items: center;}
.shared-permission-badge {padding: 0.125rem 0.5rem; border-radius: 6px; font-weight: 600;}
.shared-permission-badge.view {background: rgba(59, 130, 246, 0.15); color: #3b82f6;}
.shared-permission-badge.edit {background: rgba(16, 185, 129, 0.15); color: #10b981;}
.shared-status-badge {padding: 0.125rem 0.5rem; border-radius: 6px; font-weight: 600;}
.shared-status-badge.accepted {background: rgba(16, 185, 129, 0.15); color: #10b981;}
.shared-status-badge.pending {background: rgba(245, 158, 11, 0.15); color: #f59e0b;}
.shared-user-actions {display: flex; gap: 0.35rem;}

.link-sharing-section {background: var(--bg-secondary); padding: 1rem; border-radius: 8px;}
.link-toggle {
    display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;
    padding-bottom: 1rem; border-bottom: 1px solid var(--border);
}
.link-url-box {display: flex; gap: 0.5rem; margin-bottom: 1rem;}
.link-url-input {
    flex: 1; padding: 0.5rem 0.75rem; border: 1px solid var(--border);
    border-radius: 8px; background: var(--bg-tertiary);
    color: var(--text-primary); font-size: 0.85rem; font-family: 'Courier New', monospace;
}

.shared-meetings-section {
    display: none; background: var(--bg-primary); border-radius: 12px;
    padding: 1rem; box-shadow: 0 1px 4px var(--shadow); margin-bottom: 1rem;
}
.shared-meetings-section.active {display: block;}
.shared-filter-bar {
    display: flex; gap: 0.5rem; margin-bottom: 1rem;
    flex-wrap: wrap; align-items: center;
}
.shared-filter-select {
    padding: 0.5rem 0.75rem; border: 1px solid var(--border);
    border-radius: 8px; background: var(--bg-secondary);
    color: var(--text-primary); font-size: 0.85rem; cursor: pointer;
}
.shared-status-filter {display: flex; gap: 0.35rem;}
.shared-status-btn {
    padding: 0.35rem 0.75rem; border: 1px solid var(--border);
    background: transparent; color: var(--text-secondary); border-radius: 6px;
    cursor: pointer; font-size: 0.75rem; transition: all 0.2s;
}
.shared-status-btn.active {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
    color: white; border-color: #023747;
}
.shared-meetings-grid {display: flex; flex-direction: column; gap: 0.75rem;}
.shared-meeting-card {
    background: var(--bg-secondary); border-radius: 10px; padding: 1rem;
    border-left: 4px solid; transition: all 0.2s; cursor: pointer;
}
.shared-meeting-card:hover {transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow);}
.shared-meeting-card.pending {
    border-left-color: #f59e0b;
    background: linear-gradient(90deg, rgba(245, 158, 11, 0.08), var(--bg-secondary));
}
.shared-meeting-card.accepted {border-left-color: #10b981;}
.shared-meeting-card.shared-by-me {border-left-color: #3b82f6;}
.shared-card-header {
    display: flex; justify-content: space-between;
    align-items: start; margin-bottom: 0.75rem;
}
.shared-card-badge {
    padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.7rem;
    font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
}
.shared-card-badge.new {background: #3b82f6; color: white; animation: pulse-badge 2s infinite;}
.shared-card-badge.accepted {background: rgba(16, 185, 129, 0.2); color: #10b981;}
.shared-card-badge.shared {background: rgba(59, 130, 246, 0.2); color: #3b82f6;}
.shared-card-title {font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem;}
.shared-card-meta {
    display: flex; flex-wrap: wrap; gap: 0.75rem;
    font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem;
}
.shared-card-meta-item {display: flex; align-items: center; gap: 0.35rem;}
.shared-card-preview {
    background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px;
    font-size: 0.85rem; color: var(--text-secondary);
    margin-bottom: 0.75rem; font-style: italic;
}
.shared-card-actions {display: flex; gap: 0.5rem; flex-wrap: wrap;}
.shared-action-btn {
    padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 8px;
    font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; gap: 0.35rem;
}
.shared-action-btn.primary {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
    color: white; border-color: #023747;
}
.shared-action-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(27, 168, 175, 0.5);
}
.shared-action-btn.secondary {background: transparent; color: var(--text-secondary);}
.shared-action-btn.secondary:hover {background: var(--bg-tertiary); color: var(--text-primary);}
.shared-action-btn.danger {
    background: transparent; color: var(--danger); border-color: var(--danger);
}
.shared-action-btn.danger:hover {background: var(--danger); color: white;}

.shared-meeting-banner {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1rem; display: none;
}
.shared-meeting-banner.active {display: block;}
.shared-banner-content {
    display: flex; justify-content: space-between;
    align-items: center; gap: 1rem;
}
.shared-banner-info {flex: 1;}
.shared-banner-title {
    font-size: 0.85rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.05em; margin-bottom: 0.5rem;
}
.shared-banner-meta {font-size: 0.85rem; opacity: 0.9;}
.shared-banner-actions {display: flex; gap: 0.5rem;}

.collaborators-indicator {
    background: var(--bg-secondary); border-radius: 8px;
    padding: 0.75rem; margin-bottom: 1rem; display: none;
}
.collaborators-indicator.active {display: block;}
.collaborators-list {display: flex; flex-direction: column; gap: 0.35rem;}
.collaborator-item {
    display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;
}
.collaborator-status {width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;}
.collaborator-status.online {background: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);}
.collaborator-status.offline {background: var(--text-tertiary);}

.accept-meeting-options {display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem;}
.accept-option {
    padding: 1rem; border: 2px solid var(--border); border-radius: 8px;
    cursor: pointer; transition: all 0.2s;
}
.accept-option:hover {border-color: var(--primary); background: var(--bg-secondary);}
.accept-option input[type="radio"]:checked ~ div {color: var(--text-primary);}
.accept-option:has(input[type="radio"]:checked) {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(0, 206, 200, 0.1), rgba(0, 168, 163, 0.05));
}
.accept-option-title {font-weight: 700; font-size: 0.95rem; margin-bottom: 0.35rem;}
.accept-option-desc {font-size: 0.8rem; color: var(--text-secondary);}

.category-filter {
    padding: 0.45rem 0.6rem; border: none; background: rgba(255, 255, 255, 0.03);
    color: rgba(255, 255, 255, 1); border-radius: 8px; cursor: pointer;
    display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;
    margin-bottom: 0.4rem; transition: all 0.3s;
    position: relative; overflow: visible; white-space: nowrap;
    width: 100%;
}

.category-filter-content {display: contents;}
.category-filter-name {overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; flex: 1; text-align: left;}
.category-filter::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0;
    width: 3px; background: var(--primary);
    transform: scaleY(0); transition: transform 0.3s;
}
.category-filter:hover {background: rgba(255, 255, 255, 0.08); transform: translateX(4px);}
.category-filter:hover::before {transform: scaleY(1);}
.category-filter.active {
    background: linear-gradient(135deg, rgba(0, 206, 200, 0.2), rgba(0, 168, 163, 0.15));
    color: white; border-left: 3px solid var(--primary); font-weight: 600;
}
.category-filter.active::before {transform: scaleY(1);}
.category-dot {width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 6px currentColor;}
.customer-count {
    font-size: 0.6rem; background: rgba(0, 206, 200, 0.15);
    color: var(--primary); padding: 0.15rem 0.4rem; border-radius: 5px;
    font-weight: 700; min-width: 20px; text-align: center; flex-shrink: 0;
}
.customer-filter-actions {display: flex; gap: 0.25rem; margin-left: auto; flex-shrink: 0; opacity: 0; transition: opacity 0.2s;}
.category-filter:hover .customer-filter-actions {opacity: 1;}
.customer-filter-btn {
    background: transparent; border: none; color: rgba(255, 255, 255, 0.6);
    width: 18px; height: 18px; border-radius: 4px; cursor: pointer;
    font-size: 0.6rem; display: flex; align-items: center;
    justify-content: center; transition: all 0.2s; padding: 0;
}
.customer-filter-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    color: white; transform: scale(1.1);
}
.customer-filter-btn.delete:hover {background: var(--danger); color: white;}
.customer-filter-btn svg {
    width: 10px; height: 10px; stroke: currentColor;
    fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
}
.category-filter.active .customer-count {background: rgba(255, 255, 255, 0.2); color: white;}

/* ========== PINNED CUSTOMERS STYLES - START ========== */
.pin-star {
    cursor: pointer;
    opacity: 0.3;
    transition: all 0.2s;
    flex-shrink: 0;
    font-size: 12px;
    line-height: 1;
}

.pin-star:hover {
    opacity: 0.7;
    transform: scale(1.1);
}

.pin-star.pinned {
    opacity: 1;
    color: #fbbf24;
    text-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
}

.pin-star.pinned:hover {
    color: #fcd34d;
    transform: scale(1.15);
}

.category-filter.pinned-customer {
    background: rgba(251, 191, 36, 0.08);
    border-left: 2px solid #fbbf24;
}

.category-filter.pinned-customer .category-filter-name {
    font-weight: 600;
}

.priority-section-header {
    font-size: 0.55rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 700;
    margin: 1rem 0 0.5rem;
    padding: 0 0.4rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.priority-section-header .star-icon {
    color: #fbbf24;
}

.priority-section-empty {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.4);
    font-style: italic;
    padding: 0.5rem 0.6rem;
    text-align: center;
}

.priority-section-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(251, 191, 36, 0.3), transparent);
    margin: 0.75rem 0.5rem;
}

@keyframes pinBounce {
    0% { transform: scale(1); }
    25% { transform: scale(0.8); }
    50% { transform: scale(1.2); }
    75% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.pin-star.animate {
    animation: pinBounce 0.4s ease-out;
}
/* ========== PINNED CUSTOMERS STYLES - END ========== */

.header {
    position: sticky; top: 0; background: var(--bg-primary);
    border-bottom: 1px solid var(--border); padding: 0.75rem 1.5rem;
    margin-left: var(--sidebar-width); z-index: 100; box-shadow: 0 1px 4px var(--shadow);
}
.header-content {
    display: flex; gap: 1rem; align-items: center;
    justify-content: space-between; padding: 0 1rem;
}
.search-bar {flex: 1; max-width: 400px; position: relative;}
.search-bar input {
    width: 100%; padding: 0.5rem 0.75rem 0.5rem 2rem;
    border: 1px solid var(--border); border-radius: 8px;
    background: var(--bg-secondary); color: var(--text-primary); font-size: 0.85rem;
}
.search-bar input:focus {
    outline: none; border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(0, 206, 200, 0.1);
}
.search-icon {
    position: absolute; left: 0.5rem; top: 50%; transform: translateY(-50%);
    width: 16px; height: 16px; color: var(--text-secondary); pointer-events: none;
}
.header-actions {display: flex; gap: 0.35rem;}
.btn-icon {
    background: transparent; border: none; padding: 0.5rem;
    border-radius: 6px; cursor: pointer; font-size: 1rem;
    color: var(--text-secondary); transition: all 0.2s;
}
.btn-add-note {
    background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
    color: white !important; width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%; transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(0, 206, 200, 0.3);
}
.btn-add-note:hover {transform: scale(1.1) rotate(90deg); box-shadow: 0 4px 12px rgba(0, 206, 200, 0.5);}
.btn-add-note svg {width: 18px; height: 18px;}
.btn-icon:hover {background: var(--bg-secondary); color: var(--text-primary);}
.btn-icon.danger:hover {background: rgba(239, 68, 68, 0.1); color: var(--danger);}
.btn-icon svg {width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;}

.container {
    margin-left: var(--sidebar-width); padding: 1rem;
    display: grid; grid-template-columns: 1fr 280px; gap: 1rem;
    transition: grid-template-columns 0.3s ease;
}
.container.kanban-mode, .container.form-mode {grid-template-columns: 1fr;}
.container.sidebar-collapsed {grid-template-columns: 1fr 50px;}
.main-content {display: flex; flex-direction: column; gap: 1rem;}

.inline-form-container {
    display: none; background: var(--bg-primary); border-radius: 12px;
    padding: 1.5rem 2rem; box-shadow: 0 4px 12px var(--shadow);
    animation: slideIn 0.3s ease-out; overflow: visible;
    max-width: 60%; width: 100%; margin: 0 auto; position: relative; z-index: 200;
}
.inline-form-container.active {display: block;}
@keyframes slideIn {
    from {opacity: 0; transform: translateY(-10px);}
    to {opacity: 1; transform: translateY(0);}
}


.meeting-tabs-container {
    display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;
    padding-bottom: 0; border-bottom: 2px solid var(--border);
    overflow-x: visible; flex-wrap: wrap;
}
.meeting-tab {
    padding: 0.5rem 0.65rem; border: 2px solid var(--border);
    background: var(--bg-secondary); color: var(--text-secondary);
    border-radius: 8px 8px 0 0; cursor: pointer; font-size: 0.8rem;
    font-weight: 600; transition: all 0.2s; white-space: nowrap;
    display: flex; align-items: center; gap: 0.35rem;
    position: relative; user-select: none; margin-bottom: -2px;
}
.meeting-tab:hover {background: var(--bg-tertiary); transform: translateY(-2px);}
.meeting-tab.active {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
    color: white; border: 2px solid var(--border);
    border-bottom: 2px solid var(--bg-primary);
    box-shadow: 0 2px 6px rgba(27, 168, 175, 0.3); z-index: 1;
}
.meeting-tab.drag-over {
    background: rgba(0, 206, 200, 0.2); border-color: var(--primary);
    border-style: dashed; animation: pulse 0.5s infinite;
}
.meeting-tab-icon {font-size: 1rem;}
.meeting-tab-count {
    background: rgba(255, 255, 255, 0.2); padding: 0.125rem 0.35rem;
    border-radius: 10px; font-size: 0.7rem; font-weight: 700; margin-right: 0.75rem;
}
.meeting-tab.active .meeting-tab-count {background: rgba(255, 255, 255, 0.3);}
.meeting-tab-edit {
    display: none; position: absolute; top: 1.25rem; right: -0.25rem;
    background: var(--primary); color: white; width: 20px; height: 20px;
    border-radius: 50%; align-items: center; justify-content: center;
    cursor: pointer; border: 2px solid var(--bg-primary); z-index: 10;
}
.meeting-tab:hover .meeting-tab-edit {display: flex;}
.meeting-tab-actions {
    display: none; position: absolute; top: -0.25rem; right: -0.25rem;
    background: var(--danger); color: white; width: 20px; height: 20px;
    border-radius: 50%; align-items: center; justify-content: center;
    font-size: 0.7rem; cursor: pointer; border: 2px solid var(--bg-primary); z-index: 10;
}
.meeting-tab:hover .meeting-tab-actions {display: flex;}
.meeting-tab-actions:hover {transform: scale(1.1);}
.btn-add-tab {
    background: var(--bg-secondary); border: 2px dashed var(--border);
    color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 8px;
    cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s;
    white-space: nowrap; display: flex; align-items: center; gap: 0.5rem;
}

.meetings-drop-zone {
    display: none; border: 3px dashed var(--primary);
    background: rgba(0, 206, 200, 0.1); border-radius: 12px; padding: 3rem;
    text-align: center; color: var(--primary); font-weight: 600;
    font-size: 1rem; margin-bottom: 1rem; animation: pulse 1s infinite;
}
.meetings-drop-zone.active {display: block;}
.meeting-card-dragging {opacity: 0.5; transform: rotate(2deg);}
.meetings-empty-tab {text-align: center; padding: 3rem 1rem; color: var(--text-secondary);}
.meetings-empty-tab-icon {font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;}
.tab-context-menu {
    position: fixed; background: var(--bg-primary); border: 2px solid var(--border);
    border-radius: 8px; box-shadow: 0 8px 24px var(--shadow);
    z-index: 10000; display: none; min-width: 150px;
}
.tab-context-menu.active {display: block;}
.tab-context-menu-item {
    padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center;
    gap: 0.5rem; font-size: 0.85rem; transition: all 0.2s;
    border-bottom: 1px solid var(--border);
}
.tab-context-menu-item:last-child {border-bottom: none;}
.tab-context-menu-item:hover {background: var(--bg-secondary); padding-left: 1.25rem;}
.tab-context-menu-item.delete:hover {background: rgba(239, 68, 68, 0.1); color: var(--danger);}

.customer-CustomerInfos-section, .customer-meetings-section {
    display: none; background: var(--bg-primary); border-radius: 12px;
    padding: 1rem; box-shadow: 0 1px 4px var(--shadow);
}
.customer-participants-section {
    display: none; background: var(--bg-primary); border-radius: 12px;
    padding: 1rem; box-shadow: 0 1px 4px var(--shadow); margin-bottom: 1rem;
}
.customer-participants-section.active {display: block;}
.participants-overview-grid {display: flex; flex-direction: column; gap: 0.15rem; margin-top: 0.5rem;}
.participant-overview-card {
    display: grid; grid-template-columns: 1.5fr 1fr 1.5fr 1fr 40px;
    align-items: center; gap: 0.75rem; padding: 0.4rem 0.5rem;
    background: var(--bg-secondary); border-radius: 6px; margin-bottom: 0.15rem;
    transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent;
}
.participant-overview-actions {
    position: absolute; top: 0.75rem; right: 0.75rem;
    display: flex; gap: 0.25rem; opacity: 0; transition: opacity 0.2s;
}
.participant-overview-card:hover .participant-overview-actions {opacity: 1;}
.participant-action-btn {
    background: transparent; border: 1px solid var(--border);
    color: var(--text-secondary); width: 24px; height: 24px;
    border-radius: 4px; cursor: pointer; display: flex;
    align-items: center; justify-content: center; transition: all 0.2s;
}
[data-theme="dark"] .participant-action-btn {background: transparent; color: var(--text-secondary);}
[data-theme="dark"] .btn-primary {box-shadow: 0 0 20px rgba(0, 229, 221, 0.3);}
[data-theme="dark"] .btn-primary:hover {box-shadow: 0 0 30px rgba(0, 229, 221, 0.5);}
[data-theme="dark"] .task-card:hover,
[data-theme="dark"] .customer-overview-card:hover,
[data-theme="dark"] .meeting-card:hover {box-shadow: 0 4px 20px rgba(0, 229, 221, 0.15);}
[data-theme="dark"] .sidebar {box-shadow: 4px 0 30px rgba(0, 0, 0, 0.7);}
[data-theme="dark"] .modal-content {
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8); border: 1px solid var(--border);
}
.participant-action-btn:hover {
    background: var(--bg-tertiary); border-color: var(--primary); color: var(--primary);
}
.participant-action-btn.delete:hover {background: var(--danger); border-color: var(--danger); color: white;}
.btn-add-participant {
    background: transparent; border: 1px solid var(--border);
    color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 8px;
    font-size: 0.8rem; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;
}

.btn-add-meeting {
    background: transparent; border: 1px solid var(--border);
    color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 8px;
    cursor: pointer; font-size: 0.8rem; font-weight: 600;
    display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;
}
.participant-action-btn svg {
    width: 16px; height: 16px; stroke: currentColor;
    fill: none; stroke-width: 2;
}
.participant-overview-card:hover {
    background: var(--bg-tertiary); transform: translateX(4px);
    box-shadow: 0 2px 8px var(--shadow); border-left-color: var(--primary);
}
.participant-overview-header {
    display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;
}
.participant-overview-avatar {
    width: 48px; height: 48px; border-radius: 50%; background: rgba(255, 255, 255, 0.2);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.25rem; font-weight: 700; backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
}
.participant-overview-info {flex: 1;}
.participant-overview-name {font-size: 1rem; font-weight: 700; margin-bottom: 0.25rem;}
.participant-overview-role {font-size: 0.75rem; opacity: 0.9;}
.participant-overview-details {font-size: 0.75rem; line-height: 1.6; opacity: 0.95;}
.participant-overview-detail {
    display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;
}
.participant-header-row {
    display: grid; grid-template-columns: 1.5fr 1fr 1.5fr 1fr 40px;
    align-items: center; gap: 0.75rem; padding: 0.35rem 0.5rem;
    margin-bottom: 0.25rem; border-bottom: 2px solid var(--border);
}
.participant-header-cell {
    font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.05em; color: var(--text-secondary);
}
.participant-header-cell.right {text-align: right;}
.participant-overview-name-single {
    font-size: 0.85rem; font-weight: 600; color: var(--text-primary);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.participant-overview-role-single {
    font-size: 0.8rem; color: var(--text-secondary);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.participant-overview-email-single {
    font-size: 0.8rem; color: var(--text-secondary);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.participant-overview-phone-single {
    font-size: 0.8rem; color: var(--text-secondary);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.participant-overview-actions-single {
    display: flex; gap: 0.15rem; opacity: 0;
    transition: opacity 0.2s; justify-content: flex-end;
}
.participant-overview-card:hover .participant-overview-actions-single {opacity: 1;}
.participant-overview-meetings {
    margin-top: 0.75rem; padding-top: 0.75rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 0.7rem; opacity: 0.9;
}
.customer-CustomerInfos-section.active, .customer-meetings-section.active {display: block;}

.meeting-type-icon-grid {
    display: grid; grid-template-columns: repeat(6, 1fr);
    gap: 0.5rem; margin: 1rem 0; max-width: 100%; overflow: hidden;
}
.meeting-type-icon-option {
    background: var(--bg-secondary); border: 2px solid var(--border);
    border-radius: 8px; padding: 0.75rem; font-size: 1rem;
    cursor: pointer; transition: all 0.2s; display: flex;
    align-items: center; justify-content: center; aspect-ratio: 1;
}
.meeting-type-icon-option:hover {
    background: var(--bg-tertiary); border-color: var(--primary); transform: scale(1.1);
}
.meeting-type-icon-option.selected {
    background: var(--primary); border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(0, 206, 200, 0.4);
}

.empty-state-compact {
    text-align: center; padding: 0.35rem; color: var(--text-secondary);
    background: var(--bg-secondary); border-radius: 8px;
    font-size: 0.8rem;
}
.empty-state-compact-icon {font-size: 1.25rem; margin-bottom: 0.25rem; opacity: 0.5;}
.empty-state-add-btn {
    margin-top: 0.5rem; padding: 0.35rem 0.75rem; background: transparent;
    border: 1px solid var(--border); color: var(--text-secondary);
    border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500;
    display: inline-flex; align-items: center; gap: 0.35rem; transition: all 0.2s;
}

.empty-state-add-btn[style*="#c43a00"]:hover {
    background: linear-gradient(135deg, #4a2000 0%, #d44500 100%) !important;
    box-shadow: 0 8px 24px rgba(61, 26, 0, 0.6) !important;
}

.customer-section-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0.75rem; padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border); cursor: pointer;
    user-select: none; transition: all 0.2s;
}
.customer-section-header:hover {
    background: var(--bg-tertiary); margin-left: -0.5rem;
    margin-right: -0.5rem; padding-left: 0.5rem;
    padding-right: 0.5rem; border-radius: 6px;
}
.customer-section-toggle {
    width: 24px; height: 24px; border-radius: 6px; background: var(--bg-tertiary);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s; font-size: 0.75rem; flex-shrink: 0;
}
.customer-participants-section.collapsed .customer-section-toggle,
.customer-CustomerInfos-section.collapsed .customer-section-toggle,
.customer-meetings-section.collapsed .customer-section-toggle {transform: rotate(-180deg);}
#customerParticipantsGrid, #customerParticipantsEmpty, #customerCustomerInfosList,
#customerCustomerInfosEmpty, #customerMeetingsList, #customerMeetingsEmpty,
.meeting-tabs-container {
    max-height: 1500px; overflow: visible;
    transition: max-height 0.25s ease-in-out, padding 0.25s ease-in-out;
}
.customer-participants-section.collapsed #customerParticipantsGrid,
.customer-participants-section.collapsed #customerParticipantsEmpty,
.customer-CustomerInfos-section.collapsed #customerCustomerInfosList,
.customer-CustomerInfos-section.collapsed #customerCustomerInfosEmpty,
.customer-meetings-section.collapsed #customerMeetingsList,
.customer-meetings-section.collapsed #customerMeetingsEmpty,
.customer-meetings-section.collapsed .meeting-tabs-container {
    max-height: 0; overflow: hidden; padding: 0; margin: 0; border: none;
}
.customer-participants-section.collapsed #customerParticipantsEmpty,
.customer-CustomerInfos-section.collapsed #customerCustomerInfosEmpty,
.customer-meetings-section.collapsed #customerMeetingsEmpty {opacity: 0;}
.customer-participants-section.collapsed .btn-add-participant,
.customer-CustomerInfos-section.collapsed .btn-add-meeting,
.customer-meetings-section.collapsed .btn-add-meeting {display: none;}
.section-count-badge {
    color: var(--text-primary); font-size: 0.85rem;
    font-weight: 600; margin-left: 0.35rem; opacity: 0.7;
}
.customer-section-title {
    font-size: 1rem; font-weight: var(--font-semibold); color: var(--text-primary);
}

.customer-meeting-summary, .customer-CustomerInfo-summary {
    background: var(--bg-secondary); border-radius: 8px;
    padding: 0.75rem; margin-bottom: 0.5rem;
}
.meetings-overview-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 0.75rem; margin-top: 0.75rem; justify-items: start; width: 100%;
}


.customer-meeting-summary {
    background: var(--bg-secondary); border-radius: 10px; padding: 1rem;
    color: var(--text-primary); transition: all 0.3s; cursor: grab;
    position: relative; overflow: hidden; display: flex;
    flex-direction: column; width: 100%; min-width: 0;
    border-left: 3px solid #127c87;
}
.customer-meeting-summary:active {cursor: grabbing;}
.customer-meeting-summary:hover {
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4), 0 0 0 2px #10b981;
}
.customer-meeting-summary::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
    opacity: 0; transition: opacity 0.3s;
}
.customer-meeting-summary:hover::before {opacity: 1;}
.meeting-summary-header {
    display: flex; justify-content: space-between;
    align-items: start; margin-bottom: 0.75rem;
}
.meeting-summary-icon {
    width: 48px; height: 48px; border-radius: 50%; background: rgba(255, 255, 255, 0.2);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; margin-bottom: 0.75rem; backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
}
.meeting-summary-title {font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; line-height: 1.3;}
.meeting-summary-date {font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.75rem;}
.meeting-summary-notes {
    background: var(--bg-tertiary); border-radius: 6px; padding: 0.75rem;
    margin-bottom: 0.75rem; font-size: 0.8rem; line-height: 1.5;
    flex: 1; position: relative;
}
.meeting-summary-notes-content {
    max-height: 60px; overflow: hidden; transition: max-height 0.3s ease-out;
    white-space: pre-wrap; word-break: break-word;
    line-height: 1.5; margin: 0;
}
.meeting-summary-notes-content.expanded {max-height: 500px;}
.meeting-summary-notes-toggle {
    background: var(--bg-tertiary); border: none; color: var(--text-primary);
    padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.7rem;
    font-weight: 600; cursor: pointer !important; margin-top: 0.5rem;
    transition: all 0.2s; width: 100%;
}

.meeting-summary-meta {
    display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.75rem;
    opacity: 0.95; padding-top: 0.75rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}
.meeting-summary-meta-item {display: flex; align-items: center; gap: 0.35rem;}
.meeting-summary-actions {
    position: absolute; top: 0.75rem; right: 0.75rem;
    display: flex; gap: 0.25rem; opacity: 0; transition: opacity 0.2s; z-index: 1;
}
.customer-meeting-summary:hover .meeting-summary-actions {opacity: 1;}
.meeting-action-btn {
    background: rgba(255, 255, 255, 0.9); border: none; color: var(--text-primary);
    width: 32px; height: 32px; border-radius: 50%; cursor: pointer !important;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}
[data-theme="dark"] .meeting-action-btn {background: rgba(31, 41, 55, 0.95); color: white;}
.meeting-action-btn:hover {transform: scale(1.1);}
.meeting-action-btn.delete:hover {background: var(--danger); color: white;}
.meeting-action-btn svg {
    width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;
}
.meddpicc-mini-progress {display: flex; align-items: center; gap: 0.35rem;}
.meddpicc-mini-bar {
    flex: 1; height: 4px; background: rgba(255, 255, 255, 0.2);
    border-radius: 2px; overflow: hidden; min-width: 40px;
}
.meddpicc-mini-fill {height: 100%; background: rgba(255, 255, 255, 0.8); transition: width 0.3s;}
.meddpicc-mini-score {font-size: 0.7rem; font-weight: 700; white-space: nowrap;}
.customer-CustomerInfo-summary {border-left: 3px solid #127c87;}
.meeting-summary-content {
    color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;
    white-space: pre-wrap; max-height: 60px; overflow: hidden;
}
.meeting-summary-content.expanded {max-height: none;}
.meeting-expand-btn {
    background: transparent; border: none; color: var(--primary);
    cursor: pointer; font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0;
}
.meeting-expand-btn:hover {color: var(--primary-dark);}
.CustomerInfo-badge {
    display: inline-block; padding: 0.125rem 0.5rem;
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white; border-radius: 8px; font-size: 0.7rem;
    font-weight: 600; margin-left: 0.35rem;
}
.customer-overview-grid {grid-template-columns: 1fr;}

.meddpicc-progress {
    margin: 0.75rem 0; padding: 0.75rem;
    background: var(--bg-tertiary); border-radius: 8px;
}
.meddpicc-progress-header {
    display: flex; justify-content: space-between;
    align-items: center; margin-bottom: 0.5rem;
}
.meddpicc-progress-title {font-weight: 600; font-size: 0.8rem; color: var(--text-secondary);}
.meddpicc-progress-score {font-weight: 700; font-size: 0.9rem; color: var(--primary);}
.meddpicc-progress-bar {
    height: 6px; background: var(--bg-secondary); border-radius: 3px;
    overflow: hidden; margin-bottom: 0.5rem;
}
.meddpicc-progress-fill {
    height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary));
    transition: width 0.3s;
}
.meddpicc-items {display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.35rem;}
.meddpicc-item {display: flex; align-items: center; gap: 0.35rem; font-size: 0.7rem;}
.meddpicc-item-icon {
    width: 16px; height: 16px; border-radius: 50%; display: flex;
    align-items: center; justify-content: center; font-size: 0.6rem; flex-shrink: 0;
}
.meddpicc-item-icon.completed {background: var(--success); color: white;}
.meddpicc-item-icon.incomplete {background: var(--bg-secondary); color: var(--text-secondary);}

.tasks-section {
    background: var(--bg-primary); border-radius: 12px;
    padding: 1rem; box-shadow: 0 1px 4px var(--shadow);
}
.section-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem;
}
.section-title {
    font-size: 1.1rem; font-weight: var(--font-bold);
    color: var(--text-primary); letter-spacing: -0.02em;
}
.view-toggle {display: flex; gap: 0.35rem;}
.view-btn {
    padding: 0.35rem 0.75rem; border: 1px solid var(--border);
    background: transparent; color: var(--text-secondary); border-radius: 6px;
    cursor: pointer; font-size: 0.75rem; transition: all 0.2s;
}
.view-btn.active {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
    color: white; border-color: #023747; box-shadow: 0 2px 6px rgba(27, 168, 175, 0.3);
}
.task-filters {display: flex; gap: 0.35rem; margin-bottom: 0.75rem; flex-wrap: wrap;}
.filter-btn {
    padding: 0.35rem 0.75rem; border: 1px solid var(--border);
    background: transparent; color: var(--text-secondary); border-radius: 6px;
    cursor: pointer; font-size: 0.75rem; transition: all 0.2s;
}
.filter-btn.active {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
    color: white; border-color: #023747; box-shadow: 0 2px 6px rgba(27, 168, 175, 0.3);
}
.tasks-list {display: flex; flex-direction: column; gap: 0.5rem;}
.kanban-board {
    display: none; grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem; margin-top: 0.5rem;
}
.kanban-board.active {display: grid;}
.kanban-column {
    background: var(--bg-secondary); border-radius: 8px;
    padding: 0.75rem; min-height: 400px;
}
.kanban-column-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border);
}
.kanban-column-title {
    font-size: 0.9rem; font-weight: 600;
    display: flex; align-items: center; gap: 0.35rem;
}
.kanban-column-count {
    background: var(--bg-tertiary); padding: 0.125rem 0.5rem;
    border-radius: 6px; font-size: 0.75rem; font-weight: 600;
}
.kanban-cards {display: flex; flex-direction: column; gap: 0.5rem; min-height: 350px;}
.kanban-cards.drag-over {
    background: var(--bg-tertiary); border-radius: 6px;
    border: 2px dashed var(--primary);
}
.task-card {
    background: var(--bg-secondary); border: 2px solid transparent;
    border-radius: 10px; padding: 0.75rem; cursor: move;
    transition: all 0.2s; display: flex; gap: 0.5rem;
    position: relative; animation: slideIn 0.2s ease-out;
}
[data-theme="dark"] .task-card {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(26, 26, 26, 0.8) 100%);
    border: 1px solid var(--border);
}

[data-theme="dark"] .customer-CustomerInfo-summary div[style*="color: #000000"] {color: #ffffff !important;}
[data-theme="dark"] .participant-overview-card {
    background: linear-gradient(90deg, var(--bg-secondary) 0%, rgba(26, 26, 26, 0.8) 100%);
    border: 1px solid var(--border);
}
.task-card:hover {box-shadow: 0 4px 12px var(--shadow); transform: translateY(-2px);}
.task-card.overdue {border-left: 3px solid var(--danger);}
.task-card.due-soon {border-left: 3px solid var(--warning);}
.task-card.dragging {opacity: 0.5; transform: rotate(2deg);}
.task-card.color-red {border-color: #ef4444;}
.task-card.color-orange {border-color: #f97316;}
.task-card.color-yellow {border-color: #eab308;}
.task-card.color-green {border-color: #10b981;}
.task-card.color-blue {border-color: #3b82f6;}
.task-card.color-purple {border-color: #8b5cf6;}
.task-card.color-pink {border-color: #ec4899;}
.task-card.priority-low-auto {border-color: #10b981;}
.task-card.priority-medium-auto {border-color: #f97316;}
.task-card.priority-high-auto {border-color: #ef4444;}

.task-number {
    position: absolute; top: -8px; left: 8px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white; width: 22px; height: 22px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.65rem; font-weight: 700;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 10;
}
.task-checkbox {
    width: 24px; height: 24px; border: 2px solid var(--border);
    border-radius: 6px; cursor: pointer; display: flex;
    align-items: center; justify-content: center;
    background: var(--bg-primary); flex-shrink: 0; transition: all 0.2s;
}
.task-checkbox:hover {border-color: var(--primary); transform: scale(1.05);}
.task-checkbox.completed {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border-color: var(--primary);
}
.task-checkbox svg {
    width: 14px; height: 14px; stroke: white; stroke-width: 3;
    fill: none; opacity: 0; transform: scale(0); transition: all 0.2s;
}
.task-checkbox.completed svg {opacity: 1; transform: scale(1);}
.task-content {flex: 1;}
.task-header {display: flex; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.35rem;}
.task-title {
    font-size: 0.9rem; font-weight: var(--font-semibold);
    flex: 1; color: var(--text-primary);
}
.task-title.completed {text-decoration: line-through; opacity: 0.5;}
.task-badges {display: flex; gap: 0.35rem; flex-wrap: wrap;}
.task-priority, .task-category {
    padding: 0.125rem 0.5rem; border-radius: 6px;
    font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
}
.priority-high {background: rgba(239, 68, 68, 0.15); color: var(--danger);}
.priority-medium {background: rgba(245, 158, 11, 0.15); color: var(--warning);}
.priority-low {background: rgba(16, 185, 129, 0.15); color: var(--success);}
.task-customer {
    padding: 0.25rem 0.75rem; border-radius: 8px; font-size: 0.75rem;
    font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
    display: inline-flex; align-items: center; gap: 0.35rem;
}
.task-meeting-badge {
    padding: 0.125rem 0.5rem; border-radius: 6px; font-size: 0.65rem;
    font-weight: 600; background: rgba(139, 92, 246, 0.15); color: #8b5cf6;
    display: flex; align-items: center; gap: 0.25rem;
}
.task-due-date {
    display: flex; align-items: center; gap: 0.35rem;
    color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.35rem;
    padding: 0.25rem 0.5rem; background: var(--bg-tertiary);
    border-radius: 6px; width: fit-content;
}
.task-due-date.overdue {
    background: rgba(239, 68, 68, 0.1); color: var(--danger); font-weight: 600;
}
.task-due-date.due-soon {
    background: rgba(245, 158, 11, 0.1); color: var(--warning); font-weight: 600;
}
.task-description {
    color: var(--text-secondary); font-size: 0.8rem;
    margin-bottom: 0.35rem; white-space: pre-wrap;
}
[data-theme="dark"] .task-description {color: var(--text-secondary); opacity: 0.9;}
[data-theme="dark"] .meeting-summary-date,
[data-theme="dark"] .customer-overview-label {
    color: var(--text-secondary); opacity: 0.85;
}
[data-theme="dark"] .inline-form-container {
    border: 1px solid var(--border); box-shadow: 0 0 40px rgba(0, 229, 221, 0.1);
}
[data-theme="dark"] .customer-header-banner {
    border: 1px solid rgba(0, 229, 221, 0.2);
    box-shadow: 0 4px 20px rgba(0, 229, 221, 0.15);
}
[data-theme="dark"] .form-section {border: 1px solid var(--border);}
[data-theme="dark"] .form-section:hover {
    border-color: rgba(0, 229, 221, 0.3);
    box-shadow: 0 0 20px rgba(0, 229, 221, 0.1);
}
[data-theme="dark"] .meeting-tab.active {
    box-shadow: 0 2px 6px rgba(0, 229, 221, 0.4), 0 0 20px rgba(0, 229, 221, 0.2);
}

.subtasks-container {
    margin: 0.35rem 0; padding-left: 0.5rem; border-left: 2px solid var(--border);
}
.subtask-item {
    display: flex; align-items: center; gap: 0.35rem;
    padding: 0.25rem 0; font-size: 0.75rem;
}
.subtask-checkbox {
    width: 14px; height: 14px; border: 2px solid var(--border);
    border-radius: 3px; cursor: pointer; flex-shrink: 0;
}
.subtask-checkbox.completed {background: var(--primary); border-color: var(--primary);}
.subtask-text.completed {text-decoration: line-through; opacity: 0.6;}
.task-meta {
    display: flex; justify-content: space-between; align-items: center;
    margin-top: 0.35rem; gap: 0.5rem;
}
.task-tags {display: flex; gap: 0.35rem; flex-wrap: wrap; flex: 1;}
.tag {
    padding: 0.125rem 0.5rem; background: var(--bg-tertiary);
    border-radius: 6px; font-size: 0.7rem; color: var(--text-secondary);
}
.task-actions {display: flex; gap: 0.25rem;}
.task-btn {
    background: transparent; border: none; padding: 0.35rem;
    border-radius: 6px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s;
}
.task-btn:hover {background: var(--bg-tertiary); color: var(--primary);}
.task-btn.delete:hover {background: rgba(239, 68, 68, 0.1); color: var(--danger);}
.task-btn.archive:hover {background: rgba(245, 158, 11, 0.1); color: var(--warning);}
.task-btn svg {width: 14px; height: 14px;}

.color-picker {display: flex; gap: 0.35rem; margin-top: 0.35rem;}
.color-option {
    width: 24px; height: 24px; border-radius: 6px; cursor: pointer;
    border: 2px solid transparent; transition: all 0.2s;
}
.color-option:hover {transform: scale(1.1);}
.color-option.selected {border: 2px solid var(--text-primary); transform: scale(1.05);}

.notes-container {
    background: var(--bg-primary); border-radius: 12px; padding: 2.5rem 1rem 1rem 1rem;
    box-shadow: 0 1px 4px var(--shadow); position: sticky; top: 80px;
    max-height: calc(100vh - 100px); overflow-y: auto;
    transition: all 0.3s ease;
    min-height: 120px;
}
.notes-container.has-notes {
    min-height: 200px;
}
.notes-container.empty-notes {
    min-height: 120px;
}
.notes-container.hidden {display: none;}
.notes-container.collapsed-right {
    width: 50px !important; min-width: 50px; padding: 1rem 0.5rem; overflow: hidden;
}
.notes-container.collapsed-right .notes-section-content,
.notes-container.collapsed-right .timeline-section-content,
.notes-container.collapsed-right .section-title span,
.notes-container.collapsed-right .btn-add-note {
    display: none;
}
.notes-container.collapsed-right .collapsible-section-header {
    writing-mode: vertical-rl; text-orientation: mixed;
    justify-content: center; padding: 1rem 0;
}
.notes-container.collapsed-right .collapse-btn {
    transform: rotate(180deg);
}

/* Timeline Section */
.timeline-section {
    margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;
}
.timeline-section:last-child {
    border-bottom: none; margin-bottom: 0; padding-bottom: 0;
}
.section-header-simple {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.25rem 0; margin-bottom: 0.5rem;
}
.timeline-section-content {
    max-height: 400px; overflow-y: auto; overflow-x: hidden;
}
.notes-section-content {
    flex: 1; overflow-y: auto;
}

/* Timeline Items */
.timeline-list {
    position: relative; padding-left: 2rem; margin-left: 0.5rem;
}
.timeline-list::before {
    content: ''; position: absolute; left: 0.35rem; top: 0.5rem; bottom: 0.5rem;
    width: 2px; background: linear-gradient(to bottom, var(--primary), var(--border));
    border-radius: 1px;
}
.timeline-item {
    position: relative; padding: 0.5rem 2rem 0.5rem 0.75rem;
    transition: all 0.2s;
}
.timeline-item:hover {
    background: var(--bg-secondary); 
    padding-left: 1.25rem;
    border-radius: 6px;
}
.timeline-dot {
    position: absolute; left: -1.96rem; top: 0.75rem; width: 12px; height: 12px;
    border-radius: 50%; border: 2px solid var(--bg-primary); z-index: 1;
    transition: all 0.2s;
}
.timeline-dot.meeting { background: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
.timeline-dot.meeting-upcoming { background: #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
.timeline-dot.task-done { background: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
.timeline-dot.task-pending { background: #6b7280; box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.2); }
.timeline-dot.note { background: #8b5cf6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2); }
.timeline-dot.customer { background: var(--primary); box-shadow: 0 0 0 3px rgba(0, 206, 200, 0.2); }
.timeline-dot.prep { background: #ec4899; box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2); }
.timeline-item:hover .timeline-dot {
    transform: scale(1.3);
}
.timeline-item-header {
    display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.15rem;
}
.timeline-item-icon {
    font-size: 0.85rem;
}
.timeline-item-title {
    font-size: 0.8rem; font-weight: 600; color: var(--text-primary);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;
}
.timeline-item-meta {
    font-size: 0.7rem; color: var(--text-secondary);
    display: flex; align-items: center; gap: 0.35rem;
}
.timeline-item-type {
    background: var(--bg-tertiary); padding: 0.1rem 0.4rem; border-radius: 4px;
    font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
}
.timeline-date-separator {
    font-size: 0.65rem; font-weight: 700; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.05em; padding: 0.75rem 0 0.25rem 0;
    border-top: 1px dashed var(--border); margin-top: 0.5rem;
}
.timeline-date-separator:first-child {
    border-top: none; margin-top: 0; padding-top: 0;
}
.timeline-empty {
    text-align: center; padding: 1.5rem 0.5rem; color: var(--text-secondary);
    font-size: 0.8rem;
}
.timeline-empty-icon {
    font-size: 1.5rem; margin-bottom: 0.5rem; opacity: 0.5;
}

.sidebar-collapse-btn {
    position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-tertiary);
    border: 1px solid var(--border); width: 28px; height: 28px; border-radius: 6px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; color: var(--text-secondary); font-size: 0.8rem; z-index: 10;
}

.notes-container.collapsed-right .sidebar-collapse-btn {
    position: static; margin: 0 auto 1rem auto;
}

.notes-list {display: flex; flex-direction: column; gap: 0.5rem; padding-top: 0.75rem;}
.note-box {
    border-radius: 10px; padding: 0.75rem; color: white;
    cursor: move; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative; animation: slideIn 0.2s ease-out;
}
[data-theme="dark"] .note-box {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4), 0 0 20px rgba(0, 229, 221, 0.1);
}
[data-theme="dark"] .note-box:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 30px rgba(0, 229, 221, 0.2);
}
.note-box:hover {transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15);}
.note-box.dragging {opacity: 0.7;}
.note-number {
    position: absolute; top: -10px; left: 8px;
    background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);
    color: white; min-width: 24px; height: 24px; padding: 0 6px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 5;
}
.note-content {
    margin-bottom: 0.5rem; line-height: 1.4;
    white-space: pre-wrap; font-size: 0.8rem;
}
.note-actions {display: flex; justify-content: flex-end; gap: 0.35rem;}
.note-btn {
    background: rgba(255, 255, 255, 0.2); border: none; color: white;
    padding: 0.35rem; border-radius: 6px; cursor: pointer;
    width: 28px; height: 28px; display: flex; align-items: center;
    justify-content: center; transition: all 0.2s;
}
.note-btn:hover {background: rgba(255, 255, 255, 0.3);}
.note-btn svg {width: 14px; height: 14px;}

.modal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 1000;
    align-items: center; justify-content: center; overflow-y: auto; padding: 1rem 0;
}
.modal.active {display: flex;}
.modal-content {
    background: var(--bg-primary); border-radius: 12px; padding: 1.25rem;
    max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3); margin: auto;
}
.modal-content.large {max-width: 800px;}
.modal-content.xlarge {max-width: 1200px; width: 95%;}
.modal-header {
    display: flex; justify-content: space-between;
    align-items: center; margin-bottom: 1rem;
}
.modal-title {
    font-size: 1.25rem; font-weight: var(--font-bold);
    color: var(--text-primary); letter-spacing: -0.02em;
}
.close-btn {
    background: transparent; border: none; font-size: 1.5rem;
    cursor: pointer; padding: 0.25rem; border-radius: 6px;
    color: var(--text-secondary); transition: all 0.2s; line-height: 1;
}
.close-btn:hover {background: var(--bg-secondary); transform: rotate(90deg);}

.modal-tabs {
    display: flex; gap: 0.35rem; margin-bottom: 1rem;
    border-bottom: 2px solid var(--border); overflow-x: auto;
}
.modal-tab {
    padding: 0.5rem 1rem; background: transparent; border: none;
    color: var(--text-secondary); font-size: 0.8rem; font-weight: 500;
    cursor: pointer; border-bottom: 2px solid transparent;
    transition: all 0.2s; white-space: nowrap;
    display: flex; align-items: center; gap: 0.35rem;
}
.modal-tab:hover {color: var(--text-primary); background: var(--bg-secondary);}
.modal-tab.active {color: var(--primary); border-bottom-color: var(--primary);}
.tab-content {display: none;}
.tab-content.active {display: block; animation: fadeIn 0.2s ease-out;}

.form-group {margin-bottom: 0.75rem;}
.form-label {
    display: block; margin-bottom: 0.35rem; font-weight: var(--font-medium);
    font-size: 0.8rem; color: var(--text-primary);
}
.form-input, .form-textarea, .form-select {
    width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border);
    border-radius: 8px; background: var(--bg-secondary);
    color: var(--text-primary); font-size: 0.85rem; font-family: inherit;
}
.form-input:focus, .form-textarea:focus, .form-select:focus {
    outline: none; border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(0, 206, 200, 0.1);
}
[data-theme="dark"] .form-input:focus,
[data-theme="dark"] .form-textarea:focus,
[data-theme="dark"] .form-select:focus {
    box-shadow: 0 0 0 2px rgba(0, 229, 221, 0.2), 0 0 20px rgba(0, 229, 221, 0.1);
}
.form-textarea {resize: vertical; min-height: 80px;}
.form-row {display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;}
.form-row-3 {display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;}
.form-footer {
    display: flex; gap: 0.5rem; justify-content: flex-end;
    margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--border);
}

/* Timeline Delete Button */
.timeline-item-actions {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0;
    transition: opacity 0.2s;
}

.timeline-item:hover .timeline-item-actions {
    opacity: 1;
}

.timeline-delete-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.timeline-delete-btn:hover {
    background: var(--danger);
    border-color: var(--danger);
    color: white;
}

.timeline-delete-btn svg {
    width: 12px;
    height: 12px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

.btn {
    padding: 0.5rem 1rem; border: none; border-radius: 8px;
    font-size: 0.85rem; font-weight: var(--font-semibold);
    cursor: pointer; transition: all 0.2s; letter-spacing: 0.01em;
}
.btn-primary {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%);
    color: white; box-shadow: 0 2px 6px rgba(27, 168, 175, 0.3);
}
.btn-primary:hover {
    background: linear-gradient(135deg, #034857 0%, #1bb8bf 100%);
    transform: translateY(-1px); box-shadow: 0 4px 10px rgba(27, 168, 175, 0.5);
}
.btn-secondary {
    background: var(--bg-secondary); color: var(--text-primary);
    border: 1px solid var(--border);
}
.btn-secondary:hover {background: var(--bg-tertiary);}
.btn-danger {background: var(--danger); color: white;}
.btn-danger:hover {background: #dc2626; transform: translateY(-1px);}

.rich-text-toolbar {
    display: flex; gap: 0.35rem; padding: 0.5rem;
    background: var(--bg-tertiary); border: 1px solid var(--border);
    border-bottom: none; border-radius: 8px 8px 0 0; flex-wrap: wrap;
}
.rich-text-btn {
    padding: 0.4rem 0.6rem; background: var(--bg-secondary);
    border: 1px solid var(--border); border-radius: 6px; cursor: pointer;
    font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);
    transition: all 0.2s; min-width: 34px; display: flex;
    align-items: center; justify-content: center; gap: 0.25rem;
}
.rich-text-btn svg {
    width: 14px; height: 14px; stroke: currentColor; fill: none;
    stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
}
.rich-text-btn:hover {
    background: var(--primary); color: white;
    border-color: var(--primary); transform: translateY(-1px);
}
.rich-text-btn.active {
    background: var(--primary); color: white; border-color: var(--primary);
}
.rich-text-editor {
    width: 100%; min-height: 150px; padding: 0.75rem;
    border: 1px solid var(--border); border-radius: 0 0 8px 8px;
    background: var(--bg-secondary); color: var(--text-primary);
    font-size: 0.85rem; font-family: inherit; overflow-y: auto; line-height: 1.6;
}

.customer-activity-section.fullscreen {
    position: fixed; top: 60px; left: var(--sidebar-width); right: 0; bottom: 0;
    z-index: 1000; margin: 0; border-radius: 0; height: auto !important;
    background: var(--bg-primary); padding: 1.5rem;
}
.customer-activity-section.fullscreen .activity-list {
    max-height: calc(100vh - 170px);
}

.all-customers-section.fullscreen {
    position: fixed; top: 60px; left: var(--sidebar-width); right: 0; bottom: 0;
    z-index: 1000; margin: 0; border-radius: 0; height: auto !important;
    background: var(--bg-primary); padding: 1.5rem;
}
.all-customers-section.fullscreen .customers-list {
    height: calc(100vh - 170px);
}

.fullscreen-btn {
    background: var(--bg-tertiary); border: 1px solid var(--border);
    color: var(--text-secondary); padding: 0.35rem 0.75rem; border-radius: 6px;
    cursor: pointer; font-size: 0.75rem; transition: all 0.2s;
}

/* Auth Styles */
.user-avatar {
    width: 32px; height: 32px; border-radius: 50%; background: var(--primary);
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700; font-size: 0.8rem; cursor: pointer;
}
.user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

/* ========== AI BUTTON STYLES - START ========== */
/*  KEEP THIS - Works for both local and Firebase */

.ai-btn {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.1)) !important;
    border: 1px solid rgba(102, 126, 234, 0.4) !important;
    padding: 0.5rem 0.75rem !important;
    display: flex !important;
    align-items: center !important;
    gap: 0.35rem !important;
}

.ai-btn:hover {
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    border-color: #667eea !important;
    color: white !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.ai-btn:active {
    transform: translateY(0);
}

/* Loading state for editor */
.editor-loading {
    position: relative;
    pointer-events: none;
    opacity: 0.6;
}

.editor-loading::after {
    content: ' AI is improving your text...';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-primary);
    padding: 1rem 1.5rem;
    border-radius: 10px;
    box-shadow: 0 8px 24px var(--shadow);
    font-weight: 600;
    color: var(--primary);
    white-space: nowrap;
    z-index: 10;
    border: 2px solid var(--primary);
}

[data-theme="dark"] .editor-loading::after {
    background: var(--bg-secondary);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8), 0 0 40px rgba(102, 126, 234, 0.3);
}

/* AI improvement badge styles */
.ai-improvement-badge {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05));
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border-left: 4px solid #667eea;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    animation: slideIn 0.3s ease-out;
}

.ai-improvement-badge button {
    background: transparent;
    border: 1px solid #667eea;
    color: #667eea;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    transition: all 0.2s;
}

.ai-improvement-badge button:hover {
    background: #667eea;
    color: white;
    transform: translateY(-1px);
}

/* ========== AI BUTTON STYLES - END ========== */

.rich-text-editor:focus {
    outline: none; border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(0, 206, 200, 0.1);
}
.rich-text-editor ul, .rich-text-editor ol {margin-left: 1.5rem; margin-bottom: 0.5rem;}
.rich-text-editor li {margin-bottom: 0.25rem;}
.rich-text-editor p {margin-bottom: 0.5rem;}
.rich-text-editor strong {font-weight: 700;}
.rich-text-editor em {font-style: italic;}
.rich-text-editor u {text-decoration: underline;}

.meddpicc-toolbar, .action-item-toolbar {
    margin-top: 0.5rem; padding: 0.75rem; background: var(--bg-tertiary);
    border-radius: 8px; border: 1px solid var(--border);
}
.meddpicc-toolbar-label, .action-item-toolbar-label {
    font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);
    margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.35rem;
}
.meddpicc-toolbar-label svg, .action-item-toolbar-label svg {
    width: 14px; height: 14px; stroke: currentColor; fill: none;
    stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
}
.meddpicc-toolbar-buttons, .action-item-toolbar-buttons {
    display: flex; flex-wrap: wrap; gap: 0.35rem;
}
.meddpicc-quick-btn, .action-item-quick-btn {
    padding: 0.4rem 0.75rem; background: var(--bg-primary);
    border: 1px solid var(--border); border-radius: 6px;
    font-size: 0.75rem; font-weight: 500; cursor: pointer;
    transition: all 0.2s; color: var(--text-primary); white-space: nowrap;
    display: flex; align-items: center; gap: 0.35rem; position: relative;
}
.meddpicc-info-icon {
    display: inline-flex; align-items: center; justify-content: center;
    width: 14px; height: 14px; border-radius: 50%; background: var(--text-secondary);
    color: white; font-size: 0.6rem; font-weight: 700;
    cursor: help; margin-left: 0.25rem; position: relative;
}
.meddpicc-info-icon:hover {background: var(--primary);}
.meddpicc-tooltip {
    position: fixed; bottom: auto; left: 50%; transform: translateX(-50%) translateY(-100%);
    background: var(--bg-primary); border: 1px solid var(--border);
    border-radius: 8px; padding: 0.75rem; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    z-index: 10000; width: 320px; display: none; pointer-events: none;
}
.meddpicc-tooltip::after {
    content: ''; position: absolute; top: 100%; left: 50%;
    transform: translateX(-50%); border: 6px solid transparent; border-top-color: var(--border);
}
.meddpicc-tooltip::before {
    content: ''; position: absolute; top: 100%; left: 50%;
    transform: translateX(-50%); border: 5px solid transparent;
    border-top-color: var(--bg-primary); z-index: 1;
}
.meddpicc-info-icon:hover .meddpicc-tooltip {display: block;}
.meddpicc-quick-btn:hover .meddpicc-tooltip {display: block;}
.meddpicc-tooltip-title {
    font-weight: 700; font-size: 0.8rem; margin-bottom: 0.35rem; color: var(--primary);
}
.meddpicc-tooltip-description {font-size: 0.75rem; line-height: 1.4; color: var(--text-primary);}
.meddpicc-quick-btn:hover {
    background: var(--primary); color: white;
    border-color: var(--primary); transform: translateY(-1px);
}
.action-item-quick-btn:hover {
    background: var(--success); color: white;
    border-color: var(--success); transform: translateY(-1px);
}
.meddpicc-quick-btn.success-flash, .action-item-quick-btn.success-flash {
    background: var(--success); color: white;
    border-color: var(--success); animation: successPulse 0.5s ease-out;
}
@keyframes successPulse {
    0% {transform: scale(1);}
    50% {transform: scale(1.05);}
    100% {transform: scale(1);}
}

.task-status {
    padding: 0.125rem 0.5rem;
    border-radius: 6px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
}
.task-status:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}
.status-todo {
    background: rgba(107, 114, 128, 0.15);
    color: #6b7280;
}
.status-todo:hover {
    background: rgba(107, 114, 128, 0.25);
}
.status-in-progress {
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
}
.status-in-progress:hover {
    background: rgba(59, 130, 246, 0.25);
}
.status-done {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}
.status-done:hover {
    background: rgba(16, 185, 129, 0.25);
}

.subtasks-form {margin-top: 0.35rem;}
.subtask-input-group {display: flex; gap: 0.35rem; margin-bottom: 0.35rem;}
.subtask-input {flex: 1;}
.btn-add-subtask {
    padding: 0.35rem 0.75rem; background: var(--bg-tertiary);
    border: 1px solid var(--border); border-radius: 6px;
    cursor: pointer; color: var(--text-primary); font-size: 0.8rem;
}
.btn-add-subtask:hover {
    background: var(--primary); color: white; border-color: var(--primary);
}
.btn-remove-subtask {
    padding: 0.35rem; background: var(--danger); color: white;
    border: none; border-radius: 6px; cursor: pointer;
}

.participants-list {
    margin-top: 0.5rem; padding: 0.75rem;
    background: var(--bg-secondary); border-radius: 6px;
}
.participant-item {
    padding: 0.5rem; background: var(--bg-tertiary); border-radius: 6px;
    margin-bottom: 0.35rem; display: flex; justify-content: space-between; align-items: center;
}
.participant-info {flex: 1;}
.participant-name {font-weight: 600; margin-bottom: 0.125rem; font-size: 0.8rem;}
.participant-role {font-size: 0.75rem; color: var(--text-secondary);}
.btn-remove-participant {
    background: var(--danger); color: white; border: none;
    padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;
}

.meeting-tasks-list {
    margin-top: 0.5rem; padding: 0.75rem; background: var(--bg-secondary);
    border-radius: 6px; max-height: 200px; overflow-y: auto;
}
.meeting-task-preview {
    padding: 0.5rem; background: var(--bg-tertiary); border-radius: 6px;
    margin-bottom: 0.35rem; display: flex; justify-content: space-between;
    align-items: center; font-size: 0.8rem;
}
.btn-remove-meeting-task {
    background: var(--danger); color: white; border: none;
    padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;
}

.export-content {background: var(--bg-secondary); border-radius: 8px; padding: 0.75rem;}
.export-preview {
    background: var(--bg-tertiary); border: 1px solid var(--border);
    border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem;
    max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace;
    font-size: 0.75rem; white-space: pre-wrap;
}
.export-actions {display: flex; gap: 0.35rem;}
.btn-export {
    flex: 1; padding: 0.5rem 1rem; border: 1px solid var(--border);
    border-radius: 8px; font-size: 0.8rem; font-weight: var(--font-semibold);
    cursor: pointer; transition: all 0.2s; background: var(--bg-secondary);
    color: var(--text-primary); box-shadow: none;
}


.customer-list {
    display: flex; flex-direction: column; gap: 0.5rem;
    max-height: 350px; overflow-y: auto;
}
.customer-item {
    padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;
    display: flex; justify-content: space-between; align-items: center;
}
.customer-info {flex: 1;}
.customer-name {font-weight: 600; margin-bottom: 0.125rem; font-size: 0.85rem;}
.customer-email {font-size: 0.75rem; color: var(--text-secondary);}
.customer-actions {display: flex; gap: 0.35rem;}

.modal-content.fullscreen {
    position: fixed;
    top: 60px;
    left: var(--sidebar-width);
    right: 0;
    bottom: 0;
    max-width: none !important;
    width: auto !important;
    max-height: none !important;
    margin: 0;
    border-radius: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal:has(.modal-content.fullscreen) {
    overflow: hidden;
    padding: 0;
}

.modal-content.fullscreen .modal-header {
    flex-shrink: 0;
}

.modal-content.fullscreen .modal-tabs {
    flex-shrink: 0;
}

.modal-content.fullscreen .tab-content.active {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-content.fullscreen #consolidatedNotesContent {
    flex: 1;
    max-height: none;
    height: 100%;
    overflow-y: auto;
}

/* Default (non-fullscreen) state for consolidated notes */
#consolidatedNotesContent {
    max-height: 70vh;
    overflow-y: auto;
}

.modal-content.fullscreen .export-preview {
    max-height: calc(100vh - 250px);
}

.tags-overview-content {
    display: grid; grid-template-columns: 250px 1fr; gap: 1rem; max-height: 70vh;
}
.tags-list-section {
    border-right: 1px solid var(--border); padding-right: 1rem; overflow-y: auto;
}
.tag-item {
    padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px;
    margin-bottom: 0.35rem; cursor: pointer; transition: all 0.2s;
    display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;
}
.tag-item:hover {background: var(--bg-tertiary); transform: translateX(2px);}
.tag-item.active {
    background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;
}
.tag-item-name {font-weight: 600;}
.tag-item-count {
    font-size: 0.75rem; background: var(--bg-tertiary);
    padding: 0.125rem 0.35rem; border-radius: 4px;
}
.tag-item.active .tag-item-count {background: rgba(255, 255, 255, 0.2);}
.customers-by-tag-section {overflow-y: auto;}
.customer-tag-card {
    background: var(--bg-secondary); border-radius: 8px;
    padding: 0.75rem; margin-bottom: 0.5rem;
}
.customer-tag-header {
    display: flex; justify-content: space-between;
    align-items: center; margin-bottom: 0.5rem;
}
.customer-tag-name {font-size: 1rem; font-weight: 600;}
.meetings-count-badge {
    background: var(--primary); color: white;
    padding: 0.125rem 0.5rem; border-radius: 6px;
    font-size: 0.7rem; font-weight: 600;
}
.meetings-list-compact {display: flex; flex-direction: column; gap: 0.35rem;}
.meeting-compact-item {
    padding: 0.5rem; background: var(--bg-tertiary);
    border-radius: 6px; font-size: 0.8rem;
}
.meeting-compact-date {
    color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.125rem;
}

.meeting-card {
    background: var(--bg-secondary); border-radius: 8px;
    padding: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid #667eea;
}
.meeting-header {
    display: flex; justify-content: space-between;
    align-items: start; margin-bottom: 0.5rem;
}
.meeting-info h3 {font-size: 0.95rem; margin-bottom: 0.25rem;}
.meeting-date {color: var(--text-secondary); font-size: 0.75rem;}
.meeting-notes {
    color: var(--text-secondary); font-size: 0.8rem;
    margin-bottom: 0.5rem; white-space: pre-wrap;
}
.meeting-tasks {margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);}
.meeting-tasks-title {
    font-size: 0.75rem; font-weight: 600;
    margin-bottom: 0.35rem; color: var(--text-secondary);
}
.meeting-task-item {
    padding: 0.35rem; background: var(--bg-tertiary);
    border-radius: 4px; margin-bottom: 0.25rem; font-size: 0.75rem;
}
.meeting-tag {
    display: inline-block; padding: 0.125rem 0.5rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white; border-radius: 8px; font-size: 0.7rem;
    font-weight: 600; margin-right: 0.35rem; margin-bottom: 0.35rem;
}

.meddpicc-section {margin-top: 0.75rem; padding-top: 0.75rem; border-top: 2px solid var(--border);}
.meddpicc-section-title {
    font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);
    margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.35rem;
}
.meddpicc-grid, .meddpicc-form-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;}
.meddpicc-field {background: var(--bg-tertiary); padding: 0.5rem; border-radius: 6px;}
.meddpicc-field-label {
    font-size: 0.65rem; font-weight: 600; color: var(--text-secondary);
    text-transform: uppercase; margin-bottom: 0.25rem;
    display: flex; align-items: center; gap: 0.25rem;
}
.meddpicc-field-value {font-size: 0.75rem; color: var(--text-primary); white-space: pre-wrap;}
.meddpicc-field.empty .meddpicc-field-value {
    color: var(--text-secondary); font-style: italic;
}

.empty-state {text-align: center; padding: 2rem 1rem; color: var(--text-secondary);}
.empty-state-icon {font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;}

.confirm-modal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
    z-index: 1001; align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out;
}
.confirm-modal.active {display: flex;}
.confirm-content {
    background: var(--bg-primary); border-radius: 12px; padding: 1.25rem;
    max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    text-align: center; animation: slideUp 0.2s ease-out;
}
@keyframes slideUp {
    from {opacity: 0; transform: translateY(20px);}
    to {opacity: 1; transform: translateY(0);}
}
.confirm-icon {font-size: 2rem; margin-bottom: 0.5rem;}
.confirm-title {font-size: 1.1rem; font-weight: 600; margin-bottom: 0.35rem;}
.confirm-message {
    color: var(--text-secondary); margin-bottom: 1rem;
    line-height: 1.4; font-size: 0.85rem;
}
.confirm-actions {display: flex; gap: 0.5rem; justify-content: center;}

.toast {
    position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%) translateY(100px);
    background: var(--bg-primary); border: 1px solid var(--border);
    border-radius: 8px; padding: 0.75rem 1rem; box-shadow: 0 4px 12px var(--shadow);
    z-index: 1001; transition: transform 0.3s; font-size: 0.85rem;
}
.toast.active {transform: translateX(-50%) translateY(0);}
.toast.success {border-left: 3px solid var(--success);}
.toast.error {border-left: 3px solid var(--danger);}

@media (max-width: 1200px) {
    .container {grid-template-columns: 1fr;}
    .notes-container {position: relative; top: 0; max-height: none;}
    .kanban-board {grid-template-columns: 1fr;}
    .form-row-3 {grid-template-columns: 1fr;}
    .tags-overview-content {grid-template-columns: 1fr;}
    .tags-list-section {
        border-right: none; border-bottom: 1px solid var(--border);
        padding-right: 0; padding-bottom: 0.5rem; margin-bottom: 0.5rem;
    }
    .meddpicc-items {grid-template-columns: repeat(2, 1fr);}
    .meddpicc-grid, .meddpicc-form-grid {grid-template-columns: 1fr;}
    .customer-overview-grid {grid-template-columns: 1fr;}
}
@media (max-width: 768px) {
    :root {--sidebar-width: 0;}
    .sidebar {transform: translateX(-100%);}
    .header, .container {margin-left: 0;}
    .form-row {grid-template-columns: 1fr;}
    .modal-content.xlarge, .modal-content.large {width: 95%; padding: 1rem;}
    .modal-tabs {overflow-x: scroll;}
    .inline-form-container {padding: 1rem 1.5rem; max-width: 100%;}
}

/* ========== CONSOLIDATED GREEN GRADIENT HOVER - START ========== */
.fullscreen-btn:hover,
.sidebar-collapse-btn:hover,
.btn-schedule-meeting:hover,
.btn-add-meeting:hover,
.btn-add-participant:hover,
.btn-add-tab:hover,
.empty-state-add-btn:hover,
.btn-view-all-notes:hover,
.meeting-summary-notes-toggle:hover,
.rich-text-btn:hover,
.meddpicc-quick-btn:hover,
.template-btn:hover,
.btn-export:hover {
    background: linear-gradient(135deg, #023747 0%, #1ba8af 100%) !important;
    color: white !important;
    border-color: #023747 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(27, 168, 175, 0.5);
}
/* ========== CONSOLIDATED GREEN GRADIENT HOVER - END ========== */

    </style>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

</head>
<body>
    <aside class="sidebar">
    <div class="sidebar-logo">Mnimi</div>

    <div>
        <button class="action-btn btn-home" id="homeBtn" style="margin-bottom: 1rem;">
                <div class="action-btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                        <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                        <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                        <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                    </svg>
                </div>
                <span>Dashboard</span>
            </button>

            <div class="sidebar-title">Quick Actions</div>
<button class="action-btn btn-add-customer" id="addCustomerBtn">
    <div class="action-btn-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
        </svg>
    </div>
    <span>Add Customer</span>
</button>

            <button class="action-btn btn-meeting" id="newMeetingBtn">
                <div class="action-btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <span>New Meeting</span>
            </button>
            <button class="action-btn btn-new-task" id="newTaskBtn">
                <div class="action-btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"></path>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>
                </div>
                <span>New Task</span>
            </button>
            <button class="action-btn btn-new-note" id="newNoteBtn">
                <div class="action-btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                </div>
                <span>Quick Note</span>
            </button>
            <button class="action-btn btn-show-tasks" id="showAllTasksBtn">
                <div class="action-btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"></line>
                        <line x1="8" y1="12" x2="21" y2="12"></line>
                        <line x1="8" y1="18" x2="21" y2="18"></line>
                        <line x1="3" y1="6" x2="3.01" y2="6"></line>
                        <line x1="3" y1="12" x2="3.01" y2="12"></line>
                        <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                </div>
                <span>All Tasks</span>
            </button>


            <!-- ========== SHARING FEATURE - START ========== -->
            <!-- Can delete this entire button when removing offline testing -->
            <button class="action-btn btn-shared" id="sharedBtn" style="position: relative;">
                <div class="action-btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                        <polyline points="16 6 12 2 8 6"></polyline>
                        <line x1="12" y1="2" x2="12" y2="15"></line>
                    </svg>
                </div>
                <span>Shared</span>
                <span class="notification-badge" id="sharedNotificationBadge" style="display: none;">0</span>
            </button>
            <!-- ========== SHARING FEATURE - END ========== -->

                    </div>

            <!-- Separator Line -->
            <div style="height: 2px; background: linear-gradient(90deg, transparent, var(--primary), transparent); opacity: 0.3; margin: 1rem 0.5rem;"></div>

<div class="sidebar-customers-scroll">
    <!-- Priority Accounts Section -->
    <div id="priorityAccountsSection" style="display: none;">
        <div class="priority-section-header">
            <span class="star-icon"></span>
            <span>Priority Accounts</span>
        </div>
        <div id="pinnedCustomerFilters"></div>
        <div class="priority-section-divider"></div>
    </div>

<!-- Customer Filters Container (hidden but kept for JS compatibility) -->
<div id="customerFilters" style="display: none;"></div>


        

 <!-- User Guide Button - Bottom of Sidebar -->
        <button class="action-btn btn-guide" onclick="window.open('guide.html', '_blank')" style="
            display: none;
            margin-top: auto;
            padding: 0.5rem 0.6rem;
            font-size: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            opacity: 0.85;
            transition: all 0.3s;
        " onmouseover="this.style.opacity='1'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.5)'" onmouseout="this.style.opacity='0.85'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'">
            <div class="action-btn-icon" style="width: 28px; height: 28px; font-size: 0.85rem;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </div>
            <span style="font-size: 0.8rem;">User Guide</span>
        </button>

    </aside>



    <header class="header">
      <div class="header-content">
    <div style="display: flex; gap: 1rem; align-items: center; flex: 1;">
        <div class="search-bar">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" id="searchInput" placeholder="Search company, industry...">
        </div>
        <div class="header-actions">
 
    <button class="btn-icon" id="exportAllBtn" title="Export All Data">
        <svg viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
    </button>
    <button class="btn-icon" id="importAllBtn" title="Import Data">
        <svg viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
    </button>
    <!-- Hidden file input for import -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;">
            <button class="btn-icon" id="tagsOverviewBtn" title="Tags">
                <svg viewBox="0 0 24 24">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                </svg>
            </button>
            <button class="btn-icon" id="viewMeetingsBtn" title="Meetings">
                <svg viewBox="0 0 24 24">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
            </button>
            <button class="btn-icon" id="themeToggle" title="Theme">
                <svg viewBox="0 0 24 24">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            <button class="btn-icon" id="archiveBtn" title="Archive">
                <svg viewBox="0 0 24 24">
                    <polyline points="21 8 21 21 3 21 3 8"></polyline>
                    <rect x="1" y="3" width="22" height="5"></rect>
                    <line x1="10" y1="12" x2="14" y2="12"></line>
                </svg>
            </button>
            <button class="btn-icon danger" id="clearAllBtn" title="Clear All">
                <svg viewBox="0 0 24 24">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
            </button>
        </div>
    </div>
    <div id="userAuthArea">
    <button class="btn-sign-in" id="signInBtn" onclick="openAuthModal()">
        <svg viewBox="0 0 24 24">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
        </svg>
        <span>Sign In</span>
    </button>
</div>
</div>
        </div>
<div class="customer-header-banner" id="customerHeaderBanner">
    <div class="customer-banner-top">
        <div class="customer-header-left">
            <div class="customer-header-icon"></div>
            <div class="customer-header-info">
                <div class="customer-header-name" id="customerHeaderName"></div>
            </div>
        </div>
        <div class="customer-header-actions">
    <button class="customer-header-btn" id="bannerPinBtn" onclick="togglePinFromBanner()" title="Pin to Priority">
        <span id="bannerPinIcon"></span>
    </button>
    <button class="customer-header-btn" onclick="editCustomerFromBanner()" title="Edit Profile">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </button>
            <button class="customer-header-btn delete" onclick="deleteCustomerFromHeader()" title="Delete">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
            <button class="customer-header-btn" onclick="showDashboard()" title="Back to All">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
    </div>
    <div class="customer-banner-details" id="customerBannerDetails"></div>
</div>
</div>
    </header>

    <div class="container" id="mainContainer">
        <div class="main-content">
<!-- Inline CustomerInfo Form -->
<div class="inline-form-container" id="inlineCustomerInfoForm">
    <form id="CustomerInfoForm">
        <input type="hidden" id="CustomerInfoId">
        
        <!-- Sticky Action Bar -->
        <div class="sticky-action-bar">
            <div class="sticky-action-bar-title">
                 Customer Info
            </div>
            <div class="sticky-action-bar-actions">
                <button type="button" class="btn btn-secondary btn-large" onclick="closeInlineCustomerInfoForm()">
                     Cancel
                </button>
                <button type="submit" class="btn btn-primary btn-large">
                     Save Customer Info
                </button>
            </div>
        </div>

        <div class="modal-tabs">
            <button type="button" class="modal-tab active" data-tab="info" data-form="Customer Info"> Info </button>
            <button type="button" class="modal-tab" data-tab="export" data-form="Customer Info"> Export</button>
        </div>

        <div class="tab-content active" data-tab-content="info">
            <!-- Customer Selection -->
            <div class="form-section" style="border-color: var(--primary);">
                <div class="form-section-header">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Customer *</div>
                </div>
                <div class="form-section-content">
                    <div class="customer-combobox">
                        <input type="text" class="customer-combobox-input" id="CustomerInfoCustomerInput" 
                               placeholder="Type to search or add new customer..." autocomplete="off" required>
                        <div class="customer-dropdown" id="CustomerInfoCustomerDropdown"></div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                         Type a name to search existing customers or create a new one
                    </div>
                </div>
            </div>


            <!-- Background & Context -->
            <div class="form-section">
                <div class="form-section-header" onclick="toggleSection(this)">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Background & Context</div>
                    <div class="form-section-toggle"></div>
                </div>
                <div class="form-section-content">
                    <textarea class="form-textarea" id="CustomerInfoBackground" 
                              placeholder="Company background, previous interactions, relevant context..."
                              style="min-height: 100px;"></textarea>
                </div>
            </div>

            <!-- Discussion Points -->
            <div class="form-section">
                <div class="form-section-header" onclick="toggleSection(this)">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Discussion Points</div>
                    <div class="form-section-toggle"></div>
                </div>
                <div class="form-section-content">
                    <textarea class="form-textarea" id="CustomerInfoDiscussionPoints" 
                              placeholder="Key topics to cover...&#10;&#10; Topic 1&#10; Topic 2&#10; Topic 3"
                              style="min-height: 100px;"></textarea>
                </div>
            </div>



            <!-- Materials Needed -->
            <div class="form-section">
                <div class="form-section-header" onclick="toggleSection(this)">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Competitive Intelligence</div>
                    <div class="form-section-toggle"></div>
                </div>
                <div class="form-section-content">
                    <textarea class="form-textarea" id="CustomerInfoMaterials" 
                              placeholder="Key topics to cover...&#10;&#10; Competitors they're evaluating 1&#10; Why they're considering switching&#10; Previous vendors"
                              style="min-height: 80px;"></textarea>
                </div>
            </div>

            <!-- Expected Outcomes -->
            <div class="form-section">
                <div class="form-section-header" onclick="toggleSection(this)">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Expected Outcomes</div>
                    <div class="form-section-toggle"></div>
                </div>
                <div class="form-section-content">
                    <textarea class="form-textarea" id="CustomerInfoOutcomes" 
                              placeholder="What success looks like after this meeting..."
                              style="min-height: 80px;"></textarea>
                </div>
            </div>
        </div>

        <div class="tab-content" data-tab-content="export">
            <div class="export-content">
                <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem;"> Export CustomerInfo</h4>
                <div class="export-preview" id="CustomerInfoExportPreview">Preview...</div>
                <div class="export-actions">
                    <button type="button" class="btn-export" id="copyCustomerInfoBtn">Copy</button>
                    <button type="button" class="btn-export" id="downloadCustomerInfoBtn">Download</button>
                </div>
            </div>
        </div>
    </form>
</div>

         <!-- Inline Meeting Form -->
<div class="inline-form-container" id="inlineMeetingForm">
    <form id="meetingForm">
        <input type="hidden" id="meetingId">
        
        <!-- Sticky Action Bar -->
        <div class="sticky-action-bar">
            <div class="sticky-action-bar-title" id="meetingFormTitle">
                 Meeting Notes
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
<label style="display: none; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.85rem; white-space: nowrap;" id="markCompletedWrapper">
    <input type="checkbox" id="meetingMarkCompleted" style="width: auto; cursor: pointer;">
    <span> Mark as completed</span>
</label>
                <div class="sticky-action-bar-actions">
                    <button type="button" class="btn btn-secondary btn-large" onclick="closeInlineMeetingForm()">
                         Cancel
                    </button>
                    <button type="submit" class="btn btn-primary btn-large">
                        Save Meeting
                    </button>
                </div>
            </div>
        </div>

        <div class="modal-tabs">
            <button type="button" class="modal-tab active" data-tab="info" data-form="meeting">
                 Info
            </button>
            <button type="button" class="modal-tab" data-tab="CustomerInfo" data-form="meeting" id="CustomerInfoTab" style="display: none;">
                 Prep
            </button>
            <button type="button" class="modal-tab" data-tab="notes" data-form="meeting">
                 Notes
            </button>
            <button type="button" class="modal-tab" data-tab="meddpicc" data-form="meeting">
                 MEDDPICC
            </button>
            <button type="button" class="modal-tab" data-tab="actions" data-form="meeting">
                 Actions
            </button>
            <button type="button" class="modal-tab" data-tab="export" data-form="meeting">
                 Export
            </button>
        </div>

        <!-- INFO TAB -->
        <div class="tab-content active" data-tab-content="info">
            <!-- Customer -->
            <div class="form-section" style="border-color: var(--primary);">
                <div class="form-section-header">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Customer *</div>
                </div>
                <div class="form-section-content">
                    <div class="customer-combobox">
                        <input type="text" class="customer-combobox-input" id="meetingCustomerInput" 
       placeholder="Type to search or add new customer..." autocomplete="off">
                        <div class="customer-dropdown" id="customerDropdown"></div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                         Type a name to search existing customers or create a new one
                    </div>
                </div>
            </div>

            <!-- Meeting Details -->
            <div class="form-section">
                <div class="form-section-header">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Meeting Details</div>
                </div>
                <div class="form-section-content">
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-input" id="meetingTitle" placeholder="e.g., Q4 Business Review">
                    </div>
                    
                   <div class="form-row">
    <div class="form-group">
        <label class="form-label">Date & Time * <span style="font-size: 0.7rem; font-weight: 400; color: var(--text-secondary);">(DD/MM/YYYY)</span></label>
        <input type="datetime-local" class="form-input" id="meetingDate" required>
    </div>
    <div class="form-group">
        <label class="form-label">Duration (min)</label>
        <input type="number" class="form-input" id="meetingDuration" placeholder="60" min="1">
    </div>
</div>
<div class="form-group">
    <label class="form-label">Conference Link <span style="font-weight: 400; color: var(--text-secondary);">(optional)</span></label>
    <div style="position: relative;">
        <input type="url" class="form-input" id="meetingConferenceLink" placeholder="https://zoom.us/j/... or https://meet.google.com/..." style="padding-left: 2.5rem;">
        <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); font-size: 1.1rem;"></span>
    </div>
    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
         Zoom, Google Meet, Teams, or any video call link
    </div>
</div>
                    <div class="form-group">
                        <label class="form-label">Meeting Type *</label>
                       <div class="meeting-type-pills" id="meetingTypePills">
    <div class="meeting-type-pill" onclick="selectMeetingType('discovery')">
        <span class="meeting-type-icon"></span>
        <span>Discovery</span>
    </div>
    <div class="meeting-type-pill" onclick="selectMeetingType('follow-up')">
        <span class="meeting-type-icon"></span>
        <span>Follow-up</span>
    </div>
    <button type="button" class="meeting-type-pill" onclick="addCustomMeetingType()" style="border: 2px dashed var(--border); background: transparent;">
        <span class="meeting-type-icon"></span>
        <span>Add Type</span>
    </button>
</div>
                        <input type="hidden" id="meetingType" value="other">

                    </div>
                </div>
            </div>

                       <!-- Participants -->
            <div class="form-section">
                <div class="form-section-header" onclick="toggleSection(this)">
                    <div class="form-section-icon"></div>
                    <div class="form-section-title">Participants</div>
                    <div class="form-section-toggle"></div>
                </div>
                <div class="form-section-content">
                    <!-- Quick Add from Existing Contacts -->
                    <div class="quick-add-contacts" id="quickAddContactsContainer">
                        <div class="quick-add-contacts-title">
                            <span></span>
                            <span>Quick Add from Contacts</span>
                        </div>
                        <div class="quick-add-contacts-list" id="quickAddContactsList"></div>
                    </div>
                    
                    <div class="form-row" style="margin-bottom: 0.75rem;">
                        <input type="text" class="form-input" id="participantNameInput" placeholder="Name *">
                        <input type="text" class="form-input" id="participantRoleInput" placeholder="Role">
                    </div>
<div class="form-row" style="margin-bottom: 0.75rem;">
    <input type="text" class="form-input" id="participantEmailInput" placeholder="Email(s) - comma separated">
    <input type="text" class="form-input" id="participantPhoneInput" placeholder="Phone(s) - comma separated">
</div>
                    <button type="button" class="btn btn-primary" id="addParticipantBtn" style="width: 100%; margin-bottom: 1rem;">
                        + Add Participant
                    </button>
                    <div class="participant-grid" id="participantsList"></div>
                </div>
            </div>
        </div>

        <!-- CUSTOMERINFO TAB -->
        <div class="tab-content" data-tab-content="CustomerInfo">
            <div id="CustomerInfoContent" style="background: var(--bg-secondary); padding: 0.75rem; border-radius: 8px;">
                <p style="color: var(--text-secondary); text-align: center; font-size: 0.8rem;">No CustomerInfo</p>
            </div>
        </div>

        <!-- NOTES TAB -->
        <div class="tab-content" data-tab-content="notes">


            <div class="form-group">
                <label class="form-label">Meeting Notes *</label>
                <div class="enhanced-editor-wrapper">
                    <div class="enhanced-editor-toolbar">
                        <div class="toolbar-group">
                            <button type="button" class="rich-text-btn" data-command="bold" title="Bold">
                                <svg viewBox="0 0 24 24"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg>
                            </button>
                            <button type="button" class="rich-text-btn" data-command="italic" title="Italic">
                                <svg viewBox="0 0 24 24"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg>
                            </button>
                            <button type="button" class="rich-text-btn" data-command="underline" title="Underline">
                                <svg viewBox="0 0 24 24"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path><line x1="4" y1="21" x2="20" y2="21"></line></svg>
                            </button>
                        </div>
                        <div class="toolbar-group">
                            <button type="button" class="rich-text-btn" data-command="insertUnorderedList" title="Bullet List">
                                <svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                            </button>
                            <button type="button" class="rich-text-btn" data-command="insertOrderedList" title="Numbered List">
                                <svg viewBox="0 0 24 24"><line x1="10" y1="6" x2="21" y2="6"></line><line x1="10" y1="12" x2="21" y2="12"></line><line x1="10" y1="18" x2="21" y2="18"></line><path d="M4 6h1v4"></path><path d="M4 10h2"></path><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"></path></svg>
                            </button>
                        </div>
                        <!-- ========== AI BUTTON FOR NOTES - START ========== -->
                        <!--  KEEP THIS - Works for both local and Firebase -->
                        <div class="toolbar-group" style="border-left: 2px solid var(--primary); padding-left: 0.5rem;">
                            <button type="button" class="rich-text-btn ai-btn" onclick="aiImproveText('meetingNotesEditor')" title="AI Improve Text">
                                <span style="font-size: 1.1rem;"></span>
                                <span style="font-size: 0.7rem; font-weight: 600;">AI Improve</span>
                            </button>
                        </div>
                        <!-- ========== AI BUTTON FOR NOTES - END ========== -->
                    </div>
                    <div class="rich-text-editor enhanced-editor-content" id="meetingNotesEditor" contenteditable="true" data-placeholder="Start typing your notes..."></div>
                </div>
                <div class="meddpicc-toolbar">
                    <div class="meddpicc-toolbar-label">
                         Select text and quick add to MEDDPICC:
                    </div>
                    <div class="meddpicc-toolbar-buttons">
                        <button type="button" class="meddpicc-quick-btn" data-field="metrics"><span></span><span>Metrics</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="economicBuyer"><span></span><span>Buyer</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="decisionCriteria"><span></span><span>Criteria</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="decisionProcess"><span></span><span>Process</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="paperProcess"><span></span><span>Paper</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="pain"><span></span><span>Pain</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="champion"><span></span><span>Champion</span></button>
                        <button type="button" class="meddpicc-quick-btn" data-field="competition"><span></span><span>Comp</span></button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Next Steps</label>
                <div class="enhanced-editor-wrapper">
                    <div class="enhanced-editor-toolbar">
                        <div class="toolbar-group">
                            <button type="button" class="rich-text-btn" data-command="bold" data-target="nextSteps" title="Bold">
                                <svg viewBox="0 0 24 24"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg>
                            </button>
                            <button type="button" class="rich-text-btn" data-command="insertUnorderedList" data-target="nextSteps" title="Bullet List">
                                <svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line></svg>
                            </button>
                        </div>
 <!-- ========== AI BUTTON FOR NEXT STEPS - START ========== -->
                        <!--  KEEP THIS - Works for both local and Firebase -->
                        <div class="toolbar-group" style="border-left: 2px solid var(--primary); padding-left: 0.5rem;">
                            <button type="button" class="rich-text-btn ai-btn" onclick="aiImproveText('meetingNextStepsEditor')" title="AI Improve Text">
                                <span style="font-size: 1.1rem;"></span>
                                <span style="font-size: 0.7rem; font-weight: 600;">AI Improve</span>
                            </button>
                        </div>
                        <!-- ========== AI BUTTON FOR NEXT STEPS - END ========== -->

                    </div>
                    <div class="rich-text-editor enhanced-editor-content" id="meetingNextStepsEditor" contenteditable="true" data-placeholder="What are the next steps?"></div>
                </div>
                <div class="action-item-toolbar">
                    <div class="action-item-toolbar-label"> Select text and quick add action:</div>
                    <div class="action-item-toolbar-buttons">
                        <button type="button" class="action-item-quick-btn">
                            <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 2;">
                                <line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            <span>Add Task</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Tags</label>
                <input type="text" class="form-input" id="meetingTags" placeholder="renewal, upsell, expansion">
            </div>
        </div>

        <!-- MEDDPICC TAB -->
        <div class="tab-content" data-tab-content="meddpicc">
            <!-- Visual Tracker -->
            <div class="meddpicc-visual-tracker" id="meddpiccVisualTracker">
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('Metrics')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Metrics</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('EconomicBuyer')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Buyer</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('DecisionCriteria')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Criteria</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('DecisionProcess')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Process</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('PaperProcess')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Paper</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('Pain')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Pain</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('Champion')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Champion</div>
                </div>
                <div class="meddpicc-tracker-item" onclick="focusMeddpiccField('Competition')">
                    <div class="meddpicc-tracker-icon"></div>
                    <div class="meddpicc-tracker-label">Comp</div>
                </div>
            </div>

            <div class="meddpicc-form-grid">
                <div class="form-group">
                    <label class="form-label"> Metrics</label>
                    <textarea class="form-textarea" id="meddpiccMetrics" placeholder="ROI, cost savings, efficiency gains..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"> Economic Buyer</label>
                    <input type="text" class="form-input" id="meddpiccEconomicBuyer" placeholder="Name & Title">
                </div>
                <div class="form-group">
                    <label class="form-label"> Decision Criteria</label>
                    <textarea class="form-textarea" id="meddpiccDecisionCriteria" placeholder="Technical & business requirements..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"> Decision Process</label>
                    <textarea class="form-textarea" id="meddpiccDecisionProcess" placeholder="Steps, stakeholders, timeline..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"> Paper Process</label>
                    <textarea class="form-textarea" id="meddpiccPaperProcess" placeholder="Legal, procurement, approvals..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"> Pain</label>
                    <textarea class="form-textarea" id="meddpiccPain" placeholder="Problems they need to solve..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"> Champion</label>
                    <input type="text" class="form-input" id="meddpiccChampion" placeholder="Name & Title">
                </div>
                <div class="form-group">
                    <label class="form-label"> Competition</label>
                    <textarea class="form-textarea" id="meddpiccCompetition" placeholder="Other vendors, alternatives..."></textarea>
                </div>
            </div>
        </div>

        <!-- ACTIONS TAB -->
        <div class="tab-content" data-tab-content="actions">
            <div class="form-group">
                <label class="form-label">Action Items</label>
                <div style="display: flex; gap: 0.35rem; margin-bottom: 0.35rem;">
                    <input type="text" class="form-input" id="quickTaskInput" placeholder="Add task...">
                    <button type="button" class="btn btn-primary" id="addQuickTaskBtn">+</button>
                </div>
                <div class="meeting-tasks-list" id="meetingTasksList"></div>
            </div>
        </div>

        <!-- EXPORT TAB -->
        <div class="tab-content" data-tab-content="export">
            <div class="export-content">
                <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem;"> Export Meeting Notes</h4>
                <div class="export-preview" id="meetingExportPreview">Preview...</div>
                <div class="export-actions">
                    <button type="button" class="btn-export" id="copyMeetingBtn">Copy</button>
                    <button type="button" class="btn-export" id="downloadMeetingBtn">Download</button>
                </div>
            </div>
        </div>
    </form>
</div>


<!-- Placeholder for future dashboard content -->
<div class="dashboard-placeholder-section" id="dashboardPlaceholder" style="display: none;">
    <div style="background: var(--bg-primary); border-radius: 12px; padding: 2rem; text-align: center; box-shadow: 0 1px 4px var(--shadow);">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></div>
        <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--text-primary);">Dashboard Content Area</h3>
        <p style="color: var(--text-secondary); font-size: 0.9rem;">Future dashboard widgets and content will appear here</p>
    </div>
</div>

<!-- ========== SHARING FEATURE SECTION - START ========== -->
<!-- Can delete this entire section when removing offline testing -->
<div class="shared-meetings-section" id="sharedMeetingsSection">
    <div class="section-header">
        <h2 class="section-title"> Shared Meetings</h2>
    </div>
    
    <div class="shared-filter-bar">
        <select class="shared-filter-select" id="sharedViewFilter" onchange="renderSharedMeetings()">
            <option value="with-me">Shared with Me</option>
            <option value="by-me">Shared by Me</option>
            <option value="all">All Shared</option>
        </select>
        
        <div class="shared-status-filter">
            <button class="shared-status-btn active" data-status="all" onclick="filterSharedByStatus('all')">All</button>
            <button class="shared-status-btn" data-status="pending" onclick="filterSharedByStatus('pending')">Pending</button>
            <button class="shared-status-btn" data-status="accepted" onclick="filterSharedByStatus('accepted')">Accepted</button>
        </div>
        
        <input type="text" class="form-input" id="sharedSearchInput" placeholder=" Search..." 
               style="max-width: 200px; margin-left: auto;" oninput="renderSharedMeetings()">
    </div>
    
    <div class="shared-meetings-grid" id="sharedMeetingsGrid">
        <!-- Populated by JS -->
    </div>
    
    <div class="empty-state" id="sharedMeetingsEmpty" style="display: none;">
        <div class="empty-state-icon"></div>
        <div>No shared meetings</div>
    </div>
</div>
<!-- ========== SHARING FEATURE SECTION - END ========== -->

<!-- Upcoming Meetings Section -->
<div class="upcoming-meetings-section" id="upcomingMeetingsSection">
    <div class="upcoming-meetings-header">
    <h2 class="upcoming-meetings-title">
        <span></span>
        <span>Upcoming Meetings</span>
    </h2>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <button class="btn-schedule-meeting" id="upcomingHeaderBtn" onclick="openInlineMeetingFormForUpcoming()">
            <span>+</span>
            <span>Upcoming Meeting</span>
        </button>
<button class="btn-schedule-meeting" id="upcomingFollowUpBtn" onclick="openFollowUpModal('upcoming')" style="display: none;">
    <span>+</span>
    <span>Follow-Up</span>
</button>
        <div class="upcoming-meetings-filters">
            <button class="upcoming-filter-btn active" data-period="all">All</button>
            <button class="upcoming-filter-btn" data-period="7">Week</button>
            <button class="upcoming-filter-btn" data-period="30">Month</button>
        </div>
    </div>
    </div>
    <div class="upcoming-meetings-list" id="upcomingMeetingsList"></div>
    <div class="upcoming-meetings-empty" id="upcomingMeetingsEmpty" style="display: none;">
        <div class="upcoming-empty-icon"></div>
        <div class="upcoming-empty-text">No upcoming meetings scheduled</div>
        <button class="btn-schedule-meeting" onclick="openInlineMeetingFormForUpcoming()">
            <span>+</span>
            <span>Upcoming Meeting</span>
        </button>
    </div>
</div>

<!-- Customer Activity Tracker -->
<div class="customer-activity-section" id="customerActivitySection">
   <div class="section-header">
    <h2 class="section-title">Customer Activity</h2>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
<button class="fullscreen-btn" id="activityFullscreenBtn" onclick="toggleSectionFullscreen('customerActivitySection', 'activityFullscreenBtn')"> Expand</button>
        <button class="filter-btn active" data-activity-filter="all" onclick="filterCustomerActivity('all')">All</button>
        <button class="filter-btn" data-activity-filter="week" onclick="filterCustomerActivity('week')">Week</button>
        <button class="filter-btn" data-activity-filter="month" onclick="filterCustomerActivity('month')">Month</button>
        <button class="filter-btn" data-activity-filter="custom" onclick="showCustomDateRange()">Custom</button>
    </div>
</div>
    <div id="customDateRangeInputs" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
            <label style="font-size: 0.8rem; font-weight: 600;">From:</label>
            <div style="position: relative;">
                <input type="text" id="activityStartDateDisplay" class="form-input" style="width: 150px; cursor: pointer;" placeholder="DD/MM/YYYY" readonly onclick="document.getElementById('activityStartDatePicker').showPicker()">
                <input type="date" id="activityStartDatePicker" style="position: absolute; opacity: 0; pointer-events: none;" onchange="updateActivityDateDisplay('start')">
            </div>
            <label style="font-size: 0.8rem; font-weight: 600;">To:</label>
            <div style="position: relative;">
                <input type="text" id="activityEndDateDisplay" class="form-input" style="width: 150px; cursor: pointer;" placeholder="DD/MM/YYYY" readonly onclick="document.getElementById('activityEndDatePicker').showPicker()">
                <input type="date" id="activityEndDatePicker" style="position: absolute; opacity: 0; pointer-events: none;" onchange="updateActivityDateDisplay('end')">
            </div>
            <button class="btn btn-primary" onclick="applyCustomDateRange()" style="padding: 0.35rem 0.75rem; font-size: 0.8rem;">Apply</button>
        </div>
    </div>
    <div class="activity-list" id="customerActivityGrid"></div>
    <div class="empty-state" id="customerActivityEmpty" style="display: none;">
        <div class="empty-state-icon"></div>
        <div>No customer meetings yet</div>
    </div>
</div>
 <div class="customer-CustomerInfos-section" id="customerCustomerInfosSection">
    <div class="customer-section-header" onclick="toggleCustomerSection('customerCustomerInfosSection')">
        <h3 class="customer-section-title">Info</h3>
        <div class="customer-section-toggle"></div>
    </div>
                <div id="customerCustomerInfosList"></div>
                <div class="empty-state" id="customerCustomerInfosEmpty" style="display: none;"></div>
            </div>

<!-- All Customers Section -->
<div class="all-customers-section" id="allCustomersSection">
    <div class="section-header">
        <h2 class="section-title">All Customers (<span id="allCustomersTotal">0</span>)</h2>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
<input type="text" class="form-input" id="customersSearchInput" placeholder="Search..." style="width: 200px; padding: 0.35rem 0.75rem; font-size: 0.8rem;" oninput="renderAllCustomersList()">
<button class="fullscreen-btn" id="customersFullscreenBtn" onclick="toggleSectionFullscreen('allCustomersSection', 'customersFullscreenBtn')"> Expand</button>
            <button class="filter-btn active" data-customers-filter="all" onclick="filterCustomersList('all')">All</button>
            <button class="filter-btn" data-customers-filter="pinned" onclick="filterCustomersList('pinned')"> Pinned</button>
            <button class="filter-btn" data-customers-filter="recent" onclick="filterCustomersList('recent')">Recent</button>
            <button class="btn-schedule-meeting" onclick="openAddCustomerForm()">+ Add</button>
        </div>
    </div>
    <div class="customers-list" id="allCustomersList">
        <div class="activity-header-row" style="grid-template-columns: 20px 1.5fr 1fr 1.5fr 0.8fr 40px;">
            <div class="activity-header-cell"></div>
            <div class="activity-header-cell">Company</div>
            <div class="activity-header-cell">Website</div>
            <div class="activity-header-cell">Address</div>
            <div class="activity-header-cell">Industry</div>
            <div class="activity-header-cell"></div>
        </div>
        <div id="customersListContent"></div>
    </div>
    <div class="empty-state" id="allCustomersEmpty" style="display: none;">
        <div class="empty-state-icon"></div>
        <div>No customers yet</div>
        <button class="btn-schedule-meeting" onclick="openAddCustomerForm()" style="margin-top: 0.5rem;">+ Add First Customer</button>
    </div>
</div>



<!-- Customer Participants Section -->
<div class="customer-participants-section" id="customerParticipantsSection">
    <div class="customer-section-header" onclick="toggleCustomerSection('customerParticipantsSection')">
        <h3 class="customer-section-title">Contacts </h3>
        <div class="customer-section-toggle"></div>
    </div>
    <div class="participants-overview-grid" id="customerParticipantsGrid"></div>
    <div class="empty-state-compact" id="customerParticipantsEmpty" style="display: none;">
        <div class="empty-state-compact-icon"></div>
        <div>No participants recorded yet</div>
    </div>
</div>

   <div class="customer-meetings-section" id="customerMeetingsSection">
    <div class="customer-section-header" onclick="toggleCustomerSection('customerMeetingsSection')">
    <h3 class="customer-section-title">Meetings</h3>
    <div class="customer-section-toggle"></div>
</div>
                <div id="customerMeetingsList"></div>
                <div class="empty-state" id="customerMeetingsEmpty" style="display: none;"></div>
            </div>

            <div class="tasks-section">
    <div class="section-header">
        <h2 class="section-title" id="mainSectionTitle">Tasks</h2>
        <div class="view-toggle">
            <button class="btn-add-meeting" onclick="openTaskModal()" style="margin-right: 0.5rem;">+ Task</button>

            <button class="view-btn" data-view="list"></button>
            <button class="view-btn" data-view="kanban"></button>
            <button class="view-btn active" data-view="active">Active</button>
            <button class="view-btn" data-view="archived">Archive</button>
        </div>
    </div>

                <div class="task-filters" id="taskFilters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="today">Today</button>
                    <button class="filter-btn" data-filter="week">Week</button>
                    <button class="filter-btn" data-filter="overdue">Overdue</button>
                    <button class="filter-btn" data-filter="high">High</button>
                </div>

                <div class="tasks-list" id="tasksList"></div>

                <div class="kanban-board" id="kanbanBoard">
                    <div class="kanban-column">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title"> To Do</div>
                            <div class="kanban-column-count" id="todoCount">0</div>
                        </div>
                        <div class="kanban-cards" id="todoColumn" data-status="todo"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title"> Progress</div>
                            <div class="kanban-column-count" id="progressCount">0</div>
                        </div>
                        <div class="kanban-cards" id="progressColumn" data-status="in-progress"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title"> Completed</div>
                            <div class="kanban-column-count" id="doneCount">0</div>
                        </div>
                        <div class="kanban-cards" id="doneColumn" data-status="done"></div>
                    </div>
                </div>

                <div class="empty-state" id="tasksEmpty" style="display: none;"></div>
            </div>
        </div>

<div class="notes-container" id="notesContainer">
    <!-- Sidebar Collapse Button -->
    <button class="sidebar-collapse-btn" onclick="toggleSidebarCollapse()" title="Collapse/Expand">
        
    </button>
    
    <!-- Timeline Section (Customer View Only) -->
    <div class="timeline-section" id="timelineSection" style="display: none;">
        <div class="section-header-simple">
            <h2 class="section-title" style="font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                
                <span>Timeline</span>
            </h2>
        </div>
        <div class="timeline-section-content">
            <div class="timeline-list" id="timelineList"></div>
            <div class="timeline-empty" id="timelineEmpty" style="display: none;">
                <div class="timeline-empty-icon"></div>
                <div>No activity yet</div>
            </div>
        </div>
    </div>
    
<!-- Notes Section -->
<div class="notes-section" id="notesSection">
    <div class="section-header-simple">
        <h2 class="section-title" style="font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            
            <span>Notes</span>
        </h2>
        <button class="btn-schedule-meeting" onclick="openNoteModal()" title="Add Note" style="padding: 0.35rem 0.75rem; font-size: 0.75rem;">
            <span>+</span>
        </button>
    </div>
        <div class="notes-section-content">
            <div class="notes-list" id="notesList"></div>
            <div class="empty-state" id="notesEmpty" style="display: none;">
                <div class="empty-state-icon"></div>
                <div>No notes</div>
            </div>
        </div>
    </div>
</div>
    </div>

    <!-- Tags Modal -->
    <div class="modal" id="tagsOverviewModal">
        <div class="modal-content xlarge">
            <div class="modal-header">
                <h3 class="modal-title"> Tags</h3>
                <button class="close-btn" id="closeTagsOverviewBtn"></button>
            </div>
            <div class="tags-overview-content">
                <div class="tags-list-section">
                    <h4 style="margin-bottom: 0.5rem; font-size: 0.85rem;">All Tags</h4>
                    <div id="tagsListContainer"></div>
                    <div class="empty-state" id="tagsEmpty" style="display: none; padding: 1rem 0;">
                        <div class="empty-state-icon"></div>
                        <div>No tags</div>
                    </div>
                </div>
                <div class="customers-by-tag-section">
                    <h4 style="margin-bottom: 0.5rem; font-size: 0.85rem;" id="selectedTagTitle">Select a tag</h4>
                    <div id="customersByTagContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customers Modal -->
    <div class="modal" id="customersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Customers</h3>
                <button class="close-btn" id="closeCustomersModalBtn"></button>
            </div>
            <button class="btn btn-primary" id="openAddCustomerBtn" style="margin-bottom: 0.75rem; width: 100%;">+ Add Customer</button>
            <div class="customer-list" id="customerList"></div>
            <div class="empty-state" id="customersEmpty" style="display: none;">
                <div class="empty-state-icon"></div>
                <div>No customers</div>
            </div>
        </div>
    </div>

<!-- Customer Form Modal -->
<div class="modal" id="customerFormModal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 class="modal-title" id="customerFormTitle">Customer Profile</h3>
            <button class="close-btn" id="closeCustomerFormBtn"></button>
        </div>
        <form id="customerForm">
            <input type="hidden" id="customerId">
            
            <!-- Basic Information -->
            <div class="customer-profile-section" style="margin-bottom: 1rem;">
                <div class="customer-profile-section-title">
                     Company Information
                </div>
                <div class="form-group">
                    <label class="form-label">Company Name *</label>
                    <input type="text" class="form-input" id="customerName" required>
                </div>
            </div>

            <!-- All Info in One Row -->
            <div class="customer-profile-section" style="margin-bottom: 1rem;">
                <div class="customer-profile-section-title">
                     Details
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="customerEmail">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="customerPhone">
                    </div>
                    <div class="form-group">
    <label class="form-label">Website</label>
    <input type="text" class="form-input" id="customerWebsite" placeholder="example.com">
</div>
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <input type="text" class="form-input" id="customerIndustry" placeholder="e.g., Technology">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company Size</label>
                        <select class="form-select" id="customerSize">
                            <option value="">Select...</option>
                            <option value="1-10">1-10</option>
                            <option value="11-50">11-50</option>
                            <option value="51-200">51-200</option>
                            <option value="201-500">201-500</option>
                            <option value="501-1000">501-1000</option>
                            <option value="1000+">1000+</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">LinkedIn</label>
                        <input type="url" class="form-input" id="customerLinkedIn" placeholder="https://linkedin.com/company/...">
                    </div>
                </div>
            </div>

            <!-- Address Information -->
            <div class="customer-profile-section" style="margin-bottom: 1rem;">
                <div class="customer-profile-section-title">
                     Address
                </div>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div class="form-group">
                        <label class="form-label">Street Address</label>
                        <input type="text" class="form-input" id="customerAddress">
                    </div>
                    <div class="form-group">
                        <label class="form-label">City</label>
                        <input type="text" class="form-input" id="customerCity">
                    </div>
                    <div class="form-group">
                        <label class="form-label">State</label>
                        <input type="text" class="form-input" id="customerState">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 0.75rem;">
                    <div class="form-group">
                        <label class="form-label">Zip Code</label>
                        <input type="text" class="form-input" id="customerZip">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <input type="text" class="form-input" id="customerCountry">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Google Maps Link</label>
                        <input type="url" class="form-input" id="customerMapsLink" placeholder="https://maps.google.com/...">
                    </div>
                </div>
            </div>

            <div class="form-footer">
                <button type="button" class="btn btn-secondary" id="cancelCustomerFormBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Customer</button>
            </div>
        </form>
    </div>
</div>
   

    <!-- All Meetings Modal -->
    <div class="modal" id="allMeetingsModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title">All Meetings</h3>
                <button class="close-btn" id="closeAllMeetingsBtn"></button>
            </div>
            <div id="allMeetingsList"></div>
            <div class="empty-state" id="meetingsEmpty" style="display: none;">
                <div class="empty-state-icon"></div>
                <div>No meetings</div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Task</h3>
                <button class="close-btn" id="closeTaskModalBtn"></button>
            </div>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <input type="hidden" id="taskMeetingId">
                
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-input" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="taskDescription"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Customer</label>
                    <div class="customer-combobox">
                        <input type="text" class="customer-combobox-input" id="taskCustomerInput" placeholder="Customer..." autocomplete="off">
                        <div class="customer-dropdown" id="taskCustomerDropdown"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="taskPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="taskStatus">
                            <option value="todo">To Do</option>
                            <option value="in-progress">In Progress</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="taskDueDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Color</label>
                    <div class="color-picker">
                        <div class="color-option" data-color="none" style="background: var(--bg-tertiary)"></div>
                        <div class="color-option" data-color="red" style="background: #ef4444"></div>
                        <div class="color-option" data-color="orange" style="background: #f97316"></div>
                        <div class="color-option" data-color="yellow" style="background: #eab308"></div>
                        <div class="color-option" data-color="green" style="background: #10b981"></div>
                        <div class="color-option" data-color="blue" style="background: #3b82f6"></div>
                        <div class="color-option" data-color="purple" style="background: #8b5cf6"></div>
                        <div class="color-option" data-color="pink" style="background: #ec4899"></div>
                    </div>
                    <input type="hidden" id="taskColor" value="none">
                </div>
                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <input type="text" class="form-input" id="taskTags" placeholder="tag1, tag2">
                </div>
                <div class="form-group">
                    <label class="form-label">Subtasks</label>
                    <div class="subtasks-form" id="subtasksForm"></div>
                    <button type="button" class="btn-add-subtask" id="addSubtaskBtn">+ Add</button>
                </div>
                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" id="cancelTaskBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

<!-- Add Participant Modal -->
<div class="modal" id="addParticipantModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New Person</h3>
            <button class="close-btn" id="closeAddParticipantBtn"></button>
        </div>
        <form id="addParticipantForm">
            <input type="hidden" id="addParticipantCustomerId">
            
            <div class="form-group">
                <label class="form-label">Name *</label>
                <input type="text" class="form-input" id="addParticipantName" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Role</label>
                <input type="text" class="form-input" id="addParticipantRole" placeholder="e.g., VP of Sales">
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="addParticipantEmail" placeholder="name.1@company.com, name.2@company.com">
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-input" id="addParticipantPhone" placeholder="+1 (555) 123-4567, +30 4324353434">
            </div>
            
            <div class="form-group">
                <label class="form-label">Add to Meeting (Optional)</label>
                <select class="form-select" id="addParticipantMeetingId">
                    <option value="">Don't add to a specific meeting</option>
                </select>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.35rem;">
                     If no meeting is selected, this person will be available for future meetings
                </div>
            </div>
            
            <div class="form-footer">
                <button type="button" class="btn btn-secondary" id="cancelAddParticipantBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">+ Add Person</button>
            </div>
        </form>
    </div>
</div>

<!-- Create Tab Modal -->
<div class="modal" id="createTabModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="tabModalTitle">Create Meeting Tab</h3>
            <button class="close-btn" id="closeCreateTabBtn" onclick="closeCreateTabModal()"></button>
        </div>
        <form id="createTabForm" onsubmit="handleTabFormSubmit(event); return false;">
            <input type="hidden" id="editingTabId">
            
            <div class="form-group">
                <label class="form-label">Tab Name *</label>
                <input type="text" class="form-input" id="tabName" placeholder="e.g., Q4 Reviews, Discovery Calls" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Icon (optional)</label>
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;">
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                    <button type="button" class="btn btn-secondary tab-icon-option" data-icon="" style="padding: 0.5rem;"></button>
                </div>
                <input type="hidden" id="tabIcon" value="">
            </div>
            
            <div class="form-footer">
                <button type="button" class="btn btn-secondary" id="cancelCreateTabBtn" onclick="closeCreateTabModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="handleTabFormSubmit(event)">Save Tab</button>
            </div>
        </form>
    </div>
</div>

<!-- Custom Meeting Type Modal -->
<div class="modal" id="customMeetingTypeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="customMeetingTypeModalTitle">Add Meeting Type</h3>
            <button class="close-btn" id="closeCustomMeetingTypeBtn"></button>
        </div>
        <form id="customMeetingTypeForm" onsubmit="handleCustomMeetingTypeSubmit(event); return false;">
            <input type="hidden" id="editingMeetingTypeSlug">
            
            <div class="form-group">
                <label class="form-label">Type Name *</label>
                <input type="text" class="form-input" id="customMeetingTypeName" placeholder="e.g., Negotiation, Training, Check-in" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select Icon *</label>
                <div class="meeting-type-icon-grid" id="meetingTypeIconGrid">
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                    <button type="button" class="meeting-type-icon-option" data-icon=""></button>
                </div>
                <input type="hidden" id="selectedMeetingTypeIcon" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Custom Emoji (Optional)</label>
                <input type="text" class="form-input" id="customMeetingTypeEmoji" placeholder="Paste any emoji here" maxlength="2">
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.35rem;">
                     You can paste any emoji from your device or use the grid above
                </div>
            </div>
            
            <div class="form-footer">
                <button type="button" class="btn btn-secondary" id="cancelCustomMeetingTypeBtn">Cancel</button>
                <button type="submit" class="btn btn-primary"> Save Type</button>
            </div>
        </form>
    </div>
</div>



<!-- Tab Context Menu -->
<div class="tab-context-menu" id="tabContextMenu">
    <div class="tab-context-menu-item" onclick="renameTab()">
        <span></span>
        <span>Rename</span>
    </div>
    <div class="tab-context-menu-item delete" onclick="deleteTab()">
        <span></span>
        <span>Delete Tab</span>
    </div>
</div>

<!-- Consolidated Notes Modal -->
<div class="modal" id="consolidatedNotesModal">
    <div class="modal-content xlarge">
        <div class="modal-header">
            <h3 class="modal-title" id="consolidatedNotesTitle"> All Meeting Notes</h3>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="fullscreen-btn" id="consolidatedNotesFullscreenBtn" onclick="toggleModalFullscreen('consolidatedNotesModal', 'consolidatedNotesFullscreenBtn')"> Expand</button>
                <button class="close-btn" id="closeConsolidatedNotesBtn"></button>
            </div>
        </div>
        
        <div class="modal-tabs">
            <button type="button" class="modal-tab active" data-tab="view" data-form="consolidated">
                 View All
            </button>
            <button type="button" class="modal-tab" data-tab="export" data-form="consolidated">
                 Export
            </button>
        </div>
        
  <div class="tab-content active" data-tab-content="view">
    <div id="consolidatedNotesContent"></div>
</div>
        
        <div class="tab-content" data-tab-content="export">
            <div class="export-content">
                <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem;"> Export All Meeting Notes</h4>
                <div class="export-preview" id="consolidatedNotesExportPreview">Preview...</div>
                <div class="export-actions">
                    <button type="button" class="btn-export" id="copyConsolidatedNotesBtn">Copy</button>
                    <button type="button" class="btn-export" id="downloadConsolidatedNotesBtn">Download</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Follow-Up Meeting Modal -->
<div class="modal" id="followUpModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 style="margin: 0;" id="followUpModalTitle"> Create Follow-Up Meeting</h2>
            <button class="close-btn" onclick="closeFollowUpModal()">&times;</button>
        </div>
        <div style="padding: 1.5rem; max-height: 600px; overflow-y: auto;">
            
           <!-- Step 1: Meeting Type (MOVED TO FIRST) -->
<div class="follow-up-step">
    <h3 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.1rem;">Step 1: Meeting Type</h3>
    
    <label class="follow-up-type-option" style="display: flex; align-items: flex-start; gap: 0.75rem; 
           padding: 1rem; border: 2px solid var(--primary); border-radius: 8px; 
           cursor: pointer; margin-bottom: 1rem; background: var(--bg-secondary);">
        <input type="radio" name="followUpType" value="upcoming" 
               style="margin-top: 0.25rem; cursor: pointer;">
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 0.25rem; font-size: 0.95rem;">
                 Upcoming Meeting (scheduled for future)
            </div>
            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                Will appear in "Upcoming Meetings" section
            </div>
            <input type="datetime-local" id="followUpDateUpcoming" class="form-input"
                   style="width: 100%; max-width: 250px;">
        </div>
    </label>
    
    <label class="follow-up-type-option" style="display: flex; align-items: flex-start; gap: 0.75rem; 
           padding: 1rem; border: 2px solid var(--border); border-radius: 8px; 
           cursor: pointer; background: var(--bg-secondary);">
        <input type="radio" name="followUpType" value="past" 
               style="margin-top: 0.25rem; cursor: pointer;">
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 0.25rem; font-size: 0.95rem;">
                 New Meeting (happening now or already completed)
            </div>
            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                Will go directly to "Meetings" section
            </div>
            <input type="datetime-local" id="followUpDatePast" class="form-input"
                   style="width: 100%; max-width: 250px;">
        </div>
    </label>
</div>
            
            <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid var(--border);">
            
            <!-- Step 2: Select Meetings (MOVED TO SECOND) -->
            <div class="follow-up-step">
                <h3 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.1rem;" id="followUpStep1Title">Step 2: Select Meeting(s) to Follow Up</h3>
                
                <!-- Search and Filters -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <input type="text" id="followUpSearch" placeholder="Search meetings..." class="form-input"
                           style="flex: 1; min-width: 200px;" oninput="filterFollowUpMeetings()">
                    <select id="followUpCustomerFilter" class="form-select" onchange="filterFollowUpMeetings()" 
                            style="width: 180px;">
                        <option value="all">All Customers</option>
                    </select>
<select id="followUpDateFilter" class="form-select" onchange="filterFollowUpMeetings()" 
        style="width: 150px;">
    <option value="30">Last 30 Days</option>
    <option value="60">Last 60 Days</option>
    <option value="90">Last 90 Days</option>
    <option value="all" selected>All Time</option>
</select>
                </div>
                
                <!-- Meetings List -->
                <div id="followUpMeetingsList" style="border: 2px solid var(--border); border-radius: 8px; 
                     max-height: 300px; overflow-y: auto; padding: 0.5rem; background: var(--bg-secondary);">
                    <!-- Populated by JS -->
                </div>
                
                <!-- Selection Counter -->
                <div id="followUpSelectionCount" style="margin-top: 0.5rem; font-size: 0.9rem; 
                     color: var(--text-secondary); font-weight: 500;">
                    No meetings selected
                </div>
                
                <!-- Warning for multiple customers -->
                <div id="followUpCustomerWarning" style="display: none; margin-top: 1rem; 
                     padding: 0.75rem; background: rgba(245, 158, 11, 0.15); border-left: 4px solid var(--warning); 
                     border-radius: 4px; color: var(--text-primary);">
                     You've selected meetings from different customers. Please select meetings from ONE customer only.
                </div>
            </div>
            
            <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid var(--border);">
            
            <!-- Step 3: Select Participants (NEW) -->
            <div class="follow-up-step">
                <h3 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.1rem;">Step 3: Select Participants</h3>
                
                <!-- Quick Add from Contacts -->
                <div class="quick-add-contacts active" id="followUpQuickAddContacts" style="margin-bottom: 1rem;">
                    <div class="quick-add-contacts-title">
                        <span></span>
                        <span>Quick Add from Contacts</span>
                    </div>
                    <div class="quick-add-contacts-list" id="followUpQuickAddList"></div>
                </div>
                
                <!-- Manual Add Form -->
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); 
                         text-transform: uppercase; margin-bottom: 0.75rem;">Or Add New Participant</div>
                    <div class="form-row" style="margin-bottom: 0.75rem;">
                        <input type="text" class="form-input" id="followUpParticipantName" placeholder="Name *">
                        <input type="text" class="form-input" id="followUpParticipantRole" placeholder="Role">
                    </div>
                    <div class="form-row" style="margin-bottom: 0.75rem;">
                        <input type="email" class="form-input" id="followUpParticipantEmail" placeholder="Email">
                        <input type="tel" class="form-input" id="followUpParticipantPhone" placeholder="Phone">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addFollowUpParticipant()" style="width: 100%;">
                        + Add Participant
                    </button>
                </div>
                
                <!-- Selected Participants List -->
                <div style="margin-top: 1rem;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); 
                         text-transform: uppercase; margin-bottom: 0.5rem;">
                        Selected Participants (<span id="followUpParticipantsCount">0</span>)
                    </div>
                    <div class="participant-grid" id="followUpParticipantsList"></div>
                </div>
            </div>
            
            <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid var(--border);">
            
            <!-- Preview -->
            <div id="followUpPreview" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 197, 253, 0.1)); 
                 padding: 1rem; border-radius: 8px; border-left: 4px solid var(--info);">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);"> Preview:</div>
                <div id="followUpPreviewContent" style="font-size: 0.9rem; color: var(--text-primary);">
                    Select meeting type and meetings to see preview
                </div>
            </div>
        </div>
        
        <div class="form-footer">
            <button class="btn btn-secondary" onclick="closeFollowUpModal()">Cancel</button>
            <button class="btn btn-primary" id="createFollowUpBtn" onclick="createFollowUpMeeting()" disabled>
                Create Follow-Up 
            </button>
        </div>
    </div>
</div>

<!-- Participant Edit Modal -->
<div class="modal" id="participantEditModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Participant</h3>
            <button class="close-btn" id="closeParticipantEditBtn"></button>
        </div>
        <form id="participantEditForm">
            <input type="hidden" id="editParticipantCustomerId">
            <input type="hidden" id="editParticipantOriginalEmail">
            
            <div class="form-group">
                <label class="form-label">Name *</label>
                <input type="text" class="form-input" id="editParticipantName" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Role</label>
                <input type="text" class="form-input" id="editParticipantRole">
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="editParticipantEmail">
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-input" id="editParticipantPhone">
            </div>
            
            <div class="form-footer">
                <button type="button" class="btn btn-secondary" id="cancelParticipantEditBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

    <!-- Note Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Note</h3>
                <button class="close-btn" id="closeNoteModalBtn"></button>
            </div>
            <form id="noteForm">
                <input type="hidden" id="noteId">
                <div class="form-group">
                    <label class="form-label">Content *</label>
                    <textarea class="form-textarea" id="noteContent" required style="min-height: 120px;"></textarea>
                </div>
                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" id="cancelNoteBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="exportModalTitle">Export</h3>
                <button class="close-btn" id="closeExportModalBtn"></button>
            </div>
            <div class="export-content">
                <div class="export-preview" id="exportModalPreview"></div>
                <div class="export-actions">
                    <button type="button" class="btn-export" id="copyExportModalBtn">Copy</button>
                    <button type="button" class="btn-export" id="downloadExportModalBtn">Download</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-icon" id="confirmIcon"></div>
            <h3 class="confirm-title" id="confirmTitle">Confirm</h3>
            <p class="confirm-message" id="confirmMessage">Are you sure?</p>
            <div class="confirm-actions">
                <button class="btn btn-secondary" id="cancelConfirmBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

<!-- Auth Modal -->
<div class="modal" id="authModal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title" id="authModalTitle">Sign In</h3>
            <button class="close-btn" onclick="closeAuthModal()"></button>
        </div>
        <div id="authContent">
            <button class="btn btn-primary" onclick="signInWithGoogle()" style="width: 100%; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Continue with Google
            </button>
            <div style="text-align: center; color: var(--text-secondary); margin: 1rem 0; font-size: 0.85rem;">or use email</div>
            <form id="authForm" onsubmit="handleEmailAuth(event)">
                <div class="form-group">
                    <input type="email" class="form-input" id="authEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="authPassword" placeholder="Password (min 6 chars)" required minlength="6">
                </div>
                <div class="form-group" id="authNameGroup" style="display: none;">
                    <input type="text" class="form-input" id="authDisplayName" placeholder="Your Name">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="authSubmitBtn">Sign In</button>
            </form>
            <div style="text-align: center; margin-top: 1rem;">
                <button onclick="toggleAuthMode()" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 0.85rem;" id="authToggleBtn">
                    Need an account? Sign Up
                </button>
            </div>
        </div>
<div id="authUserInfo" style="display: none; text-align: center;">
    <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
    <div style="font-weight: 600; font-size: 1.1rem;" id="authUserName"></div>
    <div style="color: var(--text-secondary); margin-bottom: 1.5rem;" id="authUserEmail"></div>
    <button class="btn btn-danger" onclick="signOutUser()" style="width: 100%; margin-bottom: 0.75rem;">Sign Out</button>
    <button class="btn btn-secondary" onclick="confirmDeleteAccount()" style="width: 100%; border-color: var(--danger); color: var(--danger);">
         Delete Account
    </button>
    <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.75rem;">
        Deleting your account will permanently remove all your data.
    </div>
</div>
    </div>
</div>

<!-- Note Edit Modal -->
<div class="modal" id="noteEditModal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title"> Edit Note</h3>
            <button class="close-btn" onclick="closeNoteEditModal()"></button>
        </div>
        <input type="hidden" id="noteEditMeetingId">
        <textarea class="form-textarea" id="noteEditText" placeholder="Enter note..." style="min-height: 100px;"></textarea>
        <div class="form-footer">
            <button class="btn btn-secondary" onclick="closeNoteEditModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveEditedNote()">Save</button>
        </div>
    </div>
</div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- ========== SHARING FEATURE MODALS - START ========== -->
    <!-- Can delete this entire section when removing offline testing -->
    
    <!-- Share Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="shareModalTitle"> Share Meeting</h3>
                <button class="close-btn" id="closeShareModalBtn"></button>
            </div>
            
            <div class="share-modal-tabs">
                <button class="share-modal-tab active" data-share-tab="new">Share New</button>
                <button class="share-modal-tab" data-share-tab="shared-with">Shared With (<span id="sharedWithCount">0</span>)</button>
                <button class="share-modal-tab" data-share-tab="link">Link Sharing</button>
            </div>
            
            <!-- Tab 1: Share New -->
            <div class="share-tab-content active" data-share-tab-content="new">
                <input type="hidden" id="shareModalMeetingId">
                
                <div class="form-group">
                    <label class="form-label"> Email or Username</label>
                    <input type="text" class="form-input" id="shareEmailInput" placeholder="Enter email address...">
                </div>
                
               <div class="form-group">
    <label class="form-label"> Select Tabs to Share</label>
    <div style="display: grid; gap: 0.5rem;">
        <label class="permission-option" style="padding: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="shareTab" value="info" checked style="width: auto; margin-right: 0.5rem;">
            <div style="display: inline;">
                <div style="font-weight: 600; display: inline;"> Info</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-left: 0.5rem; display: inline;">(Customer, date, type, participants)</div>
            </div>
        </label>
        <label class="permission-option" style="padding: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="shareTab" value="notes" checked style="width: auto; margin-right: 0.5rem;">
            <div style="display: inline;">
                <div style="font-weight: 600; display: inline;"> Notes</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-left: 0.5rem; display: inline;">(Meeting notes and next steps)</div>
            </div>
        </label>
        <label class="permission-option" style="padding: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="shareTab" value="meddpicc" style="width: auto; margin-right: 0.5rem;">
            <div style="display: inline;">
                <div style="font-weight: 600; display: inline;"> MEDDPICC</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-left: 0.5rem; display: inline;">(Sales qualification data)</div>
            </div>
        </label>
        <label class="permission-option" style="padding: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="shareTab" value="actions" style="width: auto; margin-right: 0.5rem;">
            <div style="display: inline;">
                <div style="font-weight: 600; display: inline;"> Actions</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-left: 0.5rem; display: inline;">(Action items and tasks)</div>
            </div>
        </label>
    </div>
    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
         Select which information to share. Recipient can edit their copy after accepting.
    </div>
</div>
                
                <div class="form-group">
                    <label class="form-label"> Add Message (optional)</label>
                    <textarea class="form-textarea" id="shareMessageInput" placeholder="Hey, check out these notes..." style="min-height: 80px;"></textarea>
                </div>
                
<div class="form-group">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
        <input type="checkbox" id="shareNotifyEmail" checked>
        <span> Notify via email</span>
    </label>
</div>
                
                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeShareModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendShareInvite()">Send Invite </button>
                </div>
            </div>
            
            <!-- Tab 2: Shared With -->
            <div class="share-tab-content" data-share-tab-content="shared-with">
                <div class="shared-with-list" id="sharedWithList">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Tab 3: Link Sharing -->
            <div class="share-tab-content" data-share-tab-content="link">
                <div class="link-sharing-section">
                    <div class="link-toggle">
                        <span style="flex: 1; font-weight: 600;"> Anyone with Link</span>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="linkSharingEnabled" onchange="toggleLinkSharing()">
                            <span>Enable</span>
                        </label>
                    </div>
                    
                    <div id="linkSharingOptions" style="display: none;">
                        <div class="link-url-box">
                            <input type="text" class="link-url-input" id="shareLinkUrl" readonly>
                            <button class="btn btn-secondary" onclick="copyShareLink()"> Copy</button>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Permission</label>
                            <select class="form-select" id="linkPermissionLevel">
                                <option value="view">View Only</option>
                                <option value="edit">Can Edit</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label"> Expires</label>
                            <select class="form-select" id="linkExpiration">
                                <option value="never">Never</option>
                                <option value="1">1 day</option>
                                <option value="7">7 days</option>
                                <option value="30">30 days</option>
                            </select>
                        </div>
                        
                        <div style="background: rgba(245, 158, 11, 0.15); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; color: var(--text-secondary);">
                             Anyone with this link can access the meeting
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Accept Meeting Modal -->
    <div class="modal" id="acceptMeetingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Shared Meeting</h3>
                <button class="close-btn" onclick="closeAcceptMeetingModal()"></button>
            </div>
            
            <input type="hidden" id="acceptMeetingId">
            
           <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 197, 253, 0.1)); 
     padding: 1rem; border-radius: 8px; border-left: 4px solid var(--info); margin-bottom: 1rem;">
    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);"> Create Independent Copy</div>
    <div style="font-size: 0.85rem; color: var(--text-secondary);">
        This will create your own copy that you can edit freely. No syncing with the original.
    </div>
</div>
            
           <div class="form-group">
    <label class="form-label">Select Customer/Location</label>
    <div class="customer-combobox" style="position: relative;">
        <input type="text" 
               class="customer-combobox-input" 
               id="acceptMeetingCustomerInput" 
               placeholder="Type to search or add new customer..." 
               autocomplete="off"
               oninput="updateAcceptCustomerDropdown(this.value)"
               onfocus="updateAcceptCustomerDropdown(this.value); document.getElementById('acceptCustomerDropdown').classList.add('active')">
        <div class="customer-dropdown" id="acceptCustomerDropdown"></div>
    </div>
    <input type="hidden" id="acceptMeetingCustomer">
    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
         Type a name to search existing customers or create a new one
    </div>
</div>
            
            <div class="form-group">
                <label class="form-label">Select Meeting Tab</label>
                <select class="form-select" id="acceptMeetingTab">
                    <option value="all">All Meetings</option>
                    <option value="individual">Individual</option>
                </select>
            </div>
            
            <div class="form-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAcceptMeetingModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="acceptSharedMeeting()">Add Meeting </button>
            </div>
        </div>
    </div>
    
    <!-- ========== SHARING FEATURE MODALS - END ========== -->

    <script>

// Firebase Configuration
const firebaseConfig = {

  apiKey: "AIzaSyD0sFHiPsOfDJFLB3Ak-Tn-xeWvTsdzPKg",

  authDomain: "salesflow-b96a8.firebaseapp.com",

  projectId: "salesflow-b96a8",

  storageBucket: "salesflow-b96a8.firebasestorage.app",

  messagingSenderId: "684901199328",

  appId: "1:684901199328:web:313da7d811a754f7378f85",

  measurementId: "G-NRLQ2RVVYB"

};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let isSignUpMode = false;

function openAuthModal() {
    const user = auth.currentUser;
    if (user) {
        document.getElementById('authContent').style.display = 'none';
        document.getElementById('authUserInfo').style.display = 'block';
        document.getElementById('authUserName').textContent = user.displayName || 'User';
        document.getElementById('authUserEmail').textContent = user.email;
        document.getElementById('authModalTitle').textContent = 'Account';
    } else {
        document.getElementById('authContent').style.display = 'block';
        document.getElementById('authUserInfo').style.display = 'none';
        document.getElementById('authModalTitle').textContent = 'Sign In';
    }
    document.getElementById('authModal').classList.add('active');
}

function closeAuthModal() {
    document.getElementById('authModal').classList.remove('active');
    document.getElementById('authForm').reset();
}

function toggleAuthMode() {
    isSignUpMode = !isSignUpMode;
    document.getElementById('authNameGroup').style.display = isSignUpMode ? 'block' : 'none';
    document.getElementById('authSubmitBtn').textContent = isSignUpMode ? 'Create Account' : 'Sign In';
    document.getElementById('authToggleBtn').textContent = isSignUpMode ? 'Have an account? Sign In' : 'Need an account? Sign Up';
    document.getElementById('authModalTitle').textContent = isSignUpMode ? 'Create Account' : 'Sign In';
}

async function signInWithGoogle() {
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        closeAuthModal();
        showToast(' Signed in with Google!', 'success');
    } catch (error) {
        showToast(' ' + error.message, 'error');
    }
}

async function handleEmailAuth(e) {
    e.preventDefault();
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    const displayName = document.getElementById('authDisplayName').value;
    
    try {
        if (isSignUpMode) {
            const cred = await auth.createUserWithEmailAndPassword(email, password);
            if (displayName) await cred.user.updateProfile({ displayName });
            showToast(' Account created!', 'success');
        } else {
            await auth.signInWithEmailAndPassword(email, password);
            showToast(' Signed in!', 'success');
        }
        closeAuthModal();
    } catch (error) {
} catch (error) {
    if (error.code === 'auth/user-not-found') {
        showToast(' No account found. Please sign up first.', 'error');
    } else if (error.code === 'auth/wrong-password') {
        showToast(' Incorrect password', 'error');
    } else if (error.code === 'auth/invalid-email') {
        showToast(' Invalid email format', 'error');
    } else if (error.code === 'auth/email-already-in-use') {
        showToast(' Email already registered. Try signing in.', 'error');
    } else if (error.code === 'auth/weak-password') {
        showToast(' Password too weak (min 6 characters)', 'error');
    } else if (error.code === 'auth/too-many-requests') {
        showToast(' Too many attempts. Try again later.', 'error');
    } else {
        showToast(' ' + error.message, 'error');
    }
}

async function signOutUser() {
    try {
        await auth.signOut();
        closeAuthModal();
        showToast(' Signed out!', 'success');
    } catch (error) {
        showToast(' ' + error.message, 'error');
    }
}

function updateAuthUI(user) {
    const area = document.getElementById('userAuthArea');
    if (user) {
        const initial = (user.displayName || user.email || 'U')[0].toUpperCase();
        const photoHTML = user.photoURL 
            ? `<img src="${user.photoURL}" alt="avatar">` 
            : initial;
        area.innerHTML = `<div class="user-avatar" onclick="openAuthModal()" title="${user.email}">${photoHTML}</div>`;
        state.currentUser = { id: user.uid, email: user.email, name: user.displayName || user.email };
    } else {
        area.innerHTML = `<button class="btn-sign-in" onclick="openAuthModal()"><svg viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg><span>Sign In</span></button>`;
        state.currentUser = null;
    }
}

// Listen for auth state changes
auth.onAuthStateChanged(async (user) => {
    updateAuthUI(user);
    if (user) {
        await loadUserDataFromFirestore(user.uid);
        await loadSharingData();
    } else {
        loadData();
        state.sharedMeetings = [];
        state.myShares = [];
    }
    
    // Reset state to dashboard view
    state.currentCustomer = 'all';
    state.currentMeetingTab = 'all';
    
    // Render all components
    render();
    renderCustomerFilters();
    updateStats();
    updateShareNotificationBadge();
    
    // Always show dashboard on initial load/refresh
    showDashboard();
});


function confirmDeleteAccount() {
    if (!auth.currentUser) {
        showToast(' Not signed in', 'error');
        return;
    }
    
    // Close auth modal first
    closeAuthModal();
    
    // Show confirmation with extra warning
    document.getElementById('confirmIcon').textContent = '';
    document.getElementById('confirmTitle').textContent = 'Delete Account?';
    document.getElementById('confirmMessage').innerHTML = `
        <div style="text-align: left;">
            <p style="margin-bottom: 0.75rem;"><strong>This action is permanent and cannot be undone!</strong></p>
            <p style="margin-bottom: 0.75rem;">The following will be permanently deleted:</p>
            <ul style="margin-left: 1.5rem; margin-bottom: 0.75rem;">
                <li>${state.customers.length} customer(s)</li>
                <li>${state.meetings.length} meeting(s)</li>
                <li>${state.tasks.length} task(s)</li>
                <li>${state.notes.length} note(s)</li>
                <li>${state.CustomerInfos.length} customer info(s)</li>
                <li>${state.myShares.length} shared meeting(s)</li>
            </ul>
            <p style="color: var(--danger); font-weight: 600;">Your account and all data will be permanently deleted.</p>
        </div>
    `;
    
    // Show cancel button
    const cancelBtn = document.getElementById('cancelConfirmBtn');
    cancelBtn.style.display = '';
    
    // Configure delete button
    const confirmBtn = document.getElementById('confirmBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.textContent = ' Delete Forever';
    newConfirmBtn.className = 'btn btn-danger';
    
    newConfirmBtn.addEventListener('click', () => {
        document.getElementById('confirmModal').classList.remove('active');
        // Show second confirmation for extra safety
        showFinalDeleteConfirmation();
    });
    
    state.confirmCallback = null;
    document.getElementById('confirmModal').classList.add('active');
}

function showFinalDeleteConfirmation() {
    // Second confirmation with email verification
    const userEmail = auth.currentUser.email;
    
    document.getElementById('confirmIcon').textContent = '';
    document.getElementById('confirmTitle').textContent = 'Final Confirmation';
    document.getElementById('confirmMessage').innerHTML = `
        <div style="text-align: center;">
            <p style="margin-bottom: 1rem;">Type your email to confirm deletion:</p>
            <input type="email" id="deleteConfirmEmail" class="form-input" placeholder="${userEmail}" style="margin-bottom: 0.75rem;">
            <p style="font-size: 0.8rem; color: var(--text-secondary);">This will permanently delete your account.</p>
        </div>
    `;
    
    // Show cancel button
    const cancelBtn = document.getElementById('cancelConfirmBtn');
    cancelBtn.style.display = '';
    
    // Configure delete button
    const confirmBtn = document.getElementById('confirmBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.textContent = 'Delete My Account';
    newConfirmBtn.className = 'btn btn-danger';
    
    newConfirmBtn.addEventListener('click', async () => {
        const enteredEmail = document.getElementById('deleteConfirmEmail').value.trim().toLowerCase();
        
        if (enteredEmail !== userEmail.toLowerCase()) {
            showToast(' Email does not match', 'error');
            return;
        }
        
        document.getElementById('confirmModal').classList.remove('active');
        await deleteUserAccount();
    });
    
    state.confirmCallback = null;
    document.getElementById('confirmModal').classList.add('active');
    
    // Focus the email input
    setTimeout(() => {
        document.getElementById('deleteConfirmEmail')?.focus();
    }, 100);
}

async function deleteUserAccount() {
    if (!auth.currentUser) {
        showToast(' Not signed in', 'error');
        return;
    }
    
    const user = auth.currentUser;
    const userId = user.uid;
    const userEmail = user.email.toLowerCase();
    
    // Show loading toast
    showToast(' Deleting account...', 'success');
    
    try {
        const deletePromises = [];
        
        // 1. Delete shared meetings where user is the sharer (shared BY me)
        const sharedByMe = await db.collection('sharedMeetings')
            .where('sharedBy', '==', userId)
            .get();
        
        sharedByMe.docs.forEach(doc => {
            deletePromises.push(doc.ref.delete());
        });
        
        // 2. Delete shared meetings where user is the recipient (shared WITH me)
        const sharedWithMe = await db.collection('sharedMeetings')
            .where('sharedWithEmail', '==', userEmail)
            .get();
        
        sharedWithMe.docs.forEach(doc => {
            deletePromises.push(doc.ref.delete());
        });
        
        // 3. Delete user's main data document
        deletePromises.push(db.collection('users').doc(userId).delete());
        
        // Wait for all Firestore deletes to complete
        if (deletePromises.length > 0) {
            await Promise.all(deletePromises);
            console.log(` Deleted ${deletePromises.length} document(s) from Firestore`);
        }
        
        // 4. Clear local state
        state.tasks = [];
        state.notes = [];
        state.customers = [];
        state.meetings = [];
        state.CustomerInfos = [];
        state.sharedMeetings = [];
        state.myShares = [];
        state.meetingTabs = [
            { id: 'all', name: 'All Meetings', icon: '', isDefault: true },
            { id: 'individual', name: 'Individual', icon: '', isDefault: true }
        ];
        state.currentUser = null;
        
        // 5. Clear localStorage
        localStorage.clear();
        
        // 6. Delete the Firebase Auth account
        await user.delete();
        
        // 7. Update UI
        updateAuthUI(null);
        render();
        updateStats();
        renderCustomerFilters();
        updateShareNotificationBadge();
        showDashboard();
        
        // Show success message
        showAccountDeletedSuccess();
        
    } catch (error) {
        console.error('Error deleting account:', error);
        
        // Handle specific errors
        if (error.code === 'auth/requires-recent-login') {
            showToast(' Please sign out, sign back in, and try again', 'error');
        } else {
            showToast(' Failed to delete account: ' + error.message, 'error');
        }
    }
}

function showAccountDeletedSuccess() {
    document.getElementById('confirmIcon').textContent = '';
    document.getElementById('confirmTitle').textContent = 'Account Deleted';
    document.getElementById('confirmMessage').textContent = 'Your account and all associated data have been permanently deleted.';
    
    // Hide cancel button
    const cancelBtn = document.getElementById('cancelConfirmBtn');
    cancelBtn.style.display = 'none';
    
    // Configure OK button
    const confirmBtn = document.getElementById('confirmBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.textContent = 'OK';
    newConfirmBtn.className = 'btn btn-primary';
    
    newConfirmBtn.addEventListener('click', () => {
        document.getElementById('confirmModal').classList.remove('active');
        // Restore cancel button for future confirms
        document.getElementById('cancelConfirmBtn').style.display = '';
        // Reset confirm button styling
        const btn = document.getElementById('confirmBtn');
        btn.textContent = 'Confirm';
        btn.className = 'btn btn-danger';
    });
    
    state.confirmCallback = null;
    document.getElementById('confirmModal').classList.add('active');
}

async function loadUserDataFromFirestore(uid) {
    try {
        const doc = await db.collection('users').doc(uid).get();
        if (doc.exists) {
            const data = doc.data();
            state.tasks = data.tasks || [];
            state.notes = data.notes || [];
            state.customers = data.customers || [];
            state.meetings = data.meetings || [];
            state.CustomerInfos = data.CustomerInfos || [];
            state.meetingTabs = data.meetingTabs || [
                { id: 'all', name: 'All Meetings', icon: '', isDefault: true },
                { id: 'individual', name: 'Individual', icon: '', isDefault: true }
            ];
            state.sharedMeetings = data.sharedMeetings || [];
            state.myShares = data.myShares || [];
        }
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

async function saveUserDataToFirestore() {
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        await db.collection('users').doc(user.uid).set({
            tasks: state.tasks,
            notes: state.notes,
            customers: state.customers,
            meetings: state.meetings,
            CustomerInfos: state.CustomerInfos,
            meetingTabs: state.meetingTabs,
            sharedMeetings: state.sharedMeetings,
            myShares: state.myShares,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
    } catch (error) {
        console.error('Error saving data:', error);
    }
}

       const state = {
    tasks: [],
    notes: [],
    customers: [],
    meetings: [],
    CustomerInfos: [],
    // ========== SHARING FEATURE - START ==========
    sharedMeetings: [], // Meetings shared with me
    myShares: [], // Meetings I've shared
    shareNotifications: [], // Pending notifications
   currentUser: null,
    // ========== SHARING FEATURE - END ==========
    meetingTabs: [],
    currentMeetingTab: 'all',
    editingTabId: null,
    selectedTabIcon: '',
    draggedMeetingId: null,
    currentCategory: 'all',
    currentCustomer: 'all',
    upcomingMeetingsPeriod: 'all',
    currentFilter: 'all',
    currentView: 'active',
    currentDisplayMode: 'list',
    searchQuery: '',
    editingTask: null,
    editingNote: null,
    editingCustomer: null,
    editingMeeting: null,
    editingCustomerInfo: null,
    selectedColor: 'none',
    confirmCallback: null,
    meetingTasks: [],           
    meetingParticipants: [],     
    selectedCustomerId: null,
    selectedTaskCustomerId: null,
    selectedCustomerInfoCustomerId: null,
    selectedTag: null,
    currentMeetingTab: 'info',
    currentCustomerInfoTab: 'info',
    returningToMeetingForm: false, 
    savedMeetingFormData: null,
        editingParticipantIndex: null,
    activityFilter: 'all',
activityCustomRange: { start: null, end: null },
};

// ========== PINNED CUSTOMERS FUNCTIONS - START ==========
function togglePinCustomer(customerId, event) {
    if (event) {
        event.stopPropagation();
    }
    
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    // Toggle pinned state
    customer.pinned = !customer.pinned;
    
    // Animate the star
    const starElement = event?.target;
    if (starElement) {
        starElement.classList.add('animate');
        setTimeout(() => starElement.classList.remove('animate'), 400);
    }
    
    saveData();
    renderCustomerFilters();
    
    // Update banner pin button if viewing this customer
    if (state.currentCustomer === customerId) {
        updateBannerPinButton(customerId);
    }
    
    // Show toast
    if (customer.pinned) {
        showToast(` ${customer.name} added to Priority Accounts`, 'success');
    } else {
        showToast(`${customer.name} removed from Priority Accounts`, 'success');
    }
}

function togglePinFromBanner() {
    if (state.currentCustomer && state.currentCustomer !== 'all') {
        togglePinCustomer(state.currentCustomer);
    }
}

function updateBannerPinButton(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    const pinIcon = document.getElementById('bannerPinIcon');
    const pinBtn = document.getElementById('bannerPinBtn');
    
    if (!pinIcon || !pinBtn) return;
    
    if (customer && customer.pinned) {
        pinIcon.textContent = '';
        pinIcon.style.color = '#fbbf24';
        pinBtn.title = 'Unpin from Priority';
    } else {
        pinIcon.textContent = '';
        pinIcon.style.color = '';
        pinBtn.title = 'Pin to Priority';
    }
}
// ========== PINNED CUSTOMERS FUNCTIONS - END ==========

function renameCustomerFromSidebar(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    const newName = prompt('Rename customer:', customer.name);
    if (!newName || newName.trim() === '') return;
    if (newName.trim() === customer.name) return;
    
    const trimmedName = newName.trim();
    
    // Check if name already exists
    if (state.customers.some(c => c.id !== customerId && c.name.toLowerCase() === trimmedName.toLowerCase())) {
        showToast('Name already exists', 'error');
        return;
    }
    
    // Update customer
    customer.name = trimmedName;
    
    // Update all references
    state.tasks.forEach(task => {
        if (task.customerId === customerId) {
            task.customerName = trimmedName;
        }
    });
    
    state.meetings.forEach(meeting => {
        if (meeting.customerId === customerId) {
            meeting.customerName = trimmedName;
        }
    });
    
    state.CustomerInfos.forEach(prep => {
        if (prep.customerId === customerId) {
            prep.customerName = trimmedName;
        }
    });
    
    saveData();
    renderCustomerFilters();
    renderCustomerList();
    
    // Update header if viewing this customer
    if (state.currentCustomer === customerId) {
        document.getElementById('customerHeaderName').textContent = trimmedName;
    }
    
    // Refresh visible sections
if (document.getElementById('upcomingMeetingsSection').classList.contains('active')) renderUpcomingMeetings();
if (document.getElementById('customerActivitySection').classList.contains('active')) renderCustomerActivity();

showToast('Renamed!', 'success');
}

function deleteCustomerFromSidebar(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    // Count associated data
    const taskCount = state.tasks.filter(t => t.customerId === customerId).length;
    const meetingCount = state.meetings.filter(m => m.customerId === customerId).length;
    const prepCount = state.CustomerInfos.filter(p => p.customerId === customerId).length;
    
    let message = `Delete "${customer.name}"?`;
    
    if (taskCount > 0 || meetingCount > 0 || prepCount > 0) {
        const parts = [];
        if (meetingCount > 0) parts.push(`${meetingCount} meeting${meetingCount !== 1 ? 's' : ''}`);
        if (taskCount > 0) parts.push(`${taskCount} task${taskCount !== 1 ? 's' : ''}`);
        if (prepCount > 0) parts.push(`${prepCount} customer info${prepCount !== 1 ? 's' : ''}`);
        message = `Delete "${customer.name}"?\n\nThis will also remove:\n ${parts.join('\n ')}`;
    }
    
    showConfirm('', 'Delete Customer?', message, () => {
        // Remove customer
        state.customers = state.customers.filter(c => c.id !== customerId);
        
        // Remove all meetings associated with this customer
        state.meetings = state.meetings.filter(m => m.customerId !== customerId);
        
        // Remove all CustomerInfos associated with this customer
        state.CustomerInfos = state.CustomerInfos.filter(p => p.customerId !== customerId);
        
        // Remove customer reference from tasks (or optionally delete tasks entirely)
        state.tasks.forEach(task => {
            if (task.customerId === customerId) {
                task.customerId = null;
                task.customerName = '';
            }
        });
        
        // Save data
        saveData();
        
        // Refresh customer filters in sidebar
        renderCustomerFilters();
        
        // Refresh All Customers section if visible
        if (document.getElementById('allCustomersSection').classList.contains('active')) {
            renderAllCustomersList();
        }
        
        // Refresh Customer Activity section if visible
        if (document.getElementById('customerActivitySection').classList.contains('active')) {
            renderCustomerActivity();
        }
        
        // Refresh Upcoming Meetings section if visible
        if (document.getElementById('upcomingMeetingsSection').classList.contains('active')) {
            renderUpcomingMeetings();
        }
        
        // Refresh tasks list
        renderTasks();
        
        // Update stats
        updateStats();
        
        // If currently viewing this customer, go back to dashboard
        if (state.currentCustomer === customerId) {
            showDashboard();
        }
        
        showToast(` "${customer.name}" and all associated data deleted`, 'success');
    });
}


function renameCustomerFromHeader() {
    if (state.currentCustomer === 'all') return;
    renameCustomerFromSidebar(state.currentCustomer);
}

function deleteCustomerFromHeader() {
    if (state.currentCustomer === 'all') return;
    deleteCustomerFromSidebar(state.currentCustomer);
}

function deleteCustomerInfo(CustomerInfoId) {
    const CustomerInfo = state.CustomerInfos.find(p => p.id === CustomerInfoId);
    if (!CustomerInfo) return;
    
    showConfirm('', 'Delete CustomerInfo?', `Delete this CustomerInfo for ${CustomerInfo.customerName}?`, () => {
        state.CustomerInfos = state.CustomerInfos.filter(p => p.id !== CustomerInfoId);
        saveData();
        
        // Update customer CustomerInfos section if visible
        if (state.currentCustomer !== 'all') {
            showCustomerCustomerInfosSection(state.currentCustomer);
        }
        

        
        updateStats();
        showToast('Deleted', 'success');
    });
}

function deleteMeetingFromCustomer(meetingId) {
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (!meeting) return;
    
    const hasTasks = state.tasks.some(t => t.meetingId === meetingId);
    const message = hasTasks 
        ? `Delete this meeting? Associated tasks will remain but lose their meeting link.`
        : `Delete this meeting?`;
    
    showConfirm('', 'Delete Meeting?', message, () => {
        state.meetings = state.meetings.filter(m => m.id !== meetingId);
        
        // Remove meeting reference from tasks
        state.tasks.forEach(task => {
            if (task.meetingId === meetingId) {
                delete task.meetingId;
            }
        });
        
        saveData();
        
        // Update customer meetings section if visible
        if (state.currentCustomer !== 'all') {
            showCustomerMeetingsSection(state.currentCustomer);
        }
        

        
        // ADD THIS: Refresh upcoming meetings if visible
        if (document.getElementById('upcomingMeetingsSection').classList.contains('active')) {
            renderUpcomingMeetings();
        }
        
        updateStats();
        showToast('Deleted', 'success');
    });
}

function editCustomerFromBanner() {
    if (state.currentCustomer === 'all') return;
    openEditCustomerForm(state.currentCustomer);
}

function updateCustomerBanner(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    const banner = document.getElementById('customerHeaderBanner');
    const nameEl = document.getElementById('customerHeaderName');
    const detailsEl = document.getElementById('customerBannerDetails');
    
    nameEl.textContent = customer.name;
    updateBannerPinButton(customerId);
    
const logoEl = document.querySelector('.customer-header-icon');
if (customer.website) {
    let domain = customer.website.replace(/^https?:\/\//, '').replace(/^www\./, '').split('/')[0];
    const logoUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
    
    logoEl.innerHTML = `<img src="${logoUrl}" alt="${escapeHtml(customer.name)}" style="width: 48px; height: 48px; border-radius: 8px; object-fit: contain; background: white; padding: 4px;" onerror="this.outerHTML=getBuildingSVG(40,'white')">`;
} else {
    logoEl.innerHTML = getBuildingSVG(40, 'white');
}

    
    // Build details horizontally
let detailsHTML = '';

if (customer.email) {
    detailsHTML += `
        <div class="customer-banner-detail">
            <div class="customer-banner-detail-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
            </div>
            <div class="customer-banner-detail-content">
                <div class="customer-banner-detail-value"><a href="mailto:${escapeHtml(customer.email)}">${escapeHtml(customer.email)}</a></div>
            </div>
        </div>
    `;
}

if (customer.phone) {
    detailsHTML += `
        <div class="customer-banner-detail">
            <div class="customer-banner-detail-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
            </div>
            <div class="customer-banner-detail-content">
                <div class="customer-banner-detail-value"><a href="tel:${escapeHtml(customer.phone)}">${escapeHtml(customer.phone)}</a></div>
            </div>
        </div>
    `;
}

if (customer.address || customer.city) {
    let addressText = '';
    if (customer.address) addressText += customer.address;
    if (customer.city) {
        if (addressText) addressText += ', ';
        addressText += customer.city;
    }
    if (customer.state) addressText += ', ' + customer.state;
    if (customer.zip) addressText += ' ' + customer.zip;
    
    detailsHTML += `
        <div class="customer-banner-detail">
            <div class="customer-banner-detail-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
            </div>
            <div class="customer-banner-detail-content">
                <div class="customer-banner-detail-value">
                    ${customer.mapsLink ? `<a href="${escapeHtml(customer.mapsLink)}" target="_blank">${escapeHtml(addressText)}</a>` : escapeHtml(addressText)}
                </div>
            </div>
        </div>
    `;
}

if (customer.website) {
    detailsHTML += `
        <div class="customer-banner-detail">
            <div class="customer-banner-detail-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
            </div>
            <div class="customer-banner-detail-content">
                <div class="customer-banner-detail-value"><a href="${escapeHtml(customer.website)}" target="_blank">Website</a></div>
            </div>
        </div>
    `;
}

if (customer.industry) {
    detailsHTML += `
        <div class="customer-banner-detail">
            <div class="customer-banner-detail-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 7h-9"></path>
                    <path d="M14 17H5"></path>
                    <circle cx="17" cy="17" r="3"></circle>
                    <circle cx="7" cy="7" r="3"></circle>
                </svg>
            </div>
            <div class="customer-banner-detail-content">
                <div class="customer-banner-detail-value">${escapeHtml(customer.industry)}</div>
            </div>
        </div>
    `;
}

if (customer.size) {
    detailsHTML += `
        <div class="customer-banner-detail">
            <div class="customer-banner-detail-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <div class="customer-banner-detail-content">
                <div class="customer-banner-detail-value">${escapeHtml(customer.size)}</div>
            </div>
        </div>
    `;
}

if (customer.linkedIn) {
    detailsHTML += `
        <div class="customer-banner-detail">
            <div class="customer-banner-detail-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                    <rect x="2" y="9" width="4" height="12"></rect>
                    <circle cx="4" cy="4" r="2"></circle>
                </svg>
            </div>
            <div class="customer-banner-detail-content">
                <div class="customer-banner-detail-value"><a href="${escapeHtml(customer.linkedIn)}" target="_blank">LinkedIn</a></div>
            </div>
        </div>
    `;
}

detailsEl.innerHTML = detailsHTML;
}

function getParticipantKey(participant) {
    // Create a consistent unique key for each participant
    if (participant.email && participant.email.trim()) {
        return participant.email.toLowerCase().trim();
    }
    return participant.name.toLowerCase().trim();
}

function openAddParticipantModal(customerId) {
    const modal = document.getElementById('addParticipantModal');
    const form = document.getElementById('addParticipantForm');
    const meetingSelect = document.getElementById('addParticipantMeetingId');
    
    // Reset form
    form.reset();
    document.getElementById('addParticipantCustomerId').value = customerId;
    
    // Populate meeting dropdown with meetings for this customer
    const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
    meetingSelect.innerHTML = '<option value="">Don\'t add to a specific meeting</option>';
    
    if (customerMeetings.length > 0) {
        customerMeetings.forEach(meeting => {
            const option = document.createElement('option');
            option.value = meeting.id;
            option.textContent = `${meeting.title} - ${new Date(meeting.date).toLocaleDateString()}`;
            meetingSelect.appendChild(option);
        });
    }
    
    // Set up event listeners
    const closeBtn = document.getElementById('closeAddParticipantBtn');
    const cancelBtn = document.getElementById('cancelAddParticipantBtn');
    
    // Remove old listeners by cloning
    const newCloseBtn = closeBtn.cloneNode(true);
    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
    
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // Add fresh listeners
    document.getElementById('closeAddParticipantBtn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeAddParticipantModal();
    });
    
    document.getElementById('cancelAddParticipantBtn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeAddParticipantModal();
    });
    
    document.getElementById('addParticipantForm').addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        handleAddParticipantSubmit(e);
    });
    
    // Show modal
    modal.classList.add('active');
}

function closeAddParticipantModal() {
    const modal = document.getElementById('addParticipantModal');
    if (modal) {
        modal.classList.remove('active');
        document.getElementById('addParticipantForm').reset();
    }
}

function handleAddParticipantSubmit(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    const customerId = document.getElementById('addParticipantCustomerId').value;
    const name = document.getElementById('addParticipantName').value.trim();
    const role = document.getElementById('addParticipantRole').value.trim();
    const email = document.getElementById('addParticipantEmail').value.trim();
    const phone = document.getElementById('addParticipantPhone').value.trim();
    const meetingId = document.getElementById('addParticipantMeetingId').value;
    
    if (!name) {
        showToast(' Name is required', 'error');
        return false;
    }
    
    const newParticipant = {
        name: name,
        role: role,
        email: email,
        phone: phone
    };
    
    // Create unique key for this participant
    const key = email && email.trim() 
        ? email.toLowerCase().trim() 
        : name.toLowerCase().trim();
    
    // Check if we should add to a specific meeting
   if (meetingId) {
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (meeting) {
        if (!meeting.participants) {
            meeting.participants = [];
        }
        
        // Check if participant already exists in this meeting
        const exists = meeting.participants.some(p => {
            const pKey = p.email && p.email.trim() 
                ? p.email.toLowerCase().trim() 
                : p.name.toLowerCase().trim();
            return pKey === key;
        });
        
        if (exists) {
            showToast(' This person is already in that meeting', 'error');
            return false;
        }
        
        meeting.participants.push(newParticipant);
        saveData();
        closeAddParticipantModal();
        showCustomerParticipantsSection(customerId);
        showCustomerMeetingsSection(customerId);  // <-- ADD THIS LINE
        showToast(` ${name} added to meeting!`, 'success');
    }
} else {
        // Save as standalone contact for this customer
        const customer = state.customers.find(c => c.id === customerId);
        if (!customer) {
            showToast(' Customer not found', 'error');
            return false;
        }
        
        // Initialize participants array if it doesn't exist
        if (!customer.participants) {
            customer.participants = [];
        }
        
        // Check if participant already exists for this customer
        const exists = customer.participants.some(p => {
            const pKey = p.email && p.email.trim() 
                ? p.email.toLowerCase().trim() 
                : p.name.toLowerCase().trim();
            return pKey === key;
        });
        
        if (exists) {
            showToast(' This contact already exists', 'error');
            return false;
        }
        
        customer.participants.push(newParticipant);
        saveData();
        closeAddParticipantModal();
        showCustomerParticipantsSection(customerId);
        showToast(` ${name} added as contact!`, 'success');
    }
    
    return false;
}



function editParticipantFromOverview(participantKey, customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    // First check standalone contacts
    let participant = null;
    if (customer.participants) {
        participant = customer.participants.find(p => {
            const key = p.email && p.email.trim() 
                ? p.email.toLowerCase().trim() 
                : p.name.toLowerCase().trim();
            return key === participantKey;
        });
    }
    
    // If not found, check meetings
    if (!participant) {
        const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
        for (let meeting of customerMeetings) {
            if (meeting.participants) {
                participant = meeting.participants.find(p => {
                    const key = p.email && p.email.trim() 
                        ? p.email.toLowerCase().trim() 
                        : p.name.toLowerCase().trim();
                    return key === participantKey;
                });
                if (participant) break;
            }
        }
    }
    
    if (!participant) {
        showToast(' Participant not found', 'error');
        return;
    }
    
    // Populate form
    document.getElementById('editParticipantCustomerId').value = customerId;
    document.getElementById('editParticipantOriginalEmail').value = participantKey;
    document.getElementById('editParticipantName').value = participant.name;
    document.getElementById('editParticipantRole').value = participant.role || '';
    document.getElementById('editParticipantEmail').value = participant.email || '';
    document.getElementById('editParticipantPhone').value = participant.phone || '';
    
    // Set up event listeners for this modal instance
    const modal = document.getElementById('participantEditModal');
    const closeBtn = document.getElementById('closeParticipantEditBtn');
    const cancelBtn = document.getElementById('cancelParticipantEditBtn');
    const form = document.getElementById('participantEditForm');
    
    // Remove old listeners by cloning
    const newCloseBtn = closeBtn.cloneNode(true);
    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
    
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // Add fresh listeners
    document.getElementById('closeParticipantEditBtn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeParticipantEditModal();
    });
    
    document.getElementById('cancelParticipantEditBtn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeParticipantEditModal();
    });
    
    document.getElementById('participantEditForm').addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        handleParticipantEditSubmit(e);
    });
    
    // Show modal
    modal.classList.add('active');
}

function closeParticipantEditModal() {
    const modal = document.getElementById('participantEditModal');
    if (modal) {
        modal.classList.remove('active');
        // Reset form
        document.getElementById('participantEditForm').reset();
    }
}

function handleParticipantEditSubmit(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    const customerId = document.getElementById('editParticipantCustomerId').value;
    const originalKey = document.getElementById('editParticipantOriginalEmail').value;
    const newName = document.getElementById('editParticipantName').value.trim();
    const newRole = document.getElementById('editParticipantRole').value.trim();
    const newEmail = document.getElementById('editParticipantEmail').value.trim();
    const newPhone = document.getElementById('editParticipantPhone').value.trim();
    
    if (!newName) {
        showToast(' Name is required', 'error');
        return false;
    }
    
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return false;
    
    let updated = 0;
    
    // Update standalone contacts
    if (customer.participants) {
        customer.participants.forEach(participant => {
            const key = participant.email && participant.email.trim() 
                ? participant.email.toLowerCase().trim() 
                : participant.name.toLowerCase().trim();
            if (key === originalKey) {
                participant.name = newName;
                participant.role = newRole;
                participant.email = newEmail;
                participant.phone = newPhone;
                updated++;
            }
        });
    }
    
    // Update participant in all meetings for this customer
    state.meetings.forEach(meeting => {
        if (meeting.customerId === customerId && meeting.participants) {
            meeting.participants.forEach(participant => {
                const key = participant.email && participant.email.trim() 
                    ? participant.email.toLowerCase().trim() 
                    : participant.name.toLowerCase().trim();
                if (key === originalKey) {
                    participant.name = newName;
                    participant.role = newRole;
                    participant.email = newEmail;
                    participant.phone = newPhone;
                    updated++;
                }
            });
        }
    });
    
if (updated > 0) {
    saveData();
    closeParticipantEditModal();
    showCustomerParticipantsSection(customerId);
    showCustomerMeetingsSection(customerId);
    showToast(' Participant updated!', 'success');
} else {
    showToast(' No records found to update', 'error');
}
    
    return false;
}

function deleteParticipantFromOverview(participantKey, customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    let totalInstances = 0;
    
    // Count standalone contacts
    if (customer.participants) {
        const standaloneExists = customer.participants.some(p => {
            const key = p.email && p.email.trim() 
                ? p.email.toLowerCase().trim() 
                : p.name.toLowerCase().trim();
            return key === participantKey;
        });
        if (standaloneExists) totalInstances++;
    }
    
    // Count meetings with this participant
    const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
    customerMeetings.forEach(meeting => {
        if (meeting.participants) {
            const hasParticipant = meeting.participants.some(p => {
                const key = p.email && p.email.trim() 
                    ? p.email.toLowerCase().trim() 
                    : p.name.toLowerCase().trim();
                return key === participantKey;
            });
            if (hasParticipant) totalInstances++;
        }
    });
    
    const message = totalInstances > 1 
        ? `Remove this participant from ${totalInstances} location(s)?`
        : 'Remove this participant?';
    
    showConfirm('', 'Delete Participant?', message, () => {
        // Remove from standalone contacts
        if (customer.participants) {
            customer.participants = customer.participants.filter(p => {
                const key = p.email && p.email.trim() 
                    ? p.email.toLowerCase().trim() 
                    : p.name.toLowerCase().trim();
                return key !== participantKey;
            });
        }
        
        // Remove participant from all meetings
        state.meetings.forEach(meeting => {
            if (meeting.customerId === customerId && meeting.participants) {
                meeting.participants = meeting.participants.filter(p => {
                    const key = p.email && p.email.trim() 
                        ? p.email.toLowerCase().trim() 
                        : p.name.toLowerCase().trim();
                    return key !== participantKey;
                });
            }
        });
        
        saveData();
        showCustomerParticipantsSection(customerId);
        showToast(' Participant deleted!', 'success');
    });
}

// Consolidated Notes Functions
function openConsolidatedNotesModal(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    const now = new Date();
    
    // Get meetings for current tab - ONLY PAST OR COMPLETED MEETINGS
    let meetings = [];
    if (state.currentMeetingTab === 'all') {
        meetings = state.meetings.filter(m => {
            if (m.customerId !== customerId) return false;
            
            // Show if explicitly marked as past meeting
            if (m.isPastMeeting) return true;
            
            // Or if meeting has already ended
            const meetingDate = new Date(m.date);
            const meetingDuration = m.duration || 60;
            const meetingEndTime = new Date(meetingDate.getTime() + meetingDuration * 60000);
            
            return meetingEndTime < now;
        });
    } else if (state.currentMeetingTab === 'individual') {
        meetings = state.meetings.filter(m => {
            if (m.customerId !== customerId) return false;
            if (m.tabId && m.tabId !== 'individual') return false;
            
            // Show if explicitly marked as past meeting
            if (m.isPastMeeting) return true;
            
            // Or if meeting has already ended
            const meetingDate = new Date(m.date);
            const meetingDuration = m.duration || 60;
            const meetingEndTime = new Date(meetingDate.getTime() + meetingDuration * 60000);
            
            return meetingEndTime < now;
        });
    } else {
        meetings = state.meetings.filter(m => {
            if (m.customerId !== customerId) return false;
            if (m.tabId !== state.currentMeetingTab) return false;
            
            // Show if explicitly marked as past meeting
            if (m.isPastMeeting) return true;
            
            // Or if meeting has already ended
            const meetingDate = new Date(m.date);
            const meetingDuration = m.duration || 60;
            const meetingEndTime = new Date(meetingDate.getTime() + meetingDuration * 60000);
            
            return meetingEndTime < now;
        });
    }
    
    // Sort by date (newest first)
    meetings.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Update modal title
    const tabName = state.meetingTabs.find(t => t.id === state.currentMeetingTab)?.name || 'All Meetings';
    document.getElementById('consolidatedNotesTitle').textContent = ` ${tabName} - ${customer.name}`;
    
    // Render consolidated notes
    renderConsolidatedNotes(meetings, customer.name);
    
    // Set up modal tabs
    document.querySelectorAll('#consolidatedNotesModal .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#consolidatedNotesModal .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#consolidatedNotesModal .modal-tab[data-tab="view"]').classList.add('active');
    document.querySelector('#consolidatedNotesModal [data-tab-content="view"]').classList.add('active');
    
    // Show modal
    document.getElementById('consolidatedNotesModal').classList.add('active');
}

function toggleModalFullscreen(modalId, btnId) {
    const modal = document.getElementById(modalId);
    const modalContent = modal.querySelector('.modal-content');
    const btn = document.getElementById(btnId);
    
    modalContent.classList.toggle('fullscreen');
    btn.innerHTML = modalContent.classList.contains('fullscreen') ? ' Close' : ' Expand';
}

function closeConsolidatedNotesModal() {
    const modal = document.getElementById('consolidatedNotesModal');
    const modalContent = modal.querySelector('.modal-content');
    const btn = document.getElementById('consolidatedNotesFullscreenBtn');
    
    // Reset fullscreen state when closing
    modalContent.classList.remove('fullscreen');
    if (btn) btn.innerHTML = ' Expand';
    
    modal.classList.remove('active');
}

function renderConsolidatedNotes(meetings, customerName) {
    const container = document.getElementById('consolidatedNotesContent');
    
    if (meetings.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><div>No meetings</div></div>';
        return;
    }
    
const typeIcons = {
    discovery: '',
    'follow-up': ''
};
    
    container.innerHTML = meetings.map((meeting, index) => {
        const meetingDate = new Date(meeting.date);
        const notesText = meeting.notesHTML ? htmlToPlainText(meeting.notesHTML) : meeting.notes || '';
        const nextStepsText = meeting.nextStepsHTML ? htmlToPlainText(meeting.nextStepsHTML) : meeting.nextSteps || '';
        const typeIcon = typeIcons[meeting.type] || '';
        
        return `
            <div class="consolidated-meeting-block">
                <div class="consolidated-meeting-header">
                    <div class="consolidated-meeting-title">
                        ${index + 1}. ${escapeHtml(meeting.title)}
                    </div>
                    <div class="consolidated-meeting-meta">
                        <div class="consolidated-meeting-meta-item">
                            <span></span>
                            <span>${meetingDate.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</span>
                        </div>
                        ${meeting.type ? `
                            <div class="consolidated-meeting-meta-item">
                                <span>${typeIcon}</span>
                                <span>${meeting.type.replace('-', ' ')}</span>
                            </div>
                        ` : ''}
                        ${meeting.duration ? `
                            <div class="consolidated-meeting-meta-item">
                                <span</span>
                                <span>${meeting.duration} min</span>
                            </div>
                        ` : ''}
                        ${meeting.outcome ? `
                            <div class="consolidated-meeting-meta-item">
                                <span></span>
                                <span>${meeting.outcome}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                ${meeting.participants && meeting.participants.length > 0 ? `
                    <div class="consolidated-meeting-participants">
                        <div class="consolidated-meeting-participants-title"> Participants</div>
                        ${meeting.participants.map(p => `
                            <div class="consolidated-participant-item">
                                <div class="consolidated-participant-name">${escapeHtml(p.name)}</div>
                                ${p.role || p.email || p.phone ? `
                                    <div class="consolidated-participant-details">
                                        ${p.role ? escapeHtml(p.role) : ''}
                                        ${p.email ? `  ${escapeHtml(p.email)}` : ''}
                                        ${p.phone ? `  ${escapeHtml(p.phone)}` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${notesText ? `
                    <div class="consolidated-meeting-notes">${escapeHtml(notesText)}</div>
                ` : `
                    <div class="consolidated-meeting-notes" style="font-style: italic; opacity: 0.6;">No notes recorded</div>
                `}
                
                ${nextStepsText ? `
                    <div class="consolidated-meeting-nextsteps">
                        <div class="consolidated-meeting-nextsteps-title">Next Steps</div>
                        <div class="consolidated-meeting-nextsteps-content">${escapeHtml(nextStepsText)}</div>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
    
    // Update export preview
    updateConsolidatedNotesExport(meetings, customerName);
}

function updateConsolidatedNotesExport(meetings, customerName) {
    const tabName = state.meetingTabs.find(t => t.id === state.currentMeetingTab)?.name || 'All Meetings';
    
    let exportText = `CONSOLIDATED MEETING NOTES\n`;
    exportText += `${'='.repeat(60)}\n\n`;
    exportText += `Customer: ${customerName}\n`;
    exportText += `Tab: ${tabName}\n`;
    exportText += `Total Meetings: ${meetings.length}\n`;
    exportText += `Export Date: ${new Date().toLocaleString()}\n\n`;
    exportText += `${'='.repeat(60)}\n\n`;
    
const typeIcons = {
    discovery: '',
    'follow-up': ''
};
    
    meetings.forEach((meeting, index) => {
        const meetingDate = new Date(meeting.date);
        const notesText = meeting.notesHTML ? htmlToPlainText(meeting.notesHTML) : meeting.notes || '';
        const nextStepsText = meeting.nextStepsHTML ? htmlToPlainText(meeting.nextStepsHTML) : meeting.nextSteps || '';
        
        exportText += `MEETING ${index + 1}: ${meeting.title}\n`;
        exportText += `${'-'.repeat(60)}\n\n`;
        exportText += `Date: ${meetingDate.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}\n`;
        if (meeting.type) exportText += `Type: ${meeting.type.replace('-', ' ')}\n`;
        if (meeting.duration) exportText += `Duration: ${meeting.duration} min\n`;
        if (meeting.outcome) exportText += `Outcome: ${meeting.outcome}\n`;
        exportText += `\n`;
        
        if (meeting.participants && meeting.participants.length > 0) {
            exportText += `PARTICIPANTS:\n`;
            meeting.participants.forEach(p => {
                exportText += ` ${p.name}`;
                if (p.role) exportText += ` - ${p.role}`;
                if (p.email) exportText += ` (${p.email})`;
                if (p.phone) exportText += ` - ${p.phone}`;
                exportText += `\n`;
            });
            exportText += `\n`;
        }
        
        exportText += `NOTES:\n`;
        exportText += notesText || 'No notes recorded';
        exportText += `\n\n`;
        
        if (nextStepsText) {
            exportText += `NEXT STEPS:\n`;
            exportText += nextStepsText;
            exportText += `\n\n`;
        }
        
        exportText += `${'='.repeat(60)}\n\n`;
    });
    
    document.getElementById('consolidatedNotesExportPreview').textContent = exportText;
}

function copyConsolidatedNotes() {
    const exportText = document.getElementById('consolidatedNotesExportPreview').textContent;
    navigator.clipboard.writeText(exportText).then(() => {
        showToast(' Copied all notes!', 'success');
    }).catch(() => {
        showToast(' Failed to copy', 'error');
    });
}

function downloadConsolidatedNotes() {
    const exportText = document.getElementById('consolidatedNotesExportPreview').textContent;
    const customer = state.customers.find(c => c.id === state.currentCustomer);
    const tabName = state.meetingTabs.find(t => t.id === state.currentMeetingTab)?.name || 'AllMeetings';
    const filename = `${customer.name.replace(/\s+/g, '_')}_${tabName.replace(/\s+/g, '_')}_Notes_${new Date().toISOString().split('T')[0]}.txt`;
    
    const blob = new Blob([exportText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast(' Downloaded!', 'success');
}


function init() {
    fixDuplicateMeetingIds();
    setupShareModalTabs();

    
    setupEventListeners();
    setupColorPicker();
    setupCustomerCombobox();
    setupTaskCustomerCombobox();
    setupCustomerInfoCustomerCombobox();
    setupInlineTabs();
    loadCustomMeetingTypes();
    setupRichTextEditor();
    setupMEDDPICCQuickAdd();
    setupActionItemQuickAdd();
    updateStats();
    renderCustomerFilters();
    renderNotes();
    showHome();

     // Reset state to ensure clean start
    state.currentCustomer = 'all';
    state.currentMeetingTab = 'all';
    
    // Show dashboard (will be called again by auth callback, but ensures immediate display)
    showDashboard();

    // Auto-refresh upcoming meetings every 30 seconds to update statuses
    setInterval(() => {
        if (document.getElementById('upcomingMeetingsSection').classList.contains('active')) {
            renderUpcomingMeetings();
        }
    }, 30000);
}

        function setupEventListeners() {
            document.getElementById('homeBtn').addEventListener('click', () => showDashboard());
            document.getElementById('showAllTasksBtn').addEventListener('click', () => showAllTasks());

document.getElementById('exportAllBtn').addEventListener('click', exportAllData);
document.getElementById('importAllBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
document.getElementById('importFileInput').addEventListener('change', importAllData);

// ========== SHARING FEATURE - START ==========
document.getElementById('sharedBtn').addEventListener('click', () => showSharedMeetings());
// Share modal close button
const closeShareBtn = document.getElementById('closeShareModalBtn');
if (closeShareBtn) {
    closeShareBtn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeShareModal();
    };
}
// ========== SHARING FEATURE - END ==========
// Setup upcoming meetings period filters
document.querySelectorAll('.upcoming-filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.upcoming-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.upcomingMeetingsPeriod = btn.dataset.period === 'all' ? 'all' : parseInt(btn.dataset.period);
        renderUpcomingMeetings();
    });
});
            document.getElementById('newMeetingBtn').addEventListener('click', () => {
    // If viewing a specific customer, auto-fill with that customer
    if (state.currentCustomer !== 'all') {
        openInlineMeetingFormForCustomer(state.currentCustomer);
    } else {
        openInlineMeetingForm();
    }
});
            document.getElementById('newTaskBtn').addEventListener('click', () => openTaskModal());
            document.getElementById('newNoteBtn').addEventListener('click', () => openNoteModal());
document.getElementById('addCustomerBtn').addEventListener('click', () => openAddCustomerForm());
            document.getElementById('viewMeetingsBtn').addEventListener('click', () => openAllMeetingsModal());
            document.getElementById('tagsOverviewBtn').addEventListener('click', () => openTagsOverviewModal());
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('archiveBtn').addEventListener('click', () => showArchived());
            document.getElementById('clearAllBtn').addEventListener('click', () => showConfirm('', 'Clear All?', 'Delete everything?', confirmClearAll));

document.getElementById('closeConsolidatedNotesBtn').addEventListener('click', closeConsolidatedNotesModal);
document.getElementById('copyConsolidatedNotesBtn').addEventListener('click', copyConsolidatedNotes);
document.getElementById('downloadConsolidatedNotesBtn').addEventListener('click', downloadConsolidatedNotes);
            
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
            document.getElementById('noteForm').addEventListener('submit', handleNoteSubmit);
            document.getElementById('customerForm').addEventListener('submit', handleCustomerSubmit);
            document.getElementById('meetingForm').addEventListener('submit', handleMeetingSubmit);
            document.getElementById('CustomerInfoForm').addEventListener('submit', handleCustomerInfoSubmit);
            
            document.getElementById('searchInput').addEventListener('input', handleSearch);

            document.getElementById('closeCustomersModalBtn').addEventListener('click', closeCustomersModal);
            document.getElementById('closeCustomerFormBtn').addEventListener('click', closeCustomerFormModal);
document.getElementById('closeCustomMeetingTypeBtn').addEventListener('click', closeCustomMeetingTypeModal);
document.getElementById('cancelCustomMeetingTypeBtn').addEventListener('click', closeCustomMeetingTypeModal);
            document.getElementById('closeAllMeetingsBtn').addEventListener('click', closeAllMeetingsModal);
            document.getElementById('closeTaskModalBtn').addEventListener('click', closeTaskModal);
            document.getElementById('closeNoteModalBtn').addEventListener('click', closeNoteModal);
            document.getElementById('closeTagsOverviewBtn').addEventListener('click', closeTagsOverviewModal);
            document.getElementById('closeExportModalBtn').addEventListener('click', closeExportModal);

            document.getElementById('cancelCustomerFormBtn').addEventListener('click', closeCustomerFormModal);
            document.getElementById('cancelTaskBtn').addEventListener('click', closeTaskModal);
            document.getElementById('cancelNoteBtn').addEventListener('click', closeNoteModal);
            document.getElementById('cancelConfirmBtn').addEventListener('click', closeConfirmModal);

            document.getElementById('copyCustomerInfoBtn').addEventListener('click', copyCustomerInfoToClipboard);
            document.getElementById('downloadCustomerInfoBtn').addEventListener('click', downloadCustomerInfo);
            document.getElementById('copyMeetingBtn').addEventListener('click', copyMeetingToClipboard);
            document.getElementById('downloadMeetingBtn').addEventListener('click', downloadMeeting);
            document.getElementById('copyExportModalBtn').addEventListener('click', copyFromExportModal);
            document.getElementById('downloadExportModalBtn').addEventListener('click', downloadFromExportModal);

            document.getElementById('openAddCustomerBtn').addEventListener('click', openAddCustomerForm);
            document.getElementById('addQuickTaskBtn').addEventListener('click', addQuickTask);
            document.getElementById('addParticipantBtn').addEventListener('click', addParticipant);
            document.getElementById('addSubtaskBtn').addEventListener('click', () => addSubtaskInput());

// Add this with the other modal tab setup
document.querySelectorAll('#consolidatedNotesModal .modal-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        document.querySelectorAll('#consolidatedNotesModal .modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#consolidatedNotesModal .tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.querySelector(`#consolidatedNotesModal [data-tab-content="${tabName}"]`).classList.add('active');
    });
});


    document.getElementById('quickTaskInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addQuickTask();
        }
    });

            document.getElementById('quickTaskInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addQuickTask();
                }
            });

            document.getElementById('participantRoleInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addParticipant();
                }
            });

document.getElementById('participantEmailInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addParticipant();
    }
});

document.getElementById('participantPhoneInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addParticipant();
    }
});



            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentFilter = btn.dataset.filter;
                    renderTasks();
                });
            });

            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    
                    if (view === 'list' || view === 'kanban') {
                        state.currentDisplayMode = view;
                        document.querySelectorAll('.view-btn[data-view="list"], .view-btn[data-view="kanban"]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        if (view === 'kanban') {
                            document.getElementById('tasksList').style.display = 'none';
                            document.getElementById('kanbanBoard').classList.add('active');
                            document.getElementById('mainContainer').classList.add('kanban-mode');
                            document.getElementById('notesContainer').classList.add('hidden');
                            document.getElementById('taskFilters').style.display = 'none';
                        } else {
                            document.getElementById('tasksList').style.display = 'flex';
                            document.getElementById('kanbanBoard').classList.remove('active');
                            document.getElementById('mainContainer').classList.remove('kanban-mode');
                            document.getElementById('notesContainer').classList.remove('hidden');
                            document.getElementById('taskFilters').style.display = 'flex';
                        }
                    } else {
                        document.querySelectorAll('.view-btn[data-view="active"], .view-btn[data-view="archived"]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        state.currentView = view;
                    }
                    
                    renderTasks();
                });
            });

            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('meetingDate').value = now.toISOString().slice(0, 16);

setTimeout(() => {
    const radios = document.querySelectorAll('input[name="followUpType"]');
    radios.forEach(radio => {
        radio.addEventListener('change', updateFollowUpPreview);
    });
}, 1000);

        }

function toggleMeetingNotesExpand(meetingId, buttonElement) {
    const content = document.getElementById(`meeting-notes-${meetingId}`);
    
    if (!content || !buttonElement) return;
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        buttonElement.textContent = 'Show More ';
    } else {
        content.classList.add('expanded');
        buttonElement.textContent = 'Show Less ';
    }
}

function toggleMeetingParticipants(meetingId, buttonElement) {
    const content = document.getElementById(`meeting-participants-${meetingId}`);
    
    if (!content || !buttonElement) return;
    
    const count = buttonElement.getAttribute('data-count') || '';
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        content.style.maxHeight = '0';
        content.style.padding = '0';
        buttonElement.textContent = `Show Participants (${count}) `;
    } else {
        content.classList.add('expanded');
        content.style.maxHeight = '150px';
        content.style.overflowY = 'auto';
        content.style.padding = '0.5rem';
        buttonElement.textContent = `Hide Participants (${count}) `;
    }
}

        function setupInlineTabs() {
            const tabs = document.querySelectorAll('.modal-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    const formType = tab.dataset.form;
                    
                    if (formType) {
                        const formContainer = formType === 'meeting' ? '#inlineMeetingForm' : '#inlineCustomerInfoForm';
                        const formTabs = document.querySelectorAll(`${formContainer} .modal-tab`);
                        const formContents = document.querySelectorAll(`${formContainer} .tab-content`);
                        
                        formTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        formContents.forEach(content => content.classList.remove('active'));
                        const targetContent = document.querySelector(`${formContainer} [data-tab-content="${tabName}"]`);
                        if (targetContent) targetContent.classList.add('active');
                        
                        if (formType === 'meeting') {
                            state.currentMeetingTab = tabName;
                            if (tabName === 'export') {
                                updateMeetingExportPreview();
                            }
                        } else {
                            state.currentCustomerInfoTab = tabName;
                            if (tabName === 'export') {
                                updateCustomerInfoExportPreview();
                            }
                        }
                    }
                });
            });
        }

       function openInlineCustomerInfoForm(CustomerInfo = null) {
    // Hide other sections
    document.getElementById('inlineMeetingForm').classList.remove('active');
    document.getElementById('customerCustomerInfosSection').classList.remove('active');
    document.getElementById('customerMeetingsSection').classList.remove('active');
hideCustomerParticipantsSection();
hideUpcomingMeetings();
hideCustomerActivity();
    document.querySelector('.tasks-section').style.display = 'none'; // Hide tasks section
    document.getElementById('notesContainer').classList.add('hidden');
    document.getElementById('mainContainer').classList.add('form-mode');
    
    state.editingCustomerInfo = CustomerInfo;
    state.selectedCustomerInfoCustomerId = null;
    
    // Reset tabs
    document.querySelectorAll('#inlineCustomerInfoForm .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#inlineCustomerInfoForm .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#inlineCustomerInfoForm .modal-tab[data-tab="info"]').classList.add('active');
    document.querySelector('#inlineCustomerInfoForm [data-tab-content="info"]').classList.add('active');
    state.currentCustomerInfoTab = 'info';
    
   if (CustomerInfo) {
    document.getElementById('CustomerInfoId').value = CustomerInfo.id;
    document.getElementById('CustomerInfoCustomerInput').value = CustomerInfo.customerName || '';
    state.selectedCustomerInfoCustomerId = CustomerInfo.customerId;
    document.getElementById('CustomerInfoBackground').value = CustomerInfo.background || '';
    document.getElementById('CustomerInfoDiscussionPoints').value = CustomerInfo.discussionPoints || '';
    document.getElementById('CustomerInfoMaterials').value = CustomerInfo.materials || '';
    document.getElementById('CustomerInfoOutcomes').value = CustomerInfo.outcomes || '';
} else {
        document.getElementById('CustomerInfoForm').reset();
 document.getElementById('CustomerInfoId').value = '';
        document.getElementById('CustomerInfoCustomerInput').value = '';
    }
    
    document.getElementById('inlineCustomerInfoForm').classList.add('active');
    window.scrollTo(0, 0);
}

function closeInlineCustomerInfoForm() {
    const formElement = document.getElementById('inlineCustomerInfoForm');
    if (formElement.classList.contains('active')) {
        formElement.classList.remove('active');
        document.querySelector('.tasks-section').style.display = 'block';
        document.getElementById('notesContainer').classList.remove('hidden');
        document.getElementById('mainContainer').classList.remove('form-mode');
        state.editingCustomerInfo = null;
        state.selectedCustomerInfoCustomerId = null;
        
        // Return to appropriate view
        if (state.currentCustomer === 'all') {
            showDashboard();
        } else {
            // Show customer-specific view
            showUpcomingMeetings();
            showCustomerParticipantsSection(state.currentCustomer);
            showCustomerCustomerInfosSection(state.currentCustomer);
            showCustomerMeetingsSection(state.currentCustomer);
            updateSectionTitle();
            renderTasks();
            renderTimeline();
        }
    }
}

function openInlineMeetingForm(meeting = null, isPastMeeting = true, isSharedPreview = false) {
    // Hide other sections
    document.getElementById('inlineCustomerInfoForm').classList.remove('active');
    document.getElementById('customerCustomerInfosSection').classList.remove('active');
    document.getElementById('customerMeetingsSection').classList.remove('active');
    hideCustomerParticipantsSection();
    hideUpcomingMeetings(); 
    hideCustomerActivity();
    hideAllCustomersSection();
    document.querySelector('.tasks-section').style.display = 'none';
    document.getElementById('notesContainer').classList.add('hidden');
    document.getElementById('mainContainer').classList.add('form-mode');
    
    // **CRITICAL: Set isPastMeeting flag FIRST before anything else**
    state.meetingIsPastMeeting = isPastMeeting;
    
    console.log('Opening form with isPastMeeting:', isPastMeeting); // DEBUG
    
    // Set title based on whether editing or creating new
    const titleElement = document.getElementById('meetingFormTitle');
    if (titleElement) {
        if (meeting) {
            titleElement.textContent = ' Edit Meeting';
        } else if (isPastMeeting) {
            titleElement.textContent = ' Meeting Notes';
        } else {
            titleElement.textContent = ' New Upcoming Meeting';
        }
    }
    

    
    // **CRITICAL: Force initialization FIRST**
    // EXCEPT when previewing shared meetings - preserve the shared data
    if (!isSharedPreview) {
        state.meetingTasks = [];
        state.meetingParticipants = [];
        state.editingParticipantIndex = null;
    } else {
        // For shared previews, only reset editing state
        state.editingParticipantIndex = null;
    }
    
    state.editingMeeting = meeting;
    state.selectedCustomerId = null;
    state.editingMeetingOriginalTab = state.currentMeetingTab;
    
    // Reset tabs
    document.querySelectorAll('#inlineMeetingForm .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#inlineMeetingForm .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#inlineMeetingForm .modal-tab[data-tab="info"]').classList.add('active');
    document.querySelector('#inlineMeetingForm [data-tab-content="info"]').classList.add('active');
    state.currentMeetingTab = 'info';
    
    // Handle "Mark as completed" checkbox visibility
    const markCompletedWrapper = document.getElementById('markCompletedWrapper');
    if (markCompletedWrapper) {
        if (meeting && meeting.isPastMeeting === false) {
            markCompletedWrapper.style.display = 'flex';
            document.getElementById('meetingMarkCompleted').checked = false;
        } else {
            markCompletedWrapper.style.display = 'none';
            document.getElementById('meetingMarkCompleted').checked = false;
        }
    }
    
    if (meeting) {
        document.getElementById('meetingId').value = meeting.id;
        document.getElementById('meetingCustomerInput').value = meeting.customerName || '';
        state.selectedCustomerId = meeting.customerId;
        document.getElementById('meetingDate').value = meeting.date;
        document.getElementById('meetingType').value = meeting.type || 'other';
        document.getElementById('meetingDuration').value = meeting.duration || '';
document.getElementById('meetingConferenceLink').value = meeting.conferenceLink || '';
        document.getElementById('meetingTitle').value = meeting.title;
        document.getElementById('meetingTags').value = meeting.tags ? meeting.tags.join(', ') : '';
        
        document.getElementById('meetingMarkCompleted').checked = false;
        
        if (meeting.notesHTML) {
            setEditorHTML('meetingNotesEditor', meeting.notesHTML);
        } else {
            setEditorHTML('meetingNotesEditor', escapeHtml(meeting.notes || ''));
        }
        
        if (meeting.nextStepsHTML) {
            setEditorHTML('meetingNextStepsEditor', meeting.nextStepsHTML);
        } else {
            setEditorHTML('meetingNextStepsEditor', escapeHtml(meeting.nextSteps || ''));
        }
        
        
        state.meetingParticipants = Array.isArray(meeting.participants) ? [...meeting.participants] : [];
        
        document.getElementById('meddpiccMetrics').value = meeting.meddpicc?.metrics || '';
        document.getElementById('meddpiccEconomicBuyer').value = meeting.meddpicc?.economicBuyer || '';
        document.getElementById('meddpiccDecisionCriteria').value = meeting.meddpicc?.decisionCriteria || '';
        document.getElementById('meddpiccDecisionProcess').value = meeting.meddpicc?.decisionProcess || '';
        document.getElementById('meddpiccPaperProcess').value = meeting.meddpicc?.paperProcess || '';
        document.getElementById('meddpiccPain').value = meeting.meddpicc?.pain || '';
        document.getElementById('meddpiccChampion').value = meeting.meddpicc?.champion || '';
        document.getElementById('meddpiccCompetition').value = meeting.meddpicc?.competition || '';
    
        // Load tasks - for shared previews, use associatedTasks; otherwise search state.tasks
        if (isSharedPreview && meeting.associatedTasks && meeting.associatedTasks.length > 0) {
            // For shared previews, use the tasks from the shared data
            state.meetingTasks = meeting.associatedTasks.map(t => t.title);
        } else if (!isSharedPreview) {
            // For regular meetings, search in state.tasks
            const meetingTasks = state.tasks.filter(t => t.meetingId === meeting.id);
            state.meetingTasks = meetingTasks.map(t => t.title);
        }
        // If isSharedPreview but no associatedTasks, keep whatever was set in viewSharedMeeting
        
        if (meeting.customerId) {
            loadCustomerInfoForCustomer(meeting.customerId);
        }
    } else {
        document.getElementById('meetingForm').reset();
document.getElementById('meetingConferenceLink').value = '';
        document.getElementById('meetingId').value = '';
        
        // **CRITICAL FIX: Set date based on meeting type**
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        
        if (isPastMeeting) {
            // Past meeting - set to now
            document.getElementById('meetingDate').value = now.toISOString().slice(0, 16);
        } else {
            // Upcoming meeting - set to 2 weeks from now
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + 14);
            futureDate.setMinutes(futureDate.getMinutes() - futureDate.getTimezoneOffset());
            document.getElementById('meetingDate').value = futureDate.toISOString().slice(0, 16);
        }
        
        document.getElementById('meetingCustomerInput').value = '';
        setEditorHTML('meetingNotesEditor', '');
        setEditorHTML('meetingNextStepsEditor', '');
        
        document.getElementById('CustomerInfoTab').style.display = 'none';
    }
    
    console.log('Form opened. state.meetingIsPastMeeting:', state.meetingIsPastMeeting); // DEBUG
    
    // **CRITICAL: Render lists AFTER all initialization**
    renderMeetingTasksList();
    renderParticipantsList();
    
    document.getElementById('inlineMeetingForm').classList.add('active');
    window.scrollTo(0, 0);
}


function closeInlineMeetingForm() {
    const formElement = document.getElementById('inlineMeetingForm');
    if (formElement.classList.contains('active')) {
        formElement.classList.remove('active');
        document.querySelector('.tasks-section').style.display = 'block';
        document.getElementById('notesContainer').classList.remove('hidden');
        document.getElementById('mainContainer').classList.remove('form-mode');
        state.editingMeeting = null;
        state.meetingTasks = [];
        state.meetingParticipants = [];
        state.selectedCustomerId = null;
        state.meetingIsPastMeeting = null;
        
        // Restore the original tab BEFORE clearing it
        if (state.editingMeetingOriginalTab) {
            state.currentMeetingTab = state.editingMeetingOriginalTab;
        }
        state.editingMeetingOriginalTab = null;
        editingSharedMeetingId = null;
        
        // Return to appropriate view
        if (state.currentCustomer === 'all') {
            showDashboard();
        } else {
            // Show customer-specific view
            showUpcomingMeetings();
            showCustomerParticipantsSection(state.currentCustomer);
            showCustomerCustomerInfosSection(state.currentCustomer);
            showCustomerMeetingsSection(state.currentCustomer);
            updateSectionTitle();
            renderTasks();
            renderTimeline();
        }
    }
}


function openInlineCustomerInfoFormForCustomer(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    // Hide other sections
    document.getElementById('inlineMeetingForm').classList.remove('active');
    
    document.getElementById('customerCustomerInfosSection').classList.remove('active');
    document.getElementById('customerMeetingsSection').classList.remove('active');
    document.querySelector('.tasks-section').style.display = 'none';
    document.getElementById('notesContainer').classList.add('hidden');
    document.getElementById('mainContainer').classList.add('form-mode');
    
    state.editingCustomerInfo = null;
    state.selectedCustomerInfoCustomerId = customerId; // Set the customer ID
    
    // Reset tabs
    document.querySelectorAll('#inlineCustomerInfoForm .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#inlineCustomerInfoForm .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#inlineCustomerInfoForm .modal-tab[data-tab="info"]').classList.add('active');
    document.querySelector('#inlineCustomerInfoForm [data-tab-content="info"]').classList.add('active');
    state.currentCustomerInfoTab = 'info';
    
    // Reset form and set customer
    document.getElementById('CustomerInfoForm').reset();
    document.getElementById('CustomerInfoCustomerInput').value = customer.name;
    
    document.getElementById('inlineCustomerInfoForm').classList.add('active');
    window.scrollTo(0, 0);
}

function openInlineMeetingFormForCustomer(customerId, isPastMeeting = true) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    // Hide other sections
    document.getElementById('inlineCustomerInfoForm').classList.remove('active');
    document.getElementById('customerCustomerInfosSection').classList.remove('active');
    document.getElementById('customerMeetingsSection').classList.remove('active');
    hideCustomerParticipantsSection(); // ADD THIS LINE
    hideUpcomingMeetings(); // ADD THIS LINE
    hideCustomerActivity(); // ADD THIS LINE
    document.querySelector('.tasks-section').style.display = 'none';
    document.getElementById('notesContainer').classList.add('hidden');
    document.getElementById('mainContainer').classList.add('form-mode');
    
    // Set title for new meeting
    const titleElement = document.getElementById('meetingFormTitle');
    if (titleElement) {
        if (isPastMeeting) {
            titleElement.textContent = ' Meeting Notes';
        } else {
            titleElement.textContent = ' New Upcoming Meeting';
        }
    }
    
    state.editingMeeting = null;
    state.meetingTasks = [];
    state.meetingParticipants = [];
    state.selectedCustomerId = customerId;
    state.editingMeetingOriginalTab = state.currentMeetingTab;
    state.meetingIsPastMeeting = isPastMeeting;
    
    // Reset tabs
    document.querySelectorAll('#inlineMeetingForm .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#inlineMeetingForm .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#inlineMeetingForm .modal-tab[data-tab="info"]').classList.add('active');
    document.querySelector('#inlineMeetingForm [data-tab-content="info"]').classList.add('active');
    state.currentMeetingTab = 'info';
    
    // Reset form and set customer
    document.getElementById('meetingForm').reset();
document.getElementById('meetingId').value = '';
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('meetingDate').value = now.toISOString().slice(0, 16);
    document.getElementById('meetingCustomerInput').value = customer.name;
    setEditorHTML('meetingNotesEditor', '');
    setEditorHTML('meetingNextStepsEditor', '');
    renderMeetingTasksList();
    renderParticipantsList();
    
    loadCustomerInfoForCustomer(customerId);
    
    document.getElementById('inlineMeetingForm').classList.add('active');
    window.scrollTo(0, 0);
}

        function setupRichTextEditor() {
            document.querySelectorAll('.rich-text-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const command = btn.dataset.command;
                    const target = btn.dataset.target;
                    
                    let editor;
                    if (target === 'nextSteps') {
                        editor = document.getElementById('meetingNextStepsEditor');
                    } else {
                        editor = document.getElementById('meetingNotesEditor');
                    }
                    
                    editor.focus();
                    document.execCommand(command, false, null);
                    update 
ToolbarState(editor);
                });
            });

            const editors = [
                document.getElementById('meetingNotesEditor'),
                document.getElementById('meetingNextStepsEditor')
            ];

            editors.forEach(editor => {
                if (!editor) return;

                editor.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const selection = window.getSelection();
                        const range = selection.getRangeAt(0);
                        const currentNode = range.startContainer.parentNode;
                        
                        const listItem = currentNode.closest('li');
                        if (listItem) {
                            const text = listItem.textContent.trim();
                            
                            if (!text) {
                                e.preventDefault();
                                document.execCommand('outdent');
                                document.execCommand('formatBlock', false, 'p');
                            }
                        }
                    }
                });

                editor.addEventListener('mouseup', () => updateToolbarState(editor));
                editor.addEventListener('keyup', () => updateToolbarState(editor));
            });
        }

        function updateToolbarState(editor) {
            const buttons = editor.previousElementSibling?.querySelectorAll('.rich-text-btn');
            if (!buttons) return;

            buttons.forEach(btn => {
                const command = btn.dataset.command;
                let isActive = false;

                try {
                    isActive = document.queryCommandState(command);
                } catch (e) {
                    // Command not supported
                }

                if (isActive) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function getEditorHTML(editorId) {
            const editor = document.getElementById(editorId);
            return editor.innerHTML.trim();
        }

        function setEditorHTML(editorId, html) {
            const editor = document.getElementById(editorId);
            editor.innerHTML = html || '';
        }

        function getEditorText(editorId) {
            const editor = document.getElementById(editorId);
            return editor.innerText.trim();
        }

        function htmlToPlainText(html) {
            if (!html) return '';
            
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            function processNode(node) {
                let text = '';
                let hasContent = false;
                
                for (let child of node.childNodes) {
                    if (child.nodeType === Node.TEXT_NODE) {
                        const content = child.textContent;
                        if (content) {
                            text += content;
                            hasContent = true;
                        }
                    } else if (child.nodeType === Node.ELEMENT_NODE) {
                        const tagName = child.tagName.toLowerCase();
                        
                        if (tagName === 'br') {
                            text += '\n';
                            hasContent = true;
                        } else if (tagName === 'div' || tagName === 'p') {
                            if (hasContent && text && !text.endsWith('\n')) {
                                text += '\n';
                            }
                            const childText = processNode(child);
                            text += childText;
                            if (childText.trim() || !childText) {
                                text += '\n';
                            }
                            hasContent = true;
                        } else if (tagName === 'ul') {
                            if (hasContent && text && !text.endsWith('\n')) {
                                text += '\n';
                            }
                            const items = child.querySelectorAll('li');
                            items.forEach(li => {
                                text += ' ' + li.textContent.trim() + '\n';
                            });
                            hasContent = true;
                        } else if (tagName === 'ol') {
                            if (hasContent && text && !text.endsWith('\n')) {
                                text += '\n';
                            }
                            const items = child.querySelectorAll('li');
                            items.forEach((li, index) => {
                                text += `${index + 1}. ` + li.textContent.trim() + '\n';
                            });
                            hasContent = true;
                        } else if (tagName !== 'li') {
                            text += processNode(child);
                            hasContent = true;
                        }
                    }
                }
                
                return text;
            }
            
            let result = processNode(temp);
            result = result.replace(/\n{3,}/g, '\n\n');
            return result.trim();
        }

        function setupMEDDPICCQuickAdd() {
            const quickButtons = document.querySelectorAll('.meddpicc-quick-btn');
            
            quickButtons.forEach(button => {
                const infoIcon = button.querySelector('.meddpicc-info-icon');
                const tooltip = button.querySelector('.meddpicc-tooltip');
                
                if (infoIcon && tooltip) {
                    infoIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                    
                    infoIcon.addEventListener('mouseenter', (e) => {
                        const rect = infoIcon.getBoundingClientRect();
                        tooltip.style.top = (rect.top - 10) + 'px';
                        tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                    });
                }
                
                button.addEventListener('click', (e) => {
                    if (e.target.closest('.meddpicc-info-icon')) {
                        return;
                    }
                    
                    const field = button.dataset.field;
                    const selection = window.getSelection();
                    const selectedText = selection.toString().trim();
                    
                    if (!selectedText) {
                        showToast('Select text first', 'error');
                        return;
                    }
                    
                    const meddpiccField = document.getElementById(`meddpicc${field.charAt(0).toUpperCase() + field.slice(1)}`);
                    if (meddpiccField) {
                        const currentValue = meddpiccField.value.trim();
                        const newValue = currentValue ? currentValue + '\n\n ' + selectedText : ' ' + selectedText;
                        meddpiccField.value = newValue;
                        button.classList.add('success-flash');
                        setTimeout(() => button.classList.remove('success-flash'), 500);
                        showToast('Added!', 'success');
                    }
                });
            });
        }

        function setupActionItemQuickAdd() {
            const quickButton = document.querySelector('.action-item-quick-btn');
            if (!quickButton) return;
            
            quickButton.addEventListener('click', () => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                
                if (!selectedText) {
                    showToast('Select text first', 'error');
                    return;
                }
                
                if (!state.meetingTasks.includes(selectedText)) {
                    state.meetingTasks.push(selectedText);
                    renderMeetingTasksList();
                    quickButton.classList.add('success-flash');
                    setTimeout(() => quickButton.classList.remove('success-flash'), 500);
                    showToast('Added!', 'success');
                } else {
                    showToast('Already exists', 'error');
                }
            });
        }

function showAllTasks() {
    state.currentCustomer = 'all';
    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
    
    // Hide all dashboard/customer sections
    hideDashboardStats();
    hideCustomerMeetingsSection();
    hideCustomerCustomerInfosSection();
    hideCustomerParticipantsSection();
    hideUpcomingMeetings();
    hideCustomerActivity();
    hideAllCustomersSection();
    
    // Hide shared meetings section
    document.getElementById('sharedMeetingsSection')?.classList.remove('active');
    
    // Hide customer header banner
    document.getElementById('customerHeaderBanner').classList.remove('active');
    
    // Close any open forms
    closeInlineMeetingForm();
    closeInlineCustomerInfoForm();
    
    // Show tasks and notes sections
    document.querySelector('.tasks-section').style.display = 'block';
    document.getElementById('notesContainer').classList.remove('hidden');
    document.getElementById('mainContainer').classList.remove('form-mode');
    
    updateSectionTitle();
    renderTasks();
    renderNotes();
}


function showDashboard() {
    state.currentCustomer = 'all';
    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
    
    // Close any open forms
    closeInlineMeetingForm();
    closeInlineCustomerInfoForm();
    
    // Hide customer-specific sections
    hideCustomerMeetingsSection();
    hideCustomerCustomerInfosSection();
    hideCustomerParticipantsSection();

    // Hide shared meetings section
    document.getElementById('sharedMeetingsSection')?.classList.remove('active');
    
    // Hide statistics, show dashboard sections
    hideDashboardStats();
    showUpcomingMeetings();
    showCustomerActivity();
    showAllCustomersSection();
    
    // Show tasks and notes
    document.querySelector('.tasks-section').style.display = 'block';
    document.getElementById('notesContainer').classList.remove('hidden');
    document.getElementById('mainContainer').classList.remove('form-mode');
    
    // Hide customer header banner
    document.getElementById('customerHeaderBanner').classList.remove('active');
    
    updateSectionTitle();
    renderTasks();
    renderNotes();
    renderTimeline();
}

        function showHome() {
            showDashboard();
renderNotes();
        }


function hideDashboardStats() {
    // Statistics feature removed
}


// All Customers Section Functions
let customersListFilter = 'all';

function showAllCustomersSection() {
    document.getElementById('allCustomersSection').classList.add('active');
    renderAllCustomersList();
}

function hideAllCustomersSection() {
    document.getElementById('allCustomersSection').classList.remove('active');
}

function filterCustomersList(filter) {
    customersListFilter = filter;
    document.querySelectorAll('[data-customers-filter]').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-customers-filter="${filter}"]`).classList.add('active');
    renderAllCustomersList();
}

function renderAllCustomersList() {
    const container = document.getElementById('customersListContent');
    const empty = document.getElementById('allCustomersEmpty');
    const localSearch = document.getElementById('customersSearchInput').value.toLowerCase();
    const searchQuery = state.searchQuery || localSearch;
    let customers = [...state.customers];
    
    if (searchQuery) {
        customers = customers.filter(c => 
            c.name.toLowerCase().includes(searchQuery) ||
            (c.industry && c.industry.toLowerCase().includes(searchQuery)) ||
            (c.city && c.city.toLowerCase().includes(searchQuery)) ||
            (c.email && c.email.toLowerCase().includes(searchQuery)) ||
            (c.website && c.website.toLowerCase().includes(searchQuery))
        );
    }
    
    if (customersListFilter === 'pinned') {
        customers = customers.filter(c => c.pinned);
    } else if (customersListFilter === 'recent') {
        const recentCustomerIds = [...new Set(
            state.meetings.sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 20).map(m => m.customerId).filter(Boolean)
        )];
        customers = customers.filter(c => recentCustomerIds.includes(c.id));
        customers.sort((a, b) => recentCustomerIds.indexOf(a.id) - recentCustomerIds.indexOf(b.id));
    } else {
        customers.sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return a.name.localeCompare(b.name);
        });
    }
    
    document.getElementById('allCustomersTotal').textContent = state.customers.length;
    
    if (customers.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        empty.innerHTML = searchQuery 
            ? `<div>No results for "${escapeHtml(searchQuery)}"</div>`
            : `<button class="btn-schedule-meeting" onclick="openAddCustomerForm()">+ Add First Customer</button>`;
        return;
    }
    
    empty.style.display = 'none';
    
    container.innerHTML = customers.map(customer => {
        const logoHtml = customer.website 
            ? `<img class="customer-logo" src="https://www.google.com/s2/favicons?domain=${customer.website.replace(/^https?:\/\//, '').replace(/^www\./, '').split('/')[0]}&sz=128" onerror="this.outerHTML=getBuildingSVG(20)">`
            : getBuildingSVG(20);
        
        const websiteHtml = customer.website
            ? `<a href="${customer.website.startsWith('http') ? customer.website : 'https://' + customer.website}" target="_blank" onclick="event.stopPropagation();">${customer.website.replace(/^https?:\/\//, '').replace(/^www\./, '')} </a>`
            : '';
        
        let addressText = '';
        if (customer.city && customer.state) addressText = `${customer.city}, ${customer.state}`;
        else if (customer.city) addressText = customer.city;
        else if (customer.address) addressText = customer.address.substring(0, 30);
        
        const addressHtml = addressText
            ? (customer.mapsLink 
                ? `<a href="${customer.mapsLink}" target="_blank" onclick="event.stopPropagation();">${escapeHtml(addressText)}</a>`
                : escapeHtml(addressText))
            : '';
        
        return `
            <div class="customer-row ${customer.pinned ? 'pinned' : ''}" onclick="selectCustomerFromOverview('${customer.id}')">
                <div>${logoHtml}</div>
                <div class="customer-name-cell">
                    <span class="pin-star ${customer.pinned ? 'pinned' : ''}" onclick="event.stopPropagation(); togglePinCustomer('${customer.id}', event)">${customer.pinned ? '' : ''}</span>
                    ${escapeHtml(customer.name)}
                </div>
                <div class="customer-website-cell">${websiteHtml}</div>
                <div class="customer-address-cell">${addressHtml}</div>
                <div class="customer-industry-badge">${customer.industry ? escapeHtml(customer.industry) : ''}</div>
                <div class="customer-row-actions">
                    <button class="participant-action-btn" onclick="event.stopPropagation(); openEditCustomerForm('${customer.id}')" title="Edit">
                        <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 2;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button class="participant-action-btn delete" onclick="event.stopPropagation(); deleteCustomerFromSidebar('${customer.id}')" title="Delete">
                        <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 2;"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function showCustomerActivity() {
    document.getElementById('customerActivitySection').classList.add('active');
    renderCustomerActivity();
}

function hideCustomerActivity() {
    document.getElementById('customerActivitySection').classList.remove('active');
}

// Upcoming Meetings Functions
function showUpcomingMeetings() {
    document.getElementById('upcomingMeetingsSection').classList.add('active');
    renderUpcomingMeetings();
}

function hideUpcomingMeetings() {
    document.getElementById('upcomingMeetingsSection').classList.remove('active');
}

function renderUpcomingMeetings() {
    const container = document.getElementById('upcomingMeetingsList');
    const empty = document.getElementById('upcomingMeetingsEmpty');
    
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    
    // Calculate period end date
    let periodEnd = null;
    if (state.upcomingMeetingsPeriod !== 'all') {
        periodEnd = new Date(now.getTime() + state.upcomingMeetingsPeriod * 24 * 60 * 60 * 1000);
    }
    
    // Get upcoming meetings (including recently finished ones)
    let upcomingMeetings = state.meetings.filter(m => {
        // Don't show meetings marked as past meetings
        if (m.isPastMeeting) return false;
        
        const meetingDate = new Date(m.date);
        const meetingDuration = m.duration || 60;
        const meetingEndTime = new Date(meetingDate.getTime() + meetingDuration * 60000);
        const twoHoursAfterEnd = new Date(meetingEndTime.getTime() + 2 * 60 * 60 * 1000);
        
        // Show if meeting hasn't ended + 2 hours yet
        const isUpcoming = now < twoHoursAfterEnd;
        
        if (!isUpcoming) return false;        
        // Filter by customer if viewing specific customer
        if (state.currentCustomer !== 'all' && m.customerId !== state.currentCustomer) {
            return false;
        }
        
        // Filter by period (for future meetings only)
        if (periodEnd && meetingDate > periodEnd && meetingDate > now) {
            return false;
        }
        
        return true;
    });

    // Apply global search filter
if (state.searchQuery) {
    upcomingMeetings = upcomingMeetings.filter(m => {
        const matchesTitle = m.title.toLowerCase().includes(state.searchQuery);
        const matchesCustomer = m.customerName && m.customerName.toLowerCase().includes(state.searchQuery);
        const matchesType = m.type && m.type.toLowerCase().includes(state.searchQuery);
        
        // Search in meeting notes
        const notesText = m.notesHTML ? htmlToPlainText(m.notesHTML) : (m.notes || '');
        const matchesNotes = notesText.toLowerCase().includes(state.searchQuery);
        
        // Search in next steps
        const nextStepsText = m.nextStepsHTML ? htmlToPlainText(m.nextStepsHTML) : (m.nextSteps || '');
        const matchesNextSteps = nextStepsText.toLowerCase().includes(state.searchQuery);
        
        // Search in tags
        const matchesTags = m.tags && m.tags.some(tag => tag.toLowerCase().includes(state.searchQuery));
        
        return matchesTitle || matchesCustomer || matchesType || matchesNotes || matchesNextSteps || matchesTags;
    });
}
    
    // Sort by date (earliest first)
    upcomingMeetings.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // Check if there are ANY past meetings to decide on Follow-Up button
    const pastMeetings = state.meetings.filter(m => {
        if (m.isPastMeeting) return true;
        const meetingDate = new Date(m.date);
        const meetingDuration = m.duration || 60;
        const meetingEndTime = new Date(meetingDate.getTime() + meetingDuration * 60000);
        return meetingEndTime < now;
    });
    
    // Filter by customer if viewing specific customer
    const relevantPastMeetings = state.currentCustomer !== 'all' 
        ? pastMeetings.filter(m => m.customerId === state.currentCustomer)
        : pastMeetings;
    
if (upcomingMeetings.length === 0) {
    container.innerHTML = '';
    empty.removeAttribute('style');
    empty.className = 'empty-state-compact';
    empty.style.display = 'block';
    
    // Determine button function based on whether viewing specific customer or all
    const buttonFunction = state.currentCustomer !== 'all' 
        ? `openInlineMeetingFormForCustomer('${state.currentCustomer}', false)` 
        : `openInlineMeetingFormForUpcoming()`;
    
    const followUpFunction = state.currentCustomer !== 'all' 
        ? `openFollowUpModal('upcoming')` 
        : `openFollowUpModal('upcoming')`;
    
    empty.innerHTML = `
        <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
            <button class="btn-schedule-meeting" onclick="${buttonFunction}" style="display: inline-flex;">
                <span>+</span>
                <span>Upcoming Meeting</span>
            </button>
            ${relevantPastMeetings.length > 0 ? `
                <button class="btn-schedule-meeting" onclick="${followUpFunction}" style="display: inline-flex;">
                    <span>+</span>
                    <span>Follow-Up</span>
                </button>
            ` : ''}
        </div>
    `;
        
        // Hide BOTH header buttons when empty
        const upcomingBtn = document.getElementById('upcomingHeaderBtn');
        if (upcomingBtn) upcomingBtn.style.display = 'none';
        
        const followUpBtn = document.getElementById('upcomingFollowUpBtn');
        if (followUpBtn) followUpBtn.style.display = 'none';
            
        return;
    }
    
    empty.style.display = 'none';
    
    container.innerHTML = upcomingMeetings.map(meeting => {
        const meetingDate = new Date(meeting.date);
        const meetingDateStr = meetingDate.toISOString().split('T')[0];
        const meetingDuration = meeting.duration || 60;
        const meetingEndTime = new Date(meetingDate.getTime() + meetingDuration * 60000);
        
        // Calculate meeting status
        const minutesUntilStart = (meetingDate - now) / (1000 * 60);
        const minutesSinceStart = (now - meetingDate) / (1000 * 60);
        const minutesSinceEnd = (now - meetingEndTime) / (1000 * 60);
        
        let meetingStatus = 'upcoming';
        let statusLabel = '';
        let statusBadge = '';
        
        if (minutesUntilStart <= 15 && minutesUntilStart > 0) {
            // Starting in 15 minutes or less
            meetingStatus = 'starting-soon';
            statusLabel = `STARTS IN ${Math.ceil(minutesUntilStart)} MIN`;
            statusBadge = `<span class="upcoming-meeting-status starting-soon"> Starting Soon</span>`;
        } else if (minutesSinceStart >= 0 && minutesSinceStart < meetingDuration) {
            // Meeting is happening now
            meetingStatus = 'happening-now';
            statusLabel = 'HAPPENING NOW';
            statusBadge = `<span class="upcoming-meeting-status happening-now"> Live Now</span>`;
        } else if (minutesSinceEnd >= 0 && minutesSinceEnd < 120) {
            // Just finished (within 2 hours)
            meetingStatus = 'just-finished';
            statusLabel = 'JUST FINISHED';
            statusBadge = `<span class="upcoming-meeting-status just-finished"> Completed</span>`;
        } else {
            // Normal upcoming
            const daysUntil = Math.floor((meetingDate - now) / (1000 * 60 * 60 * 24));
            
            if (meetingDateStr === today) {
                meetingStatus = 'today';
                statusLabel = 'TODAY';
            } else if (daysUntil === 1) {
                meetingStatus = 'soon';
                statusLabel = 'TOMORROW';
            } else if (daysUntil <= 3) {
                meetingStatus = 'soon';
                statusLabel = `IN ${daysUntil} DAYS`;
            } else if (daysUntil <= 7) {
                meetingStatus = 'upcoming';
                statusLabel = `IN ${daysUntil} DAYS`;
            } else {
                meetingStatus = 'upcoming';
                statusLabel = meetingDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }
        
        // Format time
        const timeStr = meetingDate.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
        });
        
        // Format date for badge
        const dayName = meetingDate.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
        const dateStr = meetingDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        // Check prep status
        const hasPrep = state.CustomerInfos.some(p => p.customerId === meeting.customerId);
        
        // Check if notes exist
        const hasNotes = meeting.notes || meeting.notesHTML;
        
        // Get participant count
        const participantCount = meeting.participants ? meeting.participants.length : 0;
        
        const typeIcons = {
            discovery: '',
            'follow-up': ''
        };
        const typeIcon = typeIcons[meeting.type] || (meeting.customTypeIcon || '');
        
        // Determine button action based on status
        let primaryAction = '';
        if (meetingStatus === 'starting-soon' || meetingStatus === 'happening-now') {
            primaryAction = `
                <button class="upcoming-action-btn" onclick="event.stopPropagation(); takeMeetingNotes('${meeting.id}')" title="Take Notes" style="background: var(--primary); color: white;">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                </button>
            `;
        } else if (meetingStatus === 'just-finished') {
            if (hasNotes) {
                primaryAction = `
                    <button class="upcoming-action-btn" onclick="event.stopPropagation(); viewMeetingNotes('${meeting.id}')" title="View Notes" style="background: var(--success); color: white;">
                        <svg viewBox="0 0 24 24">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                `;
            } else {
                primaryAction = `
                    <button class="upcoming-action-btn" onclick="event.stopPropagation(); takeMeetingNotes('${meeting.id}')" title="Add Notes" style="background: var(--warning); color: white;">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                    </button>
                `;
            }
        } else if (!hasPrep) {
            primaryAction = `
                <button class="upcoming-action-btn" onclick="event.stopPropagation(); createPrepForUpcoming('${meeting.customerId}')" title="Create Prep" style="background: var(--warning); color: white;">
                    <svg viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                </button>
            `;
        }
        
        return `
            <div class="upcoming-meeting-row ${meetingStatus}" onclick="editUpcomingMeeting('${meeting.id}')" data-meeting-id="${meeting.id}">
                <div class="upcoming-meeting-date ${meetingStatus}">
                    <div class="upcoming-date-day">${statusLabel.includes('MIN') || statusLabel === 'HAPPENING NOW' || statusLabel === 'JUST FINISHED' || statusLabel === 'TODAY' || statusLabel === 'TOMORROW' ? statusLabel.split(' ')[0] : dayName}</div>
                    <div class="upcoming-date-date">${statusLabel.includes('MIN') || statusLabel === 'HAPPENING NOW' || statusLabel === 'JUST FINISHED' ? timeStr.split(' ')[0] : (statusLabel === 'TODAY' || statusLabel === 'TOMORROW' ? timeStr.split(' ')[0] : dateStr)}</div>
                </div>
                
                <div class="upcoming-meeting-details">
                    <div class="upcoming-meeting-time-title">
                        <span class="upcoming-meeting-time">${timeStr}</span>
                        <span class="upcoming-meeting-title">${escapeHtml(meeting.title)}  ${escapeHtml(meeting.customerName || 'Unknown')}</span>
                        ${statusBadge}
                    </div>
                    <div class="upcoming-meeting-meta">
                        ${participantCount > 0 ? `<span class="upcoming-meeting-meta-item"> ${participantCount}</span>` : ''}
${meeting.conferenceLink ? `<a href="${escapeHtml(meeting.conferenceLink)}" target="_blank" rel="noopener" onclick="event.stopPropagation();" class="upcoming-meeting-meta-item" style="color: var(--primary); text-decoration: none;"> Join</a>` : ''}
                        ${meeting.type ? `<span class="upcoming-meeting-meta-item">${typeIcon} ${meeting.type.replace('-', ' ')}</span>` : ''}
                        ${meeting.duration ? `<span class="upcoming-meeting-meta-item"> ${meeting.duration}min</span>` : ''}
                        ${meetingStatus === 'just-finished' ? 
                            (hasNotes ? 
                                `<span class="upcoming-prep-status ready"> Notes added</span>` : 
                                `<span class="upcoming-prep-status none"> No notes yet</span>`
                            ) :
                            `<span class="upcoming-prep-status ${hasPrep ? 'ready' : 'none'}">${hasPrep ? ' Customer info' : ' No customer info'}</span>`
                        }
                    </div>
                </div>
                
                <div class="upcoming-meeting-actions">
                    ${primaryAction}
                    <button class="upcoming-action-btn" onclick="event.stopPropagation(); editUpcomingMeeting('${meeting.id}')" title="Edit">
                        <svg viewBox="0 0 24 24">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button class="upcoming-action-btn delete" onclick="event.stopPropagation(); deleteUpcomingMeeting('${meeting.id}')" title="Delete">
                        <svg viewBox="0 0 24 24">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    // Show the + Upcoming Meeting button in header when there are meetings
    const upcomingBtn = document.getElementById('upcomingHeaderBtn');
    if (upcomingBtn) {
        upcomingBtn.style.display = 'flex';
    }
    
    // Show the + Follow-Up button in header ONLY when there are meetings AND past meetings exist
    const followUpBtn = document.getElementById('upcomingFollowUpBtn');
    if (followUpBtn) {
        followUpBtn.style.display = relevantPastMeetings.length > 0 ? 'flex' : 'none';
    }
}

function editUpcomingMeeting(meetingId) {
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (meeting) {
        // Pass meeting's isPastMeeting flag (false for upcoming = notes not required)
        openInlineMeetingForm(meeting, meeting.isPastMeeting === true);
    }
}

function deleteUpcomingMeeting(meetingId) {
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (!meeting) return;
    
    showConfirm('', 'Delete Meeting?', `Delete "${meeting.title}"?`, () => {
        state.meetings = state.meetings.filter(m => m.id !== meetingId);
        
        // Remove meeting reference from tasks
        state.tasks.forEach(task => {
            if (task.meetingId === meetingId) {
                delete task.meetingId;
            }
        });
        
        saveData();
        renderUpcomingMeetings();
        updateStats();
        
        if (state.currentCustomer !== 'all') {
            showCustomerMeetingsSection(state.currentCustomer);
        }
        
        showToast(' Meeting deleted', 'success');
    });
}

function createPrepForUpcoming(customerId) {
    if (customerId) {
        openInlineCustomerInfoFormForCustomer(customerId);
    } else {
        openInlineCustomerInfoForm();
    }
}


function takeMeetingNotes(meetingId) {
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (!meeting) return;
    
    // Store that we're taking notes for this specific meeting
    sessionStorage.setItem('[REDACTED:AWS_ACCESS_KEY]g', meetingId);
    
    openInlineMeetingForm(meeting);
    
    // Auto-switch to Notes tab
    setTimeout(() => {
        const notesTab = document.querySelector('#inlineMeetingForm .modal-tab[data-tab="notes"]');
        if (notesTab) {
            notesTab.click();
        }
        
        // Focus the notes editor
        const notesEditor = document.getElementById('meetingNotesEditor');
        if (notesEditor) {
            notesEditor.focus();
        }
    }, 200);
}

function viewMeetingNotes(meetingId) {
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (!meeting) return;
    
    openInlineMeetingForm(meeting);
    
    // Auto-switch to Notes tab
    setTimeout(() => {
        const notesTab = document.querySelector('#inlineMeetingForm .modal-tab[data-tab="notes"]');
        if (notesTab) {
            notesTab.click();
        }
    }, 200);
}

function scrollToMeetingInHistory(meetingId, customerId) {
    // If not viewing this customer, switch to them first
    if (state.currentCustomer !== customerId) {
        selectCustomerFromOverview(customerId);
        
        // Wait for render then scroll
        setTimeout(() => scrollAndHighlightMeeting(meetingId), 500);
    } else {
        scrollAndHighlightMeeting(meetingId);
    }
}

function scrollAndHighlightMeeting(meetingId) {
    // Make sure meetings section is visible and expanded
    const meetingsSection = document.getElementById('customerMeetingsSection');
    if (meetingsSection) {
        meetingsSection.classList.remove('collapsed');
        meetingsSection.classList.add('active');
        
        // Find the meeting card
        setTimeout(() => {
            const meetingCard = document.querySelector(`[data-meeting-id="${meetingId}"]`);
            if (meetingCard) {
                // Scroll to it
                meetingCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Add highlight animation
                meetingCard.classList.add('meeting-highlight-flash');
                
                // Remove animation class after it completes
                setTimeout(() => {
                    meetingCard.classList.remove('meeting-highlight-flash');
                }, 3000);
            }
        }, 200);
    }
}

function openInlineMeetingFormForUpcoming() {
    // Hide upcoming meetings and participants sections
    hideUpcomingMeetings();
    hideCustomerParticipantsSection();
    
    // If viewing a specific customer, auto-fill with that customer
    if (state.currentCustomer !== 'all') {
        openInlineMeetingFormForCustomer(state.currentCustomer, false); // false = upcoming meeting
    } else {
        openInlineMeetingForm(null, false); // false = upcoming meeting
    }
}

function filterCustomerActivity(filter) {
    state.activityFilter = filter;
    
    // Update active button
    document.querySelectorAll('[data-activity-filter]').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-activity-filter="${filter}"]`).classList.add('active');
    
    // Hide custom date range if not custom
    if (filter !== 'custom') {
        document.getElementById('customDateRangeInputs').style.display = 'none';
    }
    
    renderCustomerActivity();
}

function updateActivityDateDisplay(type) {
    const picker = document.getElementById(`activity${type === 'start' ? 'Start' : 'End'}DatePicker`);
    const display = document.getElementById(`activity${type === 'start' ? 'Start' : 'End'}DateDisplay`);
    
    if (picker.value) {
        // Convert YYYY-MM-DD to DD/MM/YYYY
        const [year, month, day] = picker.value.split('-');
        display.value = `${day}/${month}/${year}`;
    }
}


function showCustomDateRange() {
    state.activityFilter = 'custom';
    
    // Update active button
    document.querySelectorAll('[data-activity-filter]').forEach(btn => btn.classList.remove('active'));
    document.querySelector('[data-activity-filter="custom"]').classList.add('active');
    
    // Show date inputs
    document.getElementById('customDateRangeInputs').style.display = 'block';
    
    // Set default dates if not set
    if (!state.activityCustomRange.start) {
        const today = new Date();
        const lastMonth = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        const formatDateYYYYMMDD = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const formatDateDDMMYYYY = (date) => {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        };
        
        // Set picker values (YYYY-MM-DD)
        document.getElementById('activityStartDatePicker').value = formatDateYYYYMMDD(lastMonth);
        document.getElementById('activityEndDatePicker').value = formatDateYYYYMMDD(today);
        
        // Set display values (DD/MM/YYYY)
        document.getElementById('activityStartDateDisplay').value = formatDateDDMMYYYY(lastMonth);
        document.getElementById('activityEndDateDisplay').value = formatDateDDMMYYYY(today);
    }
}

function applyCustomDateRange() {
    const startDate = document.getElementById('activityStartDatePicker').value;
    const endDate = document.getElementById('activityEndDatePicker').value;
    
    if (!startDate || !endDate) {
        showToast(' Select both dates', 'error');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        showToast(' Start date must be before end date', 'error');
        return;
    }
    
    state.activityCustomRange.start = startDate;
    state.activityCustomRange.end = endDate;
    
    renderCustomerActivity();
    showToast(' Custom range applied', 'success');
}

function renderCustomerActivity() {
    const container = document.getElementById('customerActivityGrid');
    const empty = document.getElementById('customerActivityEmpty');
    
    const now = new Date();
    
    // Apply date filter
    let filterStartDate = null;
    let filterEndDate = null;
    
    if (state.activityFilter === 'week') {
        filterStartDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        filterEndDate = now;
    } else if (state.activityFilter === 'month') {
        filterStartDate = new Date(now.getFullYear(), now.getMonth(), 1);
        filterEndDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
    } else if (state.activityFilter === 'custom') {
        if (state.activityCustomRange.start) {
            filterStartDate = new Date(state.activityCustomRange.start);
        }
        if (state.activityCustomRange.end) {
            filterEndDate = new Date(state.activityCustomRange.end);
            filterEndDate.setHours(23, 59, 59, 999);
        }
    }
    
    // Get ALL meetings with their customers
    const allMeetingsWithCustomers = [];
    
    state.customers.forEach(customer => {
        const meetings = state.meetings.filter(m => {
            if (m.customerId !== customer.id) return false;
            const meetingDate = new Date(m.date);
            
            // Filter by date range if applicable
            if (filterStartDate && meetingDate < filterStartDate) return false;
            if (filterEndDate && meetingDate > filterEndDate) return false;
            
            // Show if meeting is in the past OR if it's been marked as completed
            return meetingDate < now || m.markedCompleted;
        });
        
        meetings.forEach(meeting => {
            const meetingDate = new Date(meeting.date);
            const daysSince = Math.floor((now - meetingDate) / (1000 * 60 * 60 * 24));
            
            allMeetingsWithCustomers.push({
                customer,
                meeting,
                meetingDate,
                daysSince
            });
        });
    });
    
    // **NEW: Apply global search filter**
    let filteredMeetings = allMeetingsWithCustomers;
if (state.searchQuery) {
    filteredMeetings = allMeetingsWithCustomers.filter(data => {
        const matchesCustomer = data.customer.name.toLowerCase().includes(state.searchQuery);
        const matchesMeeting = data.meeting.title.toLowerCase().includes(state.searchQuery);
        const matchesIndustry = data.customer.industry && data.customer.industry.toLowerCase().includes(state.searchQuery);
        const matchesTags = data.meeting.tags && data.meeting.tags.some(tag => tag.toLowerCase().includes(state.searchQuery));
        const matchesActivityNote = data.meeting.activityNote && data.meeting.activityNote.toLowerCase().includes(state.searchQuery);
        
        // Search in meeting notes
        const notesText = data.meeting.notesHTML ? htmlToPlainText(data.meeting.notesHTML) : (data.meeting.notes || '');
        const matchesNotes = notesText.toLowerCase().includes(state.searchQuery);
        
        // Search in next steps
        const nextStepsText = data.meeting.nextStepsHTML ? htmlToPlainText(data.meeting.nextStepsHTML) : (data.meeting.nextSteps || '');
        const matchesNextSteps = nextStepsText.toLowerCase().includes(state.searchQuery);
        
        return matchesCustomer || matchesMeeting || matchesIndustry || matchesTags || matchesActivityNote || matchesNotes || matchesNextSteps;
    });
}

    // Sort by most recent first
    filteredMeetings.sort((a, b) => b.meetingDate - a.meetingDate);
    
    if (filteredMeetings.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        
        // Show different message if search is active
        if (state.searchQuery) {
            empty.innerHTML = `
                <div class="empty-state-icon"></div>
                <div>No results for "${escapeHtml(state.searchQuery)}"</div>
            `;
        } else {
            empty.innerHTML = `
                <div class="empty-state-icon"></div>
                <div>No customer meetings yet</div>
            `;
        }
        return;
    }
    
    empty.style.display = 'none';
    
    // Update section title with count
    const sectionTitle = document.querySelector('#customerActivitySection .section-title');
    if (sectionTitle) {
        const uniqueCustomers = [...new Set(filteredMeetings.map(x => x.customer.id))].length;
        sectionTitle.textContent = `Customer Activity (${filteredMeetings.length} meeting${filteredMeetings.length > 1 ? 's' : ''} from ${uniqueCustomers} customer${uniqueCustomers > 1 ? 's' : ''})`;
    }
    
    // Build header + rows
    let html = `
        <div class="activity-header-row">
            <div class="activity-header-cell"></div>
            <div class="activity-header-cell">Customer</div>
            <div class="activity-header-cell">Meeting</div>
            <div class="activity-header-cell">Note</div>
            <div class="activity-header-cell right">Date</div>
            <div class="activity-header-cell"></div>
        </div>
    `;
    
    html += filteredMeetings.map(data => {
        let statusClass = 'recent';
        let daysText = '';
        
        const meetingDate = data.meetingDate.toLocaleDateString('en-GB', { 
            day: 'numeric',
            month: 'short', 
            year: 'numeric' 
        });
        
        if (data.daysSince === 0) {
            daysText = `Today (${meetingDate})`;
        } else if (data.daysSince === 1) {
            daysText = `1 day ago (${meetingDate})`;
        } else if (data.daysSince < 0) {
            const daysUntil = Math.abs(data.daysSince);
            daysText = daysUntil === 1 ? `Tomorrow (${meetingDate})` : `In ${daysUntil} days (${meetingDate})`;
        } else {
            daysText = `${data.daysSince} days ago (${meetingDate})`;
        }
        
        if (data.daysSince > 30) {
            statusClass = 'overdue';
        } else if (data.daysSince > 14) {
            statusClass = 'warning';
        }
        
        const noteText = data.meeting.activityNote || '';
        return `
            <div class="activity-row ${statusClass}" onclick="scrollToMeetingInHistory('${data.meeting.id}', '${data.customer.id}')">
                <div class="activity-status-dot ${statusClass}"></div>
                <div class="activity-customer">${escapeHtml(data.customer.name)}</div>
                <div class="activity-meeting">${escapeHtml(data.meeting.title)}</div>
                <div class="activity-note-cell" onclick="event.stopPropagation()">
                    ${noteText ? `<span class="activity-note-text" onclick="editActivityNote('${data.meeting.id}')" title="${escapeHtml(noteText)}">${escapeHtml(noteText)}</span>` : `<textarea rows="1" class="activity-note-input" id="note-${data.meeting.id}" placeholder="+ note" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'" onkeypress="if(event.key==='Enter')saveActivityNote('${data.meeting.id}')" onblur="saveActivityNote('${data.meeting.id}')"></textarea>`}
                </div>
                <div class="activity-time ${statusClass}">${daysText}</div>
                <div class="activity-arrow"></div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}


function saveActivityNote(meetingId) {
    const input = document.getElementById(`note-${meetingId}`);
    if (!input) return;
    const note = input.value.trim();
    if (!note) { editActivityNote(meetingId); return; }
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (meeting) {
        meeting.activityNote = note;
        saveData();
        renderCustomerActivity();
        showToast(' Note saved', 'success');
    }
}

function editActivityNote(meetingId) {
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (!meeting) return;
    document.getElementById('noteEditMeetingId').value = meetingId;
    document.getElementById('noteEditText').value = meeting.activityNote || '';
    document.getElementById('noteEditModal').classList.add('active');
    document.getElementById('noteEditText').focus();
}

function closeNoteEditModal() {
    document.getElementById('noteEditModal').classList.remove('active');
}

function saveEditedNote() {
    const meetingId = document.getElementById('noteEditMeetingId').value;
    const note = document.getElementById('noteEditText').value.trim();
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (meeting) {
        meeting.activityNote = note;
        saveData();
        renderCustomerActivity();
        showToast(' Note updated', 'success');
    }
    closeNoteEditModal();
}

function toggleSectionFullscreen(sectionId, btnId) {
    const section = document.getElementById(sectionId);
    const btn = document.getElementById(btnId);
    section.classList.toggle('fullscreen');
    btn.innerHTML = section.classList.contains('fullscreen') ? ' Close' : ' Expand';
}




function selectCustomerFromOverview(customerId) {
    // Validate customer exists
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) {
        showToast(' Customer not found', 'error');
        return;
    }
    
    state.currentCustomer = customerId;
    state.currentMeetingTab = 'all'; 
    
    // Update sidebar active state
    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
    const customerFilter = document.querySelector(`.category-filter[data-customer="${customerId}"]`);
    if (customerFilter) customerFilter.classList.add('active');
    
    // Close any open forms
    closeInlineMeetingForm();
    closeInlineCustomerInfoForm();
    
    // Hide dashboard sections
    hideDashboardStats();
    hideCustomerActivity();
hideAllCustomersSection();
    document.getElementById('sharedMeetingsSection')?.classList.remove('active');
    
    // Show customer-specific sections
    showUpcomingMeetings();  
    showCustomerParticipantsSection(customerId);
    showCustomerCustomerInfosSection(customerId);
    showCustomerMeetingsSection(customerId);
    
    // Update header banner
    updateSectionTitle();
    updateCustomerBanner(customerId);
    
    // Ensure main content areas are visible
    document.querySelector('.tasks-section').style.display = 'block';
    document.getElementById('notesContainer').classList.remove('hidden');
    document.getElementById('mainContainer').classList.remove('form-mode');
    
    // Render content
    renderTasks();
    renderNotes();
    renderTimeline();
}

function showCustomerParticipantsSection(customerId) {
    const section = document.getElementById('customerParticipantsSection');
    const grid = document.getElementById('customerParticipantsGrid');
    const empty = document.getElementById('customerParticipantsEmpty');
    
    // Update section title with count - clear old badge first
    const sectionTitle = section.querySelector('.customer-section-title');
    if (sectionTitle) {
        const oldBadge = sectionTitle.querySelector('.section-count-badge');
        if (oldBadge) oldBadge.remove();
    }
    
    // Get customer
    const customer = state.customers.find(c => c.id === customerId);
    
    // Get all meetings for this customer
    const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
    
    // Collect all unique participants
    const participantsMap = new Map();
    
    // Add standalone contacts from customer
    if (customer && customer.participants) {
        customer.participants.forEach(participant => {
            const key = participant.email && participant.email.trim() 
                ? participant.email.toLowerCase().trim() 
                : participant.name.toLowerCase().trim();
            
            participantsMap.set(key, {
                ...participant,
                meetings: [],
                uniqueKey: key,
                isStandalone: true
            });
        });
    }
    
    // Add participants from meetings
    customerMeetings.forEach(meeting => {
        if (meeting.participants && meeting.participants.length > 0) {
            meeting.participants.forEach(participant => {
                // Create consistent key
                const key = participant.email && participant.email.trim() 
                    ? participant.email.toLowerCase().trim() 
                    : participant.name.toLowerCase().trim();
                
                if (!participantsMap.has(key)) {
                    participantsMap.set(key, {
                        ...participant,
                        meetings: [],
                        uniqueKey: key
                    });
                } else {
                    // Mark as no longer standalone if they're in a meeting
                    participantsMap.get(key).isStandalone = false;
                }
                
                participantsMap.get(key).meetings.push({
                    title: meeting.title,
                    date: meeting.date,
                    id: meeting.id
                });
            });
        }
    });
    
    const participants = Array.from(participantsMap.values());
    
if (participants.length === 0) {
    section.classList.add('empty');
    grid.innerHTML = '';
    empty.removeAttribute('style');  
    empty.className = 'empty-state-compact';
    empty.innerHTML = `
        <div style="display: flex; gap: 0.5rem; justify-content: center;">
            <button class="btn-schedule-meeting" onclick="openAddParticipantModal('${customerId}')" style="display: inline-flex;">
                <span>+</span>
                <span>Contact</span>
            </button>
        </div>
    `;
        
        // Remove the button from header when empty
        const sectionHeader = section.querySelector('.customer-section-header');
        if (sectionHeader) {
            const existingBtn = sectionHeader.querySelector('.btn-add-participant');
            const existingWrapper = sectionHeader.querySelector('.section-header-right');
            if (existingBtn) existingBtn.remove();
            if (existingWrapper) existingWrapper.remove();
            
            // Keep just the toggle
            let toggle = sectionHeader.querySelector('.customer-section-toggle');
            if (!toggle) {
                toggle = document.createElement('div');
                toggle.className = 'customer-section-toggle';
                toggle.textContent = '';
                sectionHeader.appendChild(toggle);
            }
        }
   } else {
    section.classList.remove('empty');
    empty.style.display = 'none'; 
  // Build header + rows
let html = `
    <div class="participant-header-row">
        <div class="participant-header-cell">Name</div>
        <div class="participant-header-cell">Title</div>
        <div class="participant-header-cell">Email</div>
        <div class="participant-header-cell">Phone</div>
        <div class="participant-header-cell"></div>
    </div>
`;

html += participants.map(participant => {
    const participantKey = participant.uniqueKey;
    
    return `
        <div class="participant-overview-card" onclick="editParticipantFromOverview('${escapeHtml(participantKey)}', '${customerId}')">
            <div class="participant-overview-name-single">${escapeHtml(participant.name)}</div>
            <div class="participant-overview-role-single">${participant.role ? escapeHtml(participant.role) : '-'}</div>
            <div class="participant-overview-email-single">${participant.email ? escapeHtml(participant.email) : '-'}</div>
            <div class="participant-overview-phone-single">${participant.phone ? escapeHtml(participant.phone) : '-'}</div>
            <div class="participant-overview-actions-single">
                <button class="participant-action-btn" onclick="event.stopPropagation(); editParticipantFromOverview('${escapeHtml(participantKey)}', '${customerId}')" title="Edit">
                    <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 2;">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="participant-action-btn delete" onclick="event.stopPropagation(); deleteParticipantFromOverview('${escapeHtml(participantKey)}', '${customerId}')" title="Delete">
                    <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2;">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
    `;
}).join('');

grid.innerHTML = html;
        
    // Add buttons to section header - ONLY when there are participants
const sectionHeader = section.querySelector('.customer-section-header');
if (sectionHeader) {
    // Find and preserve the existing toggle BEFORE removing anything
    let toggle = sectionHeader.querySelector('.customer-section-toggle');
    
    // Remove ALL existing buttons and wrapper completely
    const existingWrapper = sectionHeader.querySelector('.section-header-right');
    if (existingWrapper) {
        existingWrapper.remove();
    }
    // Also remove any stray buttons that might exist
    const strayBtns = sectionHeader.querySelectorAll('.btn-add-meeting, .btn-add-participant');
    strayBtns.forEach(btn => btn.remove());
    
    // If toggle was removed with wrapper, recreate it
    toggle = sectionHeader.querySelector('.customer-section-toggle');
    if (!toggle) {
        toggle = document.createElement('div');
        toggle.className = 'customer-section-toggle';
        toggle.textContent = '';
    }
    
    // ONLY add button if there are participants (not in empty state)
    if (participants.length > 0) {
        // Create wrapper for button and toggle
        const rightWrapper = document.createElement('div');
        rightWrapper.className = 'section-header-right';
        rightWrapper.style.display = 'flex';
        rightWrapper.style.alignItems = 'center';
        rightWrapper.style.gap = '0.5rem';
        
        // Create add contact button
        const addBtn = document.createElement('button');
        addBtn.className = 'btn-add-participant';
        addBtn.innerHTML = '+ Contact';
        addBtn.onclick = (e) => {
            e.stopPropagation();
            openAddParticipantModal(customerId);
        };
        
        rightWrapper.appendChild(addBtn);
        rightWrapper.appendChild(toggle);
        sectionHeader.appendChild(rightWrapper);
    } else {
        // No participants - just add toggle back
        if (!sectionHeader.querySelector('.customer-section-toggle')) {
            sectionHeader.appendChild(toggle);
        }
    }
}

        
        // Add count badge to title
        const sectionTitleFinal = section.querySelector('.customer-section-title');
        if (sectionTitleFinal) {
            const badge = document.createElement('span');
            badge.className = 'section-count-badge';
            badge.textContent = `(${participants.length})`;
            sectionTitleFinal.appendChild(badge);
        }
    }

    section.classList.add('active');
}

function hideCustomerParticipantsSection() {
    document.getElementById('customerParticipantsSection').classList.remove('active');
}

function updateSectionTitle() {
    const titleElement = document.getElementById('mainSectionTitle');
    const headerBanner = document.getElementById('customerHeaderBanner');
    
    if (state.currentCustomer !== 'all') {
        const customer = state.customers.find(c => c.id === state.currentCustomer);
        if (customer) {
            titleElement.textContent = 'Tasks';
            headerBanner.classList.add('active');
            updateCustomerBanner(state.currentCustomer);
        }
    } else {
        titleElement.textContent = 'Tasks';
        headerBanner.classList.remove('active');
    }
}

       function showCustomerCustomerInfosSection(customerId) {
    const section = document.getElementById('customerCustomerInfosSection');
    const container = document.getElementById('customerCustomerInfosList');
    const empty = document.getElementById('customerCustomerInfosEmpty');
    
    // Update section title with count - clear old badge first
    const sectionTitle = section.querySelector('.customer-section-title');
    if (sectionTitle) {
        const oldBadge = sectionTitle.querySelector('.section-count-badge');
        if (oldBadge) oldBadge.remove();
    }
    
    const customerCustomerInfos = state.CustomerInfos.filter(p => p.customerId === customerId);
    
if (customerCustomerInfos.length === 0) {
    section.classList.add('empty');
    container.innerHTML = '';
    empty.className = 'empty-state-compact';
    empty.removeAttribute('style');  
    empty.innerHTML = `
        <div style="display: flex; gap: 0.5rem; justify-content: center;">
            <button class="btn-schedule-meeting" onclick="openInlineCustomerInfoFormForCustomer('${customerId}')" style="display: inline-flex;">
                <span>+</span>
                <span>Info</span>
            </button>
        </div>
    `;
    } else {
    section.classList.remove('empty');
    empty.style.display = 'none';  
        container.innerHTML = customerCustomerInfos.map(prep => {
    // Build HTML content with styled labels
    let allContentHTML = '';
    
    if (prep.background) {
        allContentHTML += `<div style="font-weight: 700; color: #000000; margin-bottom: 0.5rem; margin-top: 0.5rem;"> BACKGROUND</div>`;
        allContentHTML += `<div style="margin-bottom: 1rem;">${escapeHtml(prep.background).replace(/\n/g, '<br>')}</div>`;
    }
    if (prep.discussionPoints) {
        allContentHTML += `<div style="font-weight: 700; color: #000000; margin-bottom: 0.5rem; margin-top: 0.5rem;"> DISCUSSION POINTS</div>`;
        allContentHTML += `<div style="margin-bottom: 1rem;">${escapeHtml(prep.discussionPoints).replace(/\n/g, '<br>')}</div>`;
    }
    if (prep.materials) {
        allContentHTML += `<div style="font-weight: 700; color: #000000; margin-bottom: 0.5rem; margin-top: 0.5rem;"> COMPETITIVE INTELLIGENCE</div>`;
        allContentHTML += `<div style="margin-bottom: 1rem;">${escapeHtml(prep.materials).replace(/\n/g, '<br>')}</div>`;
    }
    if (prep.outcomes) {
        allContentHTML += `<div style="font-weight: 700; color: #000000; margin-bottom: 0.5rem; margin-top: 0.5rem;"> EXPECTED OUTCOMES</div>`;
        allContentHTML += `<div style="margin-bottom: 1rem;">${escapeHtml(prep.outcomes).replace(/\n/g, '<br>')}</div>`;
    }
    
    // Count how many fields are populated (each adds a header + content block)
let populatedFieldCount = 0;
if (prep.background && prep.background.trim()) populatedFieldCount++;
if (prep.discussionPoints && prep.discussionPoints.trim()) populatedFieldCount++;
if (prep.materials && prep.materials.trim()) populatedFieldCount++;
if (prep.outcomes && prep.outcomes.trim()) populatedFieldCount++;

const plainTextLength = (prep.background || '').length + 
                        (prep.discussionPoints || '').length + 
                        (prep.materials || '').length + 
                        (prep.outcomes || '').length;

// Show "Show More" if:
// - More than 2 fields are populated (each field adds header + content visually)
// - OR total text length > 150 chars
const isLong = populatedFieldCount > 2 || plainTextLength > 150;
    
    return `
        <div class="customer-CustomerInfo-summary">
            <div class="meeting-summary-header">
                <div style="flex: 1;">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); font-weight: 600;">Customer Info</div>
                    <div class="meeting-summary-title"> ${new Date(prep.createdAt).toLocaleDateString()}</div>
                </div>
                <div class="task-actions">
                    <button class="task-btn" onclick="editCustomerInfoFromCustomer('${prep.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button class="task-btn" onclick="exportCustomerInfoFromList('${prep.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </button>
                    <button class="task-btn delete" onclick="deleteCustomerInfo('${prep.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="meeting-summary-notes">
                <div class="meeting-summary-notes-content" id="prep-all-${prep.id}">${allContentHTML}</div>
                ${isLong ? `
                    <button class="meeting-summary-notes-toggle" onclick="event.stopPropagation(); toggleCustomerInfoExpand('prep-all-${prep.id}', this)">
                        Show More 
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}).join('');
    }
    
    section.classList.add('active');
    
        // Add count badge to title
    const sectionTitleFinal = section.querySelector('.customer-section-title');
    if (sectionTitleFinal && customerCustomerInfos.length > 0) {
        const badge = document.createElement('span');
        badge.className = 'section-count-badge';
        badge.textContent = `(${customerCustomerInfos.length})`;
        sectionTitleFinal.appendChild(badge);
    }
}

        function hideCustomerCustomerInfosSection() {
            document.getElementById('customerCustomerInfosSection').classList.remove('active');
        }

        function toggleCustomerInfoExpand(elementId, buttonElement) {
    const content = document.getElementById(elementId);
    
    if (!content || !buttonElement) return;
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        buttonElement.textContent = 'Show More ';
    } else {
        content.classList.add('expanded');
        buttonElement.textContent = 'Show Less ';
    }
}

        function editCustomerInfoFromCustomer(CustomerInfoId) {
            const CustomerInfo = state.CustomerInfos.find(p => p.id === CustomerInfoId);
            if (CustomerInfo) openInlineCustomerInfoForm(CustomerInfo);
        }

      function showCustomerMeetingsSection(customerId) {
    const section = document.getElementById('customerMeetingsSection');
    const container = document.getElementById('customerMeetingsList');
    const empty = document.getElementById('customerMeetingsEmpty');

    // Hide shared meetings section in customer view
    document.getElementById('sharedMeetingsSection')?.classList.remove('active');
    
    // Initialize default tabs if needed
    if (!state.meetingTabs || state.meetingTabs.length === 0) {
        state.meetingTabs = [
            { id: 'all', name: 'All Meetings', icon: '', isDefault: true },
            { id: 'individual', name: 'Individual', icon: '', isDefault: true }
        ];
    }
    
    // Get all meetings for this customer - ONLY PAST OR COMPLETED MEETINGS
const now = new Date();
let customerMeetings = state.meetings.filter(m => {
    if (m.customerId !== customerId) return false;
    
    // Show if explicitly marked as past meeting
    if (m.isPastMeeting) return true;
    
    // Or if meeting has already ended
    const meetingDate = new Date(m.date);
    const meetingDuration = m.duration || 60;
    const meetingEndTime = new Date(meetingDate.getTime() + meetingDuration * 60000);
    
    return meetingEndTime < now;
});


// Filter by current tab
if (state.currentMeetingTab === 'individual') {
        // Individual meetings have no tab assigned
        customerMeetings = customerMeetings.filter(m => !m.tabId || m.tabId === 'individual');
    } else if (state.currentMeetingTab !== 'all') {
        // Filter by specific tab
        customerMeetings = customerMeetings.filter(m => m.tabId === state.currentMeetingTab);
    }
    
    if (customerMeetings.length === 0 && state.currentMeetingTab === 'all') {
    section.classList.add('empty');
    container.innerHTML = '';
    empty.removeAttribute('style'); 
    empty.className = 'empty-state-compact';
    empty.innerHTML = `
        <div class="empty-state-compact-icon"></div>
        <div>No meetings</div>
        <button class="btn-schedule-meeting" onclick="openInlineMeetingFormForCustomer('${customerId}')" style="margin: 0 auto; display: inline-flex;">
            <span>+</span>
            <span>Meeting</span>
        </button>
    `;
        
        // Clean up ALL buttons from header when empty
        const sectionHeader = section.querySelector('.customer-section-header');
        if (sectionHeader) {
            const existingWrapper = sectionHeader.querySelector('.section-header-right');
            if (existingWrapper) {
                existingWrapper.remove();
            }
            // Remove any stray buttons
            const strayBtns = sectionHeader.querySelectorAll('.btn-add-meeting');
            strayBtns.forEach(btn => btn.remove());
        }
    } else {
        empty.removeAttribute('style');
        empty.style.display = 'none';
        
        // Render tabs
const tabsHTML = `
    <div class="meeting-tabs-container">
        ${state.meetingTabs.map(tab => {
            const tabMeetings = tab.id === 'all' 
                ? state.meetings.filter(m => m.customerId === customerId)
                : tab.id === 'individual'
                ? state.meetings.filter(m => m.customerId === customerId && (!m.tabId || m.tabId === 'individual'))
                : state.meetings.filter(m => m.customerId === customerId && m.tabId === tab.id);
            
            return `
                <div class="meeting-tab ${state.currentMeetingTab === tab.id ? 'active' : ''}" 
                     data-tab-id="${tab.id}"
                     onclick="switchMeetingTab('${tab.id}')"
                     oncontextmenu="showTabContextMenu(event, '${tab.id}'); return false;"
                     ondragover="handleTabDragOver(event, '${tab.id}')"
                     ondragleave="handleTabDragLeave(event)"
                     ondrop="handleTabDrop(event, '${tab.id}')">
                    ${tab.icon ? `<span class="meeting-tab-icon">${tab.icon}</span>` : ''}
                    <span>${escapeHtml(tab.name)}</span>
                    <span class="meeting-tab-count">${tabMeetings.length}</span>
                    ${!tab.isDefault ? `
                        <div class="meeting-tab-edit" onclick="event.stopPropagation(); openCreateTabModal('${tab.id}', event)" title="Edit tab">
                            <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 2;">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </div>
                        <div class="meeting-tab-actions" onclick="event.stopPropagation(); deleteTabQuick('${tab.id}')" title="Delete tab"></div>
                    ` : ''}
                </div>
            `;
        }).join('')}
        <button class="btn-add-tab" onclick="openCreateTabModal(null, event)">
            <span>Create</span>
            <span>Thread</span>
        </button>
${customerMeetings.length >= 2 ? `
    <button class="btn-view-all-notes" onclick="openConsolidatedNotesModal('${customerId}')">
        
        <span>View all Notes</span>
    </button>
` : ''}
    </div>
    <div class="meetings-drop-zone" id="meetingsDropZone">
         Drop meeting here to move to "${state.meetingTabs.find(t => t.id === state.currentMeetingTab)?.name}"
    </div>
`;
        
        // Empty state for non-all tabs
        if (customerMeetings.length === 0) {
            container.innerHTML = tabsHTML + `
                <div class="meetings-empty-tab">
                    <div class="meetings-empty-tab-icon"></div>
                    <div>No meetings in "${state.meetingTabs.find(t => t.id === state.currentMeetingTab)?.name}" yet</div>
                    <div style="margin-top: 1rem; font-size: 0.85rem;">Drag meetings here or click + Meeting</div>
                </div>
            `;
        } else {
            // Create grid container
            container.innerHTML = tabsHTML + '<div class="meetings-overview-grid">' + 
                customerMeetings.map(meeting => {
                    const meetingDate = new Date(meeting.date);
                    const meddpiccScore = calculateMEDDPICCCompletion(meeting);
                    const notesText = (meeting.notesHTML ? htmlToPlainText(meeting.notesHTML) : meeting.notes || '').trim();
                    const hasNotes = notesText.trim().length > 0;
const typeIcons = {
    discovery: '',
    'follow-up': ''
};
const typeIcon = typeIcons[meeting.type] || (meeting.customTypeIcon || '');                    
                    return `
                        <div class="customer-meeting-summary" 
                             draggable="true"
                             data-meeting-id="${meeting.id}"
                             ondragstart="handleMeetingDragStart(event, '${meeting.id}')"
                             ondragend="handleMeetingDragEnd(event)">
                            <div class="meeting-summary-actions">


          
                                <button class="meeting-action-btn" onclick="event.stopPropagation(); editMeetingFromCustomer('${meeting.id}')" title="Edit">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="meeting-action-btn" onclick="event.stopPropagation(); exportMeetingFromList('${meeting.id}')" title="Export">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </button>
                                <button class="meeting-action-btn delete" onclick="event.stopPropagation(); deleteMeetingFromCustomer('${meeting.id}')" title="Delete">
                                    <svg viewBox="0 0 24 24">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>

                    <!-- ========== SHARING FEATURE - START ========== -->
                    <button class="meeting-action-btn share" onclick="event.stopPropagation(); openShareModal('${meeting.id}')" title="Share">
                        <svg viewBox="0 0 24 24">
                            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                            <polyline points="16 6 12 2 8 6"></polyline>
                            <line x1="12" y1="2" x2="12" y2="15"></line>
                        </svg>
                    </button>
                    <!-- ========== SHARING FEATURE - END ========== -->
                            </div>
                            
                            <div class="meeting-summary-title">
                                ${escapeHtml(meeting.title)}
                            </div>
                            
<div class="meeting-summary-date">
    ${getCalendarSVG(14)} ${meetingDate.toLocaleDateString()} ${meeting.duration ? ` ${meeting.duration}min` : ''} ${meeting.type ? ` ${typeIcon} ${meeting.type.replace('-', ' ')}` : ''}
</div>
                            
${hasNotes ? `
    <div class="meeting-summary-notes">
        <div class="meeting-summary-notes-content" id="meeting-notes-${meeting.id}">${escapeHtml(notesText)}</div>
        ${(notesText.length > 150 || notesText.split('\n').length > 3) ? `
            <button class="meeting-summary-notes-toggle" onclick="event.stopPropagation(); toggleMeetingNotesExpand('${meeting.id}', this)">
                Show More 
            </button>
        ` : ''}
    </div>
` : `
                                <div class="meeting-summary-notes">
                                    <div style="text-align: center; opacity: 0.7; font-style: italic;">
                                        No notes
                                    </div>
                                </div>
                            `}
                            
                            ${meeting.participants && meeting.participants.length > 0 ? `
                                <div class="meeting-summary-notes" style="padding: 0;">
                                    <button class="meeting-summary-notes-toggle" onclick="event.stopPropagation(); toggleMeetingParticipants('${meeting.id}', this)" style="width: 100%; margin: 0;" data-count="${meeting.participants.length}">
                                         Show Participants (${meeting.participants.length}) 
                                    </button>
                                    <div class="meeting-summary-notes-content" id="meeting-participants-${meeting.id}" style="padding: 0; max-height: 0; overflow: hidden;">
                                        ${meeting.participants.map(p => {
                                            const details = [];
                                            if (p.role) details.push(p.role);
                                            if (p.email) details.push(p.email);
                                            if (p.phone) details.push(p.phone);
                                            return `<div style="margin-bottom: 0.5rem;"><strong>${escapeHtml(p.name)}</strong>${details.length > 0 ? '<br>' + escapeHtml(details.join('  ')) : ''}</div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                        </div>
                    `;
                }).join('') + '</div>';
        }
        
        // Add buttons to section header - FIXED VERSION
const sectionHeader = section.querySelector('.customer-section-header');
if (sectionHeader) {
    // Find and preserve the existing toggle BEFORE removing anything
    let toggle = sectionHeader.querySelector('.customer-section-toggle');
    
    // Remove existing buttons and wrapper
    const existingBtn = sectionHeader.querySelector('.btn-add-meeting');
    const existingWrapper = sectionHeader.querySelector('.section-header-right');
    if (existingBtn) existingBtn.remove();
    if (existingWrapper) existingWrapper.remove();
    
    // If toggle was removed with wrapper, recreate it
    toggle = sectionHeader.querySelector('.customer-section-toggle');
    if (!toggle) {
        toggle = document.createElement('div');
        toggle.className = 'customer-section-toggle';
        toggle.textContent = '';
    }
    
    // Create wrapper for buttons and toggle
    const rightWrapper = document.createElement('div');
    rightWrapper.className = 'section-header-right';
    rightWrapper.style.display = 'flex';
    rightWrapper.style.alignItems = 'center';
    rightWrapper.style.gap = '0.5rem';
    
    // Create add meeting button
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-add-meeting';
    addBtn.innerHTML = '+ Meeting';
    addBtn.onclick = (e) => {
        e.stopPropagation();
        openInlineMeetingFormForCustomer(customerId);
    };
    
// Create follow-up button
const followUpBtn = document.createElement('button');
followUpBtn.className = 'btn-add-meeting';
followUpBtn.innerHTML = '+ Follow-Up';
followUpBtn.onclick = (e) => {
    e.stopPropagation();
    openFollowUpModal('past'); // Pass 'past' as parameter
};
    
    rightWrapper.appendChild(addBtn);
    rightWrapper.appendChild(followUpBtn);
    rightWrapper.appendChild(toggle);
    sectionHeader.appendChild(rightWrapper);
}
    }
    
    section.classList.add('active');
    
    // Add count badge to title (total meetings across all tabs)
    const allCustomerMeetings = state.meetings.filter(m => m.customerId === customerId);
    const sectionTitle = section.querySelector('.customer-section-title');
    if (sectionTitle) {
        const oldBadge = sectionTitle.querySelector('.section-count-badge');
        if (oldBadge) oldBadge.remove();
        
        if (allCustomerMeetings.length > 0) {
            const badge = document.createElement('span');
            badge.className = 'section-count-badge';
            badge.textContent = `(${allCustomerMeetings.length})`;
            sectionTitle.appendChild(badge);
        }
    }
}


        function hideCustomerMeetingsSection() {
            document.getElementById('customerMeetingsSection').classList.remove('active');
        }

        function toggleMeetingExpand(meetingId) {
            const content = document.getElementById(`meeting-content-${meetingId}`);
            const btn = event.currentTarget;
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.textContent = 'More';
            } else {
                content.classList.add('expanded');
                btn.textContent = 'Less';
            }
        }

        function editMeetingFromCustomer(meetingId) {
            const meeting = state.meetings.find(m => m.id === meetingId);
            if (meeting) openInlineMeetingForm(meeting);
        }

        function calculateMEDDPICCCompletion(meeting) {
            const fields = [
                meeting.meddpicc?.metrics,
                meeting.meddpicc?.economicBuyer,
                meeting.meddpicc?.decisionCriteria,
                meeting.meddpicc?.decisionProcess,
                meeting.meddpicc?.paperProcess,
                meeting.meddpicc?.pain,
                meeting.meddpicc?.champion,
                meeting.meddpicc?.competition
            ];
            const completed = fields.filter(field => field && field.trim()).length;
            return {
                completed,
                total: 8,
                percentage: Math.round((completed / 8) * 100)
            };
        }

        function setupColorPicker() {
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    state.selectedColor = option.dataset.color;
                    document.getElementById('taskColor').value = state.selectedColor;
                });
            });
        }

function setupCustomerCombobox() {
    const input = document.getElementById('meetingCustomerInput');
    const dropdown = document.getElementById('customerDropdown');
    input.addEventListener('focus', () => {
        updateCustomerDropdown(input.value);
        dropdown.classList.add('active');
    });
            input.addEventListener('input', () => {
                updateCustomerDropdown(input.value);
                dropdown.classList.add('active');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.customer-combobox')) {
                    dropdown.classList.remove('active');
                }
            });
        }

        function setupTaskCustomerCombobox() {
            const input = document.getElementById('taskCustomerInput');
            const dropdown = document.getElementById('taskCustomerDropdown');
input.addEventListener('focus', () => {
    updateTaskCustomerDropdown(input.value);
    dropdown.classList.add('active');
});
            input.addEventListener('input', () => {
                updateTaskCustomerDropdown(input.value);
                dropdown.classList.add('active');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#taskCustomerInput') && !e.target.closest('#taskCustomerDropdown')) {
                    dropdown.classList.remove('active');
                }
            });
        }

        function setupCustomerInfoCustomerCombobox() {
            const input = document.getElementById('CustomerInfoCustomerInput');
            const dropdown = document.getElementById('CustomerInfoCustomerDropdown');
input.addEventListener('focus', () => {
    updateCustomerInfoCustomerDropdown(input.value);
    dropdown.classList.add('active');
});
            input.addEventListener('input', () => {
                updateCustomerInfoCustomerDropdown(input.value);
                dropdown.classList.add('active');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#CustomerInfoCustomerInput') && !e.target.closest('#CustomerInfoCustomerDropdown')) {
                    dropdown.classList.remove('active');
                }
            });
        }

        function updateCustomerDropdown(searchTerm = '') {
            const dropdown = document.getElementById('customerDropdown');
            const filteredCustomers = state.customers.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));
            let html = '';
            if (searchTerm && !filteredCustomers.some(c => c.name.toLowerCase() === searchTerm.toLowerCase())) {
                html += `<div class="customer-dropdown-item new-customer" onclick="selectNewCustomer('${escapeHtml(searchTerm)}')"> Add "${escapeHtml(searchTerm)}"</div>`;
            }
            filteredCustomers.forEach(customer => {
                html += `
                    <div class="customer-dropdown-item" onclick="selectExistingCustomer('${customer.id}')">
                        <div class="customer-dropdown-item-name">${escapeHtml(customer.name)}</div>
                        ${customer.email ? `<div class="customer-dropdown-item-email">${escapeHtml(customer.email)}</div>` : ''}
                    </div>
                `;
            });
            if (filteredCustomers.length === 0 && !searchTerm) {
                html = '<div class="customer-dropdown-item" style="text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No customers</div>';
            }
            dropdown.innerHTML = html;
        }

        function updateTaskCustomerDropdown(searchTerm = '') {
            const dropdown = document.getElementById('taskCustomerDropdown');
            const filteredCustomers = state.customers.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));
            let html = '';
            if (searchTerm && !filteredCustomers.some(c => c.name.toLowerCase() === searchTerm.toLowerCase())) {
                html += `<div class="customer-dropdown-item new-customer" onclick="selectNewTaskCustomer('${escapeHtml(searchTerm)}')"> Add "${escapeHtml(searchTerm)}"</div>`;
            }
            filteredCustomers.forEach(customer => {
                html += `
                    <div class="customer-dropdown-item" onclick="selectExistingTaskCustomer('${customer.id}')">
                        <div class="customer-dropdown-item-name">${escapeHtml(customer.name)}</div>
                        ${customer.email ? `<div class="customer-dropdown-item-email">${escapeHtml(customer.email)}</div>` : ''}
                    </div>
                `;
            });
            if (filteredCustomers.length === 0 && !searchTerm) {
                html = '<div class="customer-dropdown-item" style="text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No customers</div>';
            }
            dropdown.innerHTML = html;
        }

        function updateCustomerInfoCustomerDropdown(searchTerm = '') {
            const dropdown = document.getElementById('CustomerInfoCustomerDropdown');
            const filteredCustomers = state.customers.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));
            let html = '';
            if (searchTerm && !filteredCustomers.some(c => c.name.toLowerCase() === searchTerm.toLowerCase())) {
                html += `<div class="customer-dropdown-item new-customer" onclick="selectNewCustomerInfoCustomer('${escapeHtml(searchTerm)}')"> Add "${escapeHtml(searchTerm)}"</div>`;
            }
            filteredCustomers.forEach(customer => {
                html += `
                    <div class="customer-dropdown-item" onclick="selectExistingCustomerInfoCustomer('${customer.id}')">
                        <div class="customer-dropdown-item-name">${escapeHtml(customer.name)}</div>
                        ${customer.email ? `<div class="customer-dropdown-item-email">${escapeHtml(customer.email)}</div>` : ''}
                    </div>
                `;
            });
            if (filteredCustomers.length === 0 && !searchTerm) {
                html = '<div class="customer-dropdown-item" style="text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No customers</div>';
            }
            dropdown.innerHTML = html;
        }

                function selectExistingCustomer(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('meetingCustomerInput').value = customer.name;
                state.selectedCustomerId = customerId;
                document.getElementById('customerDropdown').classList.remove('active');
                loadCustomerInfoForCustomer(customerId);
                loadCustomerContacts(customerId);
            }
        }

              function selectNewCustomer(customerName) {
    document.getElementById('meetingCustomerInput').value = customerName;
    state.selectedCustomerId = null;
    document.getElementById('customerDropdown').classList.remove('active');
    document.getElementById('CustomerInfoTab').style.display = 'flex';
    document.getElementById('CustomerInfoContent').innerHTML = `
        <div style="text-align: center; padding: 2rem 1rem;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></div>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.85rem;">No customer info yet. Save the meeting first to add prep.</p>
        </div>
    `;
    
    // Hide quick-add contacts for new customer
    const container = document.getElementById('quickAddContactsContainer');
    if (container) container.classList.remove('active');
}


        function loadCustomerContacts(customerId) {
            const container = document.getElementById('quickAddContactsContainer');
            const list = document.getElementById('quickAddContactsList');
            
            if (!customerId) {
                container.classList.remove('active');
                return;
            }
            
            const customer = state.customers.find(c => c.id === customerId);
            if (!customer) {
                container.classList.remove('active');
                return;
            }
            
            // Collect all unique contacts for this customer
            const contactsMap = new Map();
            
            // Add standalone contacts
            if (customer.participants) {
                customer.participants.forEach(p => {
                    const key = p.email && p.email.trim() 
                        ? p.email.toLowerCase().trim() 
                        : p.name.toLowerCase().trim();
                    if (!contactsMap.has(key)) {
                        contactsMap.set(key, p);
                    }
                });
            }
            
            // Add contacts from previous meetings
            const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
            customerMeetings.forEach(meeting => {
                if (meeting.participants) {
                    meeting.participants.forEach(p => {
                        const key = p.email && p.email.trim() 
                            ? p.email.toLowerCase().trim() 
                            : p.name.toLowerCase().trim();
                        if (!contactsMap.has(key)) {
                            contactsMap.set(key, p);
                        }
                    });
                }
            });
            
            const contacts = Array.from(contactsMap.values());
            
            if (contacts.length === 0) {
                container.classList.remove('active');
                return;
            }
            
            // Filter out contacts already added to this meeting
            const availableContacts = contacts.filter(contact => {
                const key = contact.email && contact.email.trim() 
                    ? contact.email.toLowerCase().trim() 
                    : contact.name.toLowerCase().trim();
                
                return !state.meetingParticipants.some(p => {
                    const pKey = p.email && p.email.trim() 
                        ? p.email.toLowerCase().trim() 
                        : p.name.toLowerCase().trim();
                    return pKey === key;
                });
            });
            
            if (availableContacts.length === 0) {
                container.classList.remove('active');
                return;
            }
            
            // Render contacts list
            list.innerHTML = availableContacts.map(contact => {
                const initials = contact.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                const details = [];
                if (contact.role) details.push(contact.role);
                if (contact.email) details.push(contact.email);
                if (contact.phone) details.push(contact.phone);
                
                const contactJson = JSON.stringify(contact).replace(/"/g, '&quot;');
                
                return `
                    <div class="quick-add-contact-item" onclick='quickAddParticipant(${contactJson})'>
                        <div class="quick-add-contact-avatar">${initials}</div>
                        <div class="quick-add-contact-info">
                            <div class="quick-add-contact-name">${escapeHtml(contact.name)}</div>
                            ${details.length > 0 ? `<div class="quick-add-contact-details">${escapeHtml(details.join('  '))}</div>` : ''}
                        </div>
                        <div class="quick-add-contact-icon"></div>
                    </div>
                `;
            }).join('');
            
            container.classList.add('active');
        }

        function quickAddParticipant(contactData) {
            // Check if already added
            const key = contactData.email && contactData.email.trim() 
                ? contactData.email.toLowerCase().trim() 
                : contactData.name.toLowerCase().trim();
            
            const alreadyAdded = state.meetingParticipants.some(p => {
                const pKey = p.email && p.email.trim() 
                    ? p.email.toLowerCase().trim() 
                    : p.name.toLowerCase().trim();
                return pKey === key;
            });
            
            if (alreadyAdded) {
                showToast(' Already added', 'error');
                return;
            }
            
            // Add participant
            state.meetingParticipants.push({
                name: contactData.name,
                role: contactData.role || '',
                email: contactData.email || '',
                phone: contactData.phone || ''
            });
            
            renderParticipantsList();
            
            // Refresh the quick-add list (to remove this contact)
            if (state.selectedCustomerId) {
                loadCustomerContacts(state.selectedCustomerId);
            }
            
            showToast(` ${contactData.name} added!`, 'success');
        }

        function selectExistingTaskCustomer(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('taskCustomerInput').value = customer.name;
                state.selectedTaskCustomerId = customerId;
                document.getElementById('taskCustomerDropdown').classList.remove('active');
            }
        }

        function selectNewTaskCustomer(customerName) {
            document.getElementById('taskCustomerInput').value = customerName;
            state.selectedTaskCustomerId = null;
            document.getElementById('taskCustomerDropdown').classList.remove('active');
        }

        function selectExistingCustomerInfoCustomer(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('CustomerInfoCustomerInput').value = customer.name;
                state.selectedCustomerInfoCustomerId = customerId;
                document.getElementById('CustomerInfoCustomerDropdown').classList.remove('active');
            }
        }

        function selectNewCustomerInfoCustomer(customerName) {
            document.getElementById('CustomerInfoCustomerInput').value = customerName;
            state.selectedCustomerInfoCustomerId = null;
            document.getElementById('CustomerInfoCustomerDropdown').classList.remove('active');
        }

       function loadCustomerInfoForCustomer(customerId) {
    const CustomerInfo = state.CustomerInfos.find(p => p.customerId === customerId);
    const CustomerInfoTab = document.getElementById('CustomerInfoTab');
    const CustomerInfoContent = document.getElementById('CustomerInfoContent');
    
    // Always show the tab when we have a customer
    CustomerInfoTab.style.display = 'flex';
    
    if (CustomerInfo) {
        CustomerInfoContent.innerHTML = `
            <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem; color: white; font-weight: 600; font-size: 0.8rem;">
                 Customer Info Available
            </div>
            <div style="margin-bottom: 0.75rem;">
                <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">BACKGROUND</div>
                <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px; white-space: pre-wrap; font-size: 0.8rem;">${escapeHtml(CustomerInfo.background || '')}</div>
            </div>
            ${CustomerInfo.discussionPoints ? `
                <div style="margin-bottom: 0.75rem;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">DISCUSSION POINTS</div>
                    <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px; white-space: pre-wrap; font-size: 0.8rem;">${escapeHtml(CustomerInfo.discussionPoints)}</div>
                </div>
            ` : ''}
            ${CustomerInfo.materials ? `
                <div style="margin-bottom: 0.75rem;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">COMPETITIVE INTELLIGENCE</div>
                    <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px; white-space: pre-wrap; font-size: 0.8rem;">${escapeHtml(CustomerInfo.materials)}</div>
                </div>
            ` : ''}
            ${CustomerInfo.outcomes ? `
                <div style="margin-bottom: 0.75rem;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">EXPECTED OUTCOMES</div>
                    <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px; white-space: pre-wrap; font-size: 0.8rem;">${escapeHtml(CustomerInfo.outcomes)}</div>
                </div>
            ` : ''}
            <button type="button" class="btn btn-secondary" onclick="editCustomerInfoFromMeeting('${CustomerInfo.id}')" style="width: 100%;"> Edit Customer Info</button>
        `;
    } else {
        // No CustomerInfo exists - show option to create one
        CustomerInfoContent.innerHTML = `
            <div style="text-align: center; padding: 2rem 1rem;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></div>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.85rem;">No customer info for this meeting yet</p>
                <button type="button" class="btn btn-primary" onclick="createCustomerInfoForMeeting('${customerId}')" style="width: 100%;">
                     Create Customer Info
                </button>
            </div>
        `;
    }
}

function createCustomerInfoForMeeting(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    // Save current meeting form data
    state.savedMeetingFormData = {
        meetingId: document.getElementById('meetingId').value, // **IMPORTANT: Save the meeting ID**
        customerId: customerId,
        customerName: customer.name,
        title: document.getElementById('meetingTitle').value,
        date: document.getElementById('meetingDate').value,
        type: document.getElementById('meetingType').value,
        duration: document.getElementById('meetingDuration').value,
        notesHTML: getEditorHTML('meetingNotesEditor'),
        nextStepsHTML: getEditorHTML('meetingNextStepsEditor'),
        participants: [...state.meetingParticipants],
        tasks: [...state.meetingTasks],
        markedCompleted: document.getElementById('meetingMarkCompleted').checked,
        meddpicc: {
            metrics: document.getElementById('meddpiccMetrics').value,
            economicBuyer: document.getElementById('meddpiccEconomicBuyer').value,
            decisionCriteria: document.getElementById('meddpiccDecisionCriteria').value,
            decisionProcess: document.getElementById('meddpiccDecisionProcess').value,
            paperProcess: document.getElementById('meddpiccPaperProcess').value,
            pain: document.getElementById('meddpiccPain').value,
            champion: document.getElementById('meddpiccChampion').value,
            competition: document.getElementById('meddpiccCompetition').value
        }
    };
    
    // Mark that we're coming from meeting form
    state.returningToMeetingForm = true;
    
    // Close meeting form and open CustomerInfo form for this customer
    closeInlineMeetingForm();
    openInlineCustomerInfoFormForCustomer(customerId);
    
    showToast(' Create customer info to prepare for the meeting', 'success');
}


function restoreMeetingForm() {
    const data = state.savedMeetingFormData;
    if (!data) return;
    
    // **FIX: Check if we were editing an existing meeting**
    const isEditingExisting = data.meetingId && data.meetingId.trim() !== '';
    
    if (isEditingExisting) {
        // **EDITING EXISTING MEETING - Just reopen it with the same ID**
        const existingMeeting = state.meetings.find(m => m.id === data.meetingId);
        
        if (existingMeeting) {
            // Update the meeting data with any changes made before creating CustomerInfo
            existingMeeting.title = data.title;
            existingMeeting.date = data.date;
            existingMeeting.type = data.type;
            existingMeeting.duration = data.duration;
            existingMeeting.notesHTML = data.notesHTML;
            existingMeeting.notes = htmlToPlainText(data.notesHTML);
            existingMeeting.nextStepsHTML = data.nextStepsHTML;
            existingMeeting.nextSteps = htmlToPlainText(data.nextStepsHTML);
            existingMeeting.followUpDate = data.followUpDate;
            existingMeeting.outcome = data.outcome;
            existingMeeting.participants = data.participants;
            existingMeeting.meddpicc = data.meddpicc;
            
            // Save the updates
            saveData();
            
            // Reopen the meeting form for editing
            openInlineMeetingForm(existingMeeting);
            
            // Switch to CustomerInfo tab
            setTimeout(() => {
                document.querySelectorAll('#inlineMeetingForm .modal-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('#inlineMeetingForm .tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('#inlineMeetingForm .modal-tab[data-tab="CustomerInfo"]').classList.add('active');
                document.querySelector('#inlineMeetingForm [data-tab-content="CustomerInfo"]').classList.add('active');
            }, 100);
            
            showToast(' Customer Info saved! Returning to meeting', 'success');
        } else {
            // Meeting not found, treat as new
            createNewMeetingFromSavedData(data);
        }
    } else {
        // **CREATING NEW MEETING**
        createNewMeetingFromSavedData(data);
    }
    
    // Clear the saved state
    state.returningToMeetingForm = false;
    state.savedMeetingFormData = null;
    
    window.scrollTo(0, 0);
}

// **NEW HELPER FUNCTION** - Extract the "create new meeting" logic
function createNewMeetingFromSavedData(data) {
    // Restore state
    state.selectedCustomerId = data.customerId;
    state.meetingParticipants = data.participants;
    state.meetingTasks = data.tasks;
    
    // Open the meeting form
    hideUpcomingMeetings();
    hideCustomerParticipantsSection();
    document.getElementById('inlineCustomerInfoForm').classList.remove('active');

    document.getElementById('customerCustomerInfosSection').classList.remove('active');
    document.getElementById('customerMeetingsSection').classList.remove('active');
    document.querySelector('.tasks-section').style.display = 'none';
    document.getElementById('notesContainer').classList.add('hidden');
    document.getElementById('mainContainer').classList.add('form-mode');
    
    // Set title
    const titleElement = document.getElementById('meetingFormTitle');
    if (titleElement) {
        titleElement.textContent = ' New Meeting';
    }
    
    // Restore form values
    document.getElementById('meetingForm').reset();
    document.getElementById('meetingId').value = ''; // **IMPORTANT: Empty ID = new meeting**
    document.getElementById('meetingCustomerInput').value = data.customerName;
    document.getElementById('meetingTitle').value = data.title;
    document.getElementById('meetingDate').value = data.date;
    document.getElementById('meetingType').value = data.type;
    document.getElementById('meetingDuration').value = data.duration;
    document.getElementById('meetingMarkCompleted').checked = data.markedCompleted || false;
    
    // Restore editors
    setEditorHTML('meetingNotesEditor', data.notesHTML);
    setEditorHTML('meetingNextStepsEditor', data.nextStepsHTML);
    
    // Restore MEDDPICC
    document.getElementById('meddpiccMetrics').value = data.meddpicc.metrics;
    document.getElementById('meddpiccEconomicBuyer').value = data.meddpicc.economicBuyer;
    document.getElementById('meddpiccDecisionCriteria').value = data.meddpicc.decisionCriteria;
    document.getElementById('meddpiccDecisionProcess').value = data.meddpicc.decisionProcess;
    document.getElementById('meddpiccPaperProcess').value = data.meddpicc.paperProcess;
    document.getElementById('meddpiccPain').value = data.meddpicc.pain;
    document.getElementById('meddpiccChampion').value = data.meddpicc.champion;
    document.getElementById('meddpiccCompetition').value = data.meddpicc.competition;
    
    // Render participants and tasks
    renderParticipantsList();
    renderMeetingTasksList();
    
    // Load CustomerInfo (now it should exist!)
    loadCustomerInfoForCustomer(data.customerId);
    
    // Show the form
    document.getElementById('inlineMeetingForm').classList.add('active');
    
    // Switch to CustomerInfo tab
    document.querySelectorAll('#inlineMeetingForm .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#inlineMeetingForm .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#inlineMeetingForm .modal-tab[data-tab="CustomerInfo"]').classList.add('active');
    document.querySelector('#inlineMeetingForm [data-tab-content="CustomerInfo"]').classList.add('active');
    
    showToast(' Customer Info saved! Now showing in Prep tab', 'success');
}

        function editCustomerInfoFromMeeting(CustomerInfoId) {
            const CustomerInfo = state.CustomerInfos.find(p => p.id === CustomerInfoId);
            if (CustomerInfo) {
                closeInlineMeetingForm();
                openInlineCustomerInfoForm(CustomerInfo);
            }
        }

        function openTagsOverviewModal() {
            renderTagsOverview();
            document.getElementById('tagsOverviewModal').classList.add('active');
        }

        function closeTagsOverviewModal() {
            document.getElementById('tagsOverviewModal').classList.remove('active');
            state.selectedTag = null;
        }

        function renderTagsOverview() {
            const tagsMap = new Map();
            state.meetings.forEach(meeting => {
                if (meeting.tags && meeting.tags.length > 0) {
                    meeting.tags.forEach(tag => {
                        if (!tagsMap.has(tag)) {
                            tagsMap.set(tag, []);
                        }
                        tagsMap.get(tag).push({
                            meetingId: meeting.id,
                            customerId: meeting.customerId,
                            customerName: meeting.customerName,
                            meetingTitle: meeting.title,
                            meetingDate: meeting.date
                        });
                    });
                }
            });
            const tagsContainer = document.getElementById('tagsListContainer');
            const emptyState = document.getElementById('tagsEmpty');
            if (tagsMap.size === 0) {
                tagsContainer.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('selectedTagTitle').textContent = 'No tags';
                document.getElementById('customersByTagContainer').innerHTML = '';
                return;
            }
            emptyState.style.display = 'none';
            const sortedTags = Array.from(tagsMap.entries()).sort((a, b) => b[1].length - a[1].length);
            tagsContainer.innerHTML = sortedTags.map(([tag, meetings]) => `
                <div class="tag-item" onclick="selectTag('${escapeHtml(tag)}')">
                    <span class="tag-item-name"> ${escapeHtml(tag)}</span>
                    <span class="tag-item-count">${meetings.length}</span>
                </div>
            `).join('');
            if (!state.selectedTag && sortedTags.length > 0) {
                selectTag(sortedTags[0][0]);
            } else if (state.selectedTag) {
                selectTag(state.selectedTag);
            }
        }

        function selectTag(tag) {
            state.selectedTag = tag;
            document.querySelectorAll('.tag-item').forEach(item => item.classList.remove('active'));
            event.currentTarget?.classList.add('active');
            document.getElementById('selectedTagTitle').textContent = `Tag: ${tag}`;
            const meetingsWithTag = state.meetings.filter(m => m.tags && m.tags.includes(tag));
            const customerMeetings = new Map();
            meetingsWithTag.forEach(meeting => {
                if (meeting.customerId) {
                    if (!customerMeetings.has(meeting.customerId)) {
                        customerMeetings.set(meeting.customerId, {
                            customerName: meeting.customerName,
                            meetings: []
                        });
                    }
                    customerMeetings.get(meeting.customerId).meetings.push(meeting);
                }
            });
            const container = document.getElementById('customersByTagContainer');
            if (customerMeetings.size === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><div class="empty-state-icon"></div><div>No customers</div></div>';
                return;
            }
            container.innerHTML = Array.from(customerMeetings.entries()).map(([customerId, data]) => `
                <div class="customer-tag-card">
                    <div class="customer-tag-header">
                        <div class="customer-tag-name"> ${escapeHtml(data.customerName)}</div>
                        <div class="meetings-count-badge">${data.meetings.length}</div>
                    </div>
                    <div class="meetings-list-compact">
                        ${data.meetings.map(meeting => `
                            <div class="meeting-compact-item">
                                <strong>${escapeHtml(meeting.title)}</strong>
                                <div class="meeting-compact-date"> ${new Date(meeting.date).toLocaleDateString()}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function openCustomersModal() {
            renderCustomerList();
            document.getElementById('customersModal').classList.add('active');
        }

        function closeCustomersModal() {
            document.getElementById('customersModal').classList.remove('active');
        }

function openAddCustomerForm() {
    state.editingCustomer = null;
    document.getElementById('customerFormTitle').textContent = 'Add Customer';
    document.getElementById('customerForm').reset();
document.getElementById('customerId').value = '';
    document.getElementById('customerFormModal').classList.add('active');
}

       function openEditCustomerForm(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    state.editingCustomer = customer;
    document.getElementById('customerFormTitle').textContent = 'Edit Customer Profile';
    document.getElementById('customerId').value = customer.id;
    document.getElementById('customerName').value = customer.name;
    document.getElementById('customerEmail').value = customer.email || '';
    document.getElementById('customerPhone').value = customer.phone || '';
    document.getElementById('customerWebsite').value = customer.website || '';
    document.getElementById('customerAddress').value = customer.address || '';
    document.getElementById('customerCity').value = customer.city || '';
    document.getElementById('customerState').value = customer.state || '';
    document.getElementById('customerZip').value = customer.zip || '';
    document.getElementById('customerCountry').value = customer.country || '';
    document.getElementById('customerIndustry').value = customer.industry || '';
    document.getElementById('customerSize').value = customer.size || '';
    document.getElementById('customerLinkedIn').value = customer.linkedIn || '';
    document.getElementById('customerMapsLink').value = customer.mapsLink || '';
    document.getElementById('customerFormModal').classList.add('active');
}

        function closeCustomerFormModal() {
            document.getElementById('customerFormModal').classList.remove('active');
            state.editingCustomer = null;
        }

       function handleCustomerSubmit(e) {
    e.preventDefault();
    
    const existingId = document.getElementById('customerId').value;
    const isEditing = state.editingCustomer && existingId;
    
    const customer = {
        id: existingId || Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
        name: document.getElementById('customerName').value.trim(),
        email: document.getElementById('customerEmail').value.trim(),
        phone: document.getElementById('customerPhone').value.trim(),
        website: document.getElementById('customerWebsite').value.trim(),
        address: document.getElementById('customerAddress').value.trim(),
        city: document.getElementById('customerCity').value.trim(),
        state: document.getElementById('customerState').value.trim(),
        zip: document.getElementById('customerZip').value.trim(),
        country: document.getElementById('customerCountry').value.trim(),
        industry: document.getElementById('customerIndustry').value.trim(),
        size: document.getElementById('customerSize').value,
        linkedIn: document.getElementById('customerLinkedIn').value.trim(),
        mapsLink: document.getElementById('customerMapsLink').value.trim(),
        createdAt: state.editingCustomer?.createdAt || new Date().toISOString()
    };
    
    if (isEditing) {
        const index = state.customers.findIndex(c => c.id === customer.id);
        if (index !== -1) {
            const oldName = state.customers[index].name;
            customer.pinned = state.customers[index].pinned;
            customer.participants = state.customers[index].participants;
            state.customers[index] = customer;
            
            // Sync name change to all references
            if (oldName !== customer.name) {
                state.tasks.forEach(t => { if (t.customerId === customer.id) t.customerName = customer.name; });
                state.meetings.forEach(m => { if (m.customerId === customer.id) m.customerName = customer.name; });
                state.CustomerInfos.forEach(p => { if (p.customerId === customer.id) p.customerName = customer.name; });
            }
        }
        showToast(' Customer updated!', 'success');
    } else {
        // New customer - add to array
        state.customers.push(customer);
        showToast(' Customer added!', 'success');
    }
    
    saveData();
    renderCustomerList();
    renderCustomerFilters();
    
    // Update banner if viewing this customer
    if (state.currentCustomer === customer.id) {
        updateCustomerBanner(customer.id);
    }
    
    closeCustomerFormModal();
    
    // Navigate to new customer after creation (not when editing)
    if (!isEditing) {
        closeCustomersModal();
        // Small delay to ensure UI updates
        setTimeout(() => {
            selectCustomerFromOverview(customer.id);
        }, 100);
    }
}



        function deleteCustomer(customerId) {
            showConfirm('', 'Delete?', 'Delete customer?', () => {
                state.customers = state.customers.filter(c => c.id !== customerId);
                saveData();
                renderCustomerList();
                renderCustomerFilters();
                showToast('Deleted', 'success');
            });
        }

       function renderCustomerList() {
    const container = document.getElementById('customerList');
    const empty = document.getElementById('customersEmpty');
    if (state.customers.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    empty.style.display = 'none';
    container.innerHTML = state.customers.map(customer => `
        <div class="customer-item">
            <div class="customer-info">
                <div class="customer-name">${escapeHtml(customer.name)}</div>
                ${customer.email ? `<div class="customer-email">${escapeHtml(customer.email)}</div>` : ''}
            </div>
            <div class="customer-actions">
                <button class="task-btn" onclick="openEditCustomerForm('${customer.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="task-btn delete" onclick="deleteCustomer('${customer.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

function renderCustomerFilters() {
    const container = document.getElementById('customerFilters');
    const pinnedContainer = document.getElementById('pinnedCustomerFilters');
    const prioritySection = document.getElementById('priorityAccountsSection');
    
    const taskCounts = {};
    state.tasks.filter(t => !t.archived).forEach(task => {
        if (task.customerId) {
            taskCounts[task.customerId] = (taskCounts[task.customerId] || 0) + 1;
        }
    });
    
    // Get pinned customers only
    const pinnedCustomers = state.customers.filter(c => c.pinned);
    
    // Helper function to create customer button HTML
    const createCustomerButton = (customer, isPinned) => `
        <button class="category-filter ${isPinned ? 'pinned-customer' : ''}" data-customer="${customer.id}">
            <span class="pin-star ${isPinned ? 'pinned' : ''}" onclick="event.stopPropagation(); togglePinCustomer('${customer.id}', event)" title="${isPinned ? 'Unpin' : 'Pin to Priority'}">
                ${isPinned ? '' : ''}
            </span>
            <span class="category-filter-name">${escapeHtml(customer.name)}</span>
            <span class="customer-count">${taskCounts[customer.id] || 0}</span>
            <div class="customer-filter-actions">
                <div class="customer-filter-btn" onclick="event.stopPropagation(); openEditCustomerForm('${customer.id}')" title="Edit">
                    <svg viewBox="0 0 24 24">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </div>
                <div class="customer-filter-btn delete" onclick="event.stopPropagation(); deleteCustomerFromSidebar('${customer.id}')" title="Delete">
                    <svg viewBox="0 0 24 24">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </div>
            </div>
        </button>
    `;
    
    // Render pinned customers section
    if (pinnedCustomers.length > 0) {
        prioritySection.style.display = 'block';
        pinnedContainer.innerHTML = pinnedCustomers.map(customer => createCustomerButton(customer, true)).join('');
    } else {
        prioritySection.style.display = 'none';
        pinnedContainer.innerHTML = '';
    }
    
    // Clear the regular container (kept hidden for compatibility)
    container.innerHTML = '';

    // Add click listeners to pinned customer buttons only
    const pinnedButtons = pinnedContainer.querySelectorAll('.category-filter[data-customer]');

    pinnedButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const customerId = this.dataset.customer;
            
            // Close any open forms
            closeInlineMeetingForm();
            closeInlineCustomerInfoForm();
            
            // Update UI
            document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update state
            state.currentCustomer = customerId;
            state.currentMeetingTab = 'all';
            
            // Hide dashboard sections
            hideDashboardStats();
            hideCustomerActivity();
            hideAllCustomersSection();
            
            // Hide shared meetings section
            document.getElementById('sharedMeetingsSection')?.classList.remove('active');
            
            // Show customer-specific sections
            showUpcomingMeetings();
            showCustomerParticipantsSection(customerId);
            showCustomerCustomerInfosSection(customerId);
            showCustomerMeetingsSection(customerId);
            updateSectionTitle();
            
            // Render content
            renderTasks();
            renderNotes();
            renderTimeline();
        });
    });
    
    // Refresh all customers list if visible
    if (document.getElementById('allCustomersSection').classList.contains('active')) {
        renderAllCustomersList();
    }
}


       function handleCustomerInfoSubmit(e) {
    e.preventDefault();
    
    // Clear previous errors
    document.querySelectorAll('.form-input, .form-textarea, .customer-combobox-input').forEach(el => {
        el.classList.remove('error');
    });
    document.querySelectorAll('.field-error-message').forEach(el => el.remove());
    document.querySelectorAll('.form-section').forEach(el => el.classList.remove('error'));
    
    // Validation checks
    const validations = [
        {
            field: 'CustomerInfoCustomerInput',
            value: document.getElementById('CustomerInfoCustomerInput').value.trim(),
            message: 'Please enter a customer name',
            tab: 'info'
        },
        {
            field: 'CustomerInfoBackground',
            value: document.getElementById('CustomerInfoBackground').value.trim(),
            message: 'Please enter background information',
            tab: 'info'
        }
    ];
    
    // Find first error
    for (let validation of validations) {
        if (!validation.value) {
            // Switch to the correct tab
            const tabs = document.querySelectorAll('#inlineCustomerInfoForm .modal-tab[data-form="CustomerInfo"]');
            const contents = document.querySelectorAll('#inlineCustomerInfoForm .tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            const targetTab = document.querySelector(`#inlineCustomerInfoForm .modal-tab[data-tab="${validation.tab}"][data-form="CustomerInfo"]`);
            const targetContent = document.querySelector(`#inlineCustomerInfoForm .tab-content[data-tab-content="${validation.tab}"]`);
            
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.click();
            }
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            state.currentCustomerInfoTab = validation.tab;
            
            setTimeout(() => {
                const field = document.getElementById(validation.field);
                if (field) {
                    field.classList.add('error');
                    
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'field-error-message';
                    errorMsg.innerHTML = ` ${validation.message}`;
                    
                    const parent = field.closest('.form-group') || field.closest('.form-section-content');
                    if (parent) {
                        parent.appendChild(errorMsg);
                        
                        const section = field.closest('.form-section');
                        if (section) {
                            section.classList.add('error');
                            section.classList.remove('collapsed');
                        }
                    }
                    
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => field.focus(), 300);
                }
            }, 200);
            
            showToast(` ${validation.message}`, 'error');
            return;
        }
    }
    
    // All validation passed, proceed with save
    const customerInput = document.getElementById('CustomerInfoCustomerInput').value.trim();
    const background = document.getElementById('CustomerInfoBackground').value.trim();
    
    let customerId = state.selectedCustomerInfoCustomerId;
    let customerName = customerInput;
    
    if (!customerId && customerInput) {
        const newCustomer = {
            id: Date.now().toString(),
            name: customerInput,
            email: '',
            phone: '',
            company: '',
            notes: '',
            createdAt: new Date().toISOString()
        };
        state.customers.push(newCustomer);
        customerId = newCustomer.id;
        customerName = newCustomer.name;
        showToast(' Customer created!', 'success');
    }
    
    const CustomerInfo = {
        id: document.getElementById('CustomerInfoId').value || `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        customerId: customerId,
        customerName: customerName,
        background: background,
        discussionPoints: document.getElementById('CustomerInfoDiscussionPoints').value.trim(),
        materials: document.getElementById('CustomerInfoMaterials').value.trim(),
        outcomes: document.getElementById('CustomerInfoOutcomes').value.trim(),
        createdAt: state.editingCustomerInfo?.createdAt || new Date().toISOString()
    };
    
    if (state.editingCustomerInfo) {
        const index = state.CustomerInfos.findIndex(p => p.id === CustomerInfo.id);
        state.CustomerInfos[index] = CustomerInfo;
        showToast(' Customer Info updated!', 'success');
    } else {
        const existingIndex = state.CustomerInfos.findIndex(p => p.customerId === customerId);
        if (existingIndex !== -1) {
            state.CustomerInfos[existingIndex] = CustomerInfo;
            showToast(' Customer Info updated!', 'success');
        } else {
            state.CustomerInfos.unshift(CustomerInfo);
            showToast(' Customer Info saved!', 'success');
        }
    }
    
        saveData();
    renderCustomerFilters();
    

    
    closeInlineCustomerInfoForm();
    
    // Check if we should return to meeting form
    if (state.returningToMeetingForm && state.savedMeetingFormData) {
        restoreMeetingForm();
    }
}

function handleMeetingSubmit(e) {
    e.preventDefault();
    
    // Clear previous errors
    document.querySelectorAll('.form-input, .form-textarea, .customer-combobox-input').forEach(el => {
        el.classList.remove('error');
    });
    document.querySelectorAll('.field-error-message').forEach(el => el.remove());
    document.querySelectorAll('.form-section').forEach(el => el.classList.remove('error'));
    
    // Get customer input
    const customerInput = document.getElementById('meetingCustomerInput').value.trim();
    
    // Define all validations
    const validations = [
        {
            field: 'meetingCustomerInput',
            value: customerInput,
            message: 'Please enter a customer name',
            tab: 'info',
            sectionIndex: 0
        },
        {
            field: 'meetingTitle',
            value: document.getElementById('meetingTitle').value.trim(),
            message: 'Please enter a meeting title',
            tab: 'info',
            sectionIndex: 1
        },
        {
            field: 'meetingDate',
            value: document.getElementById('meetingDate').value,
            message: 'Please select a date and time',
            tab: 'info',
            sectionIndex: 1
        },
        {
            field: 'meetingType',
            value: document.getElementById('meetingType').value,
            message: 'Please select a meeting type',
            tab: 'info',
            sectionIndex: 1
        }
    ];
    
    // **NEW: Only require notes for PAST meetings (not upcoming meetings)**
    if (state.meetingIsPastMeeting !== false) {
        validations.push({
            field: 'meetingNotesEditor',
            value: getEditorText('meetingNotesEditor'),
            message: 'Please enter meeting notes',
            tab: 'notes',
            sectionIndex: 0
        });
    }
    
    // Check for first validation error
    for (let validation of validations) {
        if (!validation.value) {
            console.log('Validation failed for:', validation.field); // DEBUG
            
            // Force switch to the correct tab
            const allTabs = document.querySelectorAll('#inlineMeetingForm .modal-tab[data-form="meeting"]');
            const allContents = document.querySelectorAll('#inlineMeetingForm .tab-content');
            
            // Remove active from all
            allTabs.forEach(t => t.classList.remove('active'));
            allContents.forEach(c => c.classList.remove('active'));
            
            // Activate the target tab
            const targetTab = document.querySelector(`#inlineMeetingForm .modal-tab[data-tab="${validation.tab}"][data-form="meeting"]`);
            const targetContent = document.querySelector(`#inlineMeetingForm .tab-content[data-tab-content="${validation.tab}"]`);
            
            if (targetTab && targetContent) {
                targetTab.classList.add('active');
                targetContent.classList.add('active');
                
                // **FIX: Update state to match the switched tab**
                state.currentMeetingTab = validation.tab;
                
                // Pulse animation on tab
                targetTab.style.animation = 'pulse 0.6s ease-in-out 3';
                setTimeout(() => {
                    targetTab.style.animation = '';
                }, 2000);
            }
            
            // Wait for tab to be visible, then highlight field
            setTimeout(() => {
                const field = document.getElementById(validation.field);
                if (field) {
                    // Add error styling
                    field.classList.add('error');
                    
                    // Find the parent container
                    const formGroup = field.closest('.form-group');
                    const formSection = field.closest('.form-section');
                    
                    // Expand section if collapsed
                    if (formSection && formSection.classList.contains('collapsed')) {
                        formSection.classList.remove('collapsed');
                    }
                    
                    // Add error message
                    if (formGroup && !formGroup.querySelector('.field-error-message')) {
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'field-error-message';
                        errorMsg.innerHTML = ` ${validation.message}`;
                        formGroup.appendChild(errorMsg);
                    }
                    
                    // Highlight section
                    if (formSection) {
                        formSection.classList.add('error');
                    }
                    
                    // Scroll to field
                    setTimeout(() => {
                        field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        field.focus();
                    }, 100);
                }
            }, 250);
            
            // Show error toast
            const tabName = validation.tab.charAt(0).toUpperCase() + validation.tab.slice(1);
            showToast(` Required field missing in ${tabName} tab!`, 'error');
            return; // Stop here - don't save
        }
    }
    
    // ========== FIX: Handle editing shared meeting preview ==========
    if (editingSharedMeetingId) {
        const sharedMeeting = state.sharedMeetings.find(sm => sm.id === editingSharedMeetingId);
        
        if (sharedMeeting) {
            // Update the shared meeting data with edited values
            const tagsInput = document.getElementById('meetingTags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
            
            sharedMeeting.meetingData = {
                ...sharedMeeting.meetingData,
                title: document.getElementById('meetingTitle').value.trim(),
                date: document.getElementById('meetingDate').value,
                type: document.getElementById('meetingType').value,
                customTypeIcon: document.getElementById('meetingForm').getAttribute('data-custom-type-icon'),
                duration: document.getElementById('meetingDuration').value,
                notesHTML: getEditorHTML('meetingNotesEditor'),
                notes: getEditorText('meetingNotesEditor'),
                nextStepsHTML: getEditorHTML('meetingNextStepsEditor'),
                nextSteps: getEditorText('meetingNextStepsEditor'),

                participants: [...state.meetingParticipants],
                tags: tags,
                meddpicc: {
                    metrics: document.getElementById('meddpiccMetrics').value.trim(),
                    economicBuyer: document.getElementById('meddpiccEconomicBuyer').value.trim(),
                    decisionCriteria: document.getElementById('meddpiccDecisionCriteria').value.trim(),
                    decisionProcess: document.getElementById('meddpiccDecisionProcess').value.trim(),
                    paperProcess: document.getElementById('meddpiccPaperProcess').value.trim(),
                    pain: document.getElementById('meddpiccPain').value.trim(),
                    champion: document.getElementById('meddpiccChampion').value.trim(),
                    competition: document.getElementById('meddpiccCompetition').value.trim()
                }
            };
            
            // Store edited tasks
            if (state.meetingTasks.length > 0) {
                sharedMeeting.meetingData.associatedTasks = state.meetingTasks.map(title => ({
                    title: title,
                    description: `From shared meeting: ${sharedMeeting.meetingData.title}`,
                    priority: 'medium',
                    status: 'todo',
                    completed: false
                }));
            }
            
            // Save changes
            saveSharingData();
            
            // Show success message
            showToast(' Changes saved! Now click "Accept & Add" to add to your meetings', 'success');
            
            // Close the form
            closeInlineMeetingForm();
            
            // Return to shared meetings view
            showSharedMeetings();
            
            // Don't continue with normal meeting save
            return;
        }
    }
    // ========== END OF FIX ==========
    
    // All validation passed, proceed with save
    const title = document.getElementById('meetingTitle').value.trim();
    const date = document.getElementById('meetingDate').value;
    const type = document.getElementById('meetingType').value;
    const notesHTML = getEditorHTML('meetingNotesEditor');
    const notesText = getEditorText('meetingNotesEditor');
    const nextStepsHTML = getEditorHTML('meetingNextStepsEditor');
    const nextStepsText = getEditorText('meetingNextStepsEditor');
    
    // Handle customer - find existing or create new
    let customerId = state.selectedCustomerId;
    let customerName = customerInput;
    
    if (!customerId) {
        // Try to find existing customer by name
        const existingCustomer = state.customers.find(c => 
            c.name.toLowerCase() === customerInput.toLowerCase()
        );
        
        if (existingCustomer) {
            // Use existing customer
            customerId = existingCustomer.id;
            customerName = existingCustomer.name;
        } else {
            // Create new customer
            const newCustomer = {
                id: Date.now().toString(),
                name: customerInput,
                email: '',
                phone: '',
                website: '',
                address: '',
                city: '',
                state: '',
                zip: '',
                country: '',
                industry: '',
                size: '',
                linkedIn: '',
                mapsLink: '',
                createdAt: new Date().toISOString()
            };
            state.customers.push(newCustomer);
            customerId = newCustomer.id;
            customerName = newCustomer.name;
            showToast(' Customer created!', 'success');
        }
    }
    
    const tagsInput = document.getElementById('meetingTags').value.trim();
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
    // Get custom type icon if it exists
    const customTypeIcon = document.getElementById('meetingForm').getAttribute('data-custom-type-icon');
    
    // Determine if this is a past meeting
    let finalIsPastMeeting;

    if (state.editingMeeting) {
        // Editing existing meeting - keep its type unless marked completed
        finalIsPastMeeting = state.editingMeeting.isPastMeeting ?? true;
    } else {
        // Creating new meeting - use the flag that was set when form opened
        // IMPORTANT: Use explicit boolean check since false is a valid value
        finalIsPastMeeting = (state.meetingIsPastMeeting === false) ? false : true;
    }

    // If user checked "Mark as completed", always convert to past meeting
    const markCompletedCheckbox = document.getElementById('meetingMarkCompleted');
    if (markCompletedCheckbox && markCompletedCheckbox.checked) {
        finalIsPastMeeting = true;
    }

    console.log('Creating meeting with isPastMeeting:', finalIsPastMeeting); // DEBUG

   const meeting = {
    id: state.editingMeeting?.id || document.getElementById('meetingId').value || `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
    customerId: customerId,
    customerName: customerName,
    date: date,
    type: type,
    customTypeIcon: customTypeIcon || null,
    duration: document.getElementById('meetingDuration').value,
    conferenceLink: document.getElementById('meetingConferenceLink').value.trim(),
    title: title,
    tags: tags,
    participants: state.meetingParticipants,
    notes: notesText,
    notesHTML: notesHTML,
    nextSteps: nextStepsText,
    nextStepsHTML: nextStepsHTML,
    isPastMeeting: finalIsPastMeeting,
    tabId: state.editingMeeting?.tabId || (state.editingMeetingOriginalTab && state.editingMeetingOriginalTab !== 'all' ? state.editingMeetingOriginalTab : 'individual'),
    activityNote: state.editingMeeting?.activityNote || '',
    meddpicc: {
            metrics: document.getElementById('meddpiccMetrics').value.trim(),
            economicBuyer: document.getElementById('meddpiccEconomicBuyer').value.trim(),
            decisionCriteria: document.getElementById('meddpiccDecisionCriteria').value.trim(),
            decisionProcess: document.getElementById('meddpiccDecisionProcess').value.trim(),
            paperProcess: document.getElementById('meddpiccPaperProcess').value.trim(),
            pain: document.getElementById('meddpiccPain').value.trim(),
            champion: document.getElementById('meddpiccChampion').value.trim(),
            competition: document.getElementById('meddpiccCompetition').value.trim()
        },
        createdAt: state.editingMeeting?.createdAt || new Date().toISOString()
    };

    // Sync participants to customer's contact list
    if (customerId && state.meetingParticipants.length > 0) {
        const customer = state.customers.find(c => c.id === customerId);
        if (customer) {
            // Initialize participants array if it doesn't exist
            if (!customer.participants) {
                customer.participants = [];
            }
            
            // Add each meeting participant to customer's contact list (avoid duplicates)
            state.meetingParticipants.forEach(participant => {
                const key = participant.email && participant.email.trim() 
                    ? participant.email.toLowerCase().trim() 
                    : participant.name.toLowerCase().trim();
                
                const alreadyExists = customer.participants.some(p => {
                    const pKey = p.email && p.email.trim() 
                        ? p.email.toLowerCase().trim() 
                        : p.name.toLowerCase().trim();
                    return pKey === key;
                });
                
                if (!alreadyExists) {
                    customer.participants.push({
                        name: participant.name,
                        role: participant.role || '',
                        email: participant.email || '',
                        phone: participant.phone || ''
                    });
                }
            });
        }
    }
    
    if (state.editingMeeting) {
        const index = state.meetings.findIndex(m => m.id === meeting.id);
        state.meetings[index] = meeting;
        showToast(' Meeting updated!', 'success');
    } else {
        state.meetings.unshift(meeting);
        showToast(' Meeting saved!', 'success');
    }
    
    // Create tasks from meeting tasks list
    state.meetingTasks.forEach(taskTitle => {
        const existingTask = state.tasks.find(t => t.meetingId === meeting.id && t.title === taskTitle);
        if (!existingTask) {
            const task = {
                id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                title: taskTitle,
                description: `From: ${meeting.title}`,
                priority: 'medium',
                status: 'todo',
                dueDate: '',
                tags: ['meeting'],
                color: 'none',
                subtasks: [],
                completed: false,
                archived: false,
                customerId: customerId,
                customerName: customerName,
                meetingId: meeting.id,
                createdAt: new Date().toISOString()
            };
            state.tasks.unshift(task);
        }
    });
    
    saveData();

    // Auto-switch to "All" if the new meeting is beyond current period
    if (document.getElementById('upcomingMeetingsSection').classList.contains('active')) {
        const meetingDate = new Date(meeting.date);
        const now = new Date();
        const daysUntilMeeting = Math.floor((meetingDate - now) / (1000 * 60 * 60 * 24));
        
        // If meeting is beyond current period filter, switch to "All"
        if (state.upcomingMeetingsPeriod !== 'all' && daysUntilMeeting > state.upcomingMeetingsPeriod) {
            state.upcomingMeetingsPeriod = 'all';
            document.querySelectorAll('.upcoming-filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.upcoming-filter-btn[data-period="all"]').classList.add('active');
        }
    }
    
    // Store current view state BEFORE any renders
    const wasInDashboard = state.currentCustomer === 'all';
    const wasEditingMeeting = !!state.editingMeeting;
    
    // Clear session storage flag
    sessionStorage.removeItem('takingNotesFor');
    
    // Close the form (this clears editing state)
    document.getElementById('inlineMeetingForm').classList.remove('active');
    document.querySelector('.tasks-section').style.display = 'block';
    document.getElementById('notesContainer').classList.remove('hidden');
    document.getElementById('mainContainer').classList.remove('form-mode');
    document.getElementById('meetingForm').reset();
    document.getElementById('meetingId').value = '';
    state.editingMeeting = null;
    state.meetingTasks = [];
    state.meetingParticipants = [];
    state.selectedCustomerId = null;
    state.editingMeetingOriginalTab = null;
    state.meetingIsPastMeeting = null;
    
    // NOW do the renders
    renderTasks();
    updateStats();
    renderCustomerFilters();
    
    // Refresh upcoming meetings if visible
    if (document.getElementById('upcomingMeetingsSection').classList.contains('active')) {
        renderUpcomingMeetings();
    }
    

    
// FINALLY, explicitly set the view
if (wasInDashboard && !wasEditingMeeting) {
    // Was creating new meeting from dashboard - STAY in dashboard
    state.currentCustomer = 'all';
    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
    
    // Force dashboard view
    hideDashboardStats();
    hideCustomerMeetingsSection();
    hideCustomerCustomerInfosSection();
    hideCustomerParticipantsSection();
    showUpcomingMeetings();
    showCustomerActivity();
    showAllCustomersSection();
    
    // Show tasks section
    document.querySelector('.tasks-section').style.display = 'block';
    document.getElementById('notesContainer').classList.remove('hidden');
    
    updateSectionTitle();
    renderTasks();
    renderNotes();
    
    showToast(' Meeting scheduled!', 'success');
} else if (!wasInDashboard && customerId) {
        // Return to customer view
        selectCustomerFromOverview(customerId);
        showToast(' Meeting scheduled!', 'success');
    } else {
        // Return to dashboard
        showDashboard();
        showToast(' Meeting saved!', 'success');
    }
}


        function generateCustomerInfoExport() {
    const customerName = document.getElementById('CustomerInfoCustomerInput').value.trim();
    const background = document.getElementById('CustomerInfoBackground').value.trim();
    const discussionPoints = document.getElementById('CustomerInfoDiscussionPoints').value.trim();
    const materials = document.getElementById('CustomerInfoMaterials').value.trim();
    const outcomes = document.getElementById('CustomerInfoOutcomes').value.trim();
    
    let exportText = `CUSTOMER INFO\n${'='.repeat(40)}\n\n`;
    exportText += `Customer: ${customerName}\n`;
    exportText += `Date: ${new Date().toLocaleString()}\n\n`;
    
    if (background) exportText += `BACKGROUND & CONTEXT\n${'-'.repeat(40)}\n${background}\n\n`;
    if (discussionPoints) exportText += `DISCUSSION POINTS\n${'-'.repeat(40)}\n${discussionPoints}\n\n`;
    if (materials) exportText += `COMPETITIVE INTELLIGENCE\n${'-'.repeat(40)}\n${materials}\n\n`;
    if (outcomes) exportText += `EXPECTED OUTCOMES\n${'-'.repeat(40)}\n${outcomes}\n\n`;
    
    return exportText;
}

        function updateCustomerInfoExportPreview() {
            const preview = document.getElementById('CustomerInfoExportPreview');
            preview.textContent = generateCustomerInfoExport();
        }

        function copyCustomerInfoToClipboard() {
            const exportText = generateCustomerInfoExport();
            navigator.clipboard.writeText(exportText).then(() => {
                showToast('Copied!', 'success');
            }).catch(() => {
                showToast('Failed', 'error');
            });
        }

        function downloadCustomerInfo() {
            const exportText = generateCustomerInfoExport();
            const customerName = document.getElementById('CustomerInfoCustomerInput').value.trim();
            const filename = `prep_${customerName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Downloaded!', 'success');
        }

        function exportCustomerInfoFromList(CustomerInfoId) {
            const CustomerInfo = state.CustomerInfos.find(p => p.id === CustomerInfoId);
            if (!CustomerInfo) return;
            let exportText = `CUSTOMERINFO\n${'='.repeat(40)}\n\n`;
            exportText += `Customer: ${CustomerInfo.customerName}\n`;
            exportText += `Date: ${new Date(CustomerInfo.createdAt).toLocaleString()}\n\n`;
            if (CustomerInfo.background) exportText += `BACKGROUND\n${'-'.repeat(40)}\n${CustomerInfo.background}\n\n`;
            if (CustomerInfo.discussionPoints) exportText += `DISCUSSION\n${'-'.repeat(40)}\n${CustomerInfo.discussionPoints}\n\n`;
            if (CustomerInfo.background) exportText += `BACKGROUND\n${'-'.repeat(40)}\n${CustomerInfo.background}\n\n`;
            if (CustomerInfo.materials) exportText += `MATERIALS\n${'-'.repeat(40)}\n${CustomerInfo.materials}\n\n`;
            if (CustomerInfo.outcomes) exportText += `OUTCOMES\n${'-'.repeat(40)}\n${CustomerInfo.outcomes}\n\n`;
            const filename = `prep_${CustomerInfo.customerName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            openExportModal(' Export', exportText, filename);
        }

function addParticipant() {
    const nameInput = document.getElementById('participantNameInput');
    const roleInput = document.getElementById('participantRoleInput');
    const emailInput = document.getElementById('participantEmailInput');
    const phoneInput = document.getElementById('participantPhoneInput');
    
    const name = nameInput.value.trim();
    const role = roleInput.value.trim();
    
    // Split by comma and clean up - support multiple emails
    const emailsRaw = emailInput.value
        .split(',')
        .map(e => e.trim())
        .filter(e => e); // Remove empty strings
    
    const phonesRaw = phoneInput.value
        .split(',')
        .map(p => p.trim())
        .filter(p => p);
    
    // Store as single string (first email) for backward compatibility, but keep all
    const email = emailsRaw.length > 0 ? emailsRaw[0] : '';
    const phone = phonesRaw.length > 0 ? phonesRaw[0] : '';
    
    if (!name) {
        showToast(' Enter participant name', 'error');
        return;
    }
    
    if (!Array.isArray(state.meetingParticipants)) {
        state.meetingParticipants = [];
    }
    
    // Check for duplicates using first email or name
    const key = email ? email.toLowerCase() : name.toLowerCase();
    const alreadyExists = state.meetingParticipants.some(p => {
        const pKey = p.email && p.email.trim() ? p.email.toLowerCase() : p.name.toLowerCase();
        return pKey === key;
    });
    
    if (alreadyExists && state.editingParticipantIndex === null) {
        showToast(' Participant already added', 'error');
        return;
    }
    
    const participant = { 
        name, 
        role, 
        email: email,           // Primary email (for backward compatibility)
        emails: emailsRaw,      // All emails as array
        phone: phone,           // Primary phone (for backward compatibility)
        phones: phonesRaw       // All phones as array
    };
    
    if (state.editingParticipantIndex !== null) {
        state.meetingParticipants[state.editingParticipantIndex] = participant;
        state.editingParticipantIndex = null;
        document.getElementById('addParticipantBtn').innerHTML = '+ Add Participant';
    } else {
        state.meetingParticipants.push(participant);
    }
    
    // Clear form
    nameInput.value = '';
    roleInput.value = '';
    emailInput.value = '';
    phoneInput.value = '';
    
    renderParticipantsList();
    
    if (state.selectedCustomerId) {
        loadCustomerContacts(state.selectedCustomerId);
    }
    
    const emailCount = emailsRaw.length;
    const phoneCount = phonesRaw.length;
    let message = ` ${name} added!`;
    if (emailCount > 1 || phoneCount > 1) {
        message += ` (${emailCount} email${emailCount !== 1 ? 's' : ''}, ${phoneCount} phone${phoneCount !== 1 ? 's' : ''})`;
    }
    showToast(message, 'success');
}

function editParticipant(index) {
    const participant = state.meetingParticipants[index];
    if (!participant) return;
    
    document.getElementById('participantNameInput').value = participant.name;
    document.getElementById('participantRoleInput').value = participant.role || '';
    document.getElementById('participantEmailInput').value = participant.email || '';
    document.getElementById('participantPhoneInput').value = participant.phone || '';
    
    state.editingParticipantIndex = index;
    document.getElementById('addParticipantBtn').innerHTML = ' Update Participant';
    
    // Scroll to the input area
    document.getElementById('participantNameInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
    document.getElementById('participantNameInput').focus();
}

     function renderParticipantsList() {
    const container = document.getElementById('participantsList');
    
    if (!container) {
        console.error('Participants list container not found');
        return;
    }
    
    if (!state.meetingParticipants || !Array.isArray(state.meetingParticipants)) {
        console.warn('meetingParticipants is not an array, initializing');
        state.meetingParticipants = [];
    }
    
    if (state.meetingParticipants.length === 0) {
        container.innerHTML = '<div style="padding: 0.75rem; text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No participants added</div>';
        
        if (state.selectedCustomerId) {
            loadCustomerContacts(state.selectedCustomerId);
        }
        return;
    }

    container.innerHTML = state.meetingParticipants.map((participant, index) => {
        const initials = participant.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        
        // Handle both array and single value for emails
        const emails = participant.emails && participant.emails.length > 0 
            ? participant.emails 
            : (participant.email ? [participant.email] : []);
        
        // Handle both array and single value for phones
        const phones = participant.phones && participant.phones.length > 0 
            ? participant.phones 
            : (participant.phone ? [participant.phone] : []);
        
        // Format emails display
        let emailDisplay = '';
        if (emails.length === 1) {
            emailDisplay = `<span> ${escapeHtml(emails[0])}</span>`;
        } else if (emails.length > 1) {
            emailDisplay = `<span title="${escapeHtml(emails.join(', '))}"> ${escapeHtml(emails[0])} <small style="opacity: 0.7;">+${emails.length - 1} more</small></span>`;
        }
        
        // Format phones display
        let phoneDisplay = '';
        if (phones.length === 1) {
            phoneDisplay = `<span> ${escapeHtml(phones[0])}</span>`;
        } else if (phones.length > 1) {
            phoneDisplay = `<span title="${escapeHtml(phones.join(', '))}"> ${escapeHtml(phones[0])} <small style="opacity: 0.7;">+${phones.length - 1} more</small></span>`;
        }
        
        return `
            <div class="participant-card">
                <div class="participant-avatar">${initials}</div>
                <div class="participant-details">
                    <div class="participant-card-name">${escapeHtml(participant.name)}</div>
                    <div class="participant-card-meta">
                        ${participant.role ? `<span> ${escapeHtml(participant.role)}</span>` : ''}
                        ${emailDisplay}
                        ${phoneDisplay}
                    </div>
                </div>
                <div class="task-actions">
                    <button type="button" class="task-btn" onclick="editParticipant(${index})" title="Edit">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button type="button" class="task-btn delete" onclick="removeParticipant(${index})" title="Delete">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    if (state.selectedCustomerId) {
        loadCustomerContacts(state.selectedCustomerId);
    }
}


        function addQuickTask() {
            const input = document.getElementById('quickTaskInput');
            const taskTitle = input.value.trim();
            if (!taskTitle) {
                showToast('Enter task', 'error');
                return;
            }
            state.meetingTasks.push(taskTitle);
            input.value = '';
            renderMeetingTasksList();
        }

        function removeMeetingTask(index) {
            state.meetingTasks.splice(index, 1);
            renderMeetingTasksList();
        }

        function renderMeetingTasksList() {
            const container = document.getElementById('meetingTasksList');
            if (state.meetingTasks.length === 0) {
                container.innerHTML = '<div style="padding: 0.75rem; text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No tasks</div>';
                return;
            }
            container.innerHTML = state.meetingTasks.map((task, index) => `
                <div class="meeting-task-preview">
                    <span> ${escapeHtml(task)}</span>
                    <button type="button" class="btn-remove-meeting-task" onclick="removeMeetingTask(${index})"></button>
                </div>
            `).join('');
        }

        
        function generateMeetingExport() {
            const customerName = document.getElementById('meetingCustomerInput').value.trim();
            const title = document.getElementById('meetingTitle').value.trim();
            const date = document.getElementById('meetingDate').value;
            const type = document.getElementById('meetingType').value;
            const duration = document.getElementById('meetingDuration').value;
            const notesHTML = getEditorHTML('meetingNotesEditor');
            const notes = htmlToPlainText(notesHTML);
            const nextStepsHTML = getEditorHTML('meetingNextStepsEditor');
            const nextSteps = htmlToPlainText(nextStepsHTML);
            const metrics = document.getElementById('meddpiccMetrics').value.trim();
            const economicBuyer = document.getElementById('meddpiccEconomicBuyer').value.trim();
            const decisionCriteria = document.getElementById('meddpiccDecisionCriteria').value.trim();
            const decisionProcess = document.getElementById('meddpiccDecisionProcess').value.trim();
            const paperProcess = document.getElementById('meddpiccPaperProcess').value.trim();
            const pain = document.getElementById('meddpiccPain').value.trim();
            const champion = document.getElementById('meddpiccChampion').value.trim();
            const competition = document.getElementById('meddpiccCompetition').value.trim();
            
            let exportText = `MEETING\n${'='.repeat(40)}\n\n`;
            exportText += `Customer: ${customerName}\n`;
            exportText += `Title: ${title}\n`;
            exportText += `Date: ${new Date(date).toLocaleString()}\n`;
            exportText += `Type: ${type}\n`;
            if (duration) exportText += `Duration: ${duration}min\n`;
            exportText += `\n`;
            
if (state.meetingParticipants.length > 0) {
    exportText += `PARTICIPANTS\n${'-'.repeat(40)}\n`;
    state.meetingParticipants.forEach(p => {
        exportText += ` ${p.name}`;
        if (p.role) exportText += `\n  Role: ${p.role}`;
        if (p.email) exportText += `\n  Email: ${p.email}`;
        if (p.phone) exportText += `\n  Phone: ${p.phone}`;
        exportText += `\n`;
    });
    exportText += `\n`;
}
            
            exportText += `NOTES\n${'-'.repeat(40)}\n${notes}\n\n`;
            
            if (nextSteps) {
                exportText += `NEXT STEPS\n${'-'.repeat(40)}\n${nextSteps}\n\n`;
            }
            
            const hasMeddpicc = metrics || economicBuyer || decisionCriteria || decisionProcess || paperProcess || pain || champion || competition;
            if (hasMeddpicc) {
                exportText += `MEDDPICC\n${'='.repeat(40)}\n\n`;
                if (metrics) exportText += ` METRICS\n${metrics}\n\n`;
                if (economicBuyer) exportText += ` BUYER\n${economicBuyer}\n\n`;
                if (decisionCriteria) exportText += ` CRITERIA\n${decisionCriteria}\n\n`;
                if (decisionProcess) exportText += ` PROCESS\n${decisionProcess}\n\n`;
                if (paperProcess) exportText += ` PAPER\n${paperProcess}\n\n`;
                if (pain) exportText += ` PAIN\n${pain}\n\n`;
                if (champion) exportText += ` CHAMPION\n${champion}\n\n`;
                if (competition) exportText += ` COMPETITION\n${competition}\n\n`;
            }
            
            if (state.meetingTasks.length > 0) {
                exportText += `ACTIONS\n${'-'.repeat(40)}\n`;
                state.meetingTasks.forEach((task, i) => {
                    exportText += `${i + 1}. ${task}\n`;
                });
                exportText += `\n`;
            }
            
            return exportText;
        }

        function updateMeetingExportPreview() {
            const preview = document.getElementById('meetingExportPreview');
            preview.textContent = generateMeetingExport();
        }

        function copyMeetingToClipboard() {
            const exportText = generateMeetingExport();
            navigator.clipboard.writeText(exportText).then(() => {
                showToast('Copied!', 'success');
            }).catch(() => {
                showToast('Failed', 'error');
            });
        }

        function downloadMeeting() {
            const exportText = generateMeetingExport();
            const customerName = document.getElementById('meetingCustomerInput').value.trim();
            const title = document.getElementById('meetingTitle').value.trim();
            const filename = `meeting_${customerName.replace(/\s+/g, '_')}_${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Downloaded!', 'success');
        }

        function exportMeetingFromList(meetingId) {
            const meeting = state.meetings.find(m => m.id === meetingId);
            if (!meeting) return;
            const notesText = meeting.notesHTML ? htmlToPlainText(meeting.notesHTML) : meeting.notes;
            const nextStepsText = meeting.nextStepsHTML ? htmlToPlainText(meeting.nextStepsHTML) : meeting.nextSteps;
            
            let exportText = `MEETING\n${'='.repeat(40)}\n\n`;
            exportText += `Customer: ${meeting.customerName || 'N/A'}\n`;
            exportText += `Title: ${meeting.title}\n`;
            exportText += `Date: ${new Date(meeting.date).toLocaleString()}\n`;
            exportText += `Type: ${meeting.type}\n`;
            if (meeting.duration) exportText += `Duration: ${meeting.duration}min\n`;
            exportText += `\n`;
            
if (meeting.participants && meeting.participants.length > 0) {
    exportText += `PARTICIPANTS\n${'-'.repeat(40)}\n`;
    meeting.participants.forEach(p => {
        exportText += ` ${p.name}`;
        if (p.role) exportText += `\n  Role: ${p.role}`;
        if (p.email) exportText += `\n  Email: ${p.email}`;
        if (p.phone) exportText += `\n  Phone: ${p.phone}`;
        exportText += `\n`;
    });
    exportText += `\n`;
}
            
            exportText += `NOTES\n${'-'.repeat(40)}\n${notesText}\n\n`;
            
            if (nextStepsText) {
                exportText += `NEXT STEPS\n${'-'.repeat(40)}\n${nextStepsText}\n\n`;
            }
            
            if (meeting.meddpicc) {
                const m = meeting.meddpicc;
                const hasMeddpicc = m.metrics || m.economicBuyer || m.decisionCriteria || m.decisionProcess || m.paperProcess || m.pain || m.champion || m.competition;
                if (hasMeddpicc) {
                    exportText += `MEDDPICC\n${'='.repeat(40)}\n\n`;
                    if (m.metrics) exportText += ` METRICS\n${m.metrics}\n\n`;
                    if (m.economicBuyer) exportText += ` BUYER\n${m.economicBuyer}\n\n`;
                    if (m.decisionCriteria) exportText += ` CRITERIA\n${m.decisionCriteria}\n\n`;
                    if (m.decisionProcess) exportText += ` PROCESS\n${m.decisionProcess}\n\n`;
                    if (m.paperProcess) exportText += ` PAPER\n${m.paperProcess}\n\n`;
                    if (m.pain) exportText += ` PAIN\n${m.pain}\n\n`;
                    if (m.champion) exportText += ` CHAMPION\n${m.champion}\n\n`;
                    if (m.competition) exportText += ` COMPETITION\n${m.competition}\n\n`;
                }
            }
            
            const meetingTasks = state.tasks.filter(t => t.meetingId === meeting.id);
            if (meetingTasks.length > 0) {
                exportText += `ACTIONS\n${'-'.repeat(40)}\n`;
                meetingTasks.forEach((task, i) => {
                    exportText += `${i + 1}. ${task.title}\n`;
                });
                exportText += `\n`;
            }
            
            const filename = `meeting_${meeting.customerName.replace(/\s+/g, '_')}_${meeting.title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            openExportModal(' Export', exportText, filename);
        }

        function openAllMeetingsModal() {
            renderAllMeetings();
            document.getElementById('allMeetingsModal').classList.add('active');
        }

        function closeAllMeetingsModal() {
            document.getElementById('allMeetingsModal').classList.remove('active');
        }

        function renderAllMeetings() {
            const container = document.getElementById('allMeetingsList');
            const empty = document.getElementById('meetingsEmpty');
            if (state.meetings.length === 0) {
                container.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';
            container.innerHTML = state.meetings.map(meeting => {
                const meetingTasks = state.tasks.filter(t => t.meetingId === meeting.id);
                const meetingDate = new Date(meeting.date);
                const meddpiccScore = calculateMEDDPICCCompletion(meeting);
                const notesText = meeting.notesHTML ? htmlToPlainText(meeting.notesHTML) : meeting.notes;
                return `
                    <div class="meeting-card">
                        <div class="meeting-header">
                            <div class="meeting-info">
                                <h3>${escapeHtml(meeting.title)}</h3>
                                <div class="meeting-date">
                                     ${meetingDate.toLocaleDateString()}
                                    ${meeting.customerName ? `   ${escapeHtml(meeting.customerName)}` : ''}
                                    ${meeting.type ? `   ${escapeHtml(meeting.type)}` : ''}
                                </div>
                            </div>
                            <div class="task-actions">
    <button class="task-btn" onclick="editMeeting('${meeting.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
    </button>
    <button class="task-btn" onclick="exportMeetingFromList('${meeting.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
    </button>
    <button class="task-btn delete" onclick="deleteMeeting('${meeting.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
    </button>
</div>
                        </div>
                        ${meddpiccScore.completed > 0 ? `
                            <div class="meddpicc-section">
                                <div class="meddpicc-section-title"> MEDDPICC (${meddpiccScore.completed}/8)</div>
                            </div>
                        ` : ''}
                        ${meeting.tags && meeting.tags.length > 0 ? `
                            <div style="margin-bottom: 0.5rem;">
                                ${meeting.tags.map(tag => `<span class="meeting-tag">${escapeHtml(tag)}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div class="meeting-notes">${escapeHtml(notesText)}</div>
                        ${meetingTasks.length > 0 ? `
                            <div class="meeting-tasks">
                                <div class="meeting-tasks-title"> Actions (${meetingTasks.length})</div>
                                ${meetingTasks.map(task => `
                                    <div class="meeting-task-item">${task.completed ? '' : ''} ${escapeHtml(task.title)}</div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function editMeeting(meetingId) {
            const meeting = state.meetings.find(m => m.id === meetingId);
            if (meeting) {
                openInlineMeetingForm(meeting);
                closeAllMeetingsModal();
            }
        }

        function deleteMeeting(meetingId) {
    showConfirm('', 'Delete?', 'Delete meeting?', () => {
        state.meetings = state.meetings.filter(m => m.id !== meetingId);
        state.tasks.forEach(task => {
            if (task.meetingId === meetingId) {
                delete task.meetingId;
            }
        });
        saveData();
        renderAllMeetings();
        renderTasks();
        updateStats();
        if (state.currentCustomer !== 'all') {
            showCustomerMeetingsSection(state.currentCustomer);
        }
        
        // ADD THIS: Refresh upcoming meetings if visible
        if (document.getElementById('upcomingMeetingsSection').classList.contains('active')) {
            renderUpcomingMeetings();
        }
        
        showToast('Deleted', 'success');
    });
}

       function openTaskModal(task = null) {
    state.editingTask = task;
    state.selectedColor = 'none';
    state.selectedTaskCustomerId = null;
    
    if (task) {
        document.getElementById('taskId').value = task.id;
        document.getElementById('taskTitle').value = task.title;
        document.getElementById('taskDescription').value = task.description || '';
        document.getElementById('taskCustomerInput').value = task.customerName || '';
        state.selectedTaskCustomerId = task.customerId || null;
        document.getElementById('taskPriority').value = task.priority;
        document.getElementById('taskStatus').value = task.status || 'todo';
        document.getElementById('taskDueDate').value = task.dueDate || '';
        document.getElementById('taskTags').value = task.tags.join(', ');
        document.getElementById('taskColor').value = task.color || 'none';
        document.getElementById('taskMeetingId').value = task.meetingId || '';
        state.selectedColor = task.color || 'none';
        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
        const colorOption = document.querySelector(`.color-option[data-color="${state.selectedColor}"]`);
        if (colorOption) colorOption.classList.add('selected');
        const subtasksForm = document.getElementById('subtasksForm');
        subtasksForm.innerHTML = '';
        task.subtasks.forEach(sub => {
            addSubtaskInput(sub.text, sub.completed);
        });
    } else {
        // Creating NEW task - reset everything first
        document.getElementById('taskForm').reset();
        document.getElementById('taskId').value = '';
        document.getElementById('taskCustomerInput').value = '';
        document.getElementById('taskColor').value = 'none'; 
        document.getElementById('subtasksForm').innerHTML = '';
        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
        document.querySelector('.color-option[data-color="none"]').classList.add('selected');
        
        // Reset the selected customer ID
        state.selectedTaskCustomerId = null;
        
        // DEBUG: Log current customer state
        console.log('Opening task modal - state.currentCustomer:', state.currentCustomer);
        
        // ONLY auto-fill customer if viewing a SPECIFIC customer (not dashboard)
        if (state.currentCustomer && state.currentCustomer !== 'all') {
            const currentCustomerId = state.currentCustomer; // Capture the value
            const customer = state.customers.find(c => c.id === currentCustomerId);
            
            console.log('Looking for customer with ID:', currentCustomerId);
            console.log('Found customer:', customer);
            
            if (customer) {
                document.getElementById('taskCustomerInput').value = customer.name;
                state.selectedTaskCustomerId = customer.id;
                console.log('Auto-filled customer:', customer.name);
            }
        }
        // When on dashboard (state.currentCustomer === 'all'), customer field stays empty
    }
    
    document.getElementById('taskModal').classList.add('active');
}


        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            state.editingTask = null;
            state.selectedTaskCustomerId = null;
        }

        function addSubtaskInput(text = '', completed = false) {
            const container = document.getElementById('subtasksForm');
            const div = document.createElement('div');
            div.className = 'subtask-input-group';
            div.innerHTML = `
                <input type="text" class="form-input subtask-input" value="${escapeHtml(text)}" placeholder="Subtask...">
                <button type="button" class="btn-remove-subtask" onclick="this.parentElement.remove()"></button>
            `;
            container.appendChild(div);
        }

        function handleTaskSubmit(e) {
            e.preventDefault();
            const subtaskInputs = document.querySelectorAll('.subtask-input');
            const subtasks = Array.from(subtaskInputs)
                .map(input => ({ text: input.value.trim(), completed: false }))
                .filter(sub => sub.text);
            const customerInputValue = document.getElementById('taskCustomerInput').value.trim();
            let customerId = state.selectedTaskCustomerId;
            let customerName = customerInputValue;
            if (!customerId && customerInputValue) {
                const existingCustomer = state.customers.find(c => c.name.toLowerCase() === customerInputValue.toLowerCase());
                if (existingCustomer) {
                    customerId = existingCustomer.id;
                    customerName = existingCustomer.name;
                } else {
                    const newCustomer = {
                        id: Date.now().toString(),
                        name: customerInputValue,
                        email: '',
                        phone: '',
                        company: '',
                        notes: '',
                        createdAt: new Date().toISOString()
                    };
                    state.customers.push(newCustomer);
                    customerId = newCustomer.id;
                    customerName = newCustomer.name;
                    showToast('Customer created!', 'success');
                }
            }
            const task = {
    id: document.getElementById('taskId').value || `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                customerId: customerId || null,
                customerName: customerName || '',
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                dueDate: document.getElementById('taskDueDate').value,
                tags: document.getElementById('taskTags').value.split(',').map(t => t.trim()).filter(t => t),
                color: document.getElementById('taskColor').value,
                subtasks: subtasks,
                completed: state.editingTask?.completed || false,
                archived: state.editingTask?.archived || false,
                meetingId: state.editingTask?.meetingId || null,
                createdAt: state.editingTask?.createdAt || new Date().toISOString()
            };
            if (state.editingTask) {
                const index = state.tasks.findIndex(t => t.id === task.id);
                state.tasks[index] = task;
                showToast('Updated!', 'success');
            } else {
                state.tasks.unshift(task);
                showToast('Created!', 'success');
            }
            saveData();
renderTasks();
updateStats();
renderCustomerFilters();
renderTimeline(); 

closeTaskModal();
        }

        function openNoteModal(note = null) {
            state.editingNote = note;
            if (note) {
                document.getElementById('noteId').value = note.id;
                document.getElementById('noteContent').value = note.content;
            } else {
                document.getElementById('noteForm').reset();
            }
            document.getElementById('noteModal').classList.add('active');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            state.editingNote = null;
        }

        function handleNoteSubmit(e) {
            e.preventDefault();
            const note = {
                id: document.getElementById('noteId').value || Date.now().toString(),
                content: document.getElementById('noteContent').value.trim(),
                createdAt: state.editingNote?.createdAt || new Date().toISOString()
            };
            if (state.editingNote) {
                const index = state.notes.findIndex(n => n.id === note.id);
                state.notes[index] = note;
                showToast('Updated!', 'success');
            } else {
                state.notes.unshift(note);
                showToast('Created!', 'success');
            }
            saveData();
            renderNotes();
            closeNoteModal();
        }

        let currentExportData = null;

        function openExportModal(title, content, filename) {
            currentExportData = { content, filename };
            document.getElementById('exportModalTitle').textContent = title;
            document.getElementById('exportModalPreview').textContent = content;
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
            currentExportData = null;
        }

        function copyFromExportModal() {
            if (currentExportData) {
                navigator.clipboard.writeText(currentExportData.content).then(() => {
                    showToast('Copied!', 'success');
                }).catch(() => {
                    showToast('Failed', 'error');
                });
            }
        }

        function downloadFromExportModal() {
            if (currentExportData) {
                const blob = new Blob([currentExportData.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentExportData.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Downloaded!', 'success');
            }
        }

        function showConfirm(icon, title, message, callback) {
    document.getElementById('confirmIcon').textContent = icon;
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    state.confirmCallback = callback;
    
    //  FIX: Reset cancel button visibility and confirm button styling
    const cancelBtn = document.getElementById('cancelConfirmBtn');
    cancelBtn.style.display = ''; // Reset to default (visible)
    
    const confirmBtn = document.getElementById('confirmBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    //  FIX: Reset confirm button to default danger styling
    newConfirmBtn.textContent = 'Confirm';
    newConfirmBtn.className = 'btn btn-danger';
    
    newConfirmBtn.addEventListener('click', () => {
        if (state.confirmCallback) {
            state.confirmCallback();
        }
        closeConfirmModal();
    });
    
    document.getElementById('confirmModal').classList.add('active');
}

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            state.confirmCallback = null;
        }

// Close follow-up modal when clicking outside
document.addEventListener('click', (e) => {
    const modal = document.getElementById('followUpModal');
    if (modal && e.target === modal) {
        closeFollowUpModal();
    }
});

             async function confirmClearAll() {
    // Clear local state
    state.tasks = [];
    state.notes = [];
    state.customers = [];
    state.meetings = [];
    state.CustomerInfos = [];
    state.sharedMeetings = [];
    state.myShares = [];
    state.meetingTabs = [
        { id: 'all', name: 'All Meetings', icon: '', isDefault: true },
        { id: 'individual', name: 'Individual', icon: '', isDefault: true }
    ];
    
    // Clear localStorage
    localStorage.clear();
    
    // If user is signed in, also clear from Firestore
    if (auth.currentUser) {
        try {
            const deletePromises = [];
            
            // Delete shared meetings where user is the sharer (shared BY me)
            const sharedByMe = await db.collection('sharedMeetings')
                .where('sharedBy', '==', auth.currentUser.uid)
                .get();
            
            sharedByMe.docs.forEach(doc => {
                deletePromises.push(doc.ref.delete());
            });
            
            // Delete shared meetings where user is the recipient (shared WITH me)
            const sharedWithMe = await db.collection('sharedMeetings')
                .where('sharedWithEmail', '==', auth.currentUser.email.toLowerCase())
                .get();
            
            sharedWithMe.docs.forEach(doc => {
                deletePromises.push(doc.ref.delete());
            });
            
            // Wait for all deletes to complete
            if (deletePromises.length > 0) {
                await Promise.all(deletePromises);
                console.log(` Deleted ${deletePromises.length} shared meeting(s) from Firestore`);
            }
            
            // Save cleared state to Firestore (clears user's main data document)
            await saveUserDataToFirestore();
            
        } catch (error) {
            console.error('Error clearing Firestore data:', error);
            showToast(' Some cloud data may not have been cleared', 'error');
        }
    }
    
    // Update UI
    render();
    updateStats();
    renderCustomerFilters();
    updateShareNotificationBadge();
    showDashboard();
    showToast(' All data cleared!', 'success');
}

        function toggleTaskComplete(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    task.status = 'done';
                } else if (task.status === 'done') {
                    task.status = 'todo';
                }
                saveData();
                renderTasks();
renderTimeline();
                updateStats();

            }
        }

        function toggleSubtask(taskId, subtaskIndex) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task && task.subtasks[subtaskIndex]) {
                task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
                saveData();
                renderTasks();
            }
        }

        function editTask(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) openTaskModal(task);
        }

        function deleteTask(id) {
            showConfirm('', 'Delete?', 'Delete task?', () => {
                state.tasks = state.tasks.filter(t => t.id !== id);
                saveData();
                renderTasks();
renderTimeline();
                updateStats();
                renderCustomerFilters();

                showToast('Deleted', 'success');
            });
        }

        function archiveTask(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.archived = !task.archived;
                saveData();
                renderTasks();
renderTimeline();
                renderCustomerFilters();

                showToast(task.archived ? 'Archived' : 'Unarchived', 'success');
            }
        }

        function changeTaskStatus(taskId, newStatus) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = newStatus;
                if (newStatus === 'done') {
                    task.completed = true;
                } else {
                    task.completed = false;
                }
                saveData();
                renderTasks();
                updateStats();
            }
        }

function cycleTaskStatus(taskId) {
    const task = state.tasks.find(t => t.id === taskId);
    if (!task) return;
    
    // Cycle through statuses: todo -> in-progress -> done -> todo
    const statusCycle = {
        'todo': 'in-progress',
        'in-progress': 'done',
        'done': 'todo'
    };
    
    const newStatus = statusCycle[task.status] || 'todo';
    task.status = newStatus;
    
    // Update completed flag to match status
    if (newStatus === 'done') {
        task.completed = true;
    } else {
        task.completed = false;
    }
    
    saveData();
    renderTasks();
    renderTimeline();
    updateStats();
    
    // Show feedback
    const statusLabels = {
        'todo': ' To Do',
        'in-progress': ' In Progress',
        'done': ' Done'
    };
    showToast(`Status: ${statusLabels[newStatus]}`, 'success');
}

        function showArchived() {
            state.currentView = 'archived';
            document.querySelectorAll('.view-btn[data-view="active"], .view-btn[data-view="archived"]').forEach(b => b.classList.remove('active'));
            document.querySelector('.view-btn[data-view="archived"]').classList.add('active');
            renderTasks();
        }

        function editNote(id) {
            const note = state.notes.find(n => n.id === id);
            if (note) openNoteModal(note);
        }

        function deleteNote(id) {
            showConfirm('', 'Delete?', 'Delete note?', () => {
                state.notes = state.notes.filter(n => n.id !== id);
                saveData();
                renderNotes();
                showToast('Deleted', 'success');
            });
        }

function render() {
    renderTasks();
    renderNotes();
    renderTimeline();
    

}

// Timeline Functions
function toggleSidebarCollapse() {
    const container = document.getElementById('notesContainer');
    const mainContainer = document.getElementById('mainContainer');
    
    container.classList.toggle('collapsed-right');
    mainContainer.classList.toggle('sidebar-collapsed');
    
    const btn = container.querySelector('.sidebar-collapse-btn');
    if (container.classList.contains('collapsed-right')) {
        btn.textContent = '';
        btn.title = 'Expand';
    } else {
        btn.textContent = '';
        btn.title = 'Collapse';
    }
}

function renderTimeline() {
    const section = document.getElementById('timelineSection');
    const container = document.getElementById('timelineList');
    const empty = document.getElementById('timelineEmpty');
    
    // Only show in customer view
    if (state.currentCustomer === 'all') {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    const customerId = state.currentCustomer;
    const customer = state.customers.find(c => c.id === customerId);
    
    // Collect all activities for this customer
    let activities = [];
    
    // Add customer creation
    if (customer && customer.createdAt) {
activities.push({
    type: 'customer',
    id: customer.id,
    icon: getBuildingSVG(14),
            title: 'Customer created',
            date: new Date(customer.createdAt),
            dotClass: 'customer',
            deletable: false // Don't allow deleting customer from timeline
        });
    }
    
    // Add meetings
    const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
    customerMeetings.forEach(meeting => {
        const meetingDate = new Date(meeting.date);
        const now = new Date();
        const isUpcoming = meetingDate > now && !meeting.isPastMeeting;
        
activities.push({
    type: 'meeting',
    id: meeting.id,
    icon: getCalendarSVG(14),
    title: meeting.title,
            date: meetingDate,
            dotClass: isUpcoming ? 'meeting-upcoming' : 'meeting',
            subtype: isUpcoming ? 'Upcoming' : 'Meeting',
            deletable: true
        });
    });
    
    // Add tasks
    const customerTasks = state.tasks.filter(t => t.customerId === customerId);
    customerTasks.forEach(task => {
        activities.push({
            type: 'task',
            id: task.id,
    icon: task.completed ? '' : getCheckboxSVG(14),
            title: task.title,
            date: new Date(task.createdAt),
            dotClass: task.completed ? 'task-done' : 'task-pending',
            subtype: task.completed ? 'Completed' : 'Task',
            deletable: true
        });
    });
    
    // Add CustomerInfos
    const customerPreps = state.CustomerInfos.filter(p => p.customerId === customerId);
    customerPreps.forEach(prep => {
        activities.push({
            type: 'prep',
            id: prep.id,
            icon: '',
            title: 'Customer info added',
            date: new Date(prep.createdAt),
            dotClass: 'prep',
            subtype: 'Prep',
            deletable: true
        });
    });
    
    // Add notes (if they have customer association - for now show all notes in customer view)
    // You can modify this logic based on your needs
    
    // Sort by date (newest first)
    activities.sort((a, b) => b.date - a.date);
    
    if (activities.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    
    // Group by date
    const grouped = groupActivitiesByDate(activities);
    
    let html = '';
    
    grouped.forEach(group => {
        html += `<div class="timeline-date-separator">${group.label}</div>`;
        
        group.items.forEach(activity => {
            const timeStr = activity.date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            
            const deleteBtn = activity.deletable ? `
                <div class="timeline-item-actions">
                    <button class="timeline-delete-btn" onclick="event.stopPropagation(); deleteTimelineItem('${activity.type}', '${activity.id}')" title="Delete">
                        <svg viewBox="0 0 24 24">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            ` : '';
            
            html += `
                <div class="timeline-item" style="position: relative;">
                    <div class="timeline-dot ${activity.dotClass}"></div>
                    <div class="timeline-item-header">
                        <span class="timeline-item-icon">${activity.icon}</span>
                        <span class="timeline-item-title">${escapeHtml(activity.title)}</span>
                    </div>
                    <div class="timeline-item-meta">
                        <span>${timeStr}</span>
                        ${activity.subtype ? `<span class="timeline-item-type">${activity.subtype}</span>` : ''}
                    </div>
                    ${deleteBtn}
                </div>
            `;
        });
    });
    
    container.innerHTML = html;
}

function deleteTimelineItem(type, id) {
    let itemName = '';
    let deleteCallback = null;
    
    switch (type) {
        case 'task':
            const task = state.tasks.find(t => t.id === id);
            if (!task) return;
            itemName = `task "${task.title}"`;
            deleteCallback = () => {
                state.tasks = state.tasks.filter(t => t.id !== id);
                saveData();
                renderTasks();
                renderTimeline();
                updateStats();
                renderCustomerFilters();
            };
            break;
            
        case 'meeting':
            const meeting = state.meetings.find(m => m.id === id);
            if (!meeting) return;
            itemName = `meeting "${meeting.title}"`;
            deleteCallback = () => {
                state.meetings = state.meetings.filter(m => m.id !== id);
                // Remove meeting reference from tasks
                state.tasks.forEach(task => {
                    if (task.meetingId === id) {
                        delete task.meetingId;
                    }
                });
                saveData();
                renderTimeline();
                updateStats();
                if (state.currentCustomer !== 'all') {
                    showCustomerMeetingsSection(state.currentCustomer);
                }
                if (document.getElementById('upcomingMeetingsSection').classList.contains('active')) {
                    renderUpcomingMeetings();
                }
            };
            break;
            
        case 'prep':
            const prep = state.CustomerInfos.find(p => p.id === id);
            if (!prep) return;
            itemName = 'customer info';
            deleteCallback = () => {
                state.CustomerInfos = state.CustomerInfos.filter(p => p.id !== id);
                saveData();
                renderTimeline();
                updateStats();
                if (state.currentCustomer !== 'all') {
                    showCustomerCustomerInfosSection(state.currentCustomer);
                }
            };
            break;
            
        case 'note':
            const note = state.notes.find(n => n.id === id);
            if (!note) return;
            itemName = 'note';
            deleteCallback = () => {
                state.notes = state.notes.filter(n => n.id !== id);
                saveData();
                renderTimeline();
                renderNotes();
            };
            break;
            
        default:
            return;
    }
    
    showConfirm('', 'Delete?', `Delete this ${itemName}?`, () => {
        deleteCallback();
        showToast(' Deleted', 'success');
    });
}

function groupActivitiesByDate(activities) {
    const groups = [];
    const now = new Date();
    const today = now.toDateString();
    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000).toDateString();
    
    let currentGroup = null;
    
    activities.forEach(activity => {
        const activityDateStr = activity.date.toDateString();
        let label;
        
        if (activityDateStr === today) {
            label = 'Today';
        } else if (activityDateStr === yesterday) {
            label = 'Yesterday';
        } else {
            // Check if it's this week
            const daysAgo = Math.floor((now - activity.date) / (1000 * 60 * 60 * 24));
            if (daysAgo < 7) {
                label = activity.date.toLocaleDateString('en-US', { weekday: 'long' });
            } else {
                label = activity.date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: activity.date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
                });
            }
        }
        
        if (!currentGroup || currentGroup.label !== label) {
            currentGroup = { label, items: [] };
            groups.push(currentGroup);
        }
        
        currentGroup.items.push(activity);
    });
    
    return groups;
}

        function renderTasks() {
            if (state.currentDisplayMode === 'kanban') {
                renderKanban();
            } else {
                renderList();
            }
        }

function renderList() {
    let tasks = state.tasks.filter(t => t.archived === (state.currentView === 'archived'));
    
    // Filter by customer
    if (state.currentCustomer !== 'all') {
        // Only show tasks that have this specific customer assigned
        tasks = tasks.filter(t => t.customerId && t.customerId === state.currentCustomer);
    }
    
    // Filter by search query
    if (state.searchQuery) {
        tasks = tasks.filter(t => {
            const matchesTitle = t.title.toLowerCase().includes(state.searchQuery);
            const matchesDescription = t.description.toLowerCase().includes(state.searchQuery);
            const matchesCustomerName = t.customerName && t.customerName.toLowerCase().includes(state.searchQuery);
            const matchesTags = t.tags.some(tag => tag.toLowerCase().includes(state.searchQuery));
            
            // Search company name
            let matchesCompany = false;
            if (t.customerId) {
                const customer = state.customers.find(c => c.id === t.customerId);
                if (customer && customer.company) {
                    matchesCompany = customer.company.toLowerCase().includes(state.searchQuery);
                }
            }
            
            // Search meeting participant names and roles
            let matchesParticipant = false;
            if (t.meetingId) {
                const meeting = state.meetings.find(m => m.id === t.meetingId);
                if (meeting && meeting.participants) {
                    matchesParticipant = meeting.participants.some(p => 
                        (p.role && p.role.toLowerCase().includes(state.searchQuery)) ||
                        (p.name && p.name.toLowerCase().includes(state.searchQuery))
                    );
                }
            }
            
            return matchesTitle || matchesDescription || matchesCustomerName || 
                   matchesTags || matchesCompany || matchesParticipant;
        });
    }
    
    // Filter by time/priority
    const today = new Date().toISOString().split('T')[0];
    const weekFromNow = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    switch (state.currentFilter) {
        case 'today':
            tasks = tasks.filter(t => t.dueDate === today);
            break;
        case 'week':
            tasks = tasks.filter(t => t.dueDate && t.dueDate <= weekFromNow);
            break;
        case 'overdue':
            tasks = tasks.filter(t => t.dueDate && t.dueDate < today && !t.completed);
            break;
        case 'high':
            tasks = tasks.filter(t => t.priority === 'high');
            break;
    }
    
// Sort by priority: high -> medium -> low
    const priorityOrder = { high: 1, medium: 2, low: 3 };
    tasks.sort((a, b) => {
        const priorityDiff = priorityOrder[a.priority] - priorityOrder[b.priority];
        if (priorityDiff !== 0) return priorityDiff;
        // If same priority, sort by due date (earliest first)
        if (a.dueDate && b.dueDate) {
            return a.dueDate.localeCompare(b.dueDate);
        }
        if (a.dueDate) return -1;
        if (b.dueDate) return 1;
        return 0;
    });

    const container = document.getElementById('tasksList');
const empty = document.getElementById('tasksEmpty');
const headerAddButton = document.querySelector('.tasks-section .btn-add-meeting');

if (tasks.length === 0) {
    container.innerHTML = '';
    empty.style.display = 'block';
    
    // Hide header button when empty
    if (headerAddButton) headerAddButton.style.display = 'none';
    
    if (state.searchQuery) {
        empty.innerHTML = `
            <div class="empty-state-icon"></div>
            <div>No results for "${escapeHtml(state.searchQuery)}"</div>
        `;
    } else {
        empty.innerHTML = `
            <div class="empty-state-icon"></div>
            <div>No tasks yet</div>
            <button class="btn-schedule-meeting" onclick="openTaskModal()" style="margin: 0 auto; display: inline-flex;">
                <span>+</span>
                <span>Task</span>
            </button>
        `;
    }
    return;
}


// Show header button when there are tasks
if (headerAddButton) headerAddButton.style.display = 'flex';

empty.style.display = 'none';
    empty.style.display = 'none';
    container.innerHTML = tasks.map((task, index) => createTaskCard(task, index + 1)).join('');
    setupDragDrop();
}

function renderKanban() {
    let tasks = state.tasks.filter(t => !t.archived);
    
    if (state.currentCustomer !== 'all') {
        // Only show tasks that have this specific customer assigned
        tasks = tasks.filter(t => t.customerId && t.customerId === state.currentCustomer);
    }
    
    // ADD THIS BLOCK for search filtering
    if (state.searchQuery) {
        tasks = tasks.filter(t => {
            const matchesTitle = t.title.toLowerCase().includes(state.searchQuery);
            const matchesDescription = t.description.toLowerCase().includes(state.searchQuery);
            const matchesCustomerName = t.customerName && t.customerName.toLowerCase().includes(state.searchQuery);
            const matchesTags = t.tags.some(tag => tag.toLowerCase().includes(state.searchQuery));
            
            let matchesCompany = false;
            if (t.customerId) {
                const customer = state.customers.find(c => c.id === t.customerId);
                if (customer && customer.company) {
                    matchesCompany = customer.company.toLowerCase().includes(state.searchQuery);
                }
            }
            
            let matchesParticipant = false;
            if (t.meetingId) {
                const meeting = state.meetings.find(m => m.id === t.meetingId);
                if (meeting && meeting.participants) {
                    matchesParticipant = meeting.participants.some(p => 
                        (p.role && p.role.toLowerCase().includes(state.searchQuery)) ||
                        (p.name && p.name.toLowerCase().includes(state.searchQuery))
                    );
                }
            }
            
            return matchesTitle || matchesDescription || matchesCustomerName || 
                   matchesTags || matchesCompany || matchesParticipant;
        });
    }

// Sort by priority: high -> medium -> low
    const priorityOrder = { high: 1, medium: 2, low: 3 };
    tasks.sort((a, b) => {
        const priorityDiff = priorityOrder[a.priority] - priorityOrder[b.priority];
        if (priorityDiff !== 0) return priorityDiff;
        if (a.dueDate && b.dueDate) {
            return a.dueDate.localeCompare(b.dueDate);
        }
        if (a.dueDate) return -1;
        if (b.dueDate) return 1;
        return 0;
    });

            const todoTasks = tasks.filter(t => t.status === 'todo');
            const progressTasks = tasks.filter(t => t.status === 'in-progress');
            const doneTasks = tasks.filter(t => t.status === 'done');
            document.getElementById('todoCount').textContent = todoTasks.length;
            document.getElementById('progressCount').textContent = progressTasks.length;
            document.getElementById('doneCount').textContent = doneTasks.length;
            document.getElementById('todoColumn').innerHTML = todoTasks.map((task, index) => createTaskCard(task, index + 1, true)).join('');
            document.getElementById('progressColumn').innerHTML = progressTasks.map((task, index) => createTaskCard(task, index + 1, true)).join('');
            document.getElementById('doneColumn').innerHTML = doneTasks.map((task, index) => createTaskCard(task, index + 1, true)).join('');
            setupKanbanDragDrop();
        }

        function setupDragDrop() {
            const tasksList = document.getElementById('tasksList');
            let draggedElement = null;
            tasksList.querySelectorAll('.task-card').forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedElement = card;
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    updateTaskOrder();
                });
            });
            tasksList.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(tasksList, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (afterElement == null) {
                    tasksList.appendChild(dragging);
                } else {
                    tasksList.insertBefore(dragging, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateTaskOrder() {
            const taskElements = document.querySelectorAll('#tasksList .task-card');
            const newOrder = [];
            taskElements.forEach(el => {
                const taskId = el.dataset.taskId;
                const task = state.tasks.find(t => t.id === taskId);
                if (task) newOrder.push(task);
            });
            state.tasks = newOrder.concat(state.tasks.filter(t => !newOrder.includes(t)));
            saveData();
            showToast('Reordered', 'success');
        }

        function setupKanbanDragDrop() {
            const columns = document.querySelectorAll('.kanban-cards');
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });
                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });
                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    const taskId = e.dataTransfer.getData('text/plain');
                    const newStatus = column.dataset.status;
                    changeTaskStatus(taskId, newStatus);
                });
            });
            const cards = document.querySelectorAll('.kanban-cards .task-card');
            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', card.dataset.taskId);
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });
        }

        function createTaskCard(task, number, isKanban = false) {
            const today = new Date().toISOString().split('T')[0];
            const threeDays = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            let dueDateClass = '';
            let dueDateText = '';
            if (task.dueDate) {
                if (task.dueDate < today && !task.completed) {
                    dueDateClass = 'overdue';
                    dueDateText = ' Overdue';
                } else if (task.dueDate <= threeDays && !task.completed) {
                    dueDateClass = 'due-soon';
                    dueDateText = ' Soon';
                } else {
                    dueDateText = ` ${task.dueDate}`;
                }
            }
            // Use manual color if set, otherwise auto-color by priority
let colorClass = '';
if (task.color && task.color !== 'none') {
    colorClass = `color-${task.color}`;
} else {
    colorClass = `priority-${task.priority}-auto`;
}
            return `
                <div class="task-card ${dueDateClass} ${colorClass}" draggable="true" data-task-id="${task.id}">
                    <div class="task-number">${number}</div>
                    <div class="task-checkbox ${task.completed ? 'completed' : ''}" onclick="event.stopPropagation(); toggleTaskComplete('${task.id}')">
                        <svg viewBox="0 0 24 24">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="task-content">
                        <div class="task-header">
                            <div style="flex: 1;">
                               ${task.customerName ? `
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
        ${getCustomerLogo(task.customerId)}
        <span style="font-size: 0.95rem; font-weight: 700; color: #127c87;">${escapeHtml(task.customerName)}</span>
    </div>
` : ''}
                                <div class="task-title ${task.completed ? 'completed' : ''}">${escapeHtml(task.title)}</div>
                            </div>
<div class="task-badges">
    ${task.meetingId ? '<span class="task-meeting-badge"></span>' : ''}
    <span class="task-status status-${task.status}" onclick="event.stopPropagation(); cycleTaskStatus('${task.id}')" title="Click to change status">${task.status === 'todo' ? ' To Do' : task.status === 'in-progress' ? ' In Progress' : ' Completed'}</span>
    <span class="task-priority priority-${task.priority}">${task.priority}</span>
</div>
                        </div>
                        ${task.dueDate ? `<div class="task-due-date ${dueDateClass}">${dueDateText}</div>` : ''}
                        ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                        ${task.subtasks.length > 0 ? `
                            <div class="subtasks-container">
                                ${task.subtasks.map((sub, i) => `
                                    <div class="subtask-item">
                                        <div class="subtask-checkbox ${sub.completed ? 'completed' : ''}" onclick="event.stopPropagation(); toggleSubtask('${task.id}', ${i})"></div>
                                        <span class="subtask-text ${sub.completed ? 'completed' : ''}">${escapeHtml(sub.text)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="task-meta">
                            <div class="task-tags">
                                ${task.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                            </div>
                            <div class="task-actions">
                                <button class="task-btn" onclick="event.stopPropagation(); editTask('${task.id}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="task-btn archive" onclick="event.stopPropagation(); archiveTask('${task.id}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                                        <rect x="1" y="3" width="22" height="5"></rect>
                                        <line x1="10" y1="12" x2="14" y2="12"></line>
                                    </svg>
                                </button>
                                <button class="task-btn delete" onclick="event.stopPropagation(); deleteTask('${task.id}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

function renderNotes() {
    const container = document.getElementById('notesList');
    const empty = document.getElementById('notesEmpty');
    const notesContainer = document.getElementById('notesContainer');
    
    if (state.notes.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        empty.innerHTML = `
            <div class="empty-state-icon"></div>
            
        `;
        // Collapse when empty
        notesContainer.classList.remove('has-notes');
        notesContainer.classList.add('empty-notes');
        return;
    }
    
    // Expand when notes exist
    notesContainer.classList.remove('empty-notes');
    notesContainer.classList.add('has-notes');
    
    empty.style.display = 'none';
    const gradients = [
        'linear-gradient(135deg, #023747 0%, #127c87 100%)',
        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'linear-gradient(135deg, #f093fb 0%, #c13584 100%)',
        'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)',
        'linear-gradient(135deg, #065f46 0%, #10b981 100%)',
        'linear-gradient(135deg, #7c2d12 0%, #ea580c 100%)',
        'linear-gradient(135deg, #831843 0%, #ec4899 100%)',
        'linear-gradient(135deg, #1e293b 0%, #475569 100%)',
    ];
    
    container.innerHTML = state.notes.map((note, i) => `
        <div class="note-box" style="background: ${gradients[i % gradients.length]}" draggable="true" data-note-id="${note.id}">
            <div class="note-number">${i + 1}</div>
            <div class="note-content">${escapeHtml(note.content)}</div>
            <div class="note-actions">
                <button class="note-btn" onclick="event.stopPropagation(); editNote('${note.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="note-btn" onclick="event.stopPropagation(); deleteNote('${note.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

function updateStats() {
    // Statistics feature removed
}

        
function handleSearch(e) {
    state.searchQuery = e.target.value.toLowerCase();
    render();
    
    // Also filter dashboard sections if visible
    if (document.getElementById('customerActivitySection').classList.contains('active')) {
        renderCustomerActivity();
    }
    if (document.getElementById('allCustomersSection').classList.contains('active')) {
        renderAllCustomersList();
    }
    if (document.getElementById('upcomingMeetingsSection').classList.contains('active')) {
        renderUpcomingMeetings();
    }
}

function toggleTheme() {
    const current = document.body.dataset.theme;
    const newTheme = current === 'dark' ? 'light' : 'dark';
    
    // Add transition class
    document.body.style.transition = 'none';
    
    // Change theme
    document.body.dataset.theme = newTheme;
    localStorage.setItem('theme', newTheme);
    
    // Re-enable transitions after a tick
    requestAnimationFrame(() => {
        document.body.style.transition = '';
    });
    
    // Show toast with theme icon
    const icon = newTheme === 'dark' ? '' : '';
    showToast(`${icon} ${newTheme === 'dark' ? 'Dark' : 'Light'} mode`, 'success');
}

let saveTimeout;
function saveData() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        if (auth.currentUser) {
            saveUserDataToFirestore();
        } else {
            localStorage.setItem('taskflow_tasks', JSON.stringify(state.tasks));
            localStorage.setItem('taskflow_notes', JSON.stringify(state.notes));
            localStorage.setItem('taskflow_customers', JSON.stringify(state.customers));
            localStorage.setItem('taskflow_meetings', JSON.stringify(state.meetings));
            localStorage.setItem('taskflow_CustomerInfos', JSON.stringify(state.CustomerInfos));
            localStorage.setItem('taskflow_meetingTabs', JSON.stringify(state.meetingTabs));
        }
    }, 300);
}

// ========== EXPORT ALL DATA ==========
function exportAllData() {
    const userId = state.currentUser?.id || 'default';
    
    const exportData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        exportedBy: state.currentUser?.name || 'Unknown',
        data: {
            tasks: state.tasks,
            notes: state.notes,
            customers: state.customers,
            meetings: state.meetings,
            CustomerInfos: state.CustomerInfos,
            meetingTabs: state.meetingTabs,
            sharedMeetings: state.sharedMeetings,
            myShares: state.myShares,
            customMeetingTypes: JSON.parse(localStorage.getItem('taskflow_customMeetingTypes') || '[]'),
            theme: localStorage.getItem('theme') || 'light'
        }
    };
    
    const jsonString = JSON.stringify(exportData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `Mnimi_Backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast(' All data exported!', 'success');
}

// ========== IMPORT ALL DATA ==========
function importAllData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // Validate structure
            if (!importedData.data) {
                throw new Error('Invalid backup file format');
            }
            
            // Show confirmation with details
            const stats = {
                tasks: importedData.data.tasks?.length || 0,
                notes: importedData.data.notes?.length || 0,
                customers: importedData.data.customers?.length || 0,
                meetings: importedData.data.meetings?.length || 0,
                CustomerInfos: importedData.data.CustomerInfos?.length || 0
            };
            
            const message = `Import will replace ALL current data with:
 ${stats.tasks} tasks
 ${stats.notes} notes  
 ${stats.customers} customers
 ${stats.meetings} meetings
 ${stats.CustomerInfos} customer infos

This cannot be undone. Continue?`;
            
            showConfirm('', 'Import Data?', message, () => {
                performImport(importedData);
            });
            
        } catch (error) {
            console.error('Import error:', error);
            showToast(' Invalid file format', 'error');
        }
    };
    
    reader.readAsText(file);
    
    // Reset file input so same file can be selected again
    event.target.value = '';
}

function performImport(importedData) {
    const data = importedData.data;
    
    // Import all data
    if (data.tasks) state.tasks = data.tasks;
    if (data.notes) state.notes = data.notes;
    if (data.customers) state.customers = data.customers;
    if (data.meetings) state.meetings = data.meetings;
    if (data.CustomerInfos) state.CustomerInfos = data.CustomerInfos;
    if (data.meetingTabs) state.meetingTabs = data.meetingTabs;
    if (data.sharedMeetings) state.sharedMeetings = data.sharedMeetings;
    if (data.myShares) state.myShares = data.myShares;
    
    // Import custom meeting types
    if (data.customMeetingTypes) {
        localStorage.setItem('taskflow_customMeetingTypes', JSON.stringify(data.customMeetingTypes));
    }
    
    // Import theme
    if (data.theme) {
        localStorage.setItem('theme', data.theme);
        document.body.dataset.theme = data.theme;
    }
    
    // Save everything
    saveData();
    saveSharingData();
    
    // Refresh UI
    renderCustomerFilters();
    renderTasks();
    renderNotes();
    updateStats();
    
    // Reload custom meeting types in the form
    // Clear existing custom pills first
    document.querySelectorAll('.meeting-type-pill[data-custom-type]').forEach(el => el.remove());
    loadCustomMeetingTypes();
    
    showToast(` Imported successfully! (${importedData.exportDate?.split('T')[0] || 'Unknown date'})`, 'success');
    
    // Go to dashboard
    showDashboard();
}

                function loadData() {
            const tasks = localStorage.getItem('taskflow_tasks');
            const notes = localStorage.getItem('taskflow_notes');
            const customers = localStorage.getItem('taskflow_customers');
            const meetings = localStorage.getItem('taskflow_meetings');
            const CustomerInfos = localStorage.getItem('taskflow_CustomerInfos');
            const meetingTabs = localStorage.getItem('taskflow_meetingTabs');
            const theme = localStorage.getItem('theme');
            if (tasks) state.tasks = JSON.parse(tasks);
            if (notes) state.notes = JSON.parse(notes);
            if (customers) state.customers = JSON.parse(customers);
            if (meetings) state.meetings = JSON.parse(meetings);
            if (CustomerInfos) state.CustomerInfos = JSON.parse(CustomerInfos);
            if (meetingTabs) {
                state.meetingTabs = JSON.parse(meetingTabs);
            } else {
                state.meetingTabs = [
                    { id: 'all', name: 'All Meetings', icon: '', isDefault: true },
                    { id: 'individual', name: 'Individual', icon: '', isDefault: true }
                ];
            }
            if (theme) document.body.dataset.theme = theme;
        }

function fixDuplicateMeetingIds() {
    const seenIds = new Set();
    let fixedCount = 0;
    
    state.meetings.forEach(meeting => {
        if (seenIds.has(meeting.id)) {
            // This is a duplicate - generate new unique ID
            const oldId = meeting.id;
            meeting.id = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            // Update any tasks that reference this meeting
            state.tasks.forEach(task => {
                if (task.meetingId === oldId) {
                    task.meetingId = meeting.id;
                }
            });
            
            fixedCount++;
            console.log(`Fixed duplicate meeting ID: ${oldId} -> ${meeting.id}`);
        }
        seenIds.add(meeting.id);
    });
    
    if (fixedCount > 0) {
        saveData();
        console.log(`Fixed ${fixedCount} duplicate meeting ID(s)`);
    }
}

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

// Section collapse/expand
function toggleSection(header) {
    const section = header.parentElement;
    section.classList.toggle('collapsed');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCustomerLogo(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return getBuildingSVG(20);
    
    if (customer.website) {
        let domain = customer.website.replace(/^https?:\/\//, '').replace(/^www\./, '').split('/')[0];
        const logoUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
        return `<img src="${logoUrl}" 
            alt="${escapeHtml(customer.name)}" 
            style="width: 28px; height: 28px; border-radius: 5px; object-fit: contain; background: white; padding: 3px;"
            onerror="this.outerHTML=getBuildingSVG(20)">`;
    }
    
    return getBuildingSVG(20);
}

// Section collapse/expand
function toggleSection(header) {
    const section = header.parentElement;
    section.classList.toggle('collapsed');
}

function toggleCustomerSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.toggle('collapsed');
    }
}

function getBuildingSVG(size = 14, color = 'currentColor') {
    return `<svg viewBox="0 0 24 24" style="width: ${size}px; height: ${size}px; stroke: ${color}; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; vertical-align: middle;"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"></path><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"></path><path d="M10 6h4"></path><path d="M10 10h4"></path><path d="M10 14h4"></path><path d="M10 18h4"></path></svg>`;
}

function getCalendarSVG(size = 14, color = 'currentColor') {
    return `<svg viewBox="0 0 24 24" style="width: ${size}px; height: ${size}px; stroke: ${color}; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; vertical-align: middle;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`;
}

function getCheckboxSVG(size = 14, color = 'currentColor') {
    return `<svg viewBox="0 0 24 24" style="width: ${size}px; height: ${size}px; stroke: ${color}; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; vertical-align: middle;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
}

// CustomerInfo templates
function applyPrepTemplate(type) {
    const templates = {
        discovery: {
            goals: " Understand current workflow and challenges\n Identify key stakeholders\n Determine budget and timeline\n Establish decision-making process",
            discussion: " Current solution and pain points\n Team size and structure\n Key metrics and KPIs\n Decision criteria and timeline",
            outcomes: " Clear understanding of their needs\n Next meeting scheduled\n Follow-up materials sent"
        },
        demo: {
            goals: " Showcase key features relevant to their needs\n Address technical questions\n Demonstrate ROI\n Secure commitment for next steps",
            discussion: " Product walkthrough\n Integration requirements\n Security and compliance\n Pricing and packages",
            outcomes: " Proof of concept agreed\n Technical requirements documented\n Trial period scheduled"
        },
        quarterly: {
            goals: " Review progress and metrics\n Discuss challenges and wins\n Plan for next quarter\n Identify expansion opportunities",
            discussion: " Usage metrics and adoption\n Feedback and feature requests\n Upcoming initiatives\n Renewal timeline",
            outcomes: " Action items documented\n Renewal discussion initiated\n Next review scheduled"
        },
        negotiation: {
            goals: " Address pricing concerns\n Finalize terms and conditions\n Secure commitment\n Close the deal",
            discussion: " Pricing and discounts\n Contract terms\n Implementation timeline\n Success metrics",
            outcomes: " Agreement on terms\n Contract sent for signature\n Kickoff meeting scheduled"
        }
    };
    
    const template = templates[type];
    if (template) {
        document.getElementById('CustomerInfoGoals').value = template.goals;
        document.getElementById('CustomerInfoDiscussionPoints').value = template.discussion;
        document.getElementById('CustomerInfoOutcomes').value = template.outcomes;
        showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} template applied!`, 'success');
    }
}

// Meeting type selection
function selectMeetingType(type) {
    document.querySelectorAll('.meeting-type-pill').forEach(pill => pill.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    document.getElementById('meetingType').value = type;
}

function selectMeetingType(type) {
    document.querySelectorAll('.meeting-type-pill').forEach(pill => pill.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    document.getElementById('meetingType').value = type;
}

// Custom Meeting Type Functions
let selectedCustomMeetingTypeIcon = '';

function addCustomMeetingType() {
    openCustomMeetingTypeModal();
}

function openCustomMeetingTypeModal(editSlug = null) {
    selectedCustomMeetingTypeIcon = '';
    
    if (editSlug) {
        const customTypes = JSON.parse(localStorage.getItem('taskflow_customMeetingTypes') || '[]');
        const type = customTypes.find(t => t.slug === editSlug);
        
        if (type) {
            document.getElementById('customMeetingTypeModalTitle').textContent = 'Edit Meeting Type';
            document.getElementById('editingMeetingTypeSlug').value = editSlug;
            document.getElementById('customMeetingTypeName').value = type.name;
            document.getElementById('selectedMeetingTypeIcon').value = type.icon;
            selectedCustomMeetingTypeIcon = type.icon;
            
            // Select the icon
            document.querySelectorAll('.meeting-type-icon-option').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.icon === type.icon) {
                    btn.classList.add('selected');
                }
            });
        }
    } else {
        document.getElementById('customMeetingTypeModalTitle').textContent = 'Add Meeting Type';
        document.getElementById('customMeetingTypeForm').reset();
        document.querySelectorAll('.meeting-type-icon-option').forEach(btn => {
            btn.classList.remove('selected');
        });
    }
    
    // Setup icon selection
    document.querySelectorAll('.meeting-type-icon-option').forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.meeting-type-icon-option').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            selectedCustomMeetingTypeIcon = this.dataset.icon;
            document.getElementById('selectedMeetingTypeIcon').value = this.dataset.icon;
            document.getElementById('customMeetingTypeEmoji').value = '';
        });
    });
    
    // Setup custom emoji input
    const emojiInput = document.getElementById('customMeetingTypeEmoji');
    const newEmojiInput = emojiInput.cloneNode(true);
    emojiInput.parentNode.replaceChild(newEmojiInput, emojiInput);
    
    newEmojiInput.addEventListener('input', function() {
        if (this.value.trim()) {
            selectedCustomMeetingTypeIcon = this.value.trim();
            document.getElementById('selectedMeetingTypeIcon').value = this.value.trim();
            document.querySelectorAll('.meeting-type-icon-option').forEach(b => b.classList.remove('selected'));
        }
    });
    
    document.getElementById('customMeetingTypeModal').classList.add('active');
}

function closeCustomMeetingTypeModal() {
    document.getElementById('customMeetingTypeModal').classList.remove('active');
    selectedCustomMeetingTypeIcon = '';
}

function handleCustomMeetingTypeSubmit(e) {
    e.preventDefault();
    
    const typeName = document.getElementById('customMeetingTypeName').value.trim();
    const customEmoji = document.getElementById('customMeetingTypeEmoji').value.trim();
    const typeIcon = customEmoji || selectedCustomMeetingTypeIcon || '';
    const editingSlug = document.getElementById('editingMeetingTypeSlug').value;
    
    if (!typeName) {
        showToast(' Enter type name', 'error');
        return;
    }
    
    if (!typeIcon) {
        showToast(' Select an icon', 'error');
        return;
    }
    
    const typeSlug = typeName.toLowerCase().replace(/\s+/g, '-');
    
    let customTypes = JSON.parse(localStorage.getItem('taskflow_customMeetingTypes') || '[]');
    
    if (editingSlug) {
        // Update existing type
        const index = customTypes.findIndex(t => t.slug === editingSlug);
        if (index !== -1) {
            customTypes[index] = { slug: typeSlug, name: typeName, icon: typeIcon };
            
            // Update the pill
            const pill = document.querySelector(`[data-custom-type="${editingSlug}"]`);
            if (pill) {
                pill.setAttribute('data-custom-type', typeSlug);
                pill.onclick = function() { selectCustomMeetingType(typeSlug, typeIcon); };
                pill.innerHTML = `
                    <span class="meeting-type-icon">${typeIcon}</span>
                    <span>${typeName}</span>
                    <span style="margin-left: auto; cursor: pointer; opacity: 0.7; padding: 0 0.5rem;" onclick="event.stopPropagation(); editCustomMeetingType('${typeSlug}')"></span>
                    <span style="cursor: pointer; opacity: 0.7;" onclick="event.stopPropagation(); removeCustomMeetingType('${typeSlug}', this.parentElement)"></span>
                `;
            }
            
            showToast(' Type updated!', 'success');
        }
    } else {
        // Check if type already exists
        if (customTypes.some(t => t.slug === typeSlug)) {
            showToast(' Type already exists', 'error');
            return;
        }
        
        // Add new type
customTypes.push({ slug: typeSlug, name: typeName, icon: typeIcon });

// Create new pill
const container = document.getElementById('meetingTypePills');
const addButton = container.querySelector('button[onclick="addCustomMeetingType()"]');

const newPill = document.createElement('div');
newPill.className = 'meeting-type-pill';
newPill.setAttribute('data-custom-type', typeSlug);
newPill.onclick = function() { selectCustomMeetingType(typeSlug, typeIcon); };
newPill.innerHTML = `
    <span class="meeting-type-icon">${typeIcon}</span>
    <span>${typeName}</span>
    <span style="margin-left: auto; cursor: pointer; opacity: 0.7; padding: 0 0.5rem;" onclick="event.stopPropagation(); editCustomMeetingType('${typeSlug}')"></span>
    <span style="cursor: pointer; opacity: 0.7;" onclick="event.stopPropagation(); removeCustomMeetingType('${typeSlug}', this.parentElement)"></span>
`;

container.insertBefore(newPill, addButton);

// AUTO-SELECT the newly created type
document.querySelectorAll('.meeting-type-pill').forEach(pill => pill.classList.remove('selected'));
newPill.classList.add('selected');
document.getElementById('meetingType').value = typeSlug;
const form = document.getElementById('meetingForm');
if (form) {
    form.setAttribute('data-custom-type-icon', typeIcon);
}

showToast(` "${typeName}" type added and selected!`, 'success');
    }
    
    localStorage.setItem('taskflow_customMeetingTypes', JSON.stringify(customTypes));
    closeCustomMeetingTypeModal();
}

function selectCustomMeetingType(typeSlug, typeIcon) {
    document.querySelectorAll('.meeting-type-pill').forEach(pill => pill.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    document.getElementById('meetingType').value = typeSlug;
    
    // Store custom icon for this meeting
    const form = document.getElementById('meetingForm');
    if (form) {
        form.setAttribute('data-custom-type-icon', typeIcon);
    }
}

function editCustomMeetingType(typeSlug) {
    openCustomMeetingTypeModal(typeSlug);
}

function removeCustomMeetingType(typeSlug, element) {
    showConfirm('', 'Delete Type?', 'Remove this meeting type?', () => {
        element.remove();
        
        // Remove from localStorage
        let customTypes = JSON.parse(localStorage.getItem('taskflow_customMeetingTypes') || '[]');
        customTypes = customTypes.filter(t => t.slug !== typeSlug);
        localStorage.setItem('taskflow_customMeetingTypes', JSON.stringify(customTypes));
        
        showToast(' Type removed!', 'success');
    });
}

function loadCustomMeetingTypes() {
    const customTypes = JSON.parse(localStorage.getItem('taskflow_customMeetingTypes') || '[]');
    const container = document.getElementById('meetingTypePills');
    const addButton = container.querySelector('button[onclick="addCustomMeetingType()"]');
    
    customTypes.forEach(type => {
        const newPill = document.createElement('div');
        newPill.className = 'meeting-type-pill';
        newPill.setAttribute('data-custom-type', type.slug);
        newPill.onclick = function() { selectCustomMeetingType(type.slug, type.icon); };
        newPill.innerHTML = `
            <span class="meeting-type-icon">${type.icon}</span>
            <span>${type.name}</span>
            <span style="margin-left: auto; cursor: pointer; opacity: 0.7; padding: 0 0.5rem;" onclick="event.stopPropagation(); editCustomMeetingType('${type.slug}')"></span>
            <span style="cursor: pointer; opacity: 0.7;" onclick="event.stopPropagation(); removeCustomMeetingType('${type.slug}', this.parentElement)"></span>
        `;
        container.insertBefore(newPill, addButton);
    });
}



function removeParticipant(index) {
    state.meetingParticipants.splice(index, 1);
    
    // Reset editing state if we're deleting the participant being edited
    if (state.editingParticipantIndex === index) {
        state.editingParticipantIndex = null;
        document.getElementById('addParticipantBtn').innerHTML = '+ Add Participant';
        document.getElementById('participantNameInput').value = '';
        document.getElementById('participantRoleInput').value = '';
        document.getElementById('participantEmailInput').value = '';
        document.getElementById('participantPhoneInput').value = '';
    } else if (state.editingParticipantIndex !== null && state.editingParticipantIndex > index) {
        // Adjust index if we deleted someone before the one being edited
        state.editingParticipantIndex--;
    }
    
    renderParticipantsList();
}



// MEDDPICC visual tracker update
function updateMeddpiccVisualTracker() {
    const fields = ['Metrics', 'EconomicBuyer', 'DecisionCriteria', 'DecisionProcess', 'PaperProcess', 'Pain', 'Champion', 'Competition'];
    fields.forEach(field => {
        const value = document.getElementById(`meddpicc${field}`).value.trim();
        const tracker = document.querySelector(`.meddpicc-tracker-item[onclick="focusMeddpiccField('${field}')"]`);
        if (value) {
            tracker.classList.add('completed');
        } else {
            tracker.classList.remove('completed');
        }
    });
}

function focusMeddpiccField(field) {
    document.getElementById(`meddpicc${field}`).focus();
}

// Update existing openInlineMeetingForm to set up trackers
const originalOpenMeetingForm = openInlineMeetingForm;
openInlineMeetingForm = function(meeting = null, isPastMeeting = true, isSharedPreview = false) {
    originalOpenMeetingForm(meeting, isPastMeeting, isSharedPreview);
    
    // Set up meeting type
    if (meeting && meeting.type) {
        document.querySelectorAll('.meeting-type-pill').forEach(pill => {
            if (pill.onclick.toString().includes(meeting.type)) {
                pill.classList.add('selected');
            }
        });
    }
    
    
    // Update MEDDPICC tracker
    setTimeout(updateMeddpiccVisualTracker, 100);
};


// Add input listeners for MEDDPICC fields
document.addEventListener('DOMContentLoaded', () => {
    ['Metrics', 'EconomicBuyer', 'DecisionCriteria', 'DecisionProcess', 'PaperProcess', 'Pain', 'Champion', 'Competition'].forEach(field => {
        const element = document.getElementById(`meddpicc${field}`);
        if (element) {
            element.addEventListener('input', updateMeddpiccVisualTracker);
        }
    });
});

// Meeting Tabs Functions
function switchMeetingTab(tabId) {
    state.currentMeetingTab = tabId;
    if (state.currentCustomer !== 'all') {
        showCustomerMeetingsSection(state.currentCustomer);
    }
}

function openCreateTabModal(tabId = null, event = null) {
    console.log('openCreateTabModal called'); // DEBUG
    
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    if (tabId) {
        const tab = state.meetingTabs.find(t => t.id === tabId);
        if (tab && !tab.isDefault) {
            state.editingTabId = tabId;
            document.getElementById('tabModalTitle').textContent = 'Edit Meeting Tab';
            document.getElementById('editingTabId').value = tabId;
            document.getElementById('tabName').value = tab.name;
            document.getElementById('tabIcon').value = tab.icon || '';
            state.selectedTabIcon = tab.icon || '';
            
            document.querySelectorAll('.tab-icon-option').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
                if (btn.dataset.icon === tab.icon) {
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                }
            });
        }
    } else {
        state.editingTabId = null;
        document.getElementById('createTabForm').reset();
        state.selectedTabIcon = '';
        document.querySelectorAll('.tab-icon-option').forEach(btn => {
            btn.style.background = '';
            btn.style.color = '';
        });
    }
    
    // Attach icon button listeners NOW since they exist in the modal
    document.querySelectorAll('.tab-icon-option').forEach(btn => {
        // Remove old listeners by cloning
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        // Add new listener
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Icon clicked:', this.dataset.icon); // DEBUG
            
            document.querySelectorAll('.tab-icon-option').forEach(b => {
                b.style.background = '';
                b.style.color = '';
            });
            this.style.background = 'var(--primary)';
            this.style.color = 'white';
            state.selectedTabIcon = this.dataset.icon;
            document.getElementById('tabIcon').value = this.dataset.icon;
        });
    });
    
    document.getElementById('createTabModal').classList.add('active');
}

function closeCreateTabModal() {
    document.getElementById('createTabModal').classList.remove('active');
    state.editingTabId = null;
    state.selectedTabIcon = '';
}

function handleTabFormSubmit(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    console.log('handleTabFormSubmit called!'); // DEBUG
    
    const name = document.getElementById('tabName').value.trim();
    const icon = document.getElementById('tabIcon').value || state.selectedTabIcon;
    
    console.log('Tab name:', name); // DEBUG
    
    if (!name) {
        showToast(' Enter tab name', 'error');
        return;
    }
    
    if (state.editingTabId) {
        const tab = state.meetingTabs.find(t => t.id === state.editingTabId);
        if (tab) {
            tab.name = name;
            tab.icon = icon;
            showToast(' Tab updated!', 'success');
        }
    } else {
        const newTab = {
            id: Date.now().toString(),
            name: name,
            icon: icon,
            isDefault: false
        };
        state.meetingTabs.push(newTab);
        console.log('New tab created:', newTab); // DEBUG
        showToast(' Tab created!', 'success');
    }
    
    saveData();
    closeCreateTabModal();
    
    if (state.currentCustomer !== 'all') {
        showCustomerMeetingsSection(state.currentCustomer);
    }
}


function showTabContextMenu(event, tabId) {
    const tab = state.meetingTabs.find(t => t.id === tabId);
    if (!tab || tab.isDefault) return;
    
    const menu = document.getElementById('tabContextMenu');
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
    menu.classList.add('active');
    menu.dataset.tabId = tabId;
    
    document.addEventListener('click', closeTabContextMenu);
}

function closeTabContextMenu() {
    const menu = document.getElementById('tabContextMenu');
    menu.classList.remove('active');
    document.removeEventListener('click', closeTabContextMenu);
}

function renameTab() {
    const menu = document.getElementById('tabContextMenu');
    const tabId = menu.dataset.tabId;
    closeTabContextMenu();
    openCreateTabModal(tabId);
}

function deleteTab() {
    const menu = document.getElementById('tabContextMenu');
    const tabId = menu.dataset.tabId;
    closeTabContextMenu();
    deleteTabConfirm(tabId);
}

function deleteTabQuick(tabId) {
    deleteTabConfirm(tabId);
}

function deleteTabConfirm(tabId) {
    const tab = state.meetingTabs.find(t => t.id === tabId);
    if (!tab || tab.isDefault) return;
    
    const meetingsInTab = state.meetings.filter(m => m.tabId === tabId);
    const message = meetingsInTab.length > 0
        ? `Delete "${tab.name}"? ${meetingsInTab.length} meeting(s) will be moved to "Individual".`
        : `Delete "${tab.name}"?`;
    
    showConfirm('', 'Delete Tab?', message, () => {
        // Move meetings to individual
        state.meetings.forEach(m => {
            if (m.tabId === tabId) {
                m.tabId = 'individual';
            }
        });
        
        // Remove tab
        state.meetingTabs = state.meetingTabs.filter(t => t.id !== tabId);
        
        // Switch to all tab if we deleted current tab
        if (state.currentMeetingTab === tabId) {
            state.currentMeetingTab = 'all';
        }
        
        saveData();
        
        if (state.currentCustomer !== 'all') {
            showCustomerMeetingsSection(state.currentCustomer);
        }
        
        showToast(' Tab deleted!', 'success');
    });
}

function handleMeetingDragStart(event, meetingId) {
    state.draggedMeetingId = meetingId;
    event.target.classList.add('meeting-card-dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', meetingId);
}

function handleMeetingDragEnd(event) {
    event.target.classList.remove('meeting-card-dragging');
    state.draggedMeetingId = null;
    
    // Hide drop zone
    const dropZone = document.getElementById('meetingsDropZone');
    if (dropZone) dropZone.classList.remove('active');
    
    // Remove drag-over from all tabs
    document.querySelectorAll('.meeting-tab').forEach(tab => {
        tab.classList.remove('drag-over');
    });
}

function handleTabDragOver(event, tabId) {
    if (!state.draggedMeetingId) return;
    
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    
    const tab = event.currentTarget;
    tab.classList.add('drag-over');
    
    // Show drop zone if on this tab
    if (state.currentMeetingTab === tabId) {
        const dropZone = document.getElementById('meetingsDropZone');
        if (dropZone) dropZone.classList.add('active');
    }
}

function handleTabDragLeave(event) {
    const tab = event.currentTarget;
    tab.classList.remove('drag-over');
}

function handleTabDrop(event, tabId) {
    event.preventDefault();
    
    const meetingId = state.draggedMeetingId || event.dataTransfer.getData('text/plain');
    if (!meetingId) return;
    
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (!meeting) return;
    
    const tab = state.meetingTabs.find(t => t.id === tabId);
    if (!tab) return;
    
    // Update meeting tab
    meeting.tabId = tabId;
    
    saveData();
    
    // Refresh view
    if (state.currentCustomer !== 'all') {
        showCustomerMeetingsSection(state.currentCustomer);
    }
    
    showToast(` Moved to "${tab.name}"!`, 'success');
}

// ============================================
// FOLLOW-UP PARTICIPANT MANAGEMENT
// ============================================

let followUpParticipants = [];

function loadFollowUpQuickAddContacts(customerId) {
    const container = document.getElementById('followUpQuickAddContacts');
    const list = document.getElementById('followUpQuickAddList');
    
    if (!customerId) {
        container.style.display = 'none';
        return;
    }
    
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) {
        container.style.display = 'none';
        return;
    }
    
    // Collect all unique contacts for this customer
    const contactsMap = new Map();
    
    // Add standalone contacts
    if (customer.participants) {
        customer.participants.forEach(p => {
            const key = p.email && p.email.trim() 
                ? p.email.toLowerCase().trim() 
                : p.name.toLowerCase().trim();
            if (!contactsMap.has(key)) {
                contactsMap.set(key, p);
            }
        });
    }
    
    // Add contacts from previous meetings
    const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
    customerMeetings.forEach(meeting => {
        if (meeting.participants) {
            meeting.participants.forEach(p => {
                const key = p.email && p.email.trim() 
                    ? p.email.toLowerCase().trim() 
                    : p.name.toLowerCase().trim();
                if (!contactsMap.has(key)) {
                    contactsMap.set(key, p);
                }
            });
        }
    });
    
    const contacts = Array.from(contactsMap.values());
    
    if (contacts.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    // Filter out already selected participants
    const availableContacts = contacts.filter(contact => {
        const key = contact.email && contact.email.trim() 
            ? contact.email.toLowerCase().trim() 
            : contact.name.toLowerCase().trim();
        
        return !followUpParticipants.some(p => {
            const pKey = p.email && p.email.trim() 
                ? p.email.toLowerCase().trim() 
                : p.name.toLowerCase().trim();
            return pKey === key;
        });
    });
    
    if (availableContacts.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    // Render contacts
    list.innerHTML = availableContacts.map(contact => {
        const initials = contact.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        const details = [];
        if (contact.role) details.push(contact.role);
        if (contact.email) details.push(contact.email);
        if (contact.phone) details.push(contact.phone);
        
        const contactJson = JSON.stringify(contact).replace(/"/g, '&quot;');
        
        return `
            <div class="quick-add-contact-item" onclick='quickAddFollowUpParticipant(${contactJson})'>
                <div class="quick-add-contact-avatar">${initials}</div>
                <div class="quick-add-contact-info">
                    <div class="quick-add-contact-name">${escapeHtml(contact.name)}</div>
                    ${details.length > 0 ? `<div class="quick-add-contact-details">${escapeHtml(details.join('  '))}</div>` : ''}
                </div>
                <div class="quick-add-contact-icon"></div>
            </div>
        `;
    }).join('');
    
    container.style.display = 'block';
}

function quickAddFollowUpParticipant(contactData) {
    // Check if already added
    const key = contactData.email && contactData.email.trim() 
        ? contactData.email.toLowerCase().trim() 
        : contactData.name.toLowerCase().trim();
    
    const alreadyAdded = followUpParticipants.some(p => {
        const pKey = p.email && p.email.trim() 
            ? p.email.toLowerCase().trim() 
            : p.name.toLowerCase().trim();
        return pKey === key;
    });
    
    if (alreadyAdded) {
        showToast(' Already added', 'error');
        return;
    }
    
    // Add participant
    followUpParticipants.push({
        name: contactData.name,
        role: contactData.role || '',
        email: contactData.email || '',
        phone: contactData.phone || ''
    });
    
    renderFollowUpParticipantsList();
    
    // **FIXED: Refresh quick-add list using the correct customer ID source**
    // Get customer ID from either selected meetings or customer filter
    let customerId = null;
    
    if (selectedFollowUpMeetings.length > 0) {
        const meetings = selectedFollowUpMeetings.map(id => state.meetings.find(m => m.id === id));
        customerId = meetings[0]?.customerId;
    } else if (state.currentCustomer && state.currentCustomer !== 'all') {
        customerId = state.currentCustomer;
    } else {
        const customerFilter = document.getElementById('followUpCustomerFilter').value;
        if (customerFilter !== 'all') {
            customerId = customerFilter;
        }
    }
    
    if (customerId) {
        loadFollowUpQuickAddContacts(customerId);
    }
    
    updateFollowUpPreview();
    showToast(` ${contactData.name} added!`, 'success');
}


function addFollowUpParticipant() {
    const name = document.getElementById('followUpParticipantName').value.trim();
    const role = document.getElementById('followUpParticipantRole').value.trim();
    const email = document.getElementById('followUpParticipantEmail').value.trim();
    const phone = document.getElementById('followUpParticipantPhone').value.trim();
    
    if (!name) {
        showToast(' Enter participant name', 'error');
        return;
    }
    
    // Check if already added
    const key = email && email.trim() ? email.toLowerCase().trim() : name.toLowerCase().trim();
    const alreadyAdded = followUpParticipants.some(p => {
        const pKey = p.email && p.email.trim() 
            ? p.email.toLowerCase().trim() 
            : p.name.toLowerCase().trim();
        return pKey === key;
    });
    
    if (alreadyAdded) {
        showToast(' Participant already added', 'error');
        return;
    }
    
    followUpParticipants.push({ name, role, email, phone });
    
    // Clear form
    document.getElementById('followUpParticipantName').value = '';
    document.getElementById('followUpParticipantRole').value = '';
    document.getElementById('followUpParticipantEmail').value = '';
    document.getElementById('followUpParticipantPhone').value = '';
    
    renderFollowUpParticipantsList();
    
    // **FIXED: Refresh quick-add list using the correct customer ID source**
    let customerId = null;
    
    if (selectedFollowUpMeetings.length > 0) {
        const meetings = selectedFollowUpMeetings.map(id => state.meetings.find(m => m.id === id));
        customerId = meetings[0]?.customerId;
    } else if (state.currentCustomer && state.currentCustomer !== 'all') {
        customerId = state.currentCustomer;
    } else {
        const customerFilter = document.getElementById('followUpCustomerFilter').value;
        if (customerFilter !== 'all') {
            customerId = customerFilter;
        }
    }
    
    if (customerId) {
        loadFollowUpQuickAddContacts(customerId);
    }
    
    updateFollowUpPreview();
    showToast(` ${name} added!`, 'success');
}

function removeFollowUpParticipant(index) {
    followUpParticipants.splice(index, 1);
    renderFollowUpParticipantsList();
    
    // **FIXED: Refresh quick-add list to show the removed participant again**
    let customerId = null;
    
    if (selectedFollowUpMeetings.length > 0) {
        const meetings = selectedFollowUpMeetings.map(id => state.meetings.find(m => m.id === id));
        customerId = meetings[0]?.customerId;
    } else if (state.currentCustomer && state.currentCustomer !== 'all') {
        customerId = state.currentCustomer;
    } else {
        const customerFilter = document.getElementById('followUpCustomerFilter').value;
        if (customerFilter !== 'all') {
            customerId = customerFilter;
        }
    }
    
    if (customerId) {
        loadFollowUpQuickAddContacts(customerId);
    }
    
    updateFollowUpPreview();
}

function renderFollowUpParticipantsList() {
    const container = document.getElementById('followUpParticipantsList');
    const countEl = document.getElementById('followUpParticipantsCount');
    
    countEl.textContent = followUpParticipants.length;
    
    if (followUpParticipants.length === 0) {
        container.innerHTML = '<div style="padding: 0.75rem; text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No participants selected</div>';
        return;
    }
    
    container.innerHTML = followUpParticipants.map((participant, index) => {
        const initials = participant.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        return `
            <div class="participant-card">
                <div class="participant-avatar">${initials}</div>
                <div class="participant-details">
                    <div class="participant-card-name">${escapeHtml(participant.name)}</div>
                    <div class="participant-card-meta">
                        ${participant.role ? `<span> ${escapeHtml(participant.role)}</span>` : ''}
                        ${participant.email ? `<span> ${escapeHtml(participant.email)}</span>` : ''}
                        ${participant.phone ? `<span> ${escapeHtml(participant.phone)}</span>` : ''}
                    </div>
                </div>
                <div class="task-actions">
                    <button type="button" class="task-btn delete" onclick="removeFollowUpParticipant(${index})" title="Remove">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}



// ============================================
// FOLLOW-UP MEETING FUNCTIONALITY
// ============================================

let selectedFollowUpMeetings = [];
let editingSharedMeetingId = null;

function openFollowUpModal(source = 'past') {
    // Reset state
    selectedFollowUpMeetings = [];
    followUpParticipants = [];
    
    // Update Step title if viewing specific customer
    const step1Title = document.getElementById('followUpStep1Title');
    if (state.currentCustomer && state.currentCustomer !== 'all') {
        const customer = state.customers.find(c => c.id === state.currentCustomer);
        if (customer) {
            step1Title.textContent = `Step 2: Select ${customer.name} Meeting(s)`;
        }
    } else {
        step1Title.textContent = 'Step 2: Select Meeting(s) to Follow Up';
    }
    
    document.getElementById('followUpModal').classList.add('active');
    
    // Scroll modal content to top
    setTimeout(() => {
        const modalContent = document.querySelector('#followUpModal .modal-content > div[style*="padding"]');
        if (modalContent) {
            modalContent.scrollTop = 0;
        }
    }, 50);
    
    // Set default dates
    const upcomingDate = new Date();
    upcomingDate.setDate(upcomingDate.getDate() + 14); // +2 weeks
    upcomingDate.setMinutes(upcomingDate.getMinutes() - upcomingDate.getTimezoneOffset());
    document.getElementById('followUpDateUpcoming').value = upcomingDate.toISOString().slice(0, 16);
    
    const pastDate = new Date();
    pastDate.setDate(pastDate.getDate() - 1); // Yesterday
    pastDate.setMinutes(pastDate.getMinutes() - pastDate.getTimezoneOffset());
    document.getElementById('followUpDatePast').value = pastDate.toISOString().slice(0, 16);
    
    // Set radio button based on source
    if (source === 'upcoming') {
        document.querySelector('input[name="followUpType"][value="upcoming"]').checked = true;
        document.querySelector('input[name="followUpType"][value="past"]').checked = false;
    } else {
        document.querySelector('input[name="followUpType"][value="past"]').checked = true;
        document.querySelector('input[name="followUpType"][value="upcoming"]').checked = false;
    }
    
    // Populate customer filter
    populateFollowUpCustomerFilter();
    
    // If viewing a specific customer, pre-filter to that customer
    if (state.currentCustomer && state.currentCustomer !== 'all') {
        document.getElementById('followUpCustomerFilter').value = state.currentCustomer;
        document.getElementById('followUpCustomerFilter').disabled = true;
        document.getElementById('followUpCustomerFilter').style.opacity = '0.6';
        document.getElementById('followUpCustomerFilter').style.cursor = 'not-allowed';
        
        // **NEW: Load quick-add contacts immediately for this customer**
        loadFollowUpQuickAddContacts(state.currentCustomer);
    } else {
        document.getElementById('followUpCustomerFilter').disabled = false;
        document.getElementById('followUpCustomerFilter').style.opacity = '1';
        document.getElementById('followUpCustomerFilter').style.cursor = 'pointer';
        
        // Hide quick-add initially for "all customers" view
        document.getElementById('followUpQuickAddContacts').style.display = 'none';
    }
    
    // Load meetings
    renderFollowUpMeetingsList();
    
    // Clear participant list
    renderFollowUpParticipantsList();
    
    // Update modal title if viewing specific customer
    const modalTitle = document.getElementById('followUpModalTitle');
    if (state.currentCustomer && state.currentCustomer !== 'all') {
        const customer = state.customers.find(c => c.id === state.currentCustomer);
        if (customer) {
            modalTitle.textContent = ` Create Follow-Up for ${customer.name}`;
        }
    } else {
        modalTitle.textContent = ' Create Follow-Up Meeting';
    }
    
    updateFollowUpPreview();
    
    // Setup radio button listeners to update preview
    document.querySelectorAll('input[name="followUpType"]').forEach(radio => {
        radio.addEventListener('change', updateFollowUpPreview);
    });
}

function closeFollowUpModal() {
    document.getElementById('followUpModal').classList.remove('active');
    selectedFollowUpMeetings = [];
    followUpParticipants = [];
}

function populateFollowUpCustomerFilter() {
    const select = document.getElementById('followUpCustomerFilter');
    select.innerHTML = '<option value="all">All Customers</option>';
    
    const customers = [...new Set(state.meetings.map(m => m.customerId))];
    customers.forEach(customerId => {
        const customer = state.customers.find(c => c.id === customerId);
        if (customer) {
            const option = document.createElement('option');
            option.value = customerId;
            option.textContent = customer.name;
            select.appendChild(option);
        }
    });
}

function filterFollowUpMeetings() {
    renderFollowUpMeetingsList();
    
    // **Update quick-add contacts when filter changes**
    const customerFilter = document.getElementById('followUpCustomerFilter').value;
    if (customerFilter !== 'all') {
        loadFollowUpQuickAddContacts(customerFilter);
    } else {
        // Hide quick-add when "all customers" is selected
        document.getElementById('followUpQuickAddContacts').style.display = 'none';
    }
}

function renderFollowUpMeetingsList() {
    const container = document.getElementById('followUpMeetingsList');
    const searchQuery = document.getElementById('followUpSearch').value.toLowerCase();
    const customerFilter = document.getElementById('followUpCustomerFilter').value;
    const dateFilterValue = document.getElementById('followUpDateFilter').value;
    const dateFilter = dateFilterValue === 'all' ? 'all' : parseInt(dateFilterValue);
    
    // Filter meetings
    let meetings = [...state.meetings];
    
    // Apply search
    if (searchQuery) {
        meetings = meetings.filter(m => 
            m.title.toLowerCase().includes(searchQuery) ||
            m.customerName.toLowerCase().includes(searchQuery)
        );
    }
    
    // Apply customer filter
    if (customerFilter !== 'all') {
        meetings = meetings.filter(m => m.customerId === customerFilter);
    }
    
    // Apply date filter
    if (dateFilter !== 'all') {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - dateFilter);
        meetings = meetings.filter(m => new Date(m.date) >= cutoffDate);
    }
    
    // Sort by date (most recent first)
    meetings.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Render
    container.innerHTML = '';
    
    meetings.forEach(meeting => {
        const div = document.createElement('div');
        div.className = 'follow-up-meeting-item';
        if (selectedFollowUpMeetings.includes(meeting.id)) {
            div.classList.add('selected');
        }
        
        const customer = state.customers.find(c => c.id === meeting.customerId);
        const participants = meeting.participants || [];
        const participantNames = participants.slice(0, 3).map(p => p.name).join(', ');
        const moreParticipants = participants.length > 3 ? ` +${participants.length - 3}` : '';
        
        // Get notes preview (strip HTML)
        const notesText = meeting.notesHTML ? htmlToPlainText(meeting.notesHTML) : meeting.notes || '';
        const notesPreview = notesText.substring(0, 60) + (notesText.length > 60 ? '...' : '');
        
        div.innerHTML = `
            <input type="checkbox" ${selectedFollowUpMeetings.includes(meeting.id) ? 'checked' : ''} 
                   onchange="toggleFollowUpMeeting('${meeting.id}')">
            <div class="follow-up-meeting-info">
                <div class="follow-up-meeting-title">${escapeHtml(meeting.title)} - ${escapeHtml(meeting.customerName)}</div>
                <div class="follow-up-meeting-meta">
                    <span> ${new Date(meeting.date).toLocaleDateString()}</span>
                    ${participantNames ? `<span> ${escapeHtml(participantNames)}${moreParticipants}</span>` : ''}
                </div>
                ${notesPreview ? `<div class="follow-up-meeting-preview"> "${escapeHtml(notesPreview)}"</div>` : ''}
            </div>
        `;
        
        div.onclick = (e) => {
            if (e.target.type !== 'checkbox') {
                toggleFollowUpMeeting(meeting.id);
            }
        };
        
        container.appendChild(div);
    });
}

function toggleFollowUpMeeting(meetingId) {
    const index = selectedFollowUpMeetings.indexOf(meetingId);
    if (index > -1) {
        selectedFollowUpMeetings.splice(index, 1);
    } else {
        selectedFollowUpMeetings.push(meetingId);
    }
    
    renderFollowUpMeetingsList();
    updateFollowUpSelectionCount();
    validateFollowUpSelection();
    
    // Load quick-add contacts when a customer's meeting is selected
    const meetings = selectedFollowUpMeetings.map(id => state.meetings.find(m => m.id === id));
    if (meetings.length > 0 && meetings[0].customerId) {
        loadFollowUpQuickAddContacts(meetings[0].customerId);
    } else {
        document.getElementById('followUpQuickAddContacts').style.display = 'none';
    }
    
    updateFollowUpPreview();
}


function updateFollowUpSelectionCount() {
    const count = selectedFollowUpMeetings.length;
    const countEl = document.getElementById('followUpSelectionCount');
    
    if (count === 0) {
        countEl.textContent = 'No meetings selected';
        countEl.style.color = 'var(--text-secondary)';
    } else if (count === 1) {
        countEl.textContent = ' 1 meeting selected';
        countEl.style.color = 'var(--success)';
    } else {
        countEl.textContent = ` ${count} meetings selected`;
        countEl.style.color = 'var(--success)';
    }
}

function validateFollowUpSelection() {
    const warningEl = document.getElementById('followUpCustomerWarning');
    const createBtn = document.getElementById('createFollowUpBtn');
    
    if (selectedFollowUpMeetings.length === 0) {
        warningEl.style.display = 'none';
        createBtn.disabled = true;
        return false;
    }
    
    // Check if all selected meetings are from the same customer
    const meetings = selectedFollowUpMeetings.map(id => state.meetings.find(m => m.id === id));
    const customerIds = [...new Set(meetings.map(m => m.customerId))];
    
    if (customerIds.length > 1) {
        warningEl.style.display = 'block';
        createBtn.disabled = true;
        return false;
    }
    
    warningEl.style.display = 'none';
    createBtn.disabled = false;
    return true;
}

function updateFollowUpPreview() {
    const previewContent = document.getElementById('followUpPreviewContent');
    
    // Get meeting type
    const type = document.querySelector('input[name="followUpType"]:checked')?.value || 'upcoming';
    const typeLabel = type === 'upcoming' ? 'Upcoming Meeting' : 'Past Meeting';
    
    if (selectedFollowUpMeetings.length === 0) {
        previewContent.innerHTML = `
            <strong>Type:</strong> ${typeLabel}<br>
            <br>
            <small style="color: var(--text-secondary);">Select meetings from Step 2 to continue</small>
        `;
        return;
    }
    
    const meetings = selectedFollowUpMeetings.map(id => state.meetings.find(m => m.id === id));
    const customerName = meetings[0].customerName;
    
    // Count unique tags
    const allTags = meetings.flatMap(m => m.tags || []);
    const uniqueTags = [...new Set(allTags)];
    
    // Count next steps
    const allNextSteps = meetings.filter(m => {
        const nextSteps = m.nextStepsHTML ? htmlToPlainText(m.nextStepsHTML) : m.nextSteps || '';
        return nextSteps.trim();
    });
    
    previewContent.innerHTML = `
        <strong>Customer:</strong> ${escapeHtml(customerName)}<br>
        <strong>Type:</strong> ${typeLabel}<br>
        <strong>Combining data from:</strong> ${meetings.length} meeting${meetings.length > 1 ? 's' : ''}<br>
        <br>
        <strong>Will Include:</strong><br>
         Combined notes from ${meetings.length} meeting${meetings.length > 1 ? 's' : ''}<br>
        ${allNextSteps.length > 0 ? ` Next steps from ${allNextSteps.length} meeting${allNextSteps.length > 1 ? 's' : ''}<br>` : ''}
         ${followUpParticipants.length} selected participant${followUpParticipants.length !== 1 ? 's' : ''}<br>
        ${uniqueTags.length > 0 ? ` ${uniqueTags.length + 1} tags (including "follow-up")<br>` : ' 1 tag ("follow-up")<br>'}
        <br>
        <small style="color: var(--text-secondary);"> You can edit all details after creation</small>
    `;
}


function createFollowUpMeeting() {
    if (!validateFollowUpSelection()) return;
    
    const meetings = selectedFollowUpMeetings.map(id => state.meetings.find(m => m.id === id));
    const type = document.querySelector('input[name="followUpType"]:checked').value;
    const isPastMeeting = type === 'past';
    const dateInput = isPastMeeting ? 
        document.getElementById('followUpDatePast').value : 
        document.getElementById('followUpDateUpcoming').value;
    
    // Get customer info
    const customerId = meetings[0].customerId;
    const customerName = meetings[0].customerName;
    
   // Get the date for the new follow-up meeting
const followUpDate = new Date(dateInput);
const followUpDateStr = followUpDate.toLocaleDateString('en-GB'); // DD/MM/YYYY format

// Get original title for the header
const originalTitle = meetings.length === 1 
    ? meetings[0].title 
    : meetings[0].title; // Use first meeting's title even for multiple

// Create header for the NEW follow-up meeting at the top
let combinedNotes = `<h3 style="color:#107580; margin: 0 0 0.5rem 0;"> Follow-Up: ${escapeHtml(originalTitle)} (${followUpDateStr}) </h3>`;


combinedNotes += '<p><br></p>'; // Space for user to type new notes
combinedNotes += '<br><br>'; // 2 blank lines before previous meeting notes

// Combine notes from selected meetings with separators
meetings.forEach(meeting => {
    const notesText = meeting.notesHTML || meeting.notes || '';
    if (notesText.trim()) {
        const meetingDate = new Date(meeting.date).toLocaleDateString('en-GB'); // DD/MM/YYYY format
        combinedNotes += `<h3> Subject: ${escapeHtml(meeting.title)} (${meetingDate}) </h3>`;
        combinedNotes += notesText;
        combinedNotes += '<br><br>';
    }
});
    
// Combine next steps
let combinedNextSteps = '';
meetings.forEach(meeting => {
    const nextStepsText = meeting.nextStepsHTML || meeting.nextSteps || '';
    if (nextStepsText.trim()) {
        const meetingDate = new Date(meeting.date).toLocaleDateString('en-GB'); // DD/MM/YYYY format
        combinedNextSteps += `<h3> Subject: ${escapeHtml(meeting.title)} (${meetingDate}) </h3>`;
        combinedNextSteps += nextStepsText;
        combinedNextSteps += '<br><br>';
    }
});
    
    // Use selected participants (not automatic merge)
    const selectedParticipants = [...followUpParticipants];
    
    // Merge tags (remove duplicates, add "follow-up")
    const allTags = meetings.flatMap(m => m.tags || []);
    const uniqueTags = [...new Set(allTags)];
    if (!uniqueTags.includes('follow-up')) {
        uniqueTags.push('follow-up');
    }
    
    // Close modal
    closeFollowUpModal();
    
    // Set up state for follow-up meeting
    state.editingMeeting = null;
    state.meetingTasks = [];
    state.meetingParticipants = selectedParticipants;
    state.selectedCustomerId = customerId;
    state.meetingIsPastMeeting = isPastMeeting;
    
    // Open meeting form
    hideUpcomingMeetings();
    hideCustomerParticipantsSection();
    document.getElementById('inlineCustomerInfoForm').classList.remove('active');

    document.getElementById('customerCustomerInfosSection').classList.remove('active');
    document.getElementById('customerMeetingsSection').classList.remove('active');
    document.querySelector('.tasks-section').style.display = 'none';
    document.getElementById('notesContainer').classList.add('hidden');
    document.getElementById('mainContainer').classList.add('form-mode');
    
    // Set title
    const titleElement = document.getElementById('meetingFormTitle');
    if (titleElement) {
        if (meetings.length === 1) {
            titleElement.textContent = `+ Follow-Up from "${meetings[0].title}"`;
        } else {
            titleElement.textContent = `+ Follow-Up from ${meetings.length} Meetings`;
        }
    }
    
    // Pre-fill form with combined data
    document.getElementById('meetingForm').reset();
    document.getElementById('meetingId').value = '';
    document.getElementById('meetingTitle').value = `Follow-Up: ${originalTitle}`;
    document.getElementById('meetingDate').value = dateInput;
    document.getElementById('meetingCustomerInput').value = customerName;
    document.getElementById('meetingTags').value = uniqueTags.join(', ');
    
    // Set notes
    setEditorHTML('meetingNotesEditor', combinedNotes);
    
    // Set next steps
    setEditorHTML('meetingNextStepsEditor', combinedNextSteps);
    
    // Render participants list
    renderParticipantsList();
    
    // Load customer info
    loadCustomerInfoForCustomer(customerId);
    
    // Show the form
    document.getElementById('inlineMeetingForm').classList.add('active');
    
    // Reset tabs to Info tab
    document.querySelectorAll('#inlineMeetingForm .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#inlineMeetingForm .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#inlineMeetingForm .modal-tab[data-tab="info"]').classList.add('active');
    document.querySelector('#inlineMeetingForm [data-tab-content="info"]').classList.add('active');
    
    showToast(` Follow-up created from ${meetings.length} meeting${meetings.length > 1 ? 's' : ''}!`, 'success');
    window.scrollTo(0, 0);
}

// ========== SHARING FEATURE FUNCTIONS - START ==========



// Initialize sharing data
async function loadSharingData() {
    if (!auth.currentUser) {
        state.sharedMeetings = [];
        state.myShares = [];
        updateShareNotificationBadge();
        return;
    }
    
    try {
        // Load meetings shared WITH me
        const sharedWithMe = await db.collection('sharedMeetings')
            .where('sharedWithEmail', '==', auth.currentUser.email.toLowerCase())
            .get();
        
        state.sharedMeetings = sharedWithMe.docs.map(doc => doc.data());
        
        // Load meetings shared BY me
        const sharedByMe = await db.collection('sharedMeetings')
            .where('sharedBy', '==', auth.currentUser.uid)
            .get();
        
        state.myShares = sharedByMe.docs.map(doc => doc.data());
        
        updateShareNotificationBadge();
    } catch (error) {
        console.error('Error loading shares:', error);
    }
}


function saveSharingData() {
    updateShareNotificationBadge();
}

function updateShareNotificationBadge() {
    const badge = document.getElementById('sharedNotificationBadge');
    const pendingCount = state.sharedMeetings.filter(s => s.status === 'pending').length;
    
    if (pendingCount > 0) {
        badge.textContent = pendingCount;
        badge.style.display = 'block';
    } else {
        badge.style.display = 'none';
    }
}

function updateSharedBadge() {
    updateShareNotificationBadge();
}


// Open share modal
let currentSharingMeetingId = null;

function openShareModal(meetingId) {
    //  Reset any previous state first
    currentSharingMeetingId = null;
    
    //  Make sure modal is fully closed before reopening
    const modal = document.getElementById('shareModal');
    modal.classList.remove('active');
    
    //  Small delay to ensure clean state
    setTimeout(() => {
        currentSharingMeetingId = meetingId;
        const meeting = state.meetings.find(m => m.id === meetingId);
        
        if (!meeting) {
            console.error('Meeting not found:', meetingId);
            showToast(' Meeting not found', 'error');
            return;
        }
        
        document.getElementById('shareModalTitle').textContent = ` Share "${meeting.title}"`;
        document.getElementById('shareModalMeetingId').value = meetingId;
        document.getElementById('shareEmailInput').value = '';
        document.getElementById('shareMessageInput').value = '';
        document.getElementById('shareNotifyEmail').checked = true;
        
        // Reset tab checkboxes to default (info and notes)
        document.querySelectorAll('input[name="shareTab"]').forEach(cb => {
            cb.checked = (cb.value === 'info' || cb.value === 'notes');
        });
        
        // Switch to first tab
        document.querySelectorAll('.share-modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.share-tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector('.share-modal-tab[data-share-tab="new"]').classList.add('active');
        document.querySelector('.share-tab-content[data-share-tab-content="new"]').classList.add('active');
        
        // Render shared with list
        renderSharedWithList(meetingId);
        
        // Setup link sharing
        setupLinkSharing(meetingId);
        
        //  Force modal to be visible
        modal.style.display = 'flex';
        modal.classList.add('active');
        
        console.log('Share modal opened for meeting:', meetingId); // Debug log
    }, 50);
}

function closeShareModal() {
    const modal = document.getElementById('shareModal');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
    }
    currentSharingMeetingId = null;
}

// Setup share modal tabs
function setupShareModalTabs() {
    document.querySelectorAll('.share-modal-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.shareTab;
            
            document.querySelectorAll('.share-modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.share-tab-content').forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            document.querySelector(`.share-tab-content[data-share-tab-content="${tabName}"]`).classList.add('active');
        });
    });
}

// Send share invite
async function sendShareInvite() {
    const meetingId = document.getElementById('shareModalMeetingId').value;
    const email = document.getElementById('shareEmailInput').value.trim().toLowerCase();
    const selectedTabs = Array.from(document.querySelectorAll('input[name="shareTab"]:checked')).map(cb => cb.value);
    const message = document.getElementById('shareMessageInput').value.trim();
    const notifyByEmail = document.getElementById('shareNotifyEmail').checked;
    
    if (!auth.currentUser) {
        showToast(' Sign in to share meetings', 'error');
        return;
    }
    
    if (selectedTabs.length === 0) {
        showToast(' Select at least one tab to share', 'error');
        return;
    }
    
    if (!email || !email.includes('@')) {
        showToast(' Enter valid email', 'error');
        return;
    }
    
    if (email === auth.currentUser.email.toLowerCase()) {
        showToast(' Cannot share with yourself', 'error');
        return;
    }
    
    const meeting = state.meetings.find(m => m.id === meetingId);
    if (!meeting) return;
    
    // Check if already shared
    if (state.myShares.some(s => s.meetingId === meetingId && s.sharedWithEmail === email)) {
        showToast(' Already shared with this user', 'error');
        return;
    }
    
    try {
        // Build shared data based on selected tabs
        const sharedData = {
            id: meeting.id,
            customerName: meeting.customerName,
            title: meeting.title,
            date: meeting.date,
            type: meeting.type,
            duration: meeting.duration
        };
        
        if (selectedTabs.includes('info')) {
            sharedData.participants = meeting.participants;
            sharedData.tags = meeting.tags;
        }
        if (selectedTabs.includes('notes')) {
            sharedData.notes = meeting.notes;
            sharedData.notesHTML = meeting.notesHTML;
            sharedData.nextSteps = meeting.nextSteps;
            sharedData.nextStepsHTML = meeting.nextStepsHTML;
        }
        if (selectedTabs.includes('meddpicc')) {
            sharedData.meddpicc = meeting.meddpicc;
        }
        if (selectedTabs.includes('actions')) {
            sharedData.associatedTasks = state.tasks.filter(t => t.meetingId === meetingId).map(t => ({
                title: t.title || '',
                description: t.description || '',
                priority: t.priority || 'medium',
                status: t.status || 'todo',
                dueDate: t.dueDate || '',
                tags: Array.isArray(t.tags) ? [...t.tags] : [],
                subtasks: Array.isArray(t.subtasks) ? [...t.subtasks] : [],
                color: t.color || 'none',
                completed: t.completed || false
            }));
        }
        
        const shareId = `share_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        const shareRecord = {
            id: shareId,
            meetingId: meetingId,
            meetingTitle: meeting.title,
            meetingData: sharedData,
            sharedBy: auth.currentUser.uid,
            sharedByEmail: auth.currentUser.email,
            sharedByName: auth.currentUser.displayName || auth.currentUser.email,
            sharedWithEmail: email,
            sharedTabs: selectedTabs,
            message: message,
            status: 'pending',
            createdAt: new Date().toISOString()
        };
        
                // Save to Firestore shared collection
        await db.collection('sharedMeetings').doc(shareId).set(shareRecord);
        
        // Send email notification if enabled
        if (notifyByEmail) {
            try {
                await db.collection('mail').add({
                    to: email,
                    template: {
                        name: 'shareNotification',
                        data: {
                            senderName: auth.currentUser.displayName || auth.currentUser.email,
                            senderEmail: auth.currentUser.email,
                            meetingTitle: meeting.title,
                            meetingDate: new Date(meeting.date).toLocaleDateString(),
                            customerName: meeting.customerName || '',
                            message: message,
                            sharedTabs: selectedTabs.join(', '),
                            appUrl: window.location.origin
                        }
                    }
                });
            } catch (emailError) {
                console.warn('Email notification failed:', emailError);
            }
        }
        
        // Update local state
        state.myShares.push(shareRecord);
        saveData();
        
        renderSharedWithList(meetingId);
        document.getElementById('shareEmailInput').value = '';
        document.getElementById('shareMessageInput').value = '';
        
        // Show success window (this also closes the share modal)
        showShareSuccess(email);
        
    } catch (error) {
        console.error('Share error:', error);
        showToast(' Failed to share: ' + error.message, 'error');
    }
}


// Render shared with list
function renderSharedWithList(meetingId) {
    const container = document.getElementById('sharedWithList');
    const shares = state.myShares.filter(s => s.meetingId === meetingId);
    
    if (shares.length === 0) {
        container.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.85rem;">Not shared yet</div>';
        return;
    }
    
    container.innerHTML = shares.map(share => {
        const email = share.sharedWithEmail || 'Unknown';
        const initial = email[0].toUpperCase();
        const statusColor = share.status === 'accepted' ? '#10b981' : share.status === 'declined' ? '#ef4444' : '#f59e0b';
        const statusText = share.status === 'accepted' ? 'Accepted' : share.status === 'declined' ? 'Declined' : 'Pending';
        
        return `
            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 8px;">
                <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.8rem;">${initial}</div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 0.85rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${email}</div>
                    <div style="font-size: 0.75rem; color: ${statusColor};">${statusText}</div>
                </div>
            </div>
        `;
    }).join('');
}


// Remind share
function remindShare(shareId) {
    // In real implementation, this would send an email
    showToast(' Reminder sent!', 'success');
}

// Link sharing functions
function setupLinkSharing(meetingId) {
    const linkEnabled = state.myShares.some(s => s.meetingId === meetingId && s.isPublicLink);
    document.getElementById('linkSharingEnabled').checked = linkEnabled;
    
    if (linkEnabled) {
        const linkShare = state.myShares.find(s => s.meetingId === meetingId && s.isPublicLink);
        document.getElementById('shareLinkUrl').value = `https://salesflow.app/m/${meetingId}`;
        document.getElementById('linkPermissionLevel').value = linkShare.permission;
        document.getElementById('linkExpiration').value = linkShare.expiration || 'never';
        document.getElementById('linkSharingOptions').style.display = 'block';
    } else {
        document.getElementById('linkSharingOptions').style.display = 'none';
    }
}

function toggleLinkSharing() {
    const enabled = document.getElementById('linkSharingEnabled').checked;
    const meetingId = currentSharingMeetingId;
    
    if (enabled) {
        // Create public link share
        const linkShare = {
            id: `link_${Date.now()}`,
            meetingId: meetingId,
            isPublicLink: true,
            permission: 'view',
            expiration: 'never',
            createdAt: new Date().toISOString()
        };
        
        state.myShares.push(linkShare);
        document.getElementById('shareLinkUrl').value = `https://salesflow.app/m/${meetingId}`;
        document.getElementById('linkSharingOptions').style.display = 'block';
        
        showToast(' Link sharing enabled', 'success');
    } else {
        // Remove public link share
        state.myShares = state.myShares.filter(s => !(s.meetingId === meetingId && s.isPublicLink));
        document.getElementById('linkSharingOptions').style.display = 'none';
        
        showToast(' Link sharing disabled', 'success');
    }
    
    saveSharingData();
}

function copyShareLink() {
    const linkUrl = document.getElementById('shareLinkUrl').value;
    navigator.clipboard.writeText(linkUrl).then(() => {
        showToast(' Link copied!', 'success');
    });
}

function showSharedMeetings() {
    state.currentCustomer = 'all';
    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
    
    // Hide other sections
    document.getElementById('inlineMeetingForm').classList.remove('active');
    document.getElementById('inlineCustomerInfoForm').classList.remove('active');

    document.getElementById('customerCustomerInfosSection').classList.remove('active');
    document.getElementById('customerMeetingsSection').classList.remove('active');
    hideCustomerParticipantsSection();
    hideUpcomingMeetings();
    hideCustomerActivity();
    hideAllCustomersSection();
    
    // Hide tasks and notes
    document.querySelector('.tasks-section').style.display = 'none';
    document.getElementById('notesContainer').classList.add('hidden');
    
    // Show shared section
    document.getElementById('sharedMeetingsSection').classList.add('active');
    
    // Update title
    document.getElementById('mainSectionTitle').textContent = 'Shared Meetings';
    
    // Hide header banner
    document.getElementById('customerHeaderBanner').classList.remove('active');
    
    // Smart default: If there are pending shares WITH me, show those first
    // Otherwise, show all shared meetings
    const pendingWithMe = state.sharedMeetings.filter(sm => sm.status === 'pending').length;
    
    if (pendingWithMe > 0) {
        document.getElementById('sharedViewFilter').value = 'with-me';
    } else {
        document.getElementById('sharedViewFilter').value = 'all';
    }
    
    // Render
    renderSharedMeetings();
}

let currentSharedStatusFilter = 'all';


function showShareSuccess(email) {
    // First close the share modal
    const shareModal = document.getElementById('shareModal');
    if (shareModal) {
        shareModal.classList.remove('active');
        shareModal.style.display = 'none';
    }
    currentSharingMeetingId = null;
    
    // Configure the confirm modal as a success message
    document.getElementById('confirmIcon').textContent = '';
    document.getElementById('confirmTitle').textContent = 'Meeting Shared!';
    document.getElementById('confirmMessage').textContent = `Meeting has been shared with ${email}!`;
    
    // Hide cancel button for this use
    const cancelBtn = document.getElementById('cancelConfirmBtn');
    cancelBtn.style.display = 'none';
    
    // Configure OK button
    const confirmBtn = document.getElementById('confirmBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.textContent = 'OK';
    newConfirmBtn.className = 'btn btn-primary';
    
    newConfirmBtn.addEventListener('click', () => {
        document.getElementById('confirmModal').classList.remove('active');
        // Restore cancel button for future confirms
        document.getElementById('cancelConfirmBtn').style.display = '';
        // Reset confirm button styling
        const btn = document.getElementById('confirmBtn');
        btn.textContent = 'Confirm';
        btn.className = 'btn btn-danger';
    });
    
    state.confirmCallback = null;
    document.getElementById('confirmModal').classList.add('active');
}

function filterSharedByStatus(status) {
    currentSharedStatusFilter = status;
    
    document.querySelectorAll('.shared-status-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.shared-status-btn[data-status="${status}"]`).classList.add('active');
    
    renderSharedMeetings();
}

function renderSharedMeetings() {
    const container = document.getElementById('sharedMeetingsGrid');
    const empty = document.getElementById('sharedMeetingsEmpty');
    const viewFilter = document.getElementById('sharedViewFilter').value;
    const searchQuery = document.getElementById('sharedSearchInput').value.toLowerCase();
    
    let meetings = [];
    
    // Filter by view type
    if (viewFilter === 'with-me') {
        meetings = state.sharedMeetings.map(sm => ({
            ...sm,
            viewType: 'with-me'
        }));
    } else if (viewFilter === 'by-me') {
        meetings = state.myShares
            .filter(s => !s.isPublicLink)
            .map(share => {
                const meeting = state.meetings.find(m => m.id === share.meetingId);
                return {
                    ...share,
                    meetingData: meeting,
                    viewType: 'by-me'
                };
            });
    } else {
        // All
        const withMe = state.sharedMeetings.map(sm => ({
            ...sm,
            viewType: 'with-me'
        }));
        const byMe = state.myShares
            .filter(s => !s.isPublicLink)
            .map(share => {
                const meeting = state.meetings.find(m => m.id === share.meetingId);
                return {
                    ...share,
                    meetingData: meeting,
                    viewType: 'by-me'
                };
            });
        meetings = [...withMe, ...byMe];
    }
    
    // Filter by status
    if (currentSharedStatusFilter !== 'all') {
        meetings = meetings.filter(m => m.status === currentSharedStatusFilter);
    }
    
    // Filter by search
    if (searchQuery) {
        meetings = meetings.filter(m => {
            const title = m.meetingData?.title || m.meetingTitle || '';
            const customer = m.meetingData?.customerName || '';
            return title.toLowerCase().includes(searchQuery) || 
                   customer.toLowerCase().includes(searchQuery);
        });
    }
    
    // Sort by date (newest first)
    meetings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    if (meetings.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    
    container.innerHTML = meetings.map(item => {
        const meeting = item.meetingData || item;
        const title = meeting.title || item.meetingTitle;
        const customerName = meeting.customerName || '';
        const meetingDate = meeting.date ? new Date(meeting.date).toLocaleDateString() : '';
        
                const notesText = meeting.notesHTML ? htmlToPlainText(meeting.notesHTML) : meeting.notes || '';
        const isLongNotes = notesText.length > 120 || notesText.split('\n').length > 2;
        
       // Inside renderSharedMeetings() function
if (item.viewType === 'with-me') {
    // Shared WITH me
    
    // Count tasks if they exist
    const taskCount = item.meetingData.associatedTasks ? item.meetingData.associatedTasks.length : 0;
    
    return `
        <div class="shared-meeting-card ${item.status}">
            <div class="shared-card-header">
                <span class="shared-card-badge ${item.status === 'pending' ? 'new' : 'accepted'}">
                    ${item.status === 'pending' ? ' NEW' : ' ACCEPTED'}
                </span>
            </div>
            <div class="shared-card-title">${escapeHtml(title)}${customerName ? ` - ${escapeHtml(customerName)}` : ''}</div>
            <div class="shared-card-meta">
                <span class="shared-card-meta-item">
                    <span></span>
                    <span>Shared by: ${escapeHtml(item.sharedByName)}</span>
                </span>
${meetingDate ? `
    <span class="shared-card-meta-item">
        <span>${getCalendarSVG(14)}</span>
        <span>${meetingDate}</span>
    </span>
` : ''}
                <span class="shared-card-meta-item">
                    <span></span>
                    <span>${item.sharedTabs ? item.sharedTabs.join(', ') : 'All tabs'}</span>
                </span>
                ${taskCount > 0 ? `
                    <span class="shared-card-meta-item">
                        <span></span>
                        <span>${taskCount} task${taskCount !== 1 ? 's' : ''} included</span>
                    </span>
                ` : ''}
            </div>
                       ${notesText ? `
                <div class="shared-card-preview" style="margin-bottom: 0.5rem;">
                    <strong> Notes Preview:</strong><br>
                    <div class="meeting-summary-notes-content" id="shared-notes-${item.id}" style="max-height: 50px; overflow: hidden; margin-top: 0.5rem;">${escapeHtml(notesText)}</div>
                    ${isLongNotes ? `
                        <button class="meeting-summary-notes-toggle" onclick="event.stopPropagation(); toggleSharedNotesExpand('shared-notes-${item.id}', this)" style="margin-top: 0.5rem;">
                            Show More 
                        </button>
                    ` : ''}
                </div>
            ` : ''}
            
            <!-- THIS IS THE GREEN BACKGROUND SECTION -->
            ${taskCount > 0 ? `
                <div class="shared-card-preview" style="background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; margin-top: 0.5rem;">
                     <strong>Tasks Preview:</strong><br>
                    ${item.meetingData.associatedTasks.slice(0, 3).map(t => 
                        ` ${escapeHtml(t.title)}`
                    ).join('<br>')}
                    ${taskCount > 3 ? `<br> ... and ${taskCount - 3} more` : ''}
                </div>
            ` : ''}
            
            <div class="shared-card-actions">
                ${item.status === 'pending' ? `
                    <button class="shared-action-btn primary" onclick="openAcceptMeetingModal('${item.id}')">
                         Accept & Add
                    </button>
                    <button class="shared-action-btn secondary" onclick="viewSharedMeeting('${item.id}')">
     Preview & Edit
</button>
                    <button class="shared-action-btn danger" onclick="declineSharedMeeting('${item.id}')">
                         Decline
                    </button>
                               ` : `
                    <button class="shared-action-btn primary" onclick="openSharedMeeting('${item.id}')">
                         Open Meeting
                    </button>
                `}
            </div>
        </div>
    `;
} else {
    // Shared BY me
    const allSharesForMeeting = state.myShares.filter(s => s.meetingId === item.meetingId && !s.isPublicLink);
    const shareCount = allSharesForMeeting.length;
    const sharedDate = new Date(item.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    
    return `
        <div class="shared-meeting-card shared-by-me">
            <div class="shared-card-header">
                <span class="shared-card-badge shared"> SHARED BY YOU</span>
            </div>
            <div class="shared-card-title">${escapeHtml(title)}${customerName ? ` - ${escapeHtml(customerName)}` : ''}</div>
            <div class="shared-card-meta">
                ${meetingDate ? `
                    <span class="shared-card-meta-item">
                        <span></span>
                        <span>Meeting: ${meetingDate}</span>
                    </span>
                ` : ''}
                <span class="shared-card-meta-item">
                    <span></span>
                    <span>Shared: ${sharedDate}</span>
                </span>
                <span class="shared-card-meta-item">
                    <span></span>
                    <span>With ${shareCount} ${shareCount === 1 ? 'person' : 'people'}</span>
                </span>
            </div>
            
            <!-- List of people shared with -->
            <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem;">
                <div style="font-size: 0.75rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.5rem;">
                     Shared With:
                </div>
                ${allSharesForMeeting.map(share => `
<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--bg-primary); border-radius: 4px; margin-bottom: 0.35rem;">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span>${share.sharedWithName.split(' ').map(n => n[0]).join('').toUpperCase()}</span>
        <div>
            <div style="font-weight: 600; font-size: 0.85rem;">${escapeHtml(share.sharedWithName)}</div>
            <div style="font-size: 0.7rem; color: var(--text-secondary);">${escapeHtml(share.sharedWithEmail)}</div>
        </div>
    </div>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span class="shared-status-badge ${share.status}">
            ${share.status === 'pending' ? ' Pending' : ' Accepted'}
        </span>
    </div>
</div>
                `).join('')}
            </div>
            
            <div class="shared-card-actions">
                <button class="shared-action-btn primary" onclick="openShareModal('${item.meetingId}')">
                    + Share with More
                </button>
                <button class="shared-action-btn secondary" onclick="editMeeting('${item.meetingId}')">
                     Edit Meeting
                </button>
            </div>
        </div>
    `;
}    }).join('');
}

// Accept meeting modal
function openAcceptMeetingModal(sharedMeetingId) {
    const sharedMeeting = state.sharedMeetings.find(sm => sm.id === sharedMeetingId);
    if (!sharedMeeting) return;
    
    // Close the editing form if it's open
    if (document.getElementById('inlineMeetingForm').classList.contains('active')) {
        closeInlineMeetingForm();
    }
    
    document.getElementById('acceptMeetingId').value = sharedMeetingId;
    
    // Reset customer input
    document.getElementById('acceptMeetingCustomerInput').value = '';
    document.getElementById('acceptMeetingCustomer').value = '';
    updateAcceptCustomerDropdown('');    
    // Populate tab dropdown
    const tabSelect = document.getElementById('acceptMeetingTab');
    tabSelect.innerHTML = '<option value="all">All Meetings</option><option value="individual">Individual</option>';
    state.meetingTabs.forEach(tab => {
        if (!tab.isDefault) {
            const option = document.createElement('option');
            option.value = tab.id;
            option.textContent = tab.name;
            tabSelect.appendChild(option);
        }
    });
    
    document.getElementById('acceptMeetingModal').classList.add('active');
}


function toggleSharedNotesExpand(elementId, buttonElement) {
    const content = document.getElementById(elementId);
    
    if (!content || !buttonElement) return;
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        content.style.maxHeight = '50px';
        buttonElement.textContent = 'Show More ';
    } else {
        content.classList.add('expanded');
        content.style.maxHeight = '500px';
        buttonElement.textContent = 'Show Less ';
    }
}


function closeAcceptMeetingModal() {
    document.getElementById('acceptMeetingModal').classList.remove('active');
}

async function acceptSharedMeeting() {
    const sharedMeetingId = document.getElementById('acceptMeetingId').value;
    let customerId = document.getElementById('acceptMeetingCustomer').value;
    const customerInputValue = document.getElementById('acceptMeetingCustomerInput').value.trim();
    const tabId = document.getElementById('acceptMeetingTab').value;
    
    if (!customerId && !customerInputValue) {
        showToast(' Enter a customer name', 'error');
        return;
    }
    
    const sharedMeeting = state.sharedMeetings.find(sm => sm.id === sharedMeetingId);
    if (!sharedMeeting) return;
    
    let customer = state.customers.find(c => c.id === customerId);
    
    if (!customer && customerInputValue) {
        customer = {
            id: Date.now().toString(),
            name: customerInputValue,
            createdAt: new Date().toISOString()
        };
        state.customers.push(customer);
        customerId = customer.id;
    }
    
    try {
        // Update status in Firestore
        await db.collection('sharedMeetings').doc(sharedMeetingId).update({
            status: 'accepted',
            acceptedAt: new Date().toISOString()
        });
        
        // Update local state
        sharedMeeting.status = 'accepted';
        
        // Create local copy of meeting
        const newMeeting = {
            ...sharedMeeting.meetingData,
            id: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            customerId: customerId,
            customerName: customer.name,
            tabId: tabId,
            originalSharedFrom: sharedMeetingId,
isPastMeeting: true,
            createdAt: new Date().toISOString()
        };
        
        state.meetings.unshift(newMeeting);
        
                // Create tasks if included
        if (sharedMeeting.meetingData.associatedTasks && Array.isArray(sharedMeeting.meetingData.associatedTasks)) {
            sharedMeeting.meetingData.associatedTasks.forEach((t, index) => {
                // Small delay to ensure unique IDs
                const uniqueId = `${Date.now()}_${index}_${Math.random().toString(36).substr(2, 9)}`;
                
                state.tasks.unshift({
                    id: uniqueId,
                    title: t.title || 'Untitled Task',
                    description: t.description || '',
                    priority: t.priority || 'medium',
                    status: t.status || 'todo',
                    dueDate: t.dueDate || '',
                    tags: Array.isArray(t.tags) ? t.tags : [],
                    color: t.color || 'none',
                    subtasks: Array.isArray(t.subtasks) ? t.subtasks : [],
                    completed: t.completed || false,
                    archived: false,
                    customerId: customerId,
                    customerName: customer.name,
                    meetingId: newMeeting.id,
                    createdAt: new Date().toISOString()
                });
            });
        }
        
                saveData();
        renderCustomerFilters();
        closeAcceptMeetingModal();
        
        // Update the notification badge since pending count changed
        updateShareNotificationBadge();
        
        selectCustomerFromOverview(customerId);
        showToast(' Meeting added!', 'success');
        
    } catch (error) {
        console.error('Accept error:', error);
        showToast(' Failed: ' + error.message, 'error');
    }
}


function updateAcceptCustomerDropdown(searchTerm = '') {
    const dropdown = document.getElementById('acceptCustomerDropdown');
    const filteredCustomers = state.customers.filter(c => 
        c.name.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    let html = '';
    
    if (searchTerm && !filteredCustomers.some(c => c.name.toLowerCase() === searchTerm.toLowerCase())) {
        html += `<div class="customer-dropdown-item new-customer" onclick="selectNewAcceptCustomer('${escapeHtml(searchTerm)}')">
             Add "${escapeHtml(searchTerm)}"
        </div>`;
    }
    
    filteredCustomers.forEach(customer => {
        html += `
            <div class="customer-dropdown-item" onclick="selectExistingAcceptCustomer('${customer.id}')">
                <div class="customer-dropdown-item-name">${escapeHtml(customer.name)}</div>
                ${customer.email ? `<div class="customer-dropdown-item-email">${escapeHtml(customer.email)}</div>` : ''}
            </div>
        `;
    });
    
    if (filteredCustomers.length === 0 && !searchTerm) {
        html = '<div class="customer-dropdown-item" style="text-align: center; color: var(--text-secondary); font-size: 0.75rem;">No customers</div>';
    }
    
    dropdown.innerHTML = html;
}

function selectExistingAcceptCustomer(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (customer) {
        document.getElementById('acceptMeetingCustomerInput').value = customer.name;
        document.getElementById('acceptMeetingCustomer').value = customerId;
        document.getElementById('acceptCustomerDropdown').classList.remove('active');
    }
}

function selectNewAcceptCustomer(customerName) {
    document.getElementById('acceptMeetingCustomerInput').value = customerName;
    document.getElementById('acceptMeetingCustomer').value = ''; // Empty = will create new
    document.getElementById('acceptCustomerDropdown').classList.remove('active');
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('#acceptMeetingCustomerInput') && 
        !e.target.closest('#acceptCustomerDropdown')) {
        document.getElementById('acceptCustomerDropdown')?.classList.remove('active');
    }
});

function declineSharedMeeting(sharedMeetingId) {
    showConfirm('', 'Decline?', 'Decline this shared meeting?', async () => {
        try {
            await db.collection('sharedMeetings').doc(sharedMeetingId).delete();
            state.sharedMeetings = state.sharedMeetings.filter(sm => sm.id !== sharedMeetingId);
            renderSharedMeetings();
            updateShareNotificationBadge();
            showToast(' Declined', 'success');
        } catch (error) {
            showToast(' Failed: ' + error.message, 'error');
        }
    });
}

function viewSharedMeeting(sharedMeetingId) {
    const sharedMeeting = state.sharedMeetings.find(sm => sm.id === sharedMeetingId);
    if (!sharedMeeting) return;
    
    // Store which shared meeting we're editing
    editingSharedMeetingId = sharedMeetingId;
    
    // Populate state.meetingTasks from shared data BEFORE opening form
    if (sharedMeeting.meetingData.associatedTasks && sharedMeeting.meetingData.associatedTasks.length > 0) {
        state.meetingTasks = sharedMeeting.meetingData.associatedTasks.map(t => t.title);
    } else {
        state.meetingTasks = [];
    }
    
    //  Pass true as third parameter to preserve shared data
    openInlineMeetingForm(sharedMeeting.meetingData, true, true);  
    
    // Hide shared meetings section
    document.getElementById('sharedMeetingsSection')?.classList.remove('active');
}


function openSharedMeeting(sharedMeetingId) {
    const sharedMeeting = state.sharedMeetings.find(sm => sm.id === sharedMeetingId);
    if (!sharedMeeting) return;
    
    if (sharedMeeting.status === 'accepted') {
        // Find the actual meeting that was created from this share
        const actualMeeting = state.meetings.find(m => m.originalSharedFrom === sharedMeetingId);
        
        if (actualMeeting) {
            // Open the REAL meeting (which has the tasks linked to it)
            openInlineMeetingForm(actualMeeting);
            
            // Close shared meetings section
            document.getElementById('sharedMeetingsSection').classList.remove('active');
            
            return;
        }
    }
    
    // Fallback to preview mode for pending/unaccepted meetings
    viewSharedMeeting(sharedMeetingId);
}

// ========== SHARING FEATURE FUNCTIONS - END ==========

// ========== AI ASSISTANT FUNCTIONS - START ==========

//  DELETE THIS SECTION WHEN SWITCHING TO FIREBASE 

// ========== LOCAL TESTING ONLY - START ==========
const GEMINI_API_KEY = 'AIzaSyBSLmfwUtcMpioSUGZgtLljxjY1yfS6u4c';

async function callGeminiAPI(prompt) {
    try {
        //  Call Gemini API directly (CORS is supported for API key auth)
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 4096,
                }
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('API Error:', errorData);
            throw new Error(`API returned ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
        }
        
        const data = await response.json();
        
        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
            throw new Error('No response from AI');
        }
        
        console.log(' AI response received');
        return data.candidates[0].content.parts[0].text;
        
    } catch (error) {
        console.error(' AI Error:', error);
        throw new Error(`AI service unavailable: ${error.message}`);
    }
}
// ========== LOCAL TESTING ONLY - END ==========
//  DELETE ABOVE SECTION WHEN SWITCHING TO FIREBASE 


//  KEEP EVERYTHING BELOW - Works for both local and Firebase 




async function aiImproveText(editorId) {
    const editor = document.getElementById(editorId);
    const currentText = editor.innerText.trim();
    
    //  Validation
    if (!currentText) {
        showToast(' Write some text first', 'error');
        return;
    }
    
    if (currentText.length < 10) {
        showToast(' Text too short to improve (min 10 characters)', 'error');
        return;
    }
    
    if (currentText.length > 5000) {
        showToast(' Text too long (max 5000 characters). Try improving sections separately.', 'error');
        return;
    }
    
    //  Save original for undo
    const originalHTML = editor.innerHTML;
    
    //  Show loading state
    editor.classList.add('editor-loading');
    editor.contentEditable = false;
    
    try {
        const fieldType = editorId === 'meetingNotesEditor' ? 'notes' : 'nextSteps';
        
        //  Different prompts for notes vs next steps
        const prompts = {
            notes: `You are a professional sales assistant. Improve these meeting notes by:

1. Fix any grammar, spelling, or punctuation errors
2. Organize into clear sections with headers (use ### for headers)
3. Make the language more professional and concise
4. Highlight key decisions, concerns, and commitments in bold
5. Keep ALL important information - don't remove anything
6. Add relevant emojis to section headers (e.g.,  Discussion,  Decisions,  Concerns)

Return the improved notes in markdown format.

Meeting Notes:
${currentText}`,
            
            nextSteps: `You are a professional sales assistant. Improve these next steps by:

1. Fix grammar and make language clear and actionable
2. Ensure each item starts with a strong action verb (e.g., "Send", "Schedule", "Follow up", "Prepare")
3. Add specific details where appropriate (e.g., "by Friday", "with VP of Sales")
4. Organize by priority (most urgent first)
5. Keep ALL items - don't remove anything
6. Format as a clear bulleted or numbered list

Return as an organized action list.

Next Steps:
${currentText}`
        };
        
        const prompt = prompts[fieldType];
        
        //  REPLACE THIS BLOCK WHEN SWITCHING TO FIREBASE 
        // ========== LOCAL VERSION - START ==========
        const improvedText = await callGeminiAPI(prompt);
        // ========== LOCAL VERSION - END ==========
        
        /* ========== FIREBASE VERSION (COMMENTED OUT FOR NOW) - START ==========
        //  UNCOMMENT THIS WHEN SWITCHING TO FIREBASE:
        
        // Check authentication
        if (!firebase.auth().currentUser) {
            throw new Error('Please sign in to use AI features');
        }
        
        // Call Firebase Function
        const aiImprove = firebase.functions().httpsCallable('aiImproveText');
        const result = await aiImprove({
            text: currentText,
            fieldType: fieldType
        });
        
        const improvedText = result.data.result;
        const remaining = result.data.remaining;
        
        // Show remaining quota
        if (remaining <= 5) {
            setTimeout(() => {
                showToast(` ${remaining} AI requests left today`, 'warning');
            }, 2000);
        }
        
        ========== FIREBASE VERSION (COMMENTED OUT FOR NOW) - END ========== */
        
        //  Convert markdown to HTML (KEEP THIS - works for both)
        let formattedHTML = improvedText
            // Headers
            .replace(/### (.+)/g, '<h3 style="color: var(--primary); margin: 1rem 0 0.5rem 0; font-size: 1rem; font-weight: 700;">$1</h3>')
            .replace(/## (.+)/g, '<h2 style="color: var(--primary); margin: 1.5rem 0 0.75rem 0; font-size: 1.1rem; font-weight: 700;">$1</h2>')
            // Bold
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            // Italic
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            // Bullet points
            .replace(/^- (.+)/gm, ' $1')
            .replace(/^\* (.+)/gm, ' $1')
            // Numbered lists (preserve numbers)
            .replace(/^(\d+)\.\s+(.+)/gm, '<div style="margin-left: 0.5rem; margin-bottom: 0.25rem;"><strong>$1.</strong> $2</div>')
            // Paragraphs
            .replace(/\n\n/g, '</p><p>')
            // Line breaks
            .replace(/\n/g, '<br>');
        
        // Wrap in paragraphs if not already
        if (!formattedHTML.startsWith('<h') && !formattedHTML.startsWith('<div')) {
            formattedHTML = '<p>' + formattedHTML + '</p>';
        }
        
        //  Add AI badge with undo button (KEEP THIS)
        const finalHTML = `
            <div class="ai-improvement-badge">
                <span style="font-size: 0.85rem; color: #667eea; font-weight: 600;">
                     Improved by AI
                </span>
                <button type="button" onclick="undoAiImprovement('${editorId}', \`${originalHTML.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" 
                        title="Undo AI changes">
                     Undo
                </button>
            </div>
            ${formattedHTML}
        `;
        
        editor.innerHTML = finalHTML;
        showToast(' Text improved by AI!', 'success');
        
    } catch (error) {
        console.error('AI Error:', error);
        editor.innerHTML = originalHTML;
        
        //  Error handling (KEEP THIS)
        if (error.message.includes('API key not valid') || error.message.includes('API_KEY_INVALID')) {
            showToast(' Invalid API key. Get one from https://makersuite.google.com/app/apikey', 'error');
        } else if (error.message.includes('quota') || error.message.includes('RESOURCE_EXHAUSTED')) {
            showToast(' Daily quota exceeded. Try again tomorrow! ', 'error');
        } else if (error.message.includes('unauthenticated')) {
            showToast(' Please sign in to use AI features', 'error');
        } else if (error.message.includes('resource-exhausted')) {
            showToast(' Daily AI limit reached (20/day). Try again tomorrow! ', 'error');
        } else {
            showToast(' AI failed: ' + error.message, 'error');
        }
    } finally {
        editor.classList.remove('editor-loading');
        editor.contentEditable = true;
    }
}

//  KEEP THIS - Works for both local and Firebase
function undoAiImprovement(editorId, originalHTML) {
    const editor = document.getElementById(editorId);
    editor.innerHTML = originalHTML;
    showToast(' Reverted to original', 'success');
}

// ========== AI ASSISTANT FUNCTIONS - END ==========


        init();
        window.addEventListener('beforeunload', saveData);
    </script>
</body>
</html>
